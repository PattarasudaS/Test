@model HomeCare_4_0.Models.WorkSheetIndexViewModel
@using HomeCare_4_0.ClassLib
@using HomeCare_4_0.Common
@using HomeCare_4_0.Controllers

@{ 
    ViewBag.Title = "WorksheetDetail";
    Layout = "~/Views/Shared/_MasterLayout.cshtml"; 
} 
<style type="text/css">
    #ddlPONumber {
        font-weight: 700;
        color: #337ab7;
    }

    .thumbnails li img {
        width: 350px;
        height: 350px;
    }

    .flag-china {
        height: 21.74px;
        border-radius: 3px;
        position: relative;
        bottom: 1px;
    }

    .modal-dialog-center {
        margin-top: 10%;
    }

    .myCard {
        border-radius: 20px;
        border: 1.5px solid rgba(128, 128, 128, 0.70);
        box-shadow: 2px 2px 4px 2px rgba(0,0,0,0.1);
        transition: 0.3s;
        max-width: 95%;
        padding: 15px 2px;
    }

        .myCard:hover {
            border: 1.5px solid rgba(128, 128, 128, 0.90);
            box-shadow: 3px 3px 12px 3px rgba(0, 111, 206, 0.3);
        }

    .slider {
        display: none;
    }

    fieldset.scheduler-border {
        border: 1px groove #ddd !important;
        padding: 0 1.4em 1.4em 1.4em !important;
        margin: 0 0 1.5em 0 !important;
        -webkit-box-shadow: 0px 0px 0px 0px #000;
        box-shadow: 0px 0px 0px 0px #000;
        border-radius: 13px;
    }

    legend.scheduler-border {
        font-size: 1.2em !important;
        font-weight: 500 !important;
        text-align: left !important;
        width: auto;
        padding: 0 10px;
        border-bottom: none;
    }

    a {
        cursor: pointer;
    }


    .input-group-row {
        position: relative;
        display: -ms-flexbox;
        display: flex !important;
        -ms-flex-align: stretch;
        align-items: stretch;
    }

    .input-group-text {
        display: -ms-flexbox;
        display: flex;
        -ms-flex-align: center;
        align-items: center;
        padding: .375rem .75rem;
        margin-bottom: 0;
        font-size: 1rem;
        font-weight: 400;
        line-height: 2.5;
        color: #495057;
        text-align: center;
        white-space: nowrap;
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: .25rem;
    }

    #ret-tabs li.active > a {
        color: #337ab7;
        font-weight: bold;
    }

    body {
        padding-right: 0px !important;
    }
</style>
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="~/Content/css/fileinput.css" type="text/css" />
    <script src="~/Scripts/fileinput.js"></script>
</head>
<body>
    <div class="main">
        <div class="main-inner">
            <h2 class="page-header  text text-blue text-bold"><i class="fa fa-file-text-o"> </i> ใบงาน</h2>
            <input type="hidden" value="@Model.Data_WorkSheet.WorkSheet_ID" id="hdWorksheetID">
            <input type="hidden" value="@Model.Data_Unit.Unit_Code" id="hdUnitCode">
            <input type="hidden" value="@Model.Data_Unit.Unit_ID" id="hdUnitID">
            <input type="hidden" value="@Model.Data_WorkSheet.WorkSheet_JobNoText" id="hdWorkSheetJobNo">
            <input type="hidden" id="hdWorksheetitemID" />
            <input type="hidden" id="hdApproveID" />
            <input type="hidden" id="hdMainProcessID" value="@Model.Data_WorkSheet.WorkSheet_StatusID" />
            <input type="hidden" id="hdApproveStatusID" value="@Model.Data_WorkSheet.Approve_StatusID" />
            <input type="hidden" id="hdDeletedAttach" />
            <input type="hidden" id="hdRepairWorksheetItemID" />
            <input type="hidden" id="hdPOStatus" />
            <input type="hidden" id="hdPaymentType" />
            <input type="hidden" id="hdVendorRetention" />
            <input type="hidden" id="hdVendorRetentionAmount" />
            <input type="hidden" id="hdPOGentype" />
            <input type="hidden" id="hdProjectID" value="@Model.Data_Unit.PJ_ID" />
            <input type="hidden" id="hdProjectCode" value="@Model.Data_Unit.PJ_Code" />


            @*คำนวณใบงานหมดประกัน*@
            @if (@Model.Data_Unit.ExtraGuaranteeDate != "")
            {
                if (cCommon.ddMMyyyyToyyyyMMdd(@Model.Data_Unit.ExtraGuaranteeDate, '/') >= cCommon.ddMMyyyyToyyyyMMdd(@Model.Data_Inform.Inform_Date, '/'))
                {
                    <input type="hidden" value="0" id="hdWarrantyExpired"> }
                else
                {
                    <input type="hidden" value="1" id="hdWarrantyExpired"> }
            }
            else if (@Model.Data_Unit.EndGuaranteeDate != "")
            {
                if (cCommon.ddMMyyyyToyyyyMMdd(@Model.Data_Unit.EndGuaranteeDate, '/') >= cCommon.ddMMyyyyToyyyyMMdd(@Model.Data_Inform.Inform_Date, '/'))
                {
                    <input type="hidden" value="0" id="hdWarrantyExpired"> }
                else
                {
                    <input type="hidden" value="1" id="hdWarrantyExpired"> }
            }
            else
            {
                <input type="hidden" value="1" id="hdWarrantyExpired">}


            @*ข้อมูลลูกค้า*@
            <div class="row">
                <div class="col-md-12 col-xs-12">
                    <div class="box box-default">
                        <div class="box-header with-border">
                            <a data-toggle="collapse" data-target="#workOrder_customer">
                                <i class="fa fa-user"></i>
                                <h3 class="box-title">
                                    ข้อมูลลูกค้า
                                    @if (Model.Data_Customer.VipStatus != null)
                                    {
                                        if (Model.Data_Customer.VipStatus.ToLower().Contains("priority"))
                                        {
                                            <span class="label label-danger">@Model.Data_Customer.VipStatus</span> }
                                        else
                                        { <a class="label label-warning DisplaySiriPiority">VIP</a>}
                                    }
                                </h3>
                            </a>
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body" id="workOrder_customer" hidden>
                            @if (@EnumConfiguration.Role.VENDOR.ToString() != @UserDetail.Role)
                            {
                                <div class="row">
                                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                        <label class="control-label">ชื่อ-สกุล</label>
                                        <div class="controls">
                                            <div class="text-primary"> @Model.Data_Customer.FullName</div>
                                        </div>
                                    </div>

                                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                        <label class="control-label">เบอร์ติดต่อ</label>
                                        <div class="controls">
                                            <div class="text-primary"> @Model.Data_Customer.FullTelephone</div>
                                        </div>
                                    </div>
                                </div>}
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label">โครงการ</label>
                                    <div class="controls">
                                        <div class="text-primary"> @Model.Data_Unit.PJ_Name</div>
                                    </div>
                                </div>

                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label">แปลง</label>
                                    <div class="controls">
                                        <div class="text-primary"> @Model.Data_Unit.Unit_Code_Address</div>
                                    </div>
                                </div>

                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label">แบบบ้าน</label>
                                    <div class="controls">
                                        <div class="text-primary"> @Model.Data_Unit.Unit_Model</div>
                                    </div>
                                </div>

                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label">วันที่เริ่มประกัน</label>
                                    <div class="controls">
                                        <div class="text-primary"> @Model.Data_Unit.StartGuaranteeDate</div>
                                    </div>
                                </div>

                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label">วันที่หมดประกัน</label>
                                    <div class="controls">
                                        <div class="text-primary"> @Model.Data_Unit.EndGuaranteeDate</div>
                                    </div>
                                </div>


                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label">วันที่ขยายประกัน</label>
                                    <div class="controls">
                                        <div class="text-primary"> @Model.Data_Unit.ExtraGuaranteeDate</div>
                                    </div>
                                </div>

                            </div>

                            <div class="row">
                                @if (@Model.Data_Unit.Unit_GuaranteedYield == 1)
                                {
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="control-label text-danger"> Guaranteed Yield </label>
                                        <div class="controls">
                                            <input type="checkbox" name="Unit_GuaranteedYield" id="Unit_GuaranteedYield" checked disabled>
                                        </div>
                                    </div>}
                                @if (@Model.Data_Unit.Unit_Defer == 1)
                                {
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="control-label text-danger"> Defer Payment </label>
                                        <div class="controls">
                                            <input type="checkbox" name="Unit_Defer" id="Unit_Defer" checked disabled>

                                        </div>
                                    </div>}
                            </div>
                        </div>
                        <!-- /.box-body -->
                    </div>
                    <!-- /.box -->
                </div>
                <!-- /.col -->
            </div>


            @if (@EnumConfiguration.Role.VENDOR.ToString() != @UserDetail.Role)
            {@*ข้อมูลแจ้งซ่อม*@
            <div class="row">
                <div class="col-md-12 col-xs-12">
                    <div class="box box-default">
                        <div class="box-header with-border">
                            <a data-toggle="collapse" data-target="#workOrder_Fixinfomation">
                                <i class="fa fa-wrench"></i>
                                <h3 class="box-title">ข้อมูลแจ้งซ่อม</h3>
                            </a>
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body" id="workOrder_Fixinfomation" hidden>
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label">รหัสงานซ่อม </label><div class="text-primary"> @Model.Data_Inform.Inform_JobNoText</div>
                                </div>

                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label ">สถานะ </label><div class="text-primary"> @Model.Data_Inform.Main_Process_Name</div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label ">วันที่รับแจ้ง </label><div class="text-primary"> @Model.Data_Inform.Inform_Date</div>
                                </div>
                            </div>
                            <div class="row">

                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label ">ผู้รับแจ้ง </label><div class="text-primary"> @Model.Data_Inform.Inform_User</div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label ">หมายเหตุ Call Centre </label>
                                    <div class="text-danger"> @Model.Data_Inform.Inform_Remark</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label">สถานะผู้แจ้ง</label>
                                    <div class="text-primary"> @Model.Data_Inform.Inform_CustomerType_Name</div>
                                    @Html.HiddenFor(x => x.Data_Inform.Inform_CustomerType_Name)
                                </div>

                                <div class="col-xs-12 col-sm-6 col-lg-4 " name="Inform_CustomerName">
                                    <label class="control-label">ชื่อผู้แจ้ง</label>
                                    <div class="text-primary"> @Model.Data_Inform.Inform_CustomerName</div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4 " name="Inform_CustomerTel">
                                    <label class="control-label">เบอร์ติดต่อ</label>
                                    <div class="text-primary"> @Model.Data_Inform.Inform_CustomerTel</div>
                                </div>

                            </div>

                        </div>
                        <!-- /.box-body -->
                    </div>
                    <!-- /.box -->
                </div>
                <!-- /.col -->
            </div> @*ข้อมูลรับเรื่อง*@
            <div class="row">
                <div class="col-md-12 col-xs-12">
                    <div class="box box-default">
                        <div class="box-header with-border">
                            <a data-toggle="collapse" data-target="#workOrder_infomation">
                                <i class="fa fa-th-list"></i>
                                <h3 class="box-title">
                                    ข้อมูลรับเรื่อง
                                    @if (Model.Data_Receive.Receive_FlagChina == true)
                                    {
                                        <img class="flag-china" src="https://s3-ap-southeast-1.amazonaws.com/sansiri-conss-ro77/www/public/images/flag-china.svg" alt="China flag">}
                                </h3>
                            </a>
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body" id="workOrder_infomation" hidden>
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label">สถานะรับเรื่อง </label>
                                    <div class="text-primary"> @Model.Data_Receive.Receive_Status_Name</div>
                                </div>

                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label ">ผู้รับเรื่อง </label>
                                    <div class="text-primary"> @Model.Data_Receive.Receive_HC_User</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label ">HC รับเรื่องวันที่ </label>
                                    <div class="text-primary"> @Model.Data_Receive.Receive_HC_Date</div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label ">หมายเหตุ HC </label>
                                    <div class="text-primary"> @Model.Data_Receive.Receive_HC_Remark</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label ">CC รับเรื่องวันที่ </label>
                                    <div class="text-primary"> @Model.Data_Receive.Receive_CC_Date</div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label ">หมายเหตุ CC </label>
                                    <div class="text-primary"> @Model.Data_Receive.Receive_CC_Remark</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label ">วันที่นัดหมายตรวจสอบ </label>
                                    <div class="text-primary"> @Model.Data_Receive.Receive_Appointment_Date</div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label ">เวลา </label>
                                    <div class="text-primary"> @Model.Data_Receive.Receive_Appointment_Time_From</div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label ">ถึง </label>
                                    <div class="text-primary"> @Model.Data_Receive.Receive_Appointment_Time_To</div>
                                </div>
                            </div>
                        </div>
                        <!-- /.box-body -->
                    </div>
                    <!-- /.box -->
                </div>
                <!-- /.col -->
            </div> } @*ข้อมูลใบงาน*@
            <div class="row">
                <div class="col-md-12 col-xs-12">
                    <div class="box box-default">
                        <div class="box-header with-border">
                            <a data-toggle="collapse" data-target="#Worksheet-Worksheet-detail">
                                <i class="fa fa-file-text-o"></i>
                                <h3 class="box-title">ข้อมูลใบงาน</h3>
                            </a>
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body" id="Worksheet-Worksheet-detail" hidden>

                            @*ใบงาน : ส่วนข้อมูลทั่วไป AddReceiveTable*@
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label ">รหัสใบงาน </label><div class="text-primary"> @Model.Data_WorkSheet.WorkSheet_JobNoText</div>
                                    <div class="text-primary" id="lbHdWorkSheet_JobNoText" hidden> @Model.Data_WorkSheet.WorkSheet_JobNoText</div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label ">สถานะ </label><div class="text-primary"><label id="lblWorksheetStatus">@Model.Data_WorkSheet.WorkSheet_Status - @Model.Data_WorkSheet.Approve_Status</label></div>
                                </div>
                                @if (@EnumConfiguration.Role.VENDOR.ToString() != @UserDetail.Role && @EnumConfiguration.Role.CallCentre.ToString() != @UserDetail.Role)
                                {
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="control-label ">ยืนยันปิดใบงาน  </label>
                                        <div class="input-group" style="width:80%">
                                            <span class="input-group-addon">
                                                @if (string.IsNullOrEmpty(@Model.Data_WorkSheet.WorkSheet_CloseJobDate))
                                                {<input type="checkbox" name="WorksheetCloseConfirm" id="WorksheetCloseConfirm">}
                                                else
                                                { <input type="checkbox" name="WorksheetCloseConfirm" id="WorksheetCloseConfirm" checked>}
                                            </span>
                                            <input type="text" class="form-control" name="WorksheetCloseConfirmDate" id="WorksheetCloseConfirmDate" value="@Model.Data_WorkSheet.WorkSheet_CloseJobDate" readonly>
                                        </div>
                                    </div>}
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label ">วันที่เปิดใบงาน  </label>
                                    <div class="text-primary"> @Model.Data_WorkSheet.WorkSheet_Create_Date น.</div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label ">ผู้เปิดใบงาน</label>
                                    <div class="text-primary"> @Model.Data_WorkSheet.WorkSheet_CreateBy</div>
                                </div>

                                @if (@EnumConfiguration.Role.VENDOR.ToString() != @UserDetail.Role && @EnumConfiguration.Role.CallCentre.ToString() != @UserDetail.Role)
                                {
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="control-label">ออกเอกสาร</label>
                                        <div>
                                            <span><label class="control-label text-primary">F1:</label> <a id="btnbtnprintF1"><i class="fa fa-print fa-lg"></i></a></span>
                                            &nbsp;
                                            <span><label class="control-label text-primary">ใบเสนอราคา:</label> <a id="btnbtnprintQT"><i class="fa fa-print fa-lg" style="color:brown"></i></a></span>
                                        </div>
                                    </div>}
                            </div>
                            <div class="row">

                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label ">ผู้รับเหมา</label>
                                    <div class="text-primary">
                                        <label id="lblVendorName">@Model.Data_WorkSheet.VendorName</label>
                                        <input type="hidden" value="@Model.Data_WorkSheet.VendorID" id="hdVendorID" />
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4" id="divchangeVendor">

                                    <label class="control-label ">เปลี่ยนผู้รับเหมา</label>
                                    <div class="text-primary">
                                        <span><a id='itemAddVendor' name='itemAddVendor[]'><i class='fa fa-user fa-lg'></i></a></span>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4" id="divchangeVendorRemark" hidden>
                                    <label class="control-label danger">*หมายเหตุเปลี่ยนผู้รับเหมา</label>
                                    <input type="text" class="form-control" name="txtVendorchangeRemark" id="txtVendorchangeRemark">
                                    <input type="hidden" id="hdFlagchangeVendor" />
                                </div>

                                @if (@EnumConfiguration.Role.SUPPORT_HC.ToString() == @UserDetail.Role || WorkSheetController.checkPermission("RollbackWorksheet"))
                                {
                                    <div class="col-xs-12 col-sm-6 col-lg-4 " style="margin-top:20px;">
                                        <span type="button" class="btn btn-danger" id="btnRollbackWorkSheet">ถอยสถานะปิดใบงาน</span>
                                    </div> } @*ใบงาน : ปุ่ม Questionnaire Modal*@
                                @{int statusID = Int32.TryParse(Model.Data_WorkSheet.WorkSheet_StatusID, out statusID) ? statusID : 0;}

                                @if ((statusID == 16 || statusID == 15) && @UserDetail.Role == "CallCentre")
                                {
                                    <div class="col-xs-12 col-sm-6 col-lg-4" id="questionnaireDisplayDiv">
                                        <label class="control-label ">แบบสอบถาม</label>
                                        <div class="text">
                                            <span><button onclick="openModalQuestionnaire(); return false" id="btnModalQuestionnaire" class="btn btn-default questionnaire">แบบสอบถาม <img src="../../Images/questionnaire_icon.png" style="width:20px;height:20px;" /></button></span>
                                            <label id="displayReason" class="text-red" style="margin-left: 5px; display: none"></label>
                                        </div>
                                    </div>}

                            </div>

                            @*ใบงาน : ส่วนตาราง AddReceiveTable*@
                            <div class="row">
                                <div style="overflow:auto" class="col-lg-12">
                                    <table class="nowrap table table-striped table-bordered table-hover" id="AddReceiveTable" style="margin: 8px 8px 0px 8px; width:1600px; white-space: nowrap;">
                                        <thead>
                                            <tr class="">
                                                <th class="text-center">
                                                    No.
                                                </th>
                                                <th class="text-center">
                                                    สถานะ
                                                </th>
                                                <th class="text-center">
                                                    หมวดงาน
                                                </th>
                                                <th class="text-center">
                                                    ลักษณะงานหลัก
                                                </th>
                                                <th class="text-center">
                                                    ลักษณะงานรอง
                                                </th>
                                                <th class="text-center">
                                                    ลักษณะการประเมิน
                                                </th>
                                                <th class="text-center">
                                                    ตำแหน่งที่เกิด
                                                </th>
                                                <th class="text-center">
                                                    สาเหตุการเกิดปัญหา
                                                </th>
                                                <th class="text-center">
                                                    อธิบายสาเหตุ
                                                </th>
                                                <th class="text-center">
                                                    วันที่นัดหมายซ่อม
                                                </th>
                                                <th class="text-center">
                                                    เลื่อนวันที่นัดหมายซ่อม
                                                </th>
                                                <th class="text-center">
                                                    Priority
                                                </th>
                                                <th class="text-center">
                                                    กำหนดแล้วเสร็จ
                                                </th>
                                                <th class="text-center">
                                                    การซ่อม
                                                </th>
                                                <th class="text-center">
                                                    ยืนยันราคา
                                                </th>
                                                <th class="text-center">
                                                    วันที่เริ่มซ่อม
                                                </th>
                                                <th class="text-center">
                                                    วันที่ซ่อมเสร็จ
                                                </th>
                                                <th class="text-center">
                                                    ไฟล์ภาพ
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>

                                            @if (Model.Data_WorkSheetItem != null && Model.Data_WorkSheetItem.Count > 0)
                                            {
                                                int i = 0;
                                                foreach (var item in @Model.Data_WorkSheetItem)
                                                {
                                                    i++;
                                                    <tr id='tr1'>
                                                        <td class="text-center">
                                                            <p type="text" id="No" name="No">@i</p>
                                                            <input hidden="hidden" value="@item.WI_ID" id="hdWorksheet_Item_ID">

                                                        </td>
                                                        <td class="text-center">
                                                            <select id="ReceivedDetailItemsStatus" name="ReceivedDetailItemsStatus1" class="form-control ReceivedDetailItemsStatus" style="width:fit-content;">
                                                                @foreach (var Operate_Status in new Cls_HC_TM_Lookup().Get_Master_DDL(Cls_HC_TM_Lookup_Type.HC_Operate_Status))
                                                                {
                                                                    if (item.WI_Status_ID == int.Parse(Operate_Status.Value))
                                                                    {
                                                                        <option value="@Operate_Status.Value" selected>@Operate_Status.Text</option>
                                                                    }
                                                                    else
                                                                    {
                                                                        <option value="@Operate_Status.Value">@Operate_Status.Text</option>
                                                                    }
                                                                }
                                                            </select>
                                                        </td>
                                                        <td class="text-left">
                                                            @item.Guarantee_Name
                                                        </td>
                                                        <td class="text-left">
                                                            @item.SpecL1_Name
                                                        </td>
                                                        <td class="text-left">
                                                            @item.SpecL2_Name
                                                        </td>
                                                        <td class="text-left">
                                                            @item.SpecL3_Name
                                                        </td>
                                                        <td class="text-left">
                                                            @item.Location_Name
                                                        </td>
                                                        <td class="text-left">
                                                            @item.Cause_Name
                                                        </td>
                                                        <td class="text-left">

                                                            @Html.TextAreaFor(m => @item.Cause_Text, new { @class = "form-control", @id = "Cause_Text", @style = "width:100px" })
                                                        </td>
                                                        <td class="text-left">
                                                            @item.RepairAppointmentDate
                                                        </td>
                                                        <td class="text-center">
                                                            <div class="controls">
                                                                @if (string.IsNullOrEmpty(@item.WI_StartDate) || @EnumConfiguration.Role.CallCentre.ToString() == @UserDetail.Role)
                                                                {
                                                                    if (@EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
                                                                    {
                                                                        <a id="btnExtendedRepair" data-value="@item.WI_ID" class="btnExtendedRepair"><i class="fa fa-calendar-plus-o fa-lg" style="color:chocolate;"></i></a>}
                                                                }

                                                                <a id="viewExtendedHistory" class="viewExtendedHistory" data-value="@item.WI_ID">  <i class="fa fa-book fa-lg"></i></a>

                                                                @if ("prajak" == @UserDetail.CodeName)
                                                                {
                                                                    <a id="btnExtendedRepairAfter" data-value="@item.WI_ID" class="btnExtendedRepairAfter"><i class="fa fa-hand-peace-o fa-lg" style="color:forestgreen;"></i></a>}

                                                            </div>
                                                        </td>
                                                        <td class="text-left">
                                                            @item.Priority_Name
                                                        </td>
                                                        <td class="text-left">
                                                            @item.WI_ExpectDate
                                                        </td>
                                                        <td class="text-center">
                                                            @if (@item.WI_Status_ID != 2)
                                                            {
                                                                <a id="viewFixPrice" data-value="@item.WI_ID" class="viewFixPrice" name="viewFixPrice" hidden>
                                                                    <span class="fa fa-folder-open fa-lg" aria-hidden="true"></span>
                                                                </a> }
                                                            else
                                                            {
                                                                <a id="viewFixPrice" data-value="@item.WI_ID" class="viewFixPrice" name="viewFixPrice">
                                                                    <span class="fa fa-folder-open fa-lg" aria-hidden="true"></span>
                                                                </a>}

                                                        </td>
                                                        <td class="text-center">
                                                            <div class="input-group">
                                                                <span class="input-group-addon">
                                                                    @if (string.IsNullOrEmpty(item.WI_ConfirmPriceDate))
                                                                    {
                                                                        <input type="checkbox" name="PriceConfirm" id="PriceConfirm" class="PriceConfirm"> }
                                                                    else
                                                                    {
                                                                        <input type="checkbox" name="PriceConfirm" id="PriceConfirm" checked class="PriceConfirm">}

                                                                </span>
                                                                <input type="text" class="form-control" name="PriceConfirmDate" id="PriceConfirmDate" value="@item.WI_ConfirmPriceDate" readonly style="width:100px">
                                                            </div>
                                                        </td>
                                                        <td class="text-center">
                                                            <div class="input-group">
                                                                <span class="input-group-addon">

                                                                    @if (string.IsNullOrEmpty(item.WI_StartDate))
                                                                    {
                                                                        <input type="checkbox" name="StartFix" id="StartFix" class="StartFix"> }
                                                                    else
                                                                    { <input type="checkbox" name="StartFix" id="StartFix" class="StartFix" checked>}

                                                                </span>
                                                                <input type="text" class="form-control" name="StartFixDate" id="StartFixDate" value="@item.WI_StartDate" readonly style="width:100px">
                                                            </div>
                                                        </td>
                                                        <td class="text-center">
                                                            <div class="input-group">
                                                                <span class="input-group-addon">
                                                                    @if (string.IsNullOrEmpty(item.WI_FinishDate))
                                                                    {
                                                                        <input type="checkbox" name="EndFix" id="EndFix" class="EndFix" value="@item.WI_ID" onclick="onvalidateEndFix($(this))"> }
                                                                    else
                                                                    {
                                                                        <input type="checkbox" name="EndFix" id="EndFix" checked class="EndFix" value="@item.WI_ID">}
                                                                </span>
                                                                <input type="text" class="form-control" name="EndFixDate" id="EndFixDate" value="@item.WI_FinishDate" readonly style="width:100px">
                                                            </div>
                                                        </td>
                                                        <td class="text-center">
                                                            <button id="btnaddWorksheetPic" value="@item.WI_ID" class="btnaddWorksheetPic"><i class="fa fa-photo fa-lg"></i></button>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td class="text-center Bold text-danger" colspan="14">ไม่มีข้อมูล</td>
                                                </tr>
                                            }


                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <br />

                            @*ใบงาน : ส่วนราคารวม divPriceApprove*@
                            <div id="divPriceApprove">
                                <div class="row from-group">
                                    <div class="col-xs-12 col-sm-6 col-lg-12">
                                        <label class="control-label ">ราคารวมตามรายการ&nbsp; </label><label class="text-danger" id="lblTotalUnit"> @Model.Data_WorkSheet.TotalPrice.ToString("#,##0.00")</label>
                                    </div>
                                </div>
                                <div class="row form-group">
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="col-sm-6 control-label" for="txtOperatingPercent">ค่าดำเนินการ (%)</label>
                                        <div class="col-sm-4">
                                            <input type="number" value="@Model.Data_WorkSheet.OperatingPercent" id="txtOperatingPercent" class="form-control input-sm" max="100" min="0">
                                        </div>
                                        <label class="col-sm-1 control-label">%</label>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="col-sm-6 control-label">เป็นจำนวนเงิน</label>
                                        <div class="col-sm-6">
                                            @{ var OperatingPercent = ((@Model.Data_WorkSheet.TotalPrice * @Model.Data_WorkSheet.OperatingPercent) / 100).ToString("#,##0.00");
                                                <input type="text" value="@OperatingPercent" id="txtIncludeOperatingPercent" class="form-control input-sm" readonly> }

                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="col-sm-6 control-label">รวมได้</label>
                                        <div class="col-sm-6">
                                            @{ var total_OperatingPercent = ((@Model.Data_WorkSheet.TotalPrice) * ((100 + @Model.Data_WorkSheet.OperatingPercent) / 100));
                                                <input type="text" value="@total_OperatingPercent.ToString(" #,##0.00")" id="txtTotalIncludeOperatingPercent" class="form-control input-sm" readonly> }
                                        </div>
                                    </div>
                                </div>

                                <!--Add retention-->
                                <div class="row form-group">
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="col-sm-6 control-label" for="txtVatPercent">Retention (%)</label>
                                        <div class="col-sm-4">
                                            @{ var retentionPercent = 0; }
                                            <input type="number" value="retentionPercent" id="txtRetentionPercent" class="form-control input-sm">
                                        </div>
                                        <div class="col-sm-1">
                                            <label class="control-label">%</label>
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="col-sm-6 control-label">เป็นจำนวนเงิน</label>
                                        <div class="col-sm-6">
                                            @{ var totalRetention = 0;
                                                <input type="text" value="@totalRetention.ToString(" #,##0.00")" id="txtTotalRetention" class="form-control input-sm" readonly> }
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="col-sm-6 control-label">รวมได้</label>
                                        <div class="col-sm-6">
                                            @{ var totalPrice = @total_OperatingPercent - totalRetention;

                                                <input type="text" value="@totalPrice.ToString(" #,##0.00")" id="txtNetPrice" class="form-control input-sm" readonly> }
                                        </div>
                                    </div>
                                </div>
                                <!--Include Vat -->
                                <div class="row form-group">
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="col-sm-6 control-label" for="txtVatPercent">Vat (%)</label>
                                        <div class="col-sm-4">
                                            <input type="number" value="@Model.Data_WorkSheet.VatPercent" id="txtVatPercent" class="form-control input-sm">
                                        </div>
                                        <div class="col-sm-1">
                                            <label class="control-label">%</label>
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="col-sm-6 control-label">เป็นจำนวนเงิน</label>
                                        <div class="col-sm-6">
                                            @{ // var total_vat = (totalPrice * @Model.Data_WorkSheet.VatPercent) / 100;
                                                <input type="text" id="txtIncludeVatPercent" class="form-control input-sm" readonly> }
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="col-sm-6 control-label">รวมได้</label>
                                        <div class="col-sm-6">
                                            @{ //  var totalPriceWithVat = @totalPrice + @total_vat;

                                                <input type="text" id="txtNetPriceWithVat" class="form-control input-sm" readonly> }
                                        </div>
                                    </div>
                                </div>


                                <div class="row form-group">
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <label class="col-sm-6 control-label Bold text-danger Bold">ราคาสุทธิ</label>
                                        <div class="col-sm-6">
                                            @{
                                                <div class="" id="lblFinalNetPrice"></div> }

                                        </div>
                                    </div>
                                </div>

                            </div>

                            @*ใบงาน : ส่วนเลือกประเภทค่าใช้จ่าย apprveDetial*@
                            <div class="row" id="apprveDetial">
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">ประเภทการอนุมัติ</label></h5>
                                    <input type="radio" name="AprrovedType" value="N"> ไม่มีค่าใช้จ่าย
                                    <input type="radio" name="AprrovedType" value="Y"> มีค่าใช้จ่าย
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-3 boxPaymentType hidden">
                                    <h5><label class="control-label">รายละเอียดการอนุมัติ</label></h5>
                                    <select id="PaymentType" name="PaymentType" class="form-control"></select>
                                </div>

                                @if ("HC" == @UserDetail.Role)
                                {
                                    <div class="col-xs-12 col-sm-6 col-lg-4" id="divApprovedRemark">
                                        <h5><label class="control-label">เหตุผลการขออนุมัติแบบมีค่าใช้จ่าย</label></h5>
                                        <input type="text" class="form-control" name="txtApproveRemark" id="txtApproveRemark" style="width:100%;">
                                    </div>}
                                @if (@EnumConfiguration.Role.VENDOR.ToString() != @UserDetail.Role && @EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
                                {
                                    <div class="col-xs-12 col-sm-6 col-lg-2" id="divbtnsendApprove">
                                        <h5><label class="control-label">ส่งอนุมัติ</label></h5>
                                        <a id="btnsendApprove"><i class="fa fa-paper-plane fa-lg"></i></a>
                                    </div>}
                            </div>

                        </div>
                    </div>

                    <!-- /.box-body -->
                </div>
            </div>

            @if (@EnumConfiguration.Role.VENDOR.ToString() != @UserDetail.Role)
            {@*ข้อมูลการอนุมัติใบงาน*@
            <div class="row">
                <div class="col-md-12 col-xs-12">
                    <div class="box box-default">
                        <div class="box-header with-border">
                            <a data-toggle="collapse" data-target="#Worksheet-Approval">
                                <i class="fa fa-file"></i>
                                <h3 class="box-title">ข้อมูลการอนุมัติใบงาน และเลขที่ใบ PO</h3>
                            </a>
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body" id="Worksheet-Approval" hidden>
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-6">
                                    <fieldset class="scheduler-border" style="min-height: 170px;">
                                        <legend class="scheduler-border">ข้อมูลการอนุมัติใบงาน</legend>
                                        <div class="row">
                                            <div class="col-xs-12 col-sm-6 col-lg-4">

                                                <label class="control-label ">รหัสใบอนุมัติ </label><div class="text-primary"><label id="lblApprove_JobNoText"></label></div>
                                            </div>
                                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                                <label class="control-label ">สถานะ </label><div class="text-primary"><label id="lblApprove_Status"></label></div>

                                            </div>
                                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                                <label class="control-label ">วันที่เปิดใบอนุมัติ </label><div class="text-primary"><label id="lblApprove_CreatedDate"></label></div>

                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                                <label class="control-label ">ผู้เปิดใบอนุมัติ </label><div class="text-primary"><label id="lblApprove_CreatedBy"></label></div>

                                            </div>
                                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                                <label class="control-label ">ประวัติการอนุมัติ </label>

                                                <div><a id="viewApproveHistory"><i class="fa fa-book fa-lg"></i></a></div>
                                            </div>
                                        </div>

                                        <div class="row" id="divApprove">
                                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                                <h5><label class="control-label">การอนุมัติ</label></h5>
                                                <button id="btnApproved" type="submit" class="btn btn-primary" value="true">อนุมัติ</button>
                                                <button id="btnNotApproved" type="submit" class="btn btn-danger" value="false">ไม่อนุมัติ</button>
                                            </div>
                                            <div class="col-xs-12 col-sm-6 col-lg-4" name="ApprovalRemark">
                                                <h5><label class="control-label">เหตุผล</label></h5>
                                                <input type="text" id="ApprovalRemark" name="ApprovalRemark" value="" class="form-control">
                                            </div>
                                        </div>
                                    </fieldset>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-6">
                                    <fieldset class="scheduler-border" style="min-height: 170px;">
                                        <legend class="scheduler-border">ข้อมูลเลขที่ PO จำนวน <span id="txtPOCount"></span> รายการ</legend>
                                        <div class="row">
                                            <div class="col-xs-12 col-sm-6 col-lg-4">

                                                <label class="control-label ">เลขที่ใบ PO  <span id="txtPOType"></span></label><div class="text-primary" id="textShowPO"><label id="lbPONumber"></label></div>
                                                <select id="ddlPONumber" name="ddlPONumber" class="form-control"></select>
                                            </div>
                                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                                <label class="control-label ">สถานะ </label><div class="text-primary"><label id="lblPOStatus"></label></div>

                                            </div>
                                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                                <label class="control-label ">ประวัติเลขที่ใบ PO </label>

                                                <div><a id="viewPOHistory"><i class="fa fa-book fa-lg"></i></a></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                                <label class="control-label ">ตรวจสอบงบโครงการ </label>

                                                <div><a id="itemCheckProjectBudget"><i class="fa fa-table fa-lg"></i></a></div>
                                            </div>
                                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                                <label class="control-label ">จำนวนเงิน</label><div class="text-primary"><label id="lblBance"></label></div>
                                            </div>
                                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                                <label class="control-label ">หัก Retention ใบงาน</label><div class="text-primary"><label id="lblRetPrice"></label></div>
                                            </div>
                                        </div>
                                        @if (@EnumConfiguration.Role.SUPPORT_HC.ToString() == @UserDetail.Role || WorkSheetController.checkPermission("POManagement"))
                                        {
                                            <div class="row" style="margin-top: 9px;">

                                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                                    <button id="btnCreatePO" type="button" class="btn btn-primary" value="true">สร้างเลขที่ใบ PO</button>
                                                    <button id="btnCancelPO" type="button" class="btn btn-danger" value="false">ยกเลิกเลขที่ใบ PO</button>
                                                    <button id="btnApprovePO" type="button" class="btn btn-primary" value="false">อนุมัติเลขที่ใบ PO</button>
                                                </div>
                                            </div>}
                                    </fieldset>
                                </div>
                            </div>

                            <br />
                            <div class="row">
                                <table class="table table-bordered table-hover" id="tbApproveitemDetail" style="margin-left: 20px; width:auto">
                                    <thead>
                                        <tr class="">
                                            <th class="text-center">
                                                No.
                                            </th>
                                            <th class="text-center">
                                                หมวดงานที่ ผรม. ต้องซ่อม
                                            </th>
                                            <th class="text-center ">
                                                รายละเอียดที่ซ่อม
                                            </th>
                                            <th class="text-center">
                                                ลักษณะปัญหา
                                            </th>
                                            <th class="text-center">
                                                วิธีการซ่อม
                                            </th>
                                            <th class="text-center">
                                                ราคาต่อหน่วย
                                            </th>
                                            <th class="text-center">
                                                ราคาพิเศษต่อหน่วย
                                            </th>
                                            <th class="text-center">
                                                ปริมาณ
                                            </th>
                                            <th class="text-center">
                                                หน่วย
                                            </th>
                                            <th class="text-center">
                                                รวมเป็นเงิน
                                            </th>
                                            <th class="text-center">
                                                หมายเหตุ
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                    </div>

                    <!-- /.box-body -->
                </div>
            </div> } @*ข้อมูลการหักเงินประกัน*@
            <div class="row" id="divRetentionPanel">
                <div class="col-md-12 col-xs-12">
                    <div class="box box-default">
                        <div class="box-header with-border">
                            <a data-toggle="collapse" data-target="#Worksheet-Retention">
                                <i class="fa fa-file"></i>
                                <h3 class="box-title">ข้อมูลการหักเงินประกัน</h3>
                            </a>
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body" id="Worksheet-Retention" hidden>
                            <ul class="nav nav-tabs" id="ret-tabs">
                                <li id="tab-searchPO" class="active"><a data-toggle="tab" href="#searchVendor">PO ผู้รับเหมา</a></li>
                                <li id="tab-listPO"><a data-toggle="tab" href="#listVendor">จัดการ PO ผู้รับเหมา</a></li>
                                <li id="tab-listRetention" class="disabled"><a data-toggle="tab" href="#listRetention">รายการหัก Retention สำเร็จ </a></li>
                            </ul>
                            <div class="tab-content">
                                <div id="searchVendor" class="tab-pane fade in active">
                                    <div class="container-fluid" style="margin-top:30px;">
                                        <fieldset class="scheduler-border">
                                            <legend class="scheduler-border">ค้นหา PO ผู้รับเหมา</legend>
                                            <div class="row">
                                                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                                    <label>รหัส/ชื่อผู้รับเหมา <span class="text-danger">*</span></label>
                                                    <div class="input-group-row">
                                                        <input class="form-control" type="text" id="vendorCode" maxlength="20" style="width: 30%" readonly />
                                                        <input class="form-control " type="text" id="vendorName" maxlength="100" readonly />
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text" style="background-color:#ffffff">
                                                                <a id="itemAddVendorRetention" name="itemAddVendorRetention"><i class="fa fa-user fa-lg"></i></a>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="form-group col-xs-12 col-md-6 col-lg-3">
                                                    <label>เลขที่ใบ PO </label>
                                                    <input class="form-control " type="text" id="poNumber-retention" />
                                                </div>

                                                <div class="form-group col-xs-12 col-md-6 col-lg-3">
                                                    <label>ประวัติข้อมูลหักเงินประกัน </label>
                                                    <div><a id="viewRetentionHistory"><i class="fa fa-book fa-lg"></i></a></div>
                                                </div>

                                            </div>
                                            <div class="row">
                                                <div class="form-group col-xs-12 col-md-6 col-lg-3">
                                                    <label>บริษัท </label>
                                                    <select class="col-lg-6 form-control select2" id="searchCompany" data-placeholder="-- กรุณาคลิกเพื่อเลือกบริษัท --">
                                                        <option selected>Please select</option>
                                                    </select>

                                                </div>

                                                <div class="form-group col-xs-12 col-md-6 col-lg-3">
                                                    <label>ประเภทระบบ :</label>
                                                    <select class="col-lg-6 form-control select2" id="searchSystemType" data-placeholder="-- กรุณาคลิกเพื่อเลือกประเภทระบบ --">
                                                        <option selected>Please select</option>
                                                    </select>
                                                </div>
                                                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                                    <label style="height:39px;"> </label>
                                                    <button type="button" class="btn btn-primary" id="btnSearchVendorList"><i class="fa fa-search"> </i> ค้นหาผู้รับเหมา</button>
                                                    <button type="button" class="btn btn-warning" id="btnClearSearchVendorList"><i class="fa fa-refresh"> </i> ล้างข้อมูล</button>
                                                </div>

                                            </div>
                                        </fieldset>

                                        <div class="row text-center">
                                            <div class="form-group col-xs-12 col-md-6 col-lg-12">

                                            </div>
                                        </div>

                                        <div class="row" style="margin-top:40px;">
                                            <div class="form-group col-xs-12 col-md-6 col-lg-12 ">
                                                <table class="table  table-striped table-bordered " id="tbvendor-list">
                                                    <thead>
                                                        <tr>
                                                            <th class="text-center">เลือก</th>
                                                            <th class="text-center">เลขที่ PO</th>
                                                            <th class="text-center">โครงการ</th>
                                                            <th class="text-center">รหัสผู้รับเหมา</th>
                                                            <th class="text-center">ชื่อผู้รับเหมา</th>
                                                            <th class="text-center">เงินประกันคงเหลือ</th>
                                                            <th class="text-center">ประเภทระบบ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>

                                            </div>

                                        </div>
                                        <div class="row">
                                            <div class="form-group col-xs-12 col-md-6 col-lg-12 text-center">
                                                <button type="button" class="btn btn-primary" id="btnActionPO-Retention">ดำเนินการ </button>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <div id="listVendor" class="tab-pane fade">
                                    <div class="container-fluid" style="margin-top:40px;">
                                        <div class="row">
                                            <div class="form-group col-xs-12 col-md-6 col-lg-12 ">
                                                <table class="table  table-striped table-bordered" id="tbVendorRetention-list" style="margin-bottom: 0;">
                                                    <thead>
                                                        <tr>
                                                            <th class="text-center">เลขที่ PO</th>
                                                            <th class="text-center">รหัสผู้รับเหมา</th>
                                                            <th class="text-center">ชื่อผู้รับเหมา</th>
                                                            <th class="text-center">เงินประกันคงเหลือ</th>
                                                            <th class="text-center">ยอดเงินที่ต้องการหัก <span class="text-danger">*</span></th>
                                                            <th class="text-center">วันที่ <span class="text-danger">*</span></th>
                                                            <th class="text-center">หมายเหตุ <span class="text-danger">*</span></th>
                                                            <th class="text-center">ประเภทระบบ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>

                                            </div>

                                        </div>
                                        <div class="row" id="dvSumRetVendor">
                                            <div class="form-group col-xs-12 col-md-6 col-lg-6 text-danger">
                                                <div><label>ยอดเงินหักประกันรวม (เดิม) : <span id="lblOldRetAmt"></span></label></div>
                                                <div><label>ยอดรวมที่ต้องการหักเงินประกัน : <span id="txtSumRetention"></span></label></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="form-group col-xs-12 col-md-6 col-lg-12 text-center">
                                                <button type="button" class="btn btn-primary" id="btnCreateRetention"><i class="fa fa-save"> </i> บันทึก </button>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <div id="listRetention" class="tab-pane fade">
                                    <div class="container-fluid" style="margin-top:40px;">
                                        <div class="row">
                                            <div class="form-group col-xs-12 col-md-6 col-lg-12 ">
                                                <table class="table  table-striped table-bordered" id="tbWorksheetRetention-list" style="margin-bottom: 0;">
                                                    <thead>
                                                        <tr>
                                                            <th class="text-center">เลขที่ใบ หักเงินประกัน</th>
                                                            <th class="text-center">เลขที่ PO</th>
                                                            <th class="text-center">รหัสผู้รับเหมา</th>
                                                            <th class="text-center">ชื่อผู้รับเหมา</th>
                                                            <th class="text-center">ยอดเงินที่หัก Retention</th>
                                                            <th class="text-center">วันที่</th>
                                                            <th class="text-center">หมายเหตุ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>

                                            </div>
                                        </div>

                                    </div>

                                </div>

                            </div>


                        </div>

                    </div>

                    <!-- /.box-body -->
                </div>
            </div>


            @*ข้อมูลการแนบเอกสาร*@
            <div class="row" id="dvAttachDocuments">
                <div class="col-md-12 col-xs-12">
                    <div class="box box-default">
                        <div class="box-header with-border">
                            <a data-toggle="collapse" data-target="#Worksheet-Attach-detail" onclick="bindingInputFile()">
                                <i class="fa fa-paperclip"></i>
                                <h3 class="box-title">ข้อมูลการแนบเอกสาร</h3>
                            </a>
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body" id="Worksheet-Attach-detail" hidden>
                            @*group 1*@
                            <div class="row">
                                <div class="col-md-12 col-xs-12">
                                    <div class="box box-default">
                                        <div class="box-header with-border">
                                            <a data-toggle="collapse" data-target="#Worksheet-Attach-detail-Group1">
                                                <i class="fa fa-photo"></i>
                                                <h3 class="box-title">รูปภาพ</h3>
                                            </a>
                                        </div>
                                        <!-- /.box-header -->
                                        <div class="box-body" id="Worksheet-Attach-detail-Group1" hidden>
                                            <div class="row">
                                                <div class="col-sm-12 col-lg-6">
                                                    <table class="table table-bordered table-hover" id="AddAttarchGroup1" style="margin: 8px 8px 0px 8px; width:auto;">
                                                        <thead>
                                                            <tr class="">
                                                                <th class="text-center">
                                                                    สถานะ
                                                                </th>
                                                                <th class="text-center">
                                                                    ประเภท
                                                                </th>
                                                                <th class="text-center ">
                                                                    ดูไฟล์
                                                                </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>

                                                                @if (Model.Data_WorkSheetAttachment != null && Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 1).Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                }
                                                                <td class="text-center">

                                                                    <label type="text" id="lbldocName">รูปก่อน</label>
                                                                </td>
                                                                <td class="text-center">
                                                                    <i class="fa fa-search fa-lg viewFile"></i>
                                                                    <input type="hidden" id="AttachmentTypeID" value="1" />
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                @if (Model.Data_WorkSheetAttachment != null && Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 2).Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                }
                                                                <td class="text-center">
                                                                    <label type="text" id="lbldocName">รูประหว่าง</label>

                                                                </td>
                                                                <td class="text-center">
                                                                    <i class="fa fa-search fa-lg viewFile"></i>
                                                                    <input type="hidden" id="AttachmentTypeID" value="2" />
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                @if (Model.Data_WorkSheetAttachment != null && Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 3).Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                }
                                                                <td class="text-center">

                                                                    <label type="text" id="lbldocName">รูปหลัง</label>
                                                                </td>
                                                                <td class="text-center">
                                                                    <i class="fa fa-search fa-lg viewFile"></i>
                                                                    <input type="hidden" id="AttachmentTypeID" value="3" />
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-12 col-lg-6">

                                                </div>
                                            </div>
                                        </div>

                                        <!-- /.box-body -->
                                    </div>
                                </div>
                            </div>
                            @*group 2*@

                            <div class="row" id="AttachDocumentsF">
                                <div class="col-md-12 col-xs-12">
                                    <div class="box box-default">
                                        <div class="box-header with-border">
                                            <a data-toggle="collapse" data-target="#Worksheet-Attach-detail-Group2">
                                                <i class="fa fa-file-text-o"></i>
                                                <h3 class="box-title">เอกสาร F</h3>
                                            </a>
                                        </div>
                                        <!-- /.box-header -->
                                        <div class="box-body" id="Worksheet-Attach-detail-Group2" hidden>
                                            <div class="row">
                                                <div class="col-sm-12 col-lg-12">
                                                    <table class="table table-bordered table-hover" id="AddAttarchGroup2" style="margin: 8px 8px 0px 8px; width:100%;">
                                                        <thead>
                                                            <tr class="">
                                                                <th class="text-center">
                                                                    สถานะ
                                                                </th>
                                                                <th class="text-center col-sm-2">
                                                                    ประเภท
                                                                </th>
                                                                <th class="text-center ">
                                                                    รายละเอียด
                                                                </th>
                                                                <th class="text-center ">
                                                                    ผู้แนบ
                                                                </th>
                                                                <th class="text-center ">
                                                                    วันที่แนบ
                                                                </th>
                                                                <th class="text-center ">
                                                                    ดูไฟล์
                                                                </th>
                                                                <th class="text-center">
                                                                    แนบไฟล์
                                                                </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                @* value 4  *@
                                                                @if (Model.Data_WorkSheetAttachment != null && Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 4).Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                    <td class="text-center">

                                                                        <label type="text" id="lbldocName">F1</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 4).LastOrDefault().Attachment_Detail" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 4).LastOrDefault().Attachment_UpdateBy</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 4).LastOrDefault().Attachment_UpdateDate</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <i class="fa fa-search fa-lg viewFile"></i>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <label type="text" id="lbldocName">F1</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-left">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<i class="fa fa-search fa-lg viewFile"></i>*@
                                                                    </td>
                                                                }
                                                                <td class="text-center">
                                                                    <input type="hidden" id="ReferenceType" value="@EnumConfiguration.enumAttachmentType.HCF.ToString()" />
                                                                    <input type="hidden" id="AttachmentTypeID" value="4" />
                                                                    @*<input type="hidden" id="AttachmentDetail" value="ใบ HCF1 พร้อมรายเซ็นลูกค้า" />*@
                                                                    @if (@EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
                                                                    {
                                                                        <input id="fileinput" name="file" type="file" class="file" data-preview-file-type="text">}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                @* value 5  *@

                                                                @if (Model.Data_DocumentF != null && Model.Data_DocumentF.Where(x => x.FormType == "F2").Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                    <td class="text-center">

                                                                        <label type="text" id="lbldocName">F2</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_DocumentF.Where(x => x.FormType == "F2").FirstOrDefault().CreatedBy</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_DocumentF.Where(x => x.FormType == "F2").FirstOrDefault().CreatedDate</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <a href="@Model.Data_DocumentF.Where(x => x.FormType == "F2").FirstOrDefault().FileName" target="_blank"><i class="fa fa-search fa-lg"></i></a>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                    <td class="text-center">

                                                                        <label type="text" id="lbldocName">F2</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                }
                                                                <td class="text-center">-</td>

                                                            </tr>
                                                            <tr>
                                                                @* value 3  *@

                                                                @if (Model.Data_DocumentF != null && Model.Data_DocumentF.Where(x => x.FormType == "F3").Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                    <td class="text-center">

                                                                        <label type="text" id="lbldocName">F3</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_DocumentF.Where(x => x.FormType == "F3").FirstOrDefault().CreatedBy</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_DocumentF.Where(x => x.FormType == "F3").FirstOrDefault().CreatedDate</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <a href="@Model.Data_DocumentF.Where(x => x.FormType == "F3").FirstOrDefault().FileName" target="_blank"><i class="fa fa-search fa-lg"></i></a>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                    <td class="text-center">

                                                                        <label type="text" id="lbldocName">F3</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                }
                                                                <td class="text-center">-</td>

                                                            </tr>
                                                            <tr>
                                                                @if (Model.Data_DocumentF != null && Model.Data_DocumentF.Where(x => x.FormType == "F5").Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                    <td class="text-center">

                                                                        <label type="text" id="lbldocName">F5</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_DocumentF.Where(x => x.FormType == "F5").FirstOrDefault().CreatedBy</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_DocumentF.Where(x => x.FormType == "F5").FirstOrDefault().CreatedDate</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <a href="@Model.Data_DocumentF.Where(x => x.FormType == "F5").FirstOrDefault().FileName" target="_blank"><i class="fa fa-search fa-lg"></i></a>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                    <td class="text-center">

                                                                        <label type="text" id="lbldocName">F5</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                }
                                                                <td class="text-center">-</td>
                                                            </tr>
                                                            <tr>
                                                                @if (Model.Data_DocumentF != null && Model.Data_DocumentF.Where(x => x.FormType == "F9").Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                    <td class="text-center">

                                                                        <label type="text" id="lbldocName">F9</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_DocumentF.Where(x => x.FormType == "F9").FirstOrDefault().CreatedBy</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_DocumentF.Where(x => x.FormType == "F9").FirstOrDefault().CreatedDate</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <a href="@Model.Data_DocumentF.Where(x => x.FormType == "F9").FirstOrDefault().FileName" target="_blank"><i class="fa fa-search fa-lg"></i></a>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                    <td class="text-center">

                                                                        <label type="text" id="lbldocName">F9</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                    <td class="text-center">
                                                                        -
                                                                    </td>
                                                                }
                                                                <td class="text-center">-</td>
                                                            </tr>
                                                            <tr>
                                                                @if (Model.Data_WorkSheetAttachment != null && Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 8).Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<p type="text">ใบประเมินงานซ่อม</p>*@
                                                                        <label type="text" id="lbldocName">ใบประเมินงานซ่อม</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 8).LastOrDefault().Attachment_Detail" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 8).LastOrDefault().Attachment_UpdateBy</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 8).LastOrDefault().Attachment_UpdateDate</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <i class="fa fa-search fa-lg viewFile"></i>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<p type="text">ใบประเมินงานซ่อม</p>*@
                                                                        <label type="text" id="lbldocName">ใบประเมินงานซ่อม</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-left">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<i class="fa fa-search fa-lg viewFile"></i>*@
                                                                    </td>
                                                                }
                                                                <td class="text-center">
                                                                    <input id="fileinput" name="file" type="file" class="file" data-preview-file-type="text">
                                                                    <input type="hidden" id="ReferenceType" value="@EnumConfiguration.enumAttachmentType.HCF.ToString()" />
                                                                    <input type="hidden" id="AttachmentTypeID" value="8" />
                                                                    @*<input type="hidden" id="AttachmentDetail" value="ใบ HCF1 พร้อมรายเซ็นลูกค้า" />*@

                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                        </div>

                                        <!-- /.box-body -->
                                    </div>
                                </div>
                            </div>








                            @*group 3*@
                            <div class="row" id="AttachMemo">
                                <div class="col-md-12 col-xs-12">
                                    <div class="box box-default">
                                        <div class="box-header with-border">
                                            <a data-toggle="collapse" data-target="#Worksheet-Attach-detail-Group3">
                                                <i class="fa fa-file"></i>
                                                <h3 class="box-title">Memo</h3>
                                            </a>
                                        </div>
                                        <!-- /.box-header -->
                                        <div class="box-body" id="Worksheet-Attach-detail-Group3" hidden>
                                            <div class="row">
                                                <div class="col-sm-12 col-lg-12">
                                                    <table class="table table-bordered table-hover" id="AddAttarchGroup3" style="margin: 8px 8px 0px 8px; width:auto;">
                                                        <thead>
                                                            <tr class="">
                                                                <th class="text-center">
                                                                    สถานะ
                                                                </th>
                                                                <th class="text-center col-sm-2">
                                                                    ประเภท
                                                                </th>
                                                                <th class="text-center">
                                                                    รายละเอียด
                                                                </th>
                                                                <th class="text-center">
                                                                    ผู้แนบ
                                                                </th>
                                                                <th class="text-center">
                                                                    วันที่แนบ
                                                                </th>
                                                                <th class="text-center">
                                                                    ดูไฟล์
                                                                </th>
                                                                <th class="text-center">
                                                                    แนบไฟล์
                                                                </th>
                                                            </tr>
                                                        </thead>

                                                        <tbody>
                                                            <tr>
                                                                @if (Model.Data_WorkSheetAttachment != null && Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 9).Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <label type="text" id="lbldocName">Memo ส่งของ</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 9).LastOrDefault().Attachment_Detail" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 9).LastOrDefault().Attachment_UpdateBy</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 9).LastOrDefault().Attachment_UpdateDate</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <i class="fa fa-search fa-lg viewFile"></i>
                                                                    </td>
 }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                    <td class="text-center">

                                                                        <label type="text" id="lbldocName">Memo ส่งของ</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-left">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<i class="fa fa-search fa-lg viewFile"></i>*@
                                                                    </td>
}
                                                                <td class="text-center">
                                                                    <input id="fileinput" name="file" type="file" class="file" data-preview-file-type="text">
                                                                    <input type="hidden" id="ReferenceType" value="@EnumConfiguration.enumAttachmentType.Memo.ToString()" />
                                                                    <input type="hidden" id="AttachmentTypeID" value="9" />
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                @if (Model.Data_WorkSheetAttachment != null && Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 10).Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<p type="text">Memo ไม่มีรูประหว่าง</p>*@
                                                                        <label type="text" id="lbldocName">Memo ไม่มีรูประหว่าง</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 10).LastOrDefault().Attachment_Detail" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 10).LastOrDefault().Attachment_UpdateBy</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 10).LastOrDefault().Attachment_UpdateDate</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <i class="fa fa-search fa-lg viewFile"></i>
                                                                    </td>
 }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<p type="text">Memo ไม่มีรูประหว่าง</p>*@
                                                                        <label type="text" id="lbldocName">Memo ไม่มีรูประหว่าง</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-left">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<i class="fa fa-search fa-lg viewFile"></i>*@
                                                                    </td>
}
                                                                <td class="text-center">
                                                                    <input id="fileinput" name="file" type="file" class="file" data-preview-file-type="text">
                                                                    <input type="hidden" id="ReferenceType" value="@EnumConfiguration.enumAttachmentType.Memo.ToString()" />
                                                                    <input type="hidden" id="AttachmentTypeID" value="10" />
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                @if (Model.Data_WorkSheetAttachment != null && Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 11).Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <label type="text" id="lbldocName">Memo พิจารณาพิเศษ</label>
                                                                        @*<p type="text">Memo พิจารณาพิเศษ</p>*@
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 11).LastOrDefault().Attachment_Detail" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 11).LastOrDefault().Attachment_UpdateBy</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 11).LastOrDefault().Attachment_UpdateDate</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <i class="fa fa-search fa-lg viewFile"></i>
                                                                    </td>
 }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <label type="text" id="lbldocName">Memo พิจารณาพิเศษ</label>
                                                                        @* <p type="text">Memo พิจารณาพิเศษ</p>*@
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-left">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<i class="fa fa-search fa-lg viewFile"></i>*@
                                                                    </td>
}
                                                                <td class="text-center">
                                                                    <input id="fileinput" name="file" type="file" class="file" data-preview-file-type="text">
                                                                    <input type="hidden" id="ReferenceType" value="@EnumConfiguration.enumAttachmentType.Memo.ToString()" />
                                                                    <input type="hidden" id="AttachmentTypeID" value="11" />
                                                                </td>
                                                            </tr>
                                                        </tbody>



                                                    </table>
                                                </div>
                                            </div>

                                        </div>


                                        <!-- /.box-body -->
                                    </div>
                                </div>
                            </div>
                            @*group4*@
                            <div class="row" id="AttachVendorDocuments">
                                <div class="col-md-12 col-xs-12">
                                    <div class="box box-default">
                                        <div class="box-header with-border">
                                            <a data-toggle="collapse" data-target="#Worksheet-Attach-detail-Group4">
                                                <i class="fa fa-file-text"></i>
                                                <label type="text" id="lbldocName">เอกสารผู้รับเหมา</label>
                                                @*<h3 class="box-title">เอกสารผู้รับเหมา</h3>*@
                                            </a>
                                        </div>
                                        <!-- /.box-header -->
                                        <div class="box-body" id="Worksheet-Attach-detail-Group4" hidden>
                                            <div class="row">
                                                <div class="col-sm-12 col-lg-12">
                                                    <table class="table table-bordered table-hover" id="AddAttarchGroup4" style="margin: 8px 8px 0px 8px; width:auto;">
                                                        <thead>
                                                            <tr class="">
                                                                <th class="text-center">
                                                                    สถานะ
                                                                </th>
                                                                <th class="text-center col-sm-2">
                                                                    ประเภท
                                                                </th>
                                                                <th class="text-center">
                                                                    รายละเอียด
                                                                </th>
                                                                <th class="text-center">
                                                                    ผู้แนบ
                                                                </th>
                                                                <th class="text-center">
                                                                    วันที่แนบ
                                                                </th>
                                                                <th class="text-center">
                                                                    ดูไฟล์
                                                                </th>
                                                                <th class="text-center">
                                                                    แนบไฟล์
                                                                </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                @if (Model.Data_WorkSheetAttachment != null && Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 12).Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                    <td class="text-center">

                                                                        <label type="text" id="lbldocName">ใบเสนอราคา</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 12).LastOrDefault().Attachment_Detail" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 12).LastOrDefault().Attachment_UpdateBy</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 12).LastOrDefault().Attachment_UpdateDate</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <i class="fa fa-search fa-lg viewFile"></i>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <label type="text" id="lbldocName">ใบเสนอราคา</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-left">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<i class="fa fa-search fa-lg viewFile"></i>*@
                                                                    </td>
                                                                }
                                                                <td class="text-center">
                                                                    <input id="fileinput" name="file" type="file" class="file" data-preview-file-type="text">
                                                                    <input type="hidden" id="ReferenceType" value="@EnumConfiguration.enumAttachmentType.Vendor.ToString()" />
                                                                    <input type="hidden" id="AttachmentTypeID" value="12" />
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                @if (Model.Data_WorkSheetAttachment != null && Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 13).Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<p type="text">ใบแจ้งหนี้</p>*@
                                                                        <label type="text" id="lbldocName">ใบแจ้งหนี้</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 13).LastOrDefault().Attachment_Detail" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 13).LastOrDefault().Attachment_UpdateBy</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 13).LastOrDefault().Attachment_UpdateDate</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <i class="fa fa-search fa-lg viewFile"></i>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <label type="text" id="lbldocName">ใบแจ้งหนี้</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-left">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<i class="fa fa-search fa-lg viewFile"></i>*@
                                                                    </td>
                                                                }
                                                                <td class="text-center">
                                                                    <input id="fileinput" name="file" type="file" class="file" data-preview-file-type="text">
                                                                    <input type="hidden" id="ReferenceType" value="@EnumConfiguration.enumAttachmentType.Vendor.ToString()" />
                                                                    <input type="hidden" id="AttachmentTypeID" value="13" />
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                @if (Model.Data_WorkSheetAttachment != null && Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 14).Count() > 0)
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-check-square-o" style="color:green;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<p type="text">ใบตรวจรับงานผู้รับเหมา</p>*@
                                                                        <label type="text" id="lbldocName">ใบตรวจรับงานผู้รับเหมา</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 14).LastOrDefault().Attachment_Detail" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 14).LastOrDefault().Attachment_UpdateBy</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">@Model.Data_WorkSheetAttachment.Where(x => x.Attachment_Type_ID == 14).LastOrDefault().Attachment_UpdateDate</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <i class="fa fa-search fa-lg viewFile"></i>
                                                                    </td>
                                                                }
                                                                else
                                                                {
                                                                    <td class="text-center">
                                                                        <span class="fa fa-times " style="color:red;"></span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <label type="text" id="lbldocName">ใบตรวจรับงานผู้รับเหมา</label>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="text" value="" id="AttachmentDetail" class="form-control">
                                                                    </td>
                                                                    <td class="text-left">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <p type="text">-</p>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        @*<i class="fa fa-search fa-lg viewFile"></i>*@
                                                                    </td>
                                                                }
                                                                <td class="text-center">
                                                                    <input id="fileinput" name="file" type="file" class="file" data-preview-file-type="text">
                                                                    <input type="hidden" id="ReferenceType" value="@EnumConfiguration.enumAttachmentType.Vendor.ToString()" />
                                                                    <input type="hidden" id="AttachmentTypeID" value="14" />
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                        </div>

                                        <!-- /.box-body -->
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- /.box-body -->
                    </div>

                </div>
            </div>

            @if (@EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
            {
                <div class="row">
                    <div class="text-center">
                        <button type="submit" class="btn btn-success" id="btnSaveWO">บันทึกข้อมูล</button>
                        @if (WorkSheetController.checkPermission("CancelWorksheet"))
                        {
                            <button class="btn btn-danger" id="btnCancelWorkSheet" onclick="openModalConfirmWithReason('หน้าต่างยืนยันการยกเลิกใบงาน', 'สาเหตุการยกเลิกใบงาน', 'cancelWorksheet', true)" style="margin-left: 10px">ยกเลิกใบงาน</button>}
                    </div>
                </div>}
        </div>


        <div>
            @Html.ActionLink("Back to List", "Index")
        </div>

        @*Modal กรอกราคา*@
        <div tabindex="-1" class="modal fade" id="VendorFixPriceModal" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
            <div class="modal-dialog" style="width:95%">
                <div class="modal-content" style="border-radius:6px;">
                    <div class="modal-header bg-light-blue">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">รายละเอียดราคางานซ่อม</h4>
                    </div>
                    <div class="modal-body">
                        <form class="widget-content">
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <label class="control-label ">โครงการ: </label><div class="text-primary"> @Model.Data_Unit.PJ_Name</div>

                                </div>

                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <label class="control-label ">แปลง: </label><div class="text-primary"> @Model.Data_Unit.Unit_Code_Address</div>

                                </div>
                            </div>
                        </form>
                        <form class="widget-content" id="addItemDetail">
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">หมวดงานที่ ผรม. ต้องซ่อม</label><span class="text text-red Bold"> * </span></h5>
                                    <select id="hclist1" name="hclist1" class="form-control"></select>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">รายละเอียดที่ซ่อม</label><span class="text text-red Bold"> * </span></h5>
                                    <select id="hclist2" name="hclist2" class="form-control"></select>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">ลักษณะปัญหา</label><span class="text text-red Bold"> * </span></h5>
                                    <select id="hclist3" name="hclist3" class="form-control"></select>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">วิธีการซ่อม</label><span class="text text-red Bold"> * </span></h5>
                                    <select id="hclist4" name="hclist4" class="form-control"></select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">ค่าวัสดุ (ราคากลาง) </label></h5>
                                    <div class="input-group" style="width:80%">
                                        <span class="input-group-addon">
                                            <input type="checkbox" name="chkVendorFixPrice_MainMateria" id="chkVendorFixPrice_MainMateria" class="vendorPrice">
                                        </span>
                                        <input type="number" class="form-control" name="txtVendorFixPrice_MainMateriaPrice" id="txtVendorFixPrice_MainMateriaPrice" value="0.00" readonly>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">ค่าแรง (ราคากลาง) </label></h5>
                                    <div class="input-group" style="width:80%">
                                        <span class="input-group-addon">
                                            <input type="checkbox" name="chkVendorFixPrice_MainWagePrice" id="chkVendorFixPrice_MainWagePrice" class="vendorPrice">
                                        </span>
                                        <input type="number" class="form-control" name="txtVendorFixPrice_MainWagePrice" id="txtVendorFixPrice_MainWagePrice" value="0.00" readonly>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">ค่าวัสดุ (ราคาพิเศษ) </label></h5>
                                    <div class="input-group" style="width:80%">
                                        <span class="input-group-addon">
                                            <input type="checkbox" name="chkVendor_SpecialMateria" id="chkVendor_SpecialMateria" class="vendorPrice">
                                        </span>
                                        <input type="number" class="form-control" name="txtVendor_SpecialMateriaPrice" id="txtVendor_SpecialMateriaPrice" value="0.00">
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">ค่าแรง (ราคาพิเศษ) </label></h5>
                                    <div class="input-group" style="width:80%">
                                        <span class="input-group-addon">
                                            <input type="checkbox" name="chkVendorFixPrice_SpecialWage" id="chkVendorFixPrice_SpecialWage" class="vendorPrice">
                                        </span>
                                        <input type="number" class="form-control" name="txtVendor_SpecialWagePrice" id="txtVendor_SpecialWagePrice" value="0.00">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">หน่วย </label></h5>
                                    <label class="text-primary" id="lblVendorFixPrice_Unit">-</label>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label" id="lblVendorFixPrice_Quantity">ปริมาณ </label><span class="text text-red Bold"> * </span></h5>
                                    <div class="">
                                        <input type="number" name="VendorFixPrice_Quantity" id="VendorFixPrice_Quantity" class="form-control text-center" style="width:100px" max="100" min="0">
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">ราคารวม </label></h5>
                                    <div class="text-primary"><label class="text-primary" id="lblVendorFixPrice_TotalPrice">0.00</label></div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">หมายเหตุ </label><span class="text text-red Bold"> * </span></h5>
                                    <div class="text-primary"><input type="text" name="txtVendorFixPrice_Remark" id="txtVendorFixPrice_Remark" class="form-control"></div>
                                </div>

                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-3 text-left">
                                    <br>
                                    @if (@EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
                                    {
                                        <button type="button" class="btn btn-primary" id="btnAddWOItem">เพิ่มรายการ</button>}
                                </div>
                            </div>
                        </form>
                        <form class="widget-content">
                            <div class="row">
                                <div class="col-lg-12" style="overflow:auto">
                                    <table class="table table-bordered table-hover" id="tbWorksheetitemDetail" style="margin: 8px 8px 0px 8px; width:auto">
                                        <thead>
                                            <tr class="">
                                                <th class="text-center">
                                                    No.
                                                </th>
                                                <th class="text-center">
                                                    หมวดงานที่ ผรม. ต้องซ่อม
                                                </th>
                                                <th class="text-center">
                                                    รายละเอียดที่ซ่อม
                                                </th>
                                                <th class="text-center">
                                                    ลักษณะปัญหา
                                                </th>
                                                <th class="text-center">
                                                    วิธีการซ่อม
                                                </th>
                                                <th class="text-center">
                                                    ค่าวัสดุ (ราคากลาง)
                                                </th>
                                                <th class="text-center">
                                                    ค่าแรง (ราคากลาง)
                                                </th>
                                                <th class="text-center">
                                                    ค่าวัสดุ (ราคาพิเศษ)
                                                </th>
                                                <th class="text-center">
                                                    ค่าแรง (ราคาพิเศษ)
                                                </th>
                                                <th class="text-center">
                                                    หน่วย
                                                </th>
                                                <th class="text-center">
                                                    ปริมาณ
                                                </th>
                                                <th class="text-center">
                                                    ราคารวม
                                                </th>
                                                <th class="text-center">
                                                    เหตุผลของราคาพิเศษ
                                                </th>
                                                <th class="text-center">
                                                    ลบ
                                                </th>

                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <label class="control-label ">รวมราคาตามรายการ: </label><span class="text-primary"> <label class="control-label" id="lbltotalPrice">0.00</label> </span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        @*Modal ดูประวัติการอนุมัติ*@
        <div tabindex="-1" class="modal fade" id="ApproveHistoryModal" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
            <div class="modal-dialog" style="width:60%">
                <div class="modal-content" style="border-radius:6px;">
                    <div class="modal-header bg-light-blue">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">ประวัติการอนุมัติ</h4>
                    </div>
                    <div class="modal-body text-center">
                        <form class="widget-content">
                            <div class="row">
                                <div class="col-lg-12" style="overflow:auto">


                                    <table class="table table-striped table-bordered table-hover " id="tbApproveHistory" style="margin: 8px 8px 0px 8px; width:100%">
                                        <thead>
                                            <tr class="">
                                                <th class="text-center">
                                                    No.
                                                </th>
                                                <th class="text-center">
                                                    สถานะการอนุมัติ
                                                </th>
                                                <th class="text-center">
                                                    ผู้อนุมัติ
                                                </th>
                                                <th class="text-center">
                                                    ความคิดเห็น
                                                </th>
                                                <th class="text-center">
                                                    วันที่อนุมัติ
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="text-center Bold text-danger" colspan="5">ไม่มีข้อมูล</td>
                                            </tr>

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <br>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        @*Modal ดูไฟล์ในส่วนแนบเอกสาร*@
        <div tabindex="-1" class="modal fade" id="modalViewFile" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;" data-backdrop="static">
            <div class="modal-dialog" style="width:90%">
                <div class="modal-content" style="border-radius:6px;">
                    <div class="modal-header badge-info">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title white"> <i class="fa fa-file-o bigger-130"></i> View Attach File</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-xs-12">
                                <label class="header smaller lighter blue" id="lblattrachgroupName"></label>
                                <div>
                                    <br />

                                </div>
                                <div class="text-left">
                                    <select class="image-picker show-labels" id="logo"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer text-center ">

                        <a class="btn btn-primary" id="btndownload"><i class="fa fa-cloud-download bigger-110"></i>Download</a>
                        <span id="spbtndeleted">
                            @if (@EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
                            {
                                <a class="btn btn-danger" id="btndeleted"><i class="fa fa-trash-o bigger-110"></i>Delete</a>}
                        </span>
                        <button class="btn btn-warning" data-dismiss="modal" type="button" id="btnmodalviewClose"><i class="fa fa-close bigger-110"></i>Close</button>

                    </div>
                </div>
            </div>
        </div>

        @*Modal ดูและอัพโหลดรูปภาพในแต่ละ Item*@
        <input type="hidden" id="hditemidUpload">
        <div tabindex="-1" class="modal fade" id="modaluploadPic" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;" data-backdrop="static">
            <div class="modal-dialog" style="width:95%">
                <div class="modal-content" style="border-radius:6px;">
                    <div class="modal-header badge-info">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title white"> <i class="fa fa-file-o bigger-130"></i> แนบรูปภาพก่อน,รูปภาพระหว่างซ่อม,รูปภาพหลังซ่อม </h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-xs-4">
                                <h5 class="text-bold text-primary">รูปภาพก่อน</h5>
                                <div>
                                    <br />
                                </div>
                                <div class="text-center">
                                    <input id="fileinput" name="file" type="file" class="file" data-preview-file-type="text" data-value="1" multiple>
                                </div>

                            </div>
                            <div class="col-xs-4">
                                <h5 class="text-bold text-primary">รูปภาพระหว่างซ่อม</h5>
                                <div>
                                    <br />
                                </div>
                                <div class="text-center">
                                    <input id="fileinput" name="file" type="file" class="file" data-preview-file-type="text" data-value="2" multiple>
                                </div>
                            </div>
                            <div class="col-xs-4">
                                <h5 class="text-bold text-primary">รูปภาพหลังซ่อม</h5>
                                <div>
                                    <br />
                                </div>
                                <div class="text-center">
                                    <input id="fileinput" name="file" type="file" class="file" data-preview-file-type="text" data-value="3" multiple>
                                </div>

                            </div>
                        </div>
                        <br />
                        <div class="row">
                            <div class="col-xs-12">
                                <div>
                                    <br />
                                </div>
                                <div class="text-left">
                                    <h5 class="page-header">รูปภาพก่อน</h5>
                                    <select class="image-picker show-labels" id="logoPic"></select>
                                    <span id="spbtnmodalDeletdBefore">
                                        @if (@EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
                                        {
                                            <a class="btn btn-danger" id="btnmodalDeletdBefore"><i class="fa fa-trash-o bigger-110"></i>Delete</a>}
                                    </span>
                                    <a class="btn btn-primary" id="btnmodalExportBefore"><i class="fa fa-cloud-download bigger-110"></i>Download</a>

                                </div>
                                <br />
                                <div class="text-left">
                                    <h5 class="page-header">รูปภาพระหว่างซ่อม</h5>
                                    <select class="image-picker show-labels" id="logoPic2"></select>
                                    <span id="spbtnmodalDeletdBetween">
                                        @if (@EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
                                        {
                                            <a class="btn btn-danger" id="btnmodalDeletdBetween"><i class="fa fa-trash-o bigger-110"></i>Delete</a>}
                                    </span>
                                    <a class="btn btn-primary" id="btnmodalExportBetween"><i class="fa fa-cloud-download bigger-110"></i>Download</a>
                                </div>
                                <br />
                                <div class="text-left">
                                    <h5 class="page-header">รูปภาพหลังซ่อม</h5>
                                    <select class="image-picker show-labels" id="logoPic3"></select>
                                    <span id="spbtnmodalDeletdPost">
                                        @if (@EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
                                        {
                                            <a class="btn btn-danger" id="btnmodalDeletdPost"><i class="fa fa-trash-o bigger-110"></i>Delete</a>}
                                    </span>
                                    <a class="btn btn-primary" id="btnmodalExportPost"><i class="fa fa-cloud-download bigger-110"></i>Download</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer text-center ">
                        <button class="btn btn-danger" data-dismiss="modal" type="button" id="btnmodalPicClose"><i class="fa fa-times bigger-110"></i>Close</button>
                    </div>
                </div>
            </div>
        </div>

        @*Modal Extended Appointment*@
        <div tabindex="-99999" class="modal fade" id="modalExtendedRepair" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
            <div class="modal-dialog" style="width:60%">
                <div class="modal-content" style="border-radius:6px;">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">เลื่อนวันที่นัดหมายซ่อม </h4>
                    </div>
                    <div class="modal-body text-center">
                        <div class="row">
                            <div class="col-xs-12">
                                <div class="row">
                                    <div class="col-xs-5  text-right">
                                        <h5><label class="control-label"> เลื่อนวันที่นัดหมายซ่อมเริ่ม (เดิม): </label></h5>
                                    </div>
                                    <div class="col-xs-3">
                                        <div class="bootstrap-datepicker">
                                            <div class="input-group">
                                                <div class="input-group-addon">
                                                    <i class="fa fa-calendar"></i>
                                                </div>
                                                <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  Appointment must be a date." id="RepairAppointmentFormDate"
                                                       name="RepairAppointmentFormDate" style="width:100%;" onkeypress="" disabled>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-1  text-right">
                                        <h5><label class="control-label"> ถึง: </label></h5>
                                    </div>
                                    <div class="col-xs-3">
                                        <div class="bootstrap-datepicker">
                                            <div class="input-group">
                                                <div class="input-group-addon">
                                                    <i class="fa fa-calendar"></i>
                                                </div>
                                                <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  Appointment must be a date." id="RepairAppointmentToDate"
                                                       name="RepairAppointmentToDate" style="width:100%;" onkeypress="" disabled>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <hr />
                            </div>
                            <div class="col-xs-12">
                                <div class="row">
                                    <div class="col-xs-5  text-right">
                                        <h5><label class="control-label"> เลื่อนวันที่นัดหมายซ่อมเริ่ม (ใหม่): </label></h5>
                                    </div>
                                    <div class="col-xs-3">
                                        <div class="bootstrap-datepicker">
                                            <div class="input-group">
                                                <div class="input-group-addon">
                                                    <i class="fa fa-calendar"></i>
                                                </div>
                                                <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  Appointment must be a date." id="ExtRepairAppointmentFormDate"
                                                       name="ExtRepairAppointmentFormDate" style="width:100%;" onkeypress="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-1  text-right">
                                        <h5><label class="control-label"> ถึง: </label></h5>
                                    </div>
                                    <div class="col-xs-3">
                                        <div class="bootstrap-datepicker">
                                            <div class="bootstrap-datepicker">
                                                <div class="input-group">
                                                    <div class="input-group-addon">
                                                        <i class="fa fa-calendar"></i>
                                                    </div>
                                                    <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  Appointment must be a date." id="ExtRepairAppointmentToDate"
                                                           name="ExtRepairAppointmentToDate" style="width:100%;" onkeypress="">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            @*<div class="col-xs-12">
                                    <div class="row">
                                        <div class="col-xs-5  text-right">
                                            <h5><label class="control-label"> เลื่อนวันที่นัดหมายซ่อมถึง: </label></h5>
                                        </div>
                                        <div class="col-xs-6">
                                            <div class="bootstrap-datepicker">
                                                <div class="input-group">
                                                    <div class="input-group-addon">
                                                        <i class="fa fa-calendar"></i>
                                                    </div>
                                                    <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  Appointment must be a date." id="ExtRepairAppointmentToDate"
                                                           name="ExtRepairAppointmentToDate" style="width:100%;" onkeypress="return false">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>*@
                            <div class="col-xs-12">
                                <div class="row">
                                    <div class="col-xs-5 text-right">
                                        <h5><label class="control-label"> สาเหตุเลื่อนนัดหมายฯ: </label></h5>
                                    </div>
                                    <div class="col-xs-6">
                                        <div class="bootstrap-timepicker">
                                            <div class="input-group">
                                                <select id="ddlExtendedReasonID" class="form-control">
                                                    <option value="">-- กรุณาเลือก --</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <div class="row">
                                    <br />
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <div class="row">
                                    <div class="col-xs-5 text-right">
                                        <h5><label class="control-label"> หมายเหตุ HC: </label></h5>
                                    </div>
                                    <div class="col-xs-6">
                                        <div class="bootstrap-timepicker">
                                            <div class="input-group">
                                                <textarea class="form-control" cols="30" rows="2" data-val="true" id="txtExtendRemark" name="txtExtendRemark" style="width:100%;" type="text" maxlength="512"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <div class="row">
                                    <br />
                                </div>
                            </div>
                            @if (@EnumConfiguration.Role.CallCentre.ToString() == @UserDetail.Role)
                            {
                                <div class="col-xs-12">
                                    <div class="row">
                                        <div class="col-xs-5 text-right">
                                            <h5><label class="control-label"> หมายเหตุ CC: </label></h5>
                                        </div>
                                        <div class="col-xs-6">
                                            <div class="bootstrap-timepicker">
                                                <div class="input-group">
                                                    <textarea class="form-control" cols="30" rows="2" data-val="true" id="txtExtendRemarkCC" name="txtExtendRemarkCC" style="width:100%;" type="text" maxlength="512"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xs-12">
                                    <div class="row">
                                        <div class="col-xs-5 text-right">
                                            <h5><label class="control-label"> ยืนยัน: </label></h5>
                                        </div>
                                        <div class="col-xs-6 text-left">

                                            <div class="form-check">
                                                <label class="radio-inline"><input type="radio" name="rdoConfirm" value="true" style="width:20px;height:20px">ยืนยัน</label>
                                                <label class="radio-inline"><input type="radio" name="rdoConfirm" value="false" style="width:20px;height:20px">ไม่ยืนยัน</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>}
                        </div>


                    </div>
                    <div class="modal-footer">
                        <div class="row">
                            <div class="col-lg-12 text-center">
                                <button type="button" class="btn btn-default" id="btnUpdateExtended"><i class="fa fa-floppy-o"> </i> บันทึก</button>
                                <button type="button" class="btn btn-default" id="btnCancelxtended" data-dismiss="modal"><i class="fa fa-remove"> </i> ยกเลิก</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        @*Modal Extended Appointment History*@
        <div tabindex="-1" class="modal fade" id="modalExtendedAppointmentHistory" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
            <div class="modal-dialog" style="width:70%">
                <div class="modal-content" style="border-radius:6px;">
                    <div class="modal-header bg-light-blue">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">ประวัติการขอเลื่อนนัด</h4>
                    </div>
                    <div class="modal-body text-center">
                        <form class="widget-content">
                            <div class="row">
                                <div class="col-lg-12" style="overflow:auto">


                                    <table class="table table-striped table-bordered table-hover " id="tbExtendedHistory" style="margin: 8px 8px 0px 8px; width:100%">
                                        <thead>
                                            <tr class="">
                                                <th class="text-center">
                                                    ลำดับ
                                                </th>
                                                <th class="text-center">
                                                    สถานะ
                                                </th>
                                                <th class="text-center">
                                                    ผู้ขอเลื่อน
                                                </th>
                                                <th class="text-center">
                                                    วันเดิม
                                                </th>
                                                <th class="text-center">
                                                    วันใหม่
                                                </th>
                                                <th class="text-center" width="200px">
                                                    สาเหตุ
                                                </th>
                                                <th class="text-center">
                                                    หมายเหตุ HC
                                                </th>
                                                <th class="text-center">
                                                    หมายเหตุ CC
                                                </th>
                                                <th class="text-center">
                                                    ผู้อนุมัติ CC
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="text-center Bold text-danger" colspan="9">ไม่มีข้อมูล</td>
                                            </tr>

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <br>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        @*Modal Extended Appointment RepairAfter For P'Prajak*@
        <div class="modal fade" id="modalExtendedRepairAfter" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
            <div class="modal-dialog" style="width:60%">
                <div class="modal-content" style="border-radius:6px;">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">ขยายกำหนดแล้วเสร็จของงานต่อเนื่อง</h4>
                    </div>
                    <div class="modal-body text-center">
                        <div class="row">
                            <div class="col-xs-12">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                        <h5><label class="control-label"> วันเริ่มซ่อมครั้งแรก: </label></h5>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-3">
                                        <div class="bootstrap-datepicker">
                                            <div class="input-group">
                                                <div class="input-group-addon">
                                                    <i class="fa fa-calendar"></i>
                                                </div>
                                                <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  StartDate must be a date." id="StartDateOld"
                                                       name="StartDateOld" style="width:100%;" onkeypress="" disabled>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                        <h5><label class="control-label"> กำหนดแล้วเสร็จ (เดิม): </label></h5>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-3">
                                        <div class="bootstrap-datepicker">
                                            <div class="input-group">
                                                <div class="input-group-addon">
                                                    <i class="fa fa-calendar"></i>
                                                </div>
                                                <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  Appointment must be a date." id="ExpectDateOld"
                                                       name="ExpectDateOld" style="width:100%;" onkeypress="" disabled>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <hr />
                            </div>

                            <div class="col-xs-12">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                        <h5><label class="control-label"> วันที่นัดซ่อม (เดิม): </label></h5>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-3">
                                        <div class="bootstrap-datepicker">
                                            <div class="input-group">
                                                <div class="input-group-addon">
                                                    <i class="fa fa-calendar"></i>
                                                </div>
                                                <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  Appointment must be a date." id="RepairAppointmentDateOld"
                                                       name="RepairAppointmentDateOld" style="width:100%;" onkeypress="">
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            <div class="col-xs-12">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                        <h5><label class="control-label"> วันที่นัดซ่อม (ใหม่): </label></h5>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-3">
                                        <div class="bootstrap-datepicker">
                                            <div class="bootstrap-datepicker">
                                                <div class="input-group">
                                                    <div class="input-group-addon">
                                                        <i class="fa fa-calendar"></i>
                                                    </div>
                                                    <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  Appointment must be a date." id="RepairAppointmentDateNew"
                                                           name="RepairAppointmentDateNew" style="width:100%;" onkeypress="">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                        <h5><label class="control-label"> กำหนดแล้วเสร็จ (ใหม่): </label></h5>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-3">
                                        <div class="bootstrap-datepicker">
                                            <div class="bootstrap-datepicker">
                                                <div class="input-group">
                                                    <div class="input-group-addon">
                                                        <i class="fa fa-calendar"></i>
                                                    </div>
                                                    <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  ExpectDate must be a date." id="ExpectDateNew"
                                                           name="ExpectDateNew" style="width:100%;" onkeypress="" disabled>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                        <h5><label class="control-label"> สาเหตุการ: </label></h5>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-3">
                                        <select id="ddlExtendedRepairAfterReasonID" class="form-control">
                                            <option value="">-- กรุณาเลือก --</option>
                                        </select>
                                    </div>
                                    <div id="PostponePart">
                                        <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                            <h5><label class="control-label"> เข้าซ่อมครั้งที่: </label></h5>
                                        </div>
                                        <div class="col-xs-12 col-sm-6 col-lg-3">
                                            <select id="ddlExtendedRepairAfterTimesID" class="form-control text-center">
                                                <option value="" class="text-center">-- กรุณาเลือก --</option>
                                                <option value="2" class="text-center">-- 2 --</option>
                                                <option value="3" class="text-center">-- 3 --</option>
                                                <option value="4" class="text-center">-- 4 --</option>
                                                <option value="5" class="text-center">-- 5 --</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <div class="row">
                                    <br />
                                </div>
                            </div>

                            <div class="col-xs-12">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                        <h5><label class="control-label"> หมายเหตุ: </label></h5>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-3">
                                        <textarea class="form-control" cols="30" rows="2" data-val="true" id="txtExtendedRepairAfterRemark" name="txtExtendedRepairAfterRemark" style="width:100%;" type="text" maxlength="512"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <div class="row">
                                    <br />
                                </div>
                            </div>

                            <div class="col-xs-12">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-6 col-lg-2 text-right">
                                        <h5><label class="control-label"> ผู้ขอขยายฯ: </label></h5>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <select class="col-lg-12 form-control select2" id="ddlUserRequestID" data-placeholder="Choose User Request...">
                                            <option selected>-- กรุณาเลือก --</option>
                                        </select>
                                    </div>


                                    <div class="col-xs-12 col-sm-6 col-lg-2 text-right">
                                        <h5><label class="control-label"> ผู้อนุมัติ: </label></h5>
                                    </div>
                                    <div class="col-xs-12 col-sm-6 col-lg-4">
                                        <select class="col-lg-12 form-control select2" id="ddlUserApproveID" data-placeholder="Choose User Approve...">
                                            <option selected>-- กรุณาเลือก --</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <div class="row">
                                    <br />
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <div class="row">
                                    <br />
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <div class="row">
                                    <br />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="row">
                            <div class="col-lg-12 text-center">
                                <button type="button" class="btn btn-default" id="btnUpdateExtendedRepairAfter"><i class="fa fa-floppy-o"> </i> บันทึก</button>
                                <button type="button" class="btn btn-default" id="btnCancelExtendedRepairAfter" data-dismiss="modal"><i class="fa fa-remove"> </i> ยกเลิก</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    @*-----------------ModalQuestionnaire--------------*@
    <div class="modal fade" id="modalQuestionnaire" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="width:60%; min-width: 450px">
            <div class="modal-content" style="border-radius:6px;">
                <div class="modal-header bg-light-blue">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">แบบสอบถามประเมินความพึงพอใจคุณภาพงานซ่อมและการให้บริการ</h4>
                </div>
                <div class="modal-body text-center" id="contentQuestionnaire">


                </div>
                <div class="modal-footer">
                    <div class="row">
                        <div class="col-lg-12 text-center">
                            <button type="button" class="btn btn-default" id="btnSaveQuestionnaire" onclick="saveQuestionnaire()"><i class="fa fa-floppy-o"> </i> บันทึก</button>
                            <button type="button" class="btn btn-default" id="btnCancelQuestionnaire" data-dismiss="modal"><i class="fa fa-remove"> </i> ยกเลิก</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="confirmQuestionnaire" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-center" style="width:40%; min-width: 450px">
            <div class="modal-content" style="border-radius:6px;">
                <div class="modal-header bg-light-blue">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">แจ้งเตือน</h4>
                </div>
                <div class="modal-body text-center">
                    <h4 id="contentConfirmQuestionnaire"></h4>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <div class="col-lg-12 text-center">
                            <button type="button" class="btn btn-default" data-dismiss="modal"> ตกลง</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @* Modal Confirm With Reason *@
    <div tabindex="-1" class="modal fade" id="modalConfirmWithReason" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
        <div class="modal-dialog modal-dialog-centered" style="margin-top: 25vh">
            <div class="modal-content" style="border-radius: 6px;">
                <div class="modal-header bg-light-blue" style="border-top-left-radius: 3px;border-top-right-radius: 3px;">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="confirmTitle"></h4>
                </div>
                <div class="modal-body " style="padding-bottom: 0">
                    <div class="row form-group">
                        <div style="margin: 0 5%">
                            <label id="confirmTxtReason"></label><label style="color: crimson" id="confirmStarReason">*</label>
                            <input class="form-control" type="text" value="" id="confirmReason" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background-color:whitesmoke; text-align:center; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; padding: 10px">
                    <button type="button" class="btn btn-success" id="confirmBtn" onclick="" style="margin-right: 5px">ยืนยัน</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalInsertRoleSuccess" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <!-- Change class .modal-sm to change the size of the modal -->
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header bg-green" id="headerModal">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title white"><label id="titleModal">ข้อความ</label></h4>
                </div>
                <div class="modal-body text-center">
                    <img src="~/images/success.png" height="100" width="100" id="alertPic" />
                    <div>
                        <label id="lbTxtSuccess" class="green">ระบบบันทึกข้อมูลสำเร็จ</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button data-dismiss="modal" class="btn btn-success" type="button" name="closeModal" id="closeAlert" onclick="">ปิด</button>
                </div>




            </div>
        </div>
    </div>
    <div tabindex="-1" class="modal fade" id="modalAlertLineApprove" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
        <div class="modal-dialog modal-dialog-centered" style="margin-top: 25vh">
            <div class="modal-content" style="border-radius: 6px;">
                <div class="modal-header bg-light-blue" style="border-top-left-radius: 3px;border-top-right-radius: 3px;">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="confirmTitleProjectApprove"></h4>
                </div>
                <div class="modal-body " style="padding-bottom: 0">
                    <label>ไม่สามารถทำการแก้ไขข้อมูลได้ เนื่องจากยังไม่ได้ทำการ Set Workflow กรุณาติดต่อ Admin HC</label>
                </div>
                <div class="modal-footer" style="background-color:whitesmoke; text-align:center; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; padding: 10px">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <div tabindex="-1" class="modal fade" id="modalAlertUserApprove" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
        <div class="modal-dialog modal-dialog-centered" style="margin-top: 25vh">
            <div class="modal-content" style="border-radius: 6px;">
                <div class="modal-header bg-light-blue" style="border-top-left-radius: 3px;border-top-right-radius: 3px;">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">รออนุมัติยกเลิกเอกสาร</h4>
                </div>
                <div class="modal-body " style="padding-bottom: 0">
                    <label id="lbAlertUserApprove"></label>
                </div>
                <div class="modal-footer" style="background-color:whitesmoke; text-align:center; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; padding: 10px">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <div tabindex="-1" class="modal fade" id="modalRequestCancelF" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
        <div class="modal-dialog modal-dialog-centered" style="margin-top: 25vh">
            <div class="modal-content" style="border-radius: 6px;">
                <div class="modal-header bg-light-blue" style="border-top-left-radius: 3px;border-top-right-radius: 3px;">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">กรุณาระบุเหตุผลการยกเลิกเอกสาร</h4>
                    <label id="lbType"></label>
                </div>
                <div class="modal-body " style="padding-bottom: 0">
                    <div class="row form-group">
                        <div style="margin: 0 5%">
                            <label id="confirmTxtReason"></label><label style="color: crimson">*หมายเหตุการขอยกเลิกเอกสาร</label>
                            <input class="form-control" type="text" value="" id="confirmReasonF" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background-color:whitesmoke; text-align:center; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; padding: 10px">
                    <button type="button" class="btn btn-success" id="confirmBtnCencelF" onclick="" style="margin-right: 5px">ยืนยัน</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>



@* Modal Alert Siri Piority *@
@{Html.RenderPartial("_DisplaySiriPiority");}

<script type="text/javascript">

    let baseUrl = '@System.Configuration.ConfigurationManager.AppSettings["Construction_API"]';
    let confirmRetention = false;
    let table, tablePORetention, tableWorksheetRetention;
    let vendorPOListResult = [];
    let vendorPOList = [];
    let selectVendorPOList = [];
    var valid = true;
    let addVendorRetFlag = false;
    let sumAllRetention = 0;
    let opDetail = [];
    var myRows_old = [];
    var empApproveEditData = null;
    var request_token = null;
    function removeZeroPrefix(str){
        for(var i = 0 ; i < 4 ; i++){
            if(str.substring(0, 1) === '0'){
                str = str.substring(1);
            }
            else {
                break;
            }
        }
        return str;
    }
    function onvalidateEndFix(e)
    {
        var itemID = e.val();
        var txt=e.closest('tr').find("#EndFixDate");
        //console.log(txt);

        $.ajax({
            url: '@Url.Action("checkEndFix", "Worksheet")',
            type: "POST",
            data: '{"Reference_ID": ' + $("#hdWorksheetID").val() + ',"Reference_Item_ID": ' + itemID + '}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {

            },
            success: function (response) {
                //console.log(response);
                if (response != "") {
                    txt.val("");
                    e.prop("checked",false);
                    modalWaring(response);

                } else {
                    var date = new Date();
                    var today = date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear();

                    if (txt.val()=="") {
                        //alert(today);
                        txt.val(today);
                    }
                    else {
                        txt.val("");
                    }
                }
            },
        });
    }

    function parseDate(str) {
        var mdy = str.split('/');
        return new Date(mdy[2], mdy[1]-1, mdy[0]);
    }

    function datediff(first, second) {
        // Take the difference between the dates and divide by milliseconds per day.
        // Round to nearest whole number to deal with DST.
        return Math.round((second-first)/(1000*60*60*24));
    }

    function bindingApproveitemDetail() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '@Url.Action("getApproveitemDetail", "Worksheet")',
                type: 'POST',
                data: '{"WorksheetID": ' + $("#hdWorksheetID").val() + '}',
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    $("#tbApproveitemDetail tbody tr").remove();

                    if (data.length == 0) {
                        $("#tbApproveitemDetail tbody").append("<tr></tr>");
                        $("#tbApproveitemDetail tbody tr:last").append("<td class='text-center Bold text-danger' colspan='12'>ไม่มีข้อมูล</td>");

                    } else {

                        $.each(data, function (key, value) {

                            $("#tbApproveitemDetail tbody").append("<tr></tr>");
                            $("#tbApproveitemDetail tbody tr:last").append("<td class='text-center'><label id='lblNo' name='No'>" + (key + 1) + "</label></td>");
                            $("#tbApproveitemDetail tbody tr:last").append("<td class='text-left'>" + value.AppvItem_List1Name + "</td>");
                            $("#tbApproveitemDetail tbody tr:last").append("<td class='text-left'>" + value.AppvItem_List2Name + "</td>");
                            $("#tbApproveitemDetail tbody tr:last").append("<td class='text-left'>" + value.AppvItem_List3Name + "</td>");
                            $("#tbApproveitemDetail tbody tr:last").append("<td class='text-left'>" + value.AppvItem_List4Name + "</td>");

                            $("#tbApproveitemDetail tbody tr:last").append("<td class='text-right'>" + value.AppvItem_StandardPrice.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + "</td>");
                            $("#tbApproveitemDetail tbody tr:last").append("<td class='text-right'>" + value.AppvItem_SpecialPrice.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + "</td>");


                            $("#tbApproveitemDetail tbody tr:last").append("<td class='text-right'>" + value.AppvItem_Quantity + "</td>");
                            $("#tbApproveitemDetail tbody tr:last").append("<td class='text-left'>" + value.AppvItem_Unit + "</td>");
                            let AppvItem_Price = value.AppvItem_Price === null ? 0 : value.AppvItem_Price;
                            $("#tbApproveitemDetail tbody tr:last").append("<td class='text-right'>" + AppvItem_Price.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") + "</td>");
                            $("#tbApproveitemDetail tbody tr:last").append("<td class='text-left'>" + value.AppvItem_Remark + "</td>");

                        });
                        //  resolve(true);
                    }
                    resolve(true);

                },
                error: function (err) {
                    reject(err);
                },
            });
        });


    }
    $(".DisplaySiriPiority").on('click', function () {
        $('#modalDisplaySiriPiority').modal('show');
    });
    function initControl() {
        $("#hclist1").empty();
        ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/getHCList1?unitID=${$('#hdUnitID').val()}`, response => {
            if (response) {
                $("#hclist1").append('<option value="">กรุณาเลือกข้อมูล</option>');
                $.each(response.data, function (index, obj) {
                    $("#hclist1").append('<option value=' + obj.id + '>' + obj.description + '</option>');
                });

                $("#hclist2").append('<option value="">กรุณาเลือกข้อมูล</option>');
                $("#hclist3").append('<option value="">กรุณาเลือกข้อมูล</option>');
                $("#hclist4").append('<option value="">กรุณาเลือกข้อมูล</option>');

            }

        });

        $("#chkVendor_SpecialMateria").prop('checked', false);
        $("#chkVendorFixPrice_SpecialWage").prop('checked', false);
        $("#chkVendorFixPrice_MainMateria").prop('checked', false);
        $("#chkVendorFixPrice_MainWagePrice").prop('checked', false);

    }

    function getExtendReason()
    {
        //ReasonType = 2 Extend Repair
        var requestData = {
            ReasonType:2
        }
        var Url = '@Url.Action("getExtendReason", "Master")';
        var response = CallController_Ajax(requestData,Url);

        $.each(response, function (key, value) {
            $('#ddlExtendedReasonID').append($("<option></option>").val(value.ExtendReasonID).html(value.Reason));
        });
    }
    function getExtendedRepairAfterReason()
    {
        //ReasonType = 3 Extend Repair After
        var requestData = {
            ReasonType:3
        }
        var Url = '@Url.Action("getExtendReason", "Master")';
        var response = CallController_Ajax(requestData,Url);

        $.each(response, function (key, value) {
            $('#ddlExtendedRepairAfterReasonID').append($("<option></option>").val(value.ExtendReasonID).html(value.Reason));
        });
    }
    function getUser()
    {
        var requestData = {}
        var Url = '@Url.Action("getUser", "Master")';
        var response = CallController_Ajax(requestData,Url);

        $.each(response, function (key, value) {
            $('#ddlUserRequestID').append($("<option></option>").val(value.Value).html(value.Text));
            $('#ddlUserApproveID').append($("<option></option>").val(value.Value).html(value.Text));
        });

    }

    // get EvaluationDetail และ get DDLNoReason Data
    var EvaluationDetail = {};
    var EvaluationReason = {};
    $(async function () {
        getToken().then(token => {
            var body = {
                "TokenCode": token.response,
                "WorksheetID": @Model.Data_WorkSheet.WorkSheet_ID,
            }
            var bodyM = {
                "Typename": "HC_CC_Contact_Reason",
                "TokenCode": token.response
            }
            $.ajax({
                url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Master/GetMasterData',
                type: 'POST',
                contentType: "application/json",
                data: JSON.stringify(bodyM),
                cache: false
            }).done(data => {
                EvaluationReason = data.response;
                var request = $.ajax({
                    url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/GetEvaluationDetail',
                    type: 'POST',
                    data: JSON.stringify(body),
                    async: true,
                    crossDomain: true,
                    headers: {
                        "Content-Type": "application/json",
                        "Cache-Control": "no-cache",
                    }
                });
                request.done(data => {
                    //  console.log(data);
                    EvaluationDetail = data.response;
                    if (EvaluationDetail !== null) {
                        $.each(EvaluationReason, (i, d) => {
                            if (EvaluationDetail.evaluate_cc_reasonID == d.ValueID) {
                                $('#displayReason').text('*' + d.DescriptionTH);
                                $('#displayReason').show();
                                return false;
                            }
                        })
                    }
                })
            });
        })
    })

    var questionnaireData
    var rowCoutQuestionnaire = 0;
    //-----เปิด modal แบบประเมิน
    function openModalQuestionnaire() {
        $("#modalQuestionnaire").modal('show')
        var request = $.ajax({
            url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/login/getTokenCode',
            type: 'GET',
            contentType: "application/json; charset=utf-8"
        });
        request.done(function (data) {
            var body = {
                "WorksheetID": @Model.Data_WorkSheet.WorkSheet_ID,
                "TokenCode": data.response
            }
            var bodyM = {
                "Typename": "HC_CC_Contact_Reason",
                "TokenCode": data.response
            }
            $.ajax({
                url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/GetQuestionnaire',
                type: 'POST',
                data: JSON.stringify(body),
                async: true,
                crossDomain: true,
                headers: {
                    "Content-Type": "application/json",
                    "Cache-Control": "no-cache",
                }
            }).done(function (data) {
                questionnaireData = data;
                //console.log(data);
                $('#contentQuestionnaire').empty();
                var tempdiv = '';
                tempdiv =	`<div class="row" id="rowReason">
								<div class="col-sm-12 col-xs-12" style="padding-left: 30px; text-align: left;">
									<div style="display: inline-flex; width: auto">
										<div class="form-check float-left" style="margin-right: 10px; padding-top: 5px; min-width: 130px;">
											<input class="form-check-input" type="checkbox" id="CBNoComment" onclick="NoCommentEffect();" />
											<label class="form-check-label" for="CBNoComment">
												ไม่สะดวกประเมิน
											</label>
										</div>
										<select id="DDLNoCommentReason" class="form-control" style="min-width: 250px; display: none;">
										</select>
									</div>
								</div>
								<hr style="margin-top: 15px; margin-bottom: 15px; width: 95%" />
							</div>`

                $('#contentQuestionnaire').append(tempdiv);
                if (data.response.Completed) {
                    $('#modalQuestionnaire').find('#btnSaveQuestionnaire').attr('disabled', '');
                    $('#rowReason').hide();
                }
                if (EvaluationDetail.evaluate_cc_contact) {
                    $('#DDLNoCommentReason').show();
                    $('#CBNoComment').attr('checked', 'true');
                }
                $.ajax({
                    url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Master/GetMasterData',
                    type: 'POST',
                    contentType: "application/json",
                    data: JSON.stringify(bodyM),
                    cache: false
                }).done(data => {
                    $('#DDLNoCommentReason').empty();
                    if (!EvaluationDetail.evaluate_cc_contact) {
                        $('#DDLNoCommentReason').append(
							'<option selected disabled value="0">---กรุณาระบุเหตุผล---</option>'
						);
                    }
                    else {
                        $('#DDLNoCommentReason').append(
							'<option disabled value="0">---กรุณาระบุเหตุผล---</option>'
						);
                    }
                    $.each(data.response, (i, d) => {
                        if (EvaluationDetail.evaluate_cc_contact && d.ValueID == EvaluationDetail.evaluate_cc_reasonID) {
                            $('#DDLNoCommentReason').append(
								`<option value="${d.ValueID}" selected>${d.DescriptionTH}</option>`
							);
                        }
                        else {
                            $('#DDLNoCommentReason').append(
								`<option value="${d.ValueID}">${d.DescriptionTH}</option>`
							);
                        }
                    })
                })
                $.each(data.response.Evaluation_Item, (index, question) => {
                    drawContentQuestionnaire(index, question, data.response.Completed);
                    rowCoutQuestionnaire++;
                })
            });
        })
    }
    function NoCommentEffect() {
        if ($('#CBNoComment').prop('checked')) {
            $('#DDLNoCommentReason').show();
            for (var i = 0; i < rowCoutQuestionnaire; i++) {
                $('#row' + i).children().toggleClass('slider');
            }
        }
        else {
            $('#DDLNoCommentReason').hide();
            for (var i = 0; i < rowCoutQuestionnaire; i++) {
                $('#row' + i).children().toggleClass('slider');
            }
        }
    }

    function drawContentQuestionnaire(index, question, Completed) {
        $('#contentQuestionnaire').append(`
			<div class="row justify-content-around" id="row${index}">
                <div class="col-xs center-block" style="float:none;align-items:center;">
                    <div class="card myCard" style="margin:5px auto">
                        <div class="container container-fluid" style="max-width:95%;">
							<label>
								${question.QN_ItemText}
							</label>
                            <div class="table-responsive">
							    <table class="table" style="margin-bottom:0px" >
								    <tr>
									    ${darwScorecontent(question)}
								    </tr>
							    </table>
                            </div>
						</div>
                    </div>
                </div>
			</div>
		`)
        if (EvaluationDetail.evaluate_cc_contact) {
            $('#row' + index).children().toggleClass('slider');
        }
        if (Completed) {
            $('#contentQuestionnaire').find('input,textarea').attr('disabled', '');
        }
    }
    function darwScorecontent(question) {
        var str = '<tr></tr>';
        if (question.Type === 'SCORE')
            for (var i = 1; i <= question.MaxScore + 1; i++) {
                if (question.Value === i) {
                    str += '<td><input type="radio" id="mark' + question.QN_ItemID + i + '" name="mark' + question.QN_ItemID + '" value="' + i + '" checked/> <label for="mark' + question.QN_ItemID + i + '">' + i + 'คะแนน</label> </td>';
                }
                else if (question.Value === 0 && i === question.MaxScore + 1) {
                    str += '<td><input type="radio" id="mark' + question.QN_ItemID + i + '" name="mark' + question.QN_ItemID + '" value="0" checked/> <label for="mark' + question.QN_ItemID + i + '">' + 'ไม่สะดวกประเมิน' + '</label> </td>';
                }
                else if (i === question.MaxScore + 1) {
                    str += '<td><input type="radio" id="mark' + question.QN_ItemID + i + '" name="mark' + question.QN_ItemID + '" value="0" /> <label for="mark' + question.QN_ItemID + i + '">' + 'ไม่สะดวกประเมิน' + '</label> </td>';
                }
                else {
                    str += '<td><input type="radio" id="mark' + question.QN_ItemID + i + '" name="mark' + question.QN_ItemID + '" value="' + i + '" /> <label for="mark' + question.QN_ItemID + i + '">' + i + 'คะแนน</label> </td>';
                }
            }
        else if (question.Type === 'REMARK') {
            if (question.Remark) {
                str += '<td><textarea id="mark' + question.QN_ItemID + '" rows="3" style="width: 100%">' + question.Remark + '</textarea></td>'
            }
            else {
                str += '<td><textarea id="mark' + question.QN_ItemID + '" rows="3" style="width: 100%"></textarea></td>'
            }
        }
        return str
    }

    function saveQuestionnaire() {
        var request = $.ajax({
            url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/login/getTokenCode',
            type: 'GET',
            contentType: "application/json; charset=utf-8"
        });
        request.done(function (Token) {
            var name = "@UserDetail.Fullname"
            var token = Token.response;
            var body = {}
            if ($('#CBNoComment').prop('checked')) {
                if ($('#DDLNoCommentReason option:selected').val() === '0') {
                    alert('กรุณาระบุเหตุผลไม่สะดวกประเมิน');
                    $('#DDLNoCommentReason').focus();
                    return;
                }
                else {
                    body = {
                        "WorksheetID": @Model.Data_WorkSheet.WorkSheet_ID,
                        "Channel": "2",
                        "ReasonID": $("#DDLNoCommentReason option:selected").val(),
                        "Evaluate_CC_Contact": true,
                        "CreatedBy": name,
                        "TokenCode": token
                    }
                    var request = $.ajax({
                        url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/UpdateCCEvaluation',
                        type: 'POST',
                        data: JSON.stringify(body),
                        async: true,
                        crossDomain: true,
                        headers: {
                            "Content-Type": "application/json",
                            "Cache-Control": "no-cache",
                        }
                    });
                    request.done(function (data) {
                        var bodyget = {
                            "TokenCode": token ,
                            "WorksheetID": @Model.Data_WorkSheet.WorkSheet_ID,
                        }
                        var request = $.ajax({
                            url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/GetEvaluationDetail',
                            type: 'POST',
                            data: JSON.stringify(bodyget),
                            async: true,
                            crossDomain: true,
                            headers: {
                                "Content-Type": "application/json",
                                "Cache-Control": "no-cache",
                            }
                        });
                        request.done(data => {
                            EvaluationDetail = data.response;
                            $.each(EvaluationReason, (i, d) => {
                                if (EvaluationDetail.evaluate_cc_reasonID == d.ValueID) {
                                    $('#displayReason').text('*' + d.DescriptionTH);
                                    $('#displayReason').show();
                                    return false;
                                }
                            })
                        });
                        openConfirmModal('บันทึกข้อมูลสำเร็จ');
                        $('#modalQuestionnaire').modal('hide');
                    })
                    request.fail(function (data) {
                        openConfirmModal('เกิดข้อผิดพลาด กรุณาตรวจสอบความถูกต้องและลองใหม่อีกครั้ง');
                    })
                }
            }
            else {
                body = {
                    WorkSheetID: @Model.Data_WorkSheet.WorkSheet_ID,
                    QN_HeaderID: questionnaireData.response.QN_HeaderID,
                    QuestionnaireItem: [],
                    CreatedBy: name,
                    TokenCode: token,
                    Channel: 2
                }
                let quit = false;
                $.each(questionnaireData.response.Evaluation_Item, function (index, data) {
                    if (data.Type === "SCORE") {
                        var question
                        for (var i = 1; i <= data.MaxScore + 1; i++) {

                            if ($('#mark' + data.QN_ItemID + i).prop("checked")) {
                                if (i === data.MaxScore + 1) {
                                    question = {
                                        QN_ItemID: data.QN_ItemID,
                                        Value: 0
                                    }
                                }
                                else {
                                    question = {
                                        QN_ItemID: data.QN_ItemID,
                                        Value: i
                                    }
                                }
                                break;
                            }
                        }
                        if (!question) {
                            modalWaring('กรุณาประเมิณรายการให้ครบถ้วนก่อนทำการบันทึก');
                            quit = true;
                            return false;
                        }
                    }
                    else if (data.Type === "REMARK") {
                        var remark = $('#mark' + data.QN_ItemID).val() || null;
                        var question = {
                            QN_ItemID: data.QN_ItemID,
                            Remark: remark
                        }
                    }
                    body.QuestionnaireItem.push(question);

                });
                if (quit) { return false; }
                var request = $.ajax({
                    url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/UpdateCCEvaluation',
                    type: 'POST',
                    data: JSON.stringify(body),
                    async: true,
                    crossDomain: true,
                    headers: {
                        "Content-Type": "application/json",
                        "Cache-Control": "no-cache",
                    }
                });
                request.done(function (data) {
                    var bodyget = {
                        "TokenCode": token ,
                        "WorksheetID": @Model.Data_WorkSheet.WorkSheet_ID,
                    }
                    var request = $.ajax({
                        url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/GetEvaluationDetail',
                        type: 'POST',
                        data: JSON.stringify(bodyget),
                        async: true,
                        crossDomain: true,
                        headers: {
                            "Content-Type": "application/json",
                            "Cache-Control": "no-cache",
                        }
                    });
                    request.done(data => {
                        EvaluationDetail = data.response;
                    });
                })
                request.fail(function (data) {
                    openConfirmModal('เกิดข้อผิดพลาด กรุณาตรวจสอบความถูกต้องและลองใหม่อีกครั้ง');
                })
                var request = $.ajax({
                    url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/InsertQuestionnaire',
                    type: 'POST',
                    data: JSON.stringify(body),
                    async: true,
                    crossDomain: true,
                    headers: {
                        "Content-Type": "application/json",
                        "Cache-Control": "no-cache",
                    }
                });
                request.done(function (data) {
                    if (body.QuestionnaireItem.length !== questionnaireData.response.Evaluation_Item.length) { return false }
                    $('#displayReason').text('');
                    $('#displayReason').hide();
                    openConfirmModal('บันทึกข้อมูลสำเร็จ');
                    $('#modalQuestionnaire').modal('hide');
                })
                request.fail(function (data) {
                    if (body.QuestionnaireItem.length !== questionnaireData.response.Evaluation_Item.length) { return false }
                    openConfirmModal('เกิดข้อผิดพลาด กรุณาตรวจสอบความถูกต้องและลองใหม่อีกครั้ง');
                })
            }
        });
    }
    function openConfirmModal(message) {
        $('#confirmQuestionnaire').modal('show');
        $('#contentConfirmQuestionnaire').text(message);
    }

    $(document).ready(async function () {

        await page.loading();
        initControl();
        await bindingApproveDetail();
        await bindingApproveitemDetail();
        validationworkOrderOnload();
        await getExtendReason();
        await getExtendedRepairAfterReason();
        await getUser();
        await UpdateRetentionStatus();
        await GetWorkSheetPODetail();
         request_token = $.ajax({
            url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/login/getTokenCode',
            type: 'GET',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    $.ajaxSetup({
                        headers: {
                            'Authorization': "Bearer " + data.response
                        }
                    });

                }
            });
        GetDocumentTypeList();
        GetCompanyList();
        $('.datepicker').datepicker({
            autoclose: true,
            format: 'dd/mm/yyyy'
        });

        page.loaded();
        // Search vendor by press enter
        $('#vendorCode').keyup(function (e) {
            if (e.keyCode == 13) {
                SearchVendorRetention();
            }
        });
        $('#vendorName').keyup(function (e) {
            if (e.keyCode == 13) {
                SearchVendorRetention();
            }
        });

        $('#tab-listRetention').hide();
        $('#tab-searchPO').click(function () {
            vendorPOList = [];
        });

        $('input[type=radio][name=AprrovedType]').change(async function () {
            var approveType = this.value;
            var warrantyExpired = $("#hdWarrantyExpired").val();
            await bindingPaymentType(approveType, warrantyExpired);
        });

        //หากเลือกดำเนินการถึงจะเปิดปุ่มให้กรอกราคา
        $('.ReceivedDetailItemsStatus').change(function (e) {
            var viewFixPrice = $(this).closest('tr').find("#viewFixPrice");
            if($(this).val()!=2)
            {
                viewFixPrice.attr("hidden","hidden");
            }
            else
            {
                viewFixPrice.removeAttr("hidden");
            }
        });

        $('#RepairAppointmentDateNew').change(function (e) {

            var RepairAppointmentDateNew = $("#RepairAppointmentDateNew").val();
            var ExpectDateOld = $("#ExpectDateOld").val();

            var Day = new Date();
            var ToDay = new Date(Day.getFullYear(), (Day.getMonth()), Day.getDate());

            var RemainDays = datediff(ToDay, parseDate(ExpectDateOld));

            var ExpectDateNew = parseDate(RepairAppointmentDateNew);
            ExpectDateNew.setDate(ExpectDateNew.getDate() + RemainDays);

            var ExpectDateNewLabel = ExpectDateNew.getDate() + '/' + (ExpectDateNew.getMonth() + 1) + '/' + ExpectDateNew.getFullYear();

            $("#ExpectDateNew").val(ExpectDateNewLabel);
        });


        $('#hclist1').change(function (e) {
            getList2();
        });

        $('#hclist2').change(function (e) {
            getList3();
        });

        $('#hclist3').change(function (e) {
            getList4();
        });

        $('#hclist4').change(function (e) {
            getList4Unit();
        });

        function toggleIcon(event) {
            //console.log($(event.target));
            $(this).find('.pull-right').toggleClass('icon-minus icon-plus');
        }
        $('.widget').on('hidden.bs.collapse', toggleIcon);
        $('.widget').on('shown.bs.collapse', toggleIcon);

        $(".btnaddWorksheetPic").click(function () {

            var statusID = $("#hdMainProcessID").val();
            var ApproveStatusID = $("#hdApproveStatusID").val();

            if(((statusID=13||statusID==8) && "@EnumConfiguration.Role.AdminHC.ToString()" != "@UserDetail.Permisson" ) || ("@EnumConfiguration.Role.AdminHC.ToString()" == "@UserDetail.Permisson"))
            {
                $("#spbtnmodalDeletdBefore").removeAttr("hidden");
                $("#spbtnmodalDeletdBetween").removeAttr("hidden");
                $("#spbtnmodalDeletdPost").removeAttr("hidden");
            }else
            {
                $("#spbtnmodalDeletdBefore").attr("hidden","hidden");
                $("#spbtnmodalDeletdBetween").attr("hidden","hidden");
                $("#spbtnmodalDeletdPost").attr("hidden","hidden");

            }


            $("#modaluploadPic").modal('show');

            $("#hditemidUpload").val($(this).val());
            //console.log($(this).val());


            $("[name*='file']").each(function () {
                $(this).fileinput('clear');
            });


            $("[name*='file']").each(function () {
                @*ReferenceID = $("#hdWorksheetID").val();
                ReferenceType = "W";
                AttachmentTypeID = $(this).data("value"),
                AttachmentDetail='';
                User = "@UserDetail.Fullname";*@

                //$(this).fileinput('refresh', { uploadUrl: '@Url.Action("uploadAttachmentFile", "Fileupload")' + '?ReferenceID=' + ReferenceID + '&ReferenceType=' + ReferenceType + '&AttachmentTypeID=' + AttachmentTypeID + '&AttachmentDetail=' + AttachmentDetail + '&User=' + User + '&ReferenceItemID=' + $("#hditemidUpload").val() + ' '});

                $(this).fileinput('refresh', {
                    uploadAsync: true,
                    uploadUrl: `${baseUrl}/homecare/api/v1/Attachment/UploadWarrantyAttatchment`,
                    uploadExtraData: {
                        referenceId: $("#hdWorksheetID").val(),
                        referenceType: 'W',
                        referenceItemId: $("#hditemidUpload").val(),
                        attachmentTypeId: $(this).data("value"),
                        userCode: '@UserDetail.Fullname'
                    },
                    ajaxSettings: {
                        headers: {
                            "Authorization": "Bearer " + constructionApiToken
                        }
                    }
                }).on('filebatchpreupload', function (event, data, id, index) {
                    $('#kv-success-2').html('<h4>Upload Status</h4><ul></ul>').hide();
                    viewPicture("#logoPic",1,"#btnmodalExportBefore","btnmodalDeletdBefore");
                    viewPicture("#logoPic2",2,"#btnmodalExportBetween","btnmodalDeletdBetween");
                    viewPicture("#logoPic3",3,"#btnmodalExportPost","btnmodalDeletdPost");
                    //if ($(this).data("value") === 1) {
                    //    viewPicture("#logoPic", 1, "#btnmodalExportBefore", "btnmodalDeletdBefore");
                    //} else if ($(this).data("value") === 2) {
                    //    viewPicture("#logoPic2",2,"#btnmodalExportBetween","btnmodalDeletdBetween");
                    //} else if ($(this).data("value") === 3) {
                    //    viewPicture("#logoPic3",3,"#btnmodalExportPost","btnmodalDeletdPost");
                    //}
                });
            });



            viewPicture("#logoPic",1,"#btnmodalExportBefore","btnmodalDeletdBefore");
            viewPicture("#logoPic2",2,"#btnmodalExportBetween","btnmodalDeletdBetween");
            viewPicture("#logoPic3",3,"#btnmodalExportPost","btnmodalDeletdPost");
        })

        $("#viewApproveHistory").click(function () {
            $("#ApproveHistoryModal").modal('show');

            $.ajax({
                url: '@Url.Action("getApproveHistory", "Worksheet")',
                type: 'POST',
                data: '{"ApproveID":' + $("#hdApproveID").val() + '}',
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    $("#tbApproveHistory tbody tr").remove();
                    $.each(data, function (key, value) {
                        $("#tbApproveHistory tbody").append("<tr></tr>");
                        if (data.length > 0) {

                            $("#tbApproveHistory tbody tr:last").append("<td class='text-center'><label id='lblNo' name='No'>" + (key + 1) + "</label></td>");
                            $("#tbApproveHistory tbody tr:last").append("<td class='text-left'>" + value.AppvLine_Status + "</td>");
                            $("#tbApproveHistory tbody tr:last").append("<td class='text-left'>" + value.AppvLine_Role + "</td>");
                            $("#tbApproveHistory tbody tr:last").append("<td class='text-left'>" + value.AppvLine_Remark + "</td>");
                            $("#tbApproveHistory tbody tr:last").append("<td class='text-left'>" + value.AppvLine_Date + "</td>");
                        } else {
                            $("#tbApproveHistory tbody tr:last").append("<td class='text-center Bold text-danger' colspan='5'>ไม่มีข้อมูล</td>");

                        }

                    });
                },
                error: function (data) {

                },
            });

        });

        var viewFileEvnet;

        $(".viewFile").click(function () {



            viewFileEvnet=$(this);
            viewFile(viewFileEvnet);


            var statusID = $("#hdMainProcessID").val();
            var ApproveStatusID = $("#hdApproveStatusID").val();

            if(((statusID=13||statusID==8) && "@EnumConfiguration.Role.AdminHC.ToString()" != "@UserDetail.Permisson" ) || ("@EnumConfiguration.Role.AdminHC.ToString()" == "@UserDetail.Permisson"))
            {
                $("#spbtndeleted").removeAttr("hidden");
            }else
            {
                $("#spbtndeleted").attr("hidden","hidden");
            }
            $("#modalViewFile").modal('show');

        });

        function viewFile(e)
        {
            $("#lblattrachgroupName").text("ประเภทเอกสาร: " + e.closest('tr').find("#lbldocName").text());

            ajaxGet(`${baseUrl}/homecare/api/v1/Images/Token`, token => {
                //$("#lblattrachgroupName").text();
                var imageToken = token.data;

                var body = {
                    referenceId: $("#hdWorksheetID").val(),
                    referenceType: "W",
                    attachmentTypeId: e.closest('tr').find("#AttachmentTypeID").val(),
                    referenceItemId: 0
                };

                ajaxPost(`${baseUrl}/homecare/api/v1/Attachment/List`, body, async response => {
                    $("#logo option").remove();

                $.each(response.data, function (key, file) {
                    //console.log(file);
                    var fileicon = "@System.Configuration.ConfigurationManager.AppSettings["Iconpath"].ToString()";

                    if (file.attachmentURL.indexOf(".pdf") != -1) {
                        fileicon = fileicon + "pdfIcon.png"
                    } else if (file.attachmentURL.indexOf(".doc") != -1 || file.attachmentURL.indexOf(".docx") != -1) {
                        fileicon = fileicon + "docIcon.png"
                    } else if (file.attachmentURL.indexOf(".xlsx") != -1 || file.attachmentURL.indexOf(".xls") != -1) {
                        fileicon = fileicon + "excelIcon.png"
                    } else {
                        fileicon = `${baseUrl}/${file.attachmentURL}?Token=${imageToken}`; //path + file.Attachment_URL;
                        fileicon = fileicon.replace(/\s/g, "%20");
                    }

                    var filePath = `${baseUrl}/${file.attachmentURL}?Token=${imageToken}`;
                    filePath = filePath.replace(/\s/g, "%20");
                    if (key == 0) {
                        $('#logo').append(`<option data-img-src=${fileicon} value=${filePath} data-id=${file.attachmentId}>${file.attachmentDetail}</option>`);
                        $("#hdDeletedAttach").val(file.attachmentId);
                        //$(".image_picker_selector").append("<li><div class='thumbnail selected' style='width:200px;height:200px'><img class='image_picker_image' src='" + fileicon + "'></div><div>" + file.Attachment_Detail + "</div></li>");
                        $("#btndownload").attr("href", filePath);
                        $("#btndownload").attr("target", "_blank")
                    } else {
                        //$(".image_picker_selector").append("<li><div class='thumbnail' style='width:200px;height:200px'><img class='image_picker_image' src='" + fileicon + "'></div><div>" + file.Attachment_Detail + "</div></li>");
                        $('#logo').append(`<option data-img-src=${fileicon} value=${filePath} data-id=${file.attachmentId}>${file.attachmentDetail}</option>`);
                    }
                });
                $("#logo").imagepicker({
                    hide_select: false,
                    show_label: false
                })
                $("#logo").imagepicker({
                    clicked: function () {
                        $("#btndownload").attr("href", this.val());
                        $("#btndownload").attr("target", "_blank")
                        $("#hdDeletedAttach").val($(this).find(':selected').data('id'));
                    }

                });

                $.each(response.data, function (key, file) {
                    var setPublishElem = '';

                    //if (file.attachmemtTypeId == 1 || file.attachmemtTypeId == 2 || file.attachmemtTypeId == 3) {
                    //    var checked = file.attachmentPublishImageHSA ? 'checked' : '';
                    //    setPublishElem = `
                    //        </br><label><input type="checkbox" onclick=setPublish('${file.attachmentId}') ${checked}/>Publish to clients</label>
                    //    `;
                    //}

                    $('#img'+file.attachmentId).html("<b>Upload By: </b>"+file.attachmentUpdatedBy+'<br><b>Upload Date: </b>'+file.attachmentUpdateDate + setPublishElem);
                });
            });
        });



    }

        $("#WorksheetCloseConfirm").click(function () {

            if ($("[name*=AprrovedType]:checked").val() === undefined) {
                modalWaring('กรุณาเลือกประเภทการอนุมัติ');
                return false;
            }
            if ($("[id *= PaymentType]").val() == 0) {
                modalWarning("กรุณาเลือกรายละเอียดการอนุมัติ");
                return;
            }

            var date = new Date();
            var today = date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear();
            if (document.getElementById('WorksheetCloseConfirm').checked) {
                $("#WorksheetCloseConfirmDate").val(today);
            }
            else {
                $("#WorksheetCloseConfirmDate").val("");
            }
        });

    $("#btndeleted").click(function () {


        DeleteViewFile();
        viewFile(viewFileEvnet)

        //console.log($("#hdDeletedAttach").val())
    });
    $("#btnmodalDeletdBefore").click(function () {


        DeleteViewFile();
        viewPicture("#logoPic",1,"#btnmodalExportBefore","btnmodalDeletdBefore");



    });

    $("#btnmodalDeletdBetween").click(function () {
        DeleteViewFile();
        viewPicture("#logoPic2",2,"#btnmodalExportBetween","btnmodalDeletdBetween");


    });  $("#btnmodalDeletdPost").click(function () {
        DeleteViewFile();
        viewPicture("#logoPic3",3,"#btnmodalExportPost","btnmodalDeletdPost");

    });

    function DeleteViewFile()
    {
        ajaxDelete(`${baseUrl}/homecare/api/v1/Attachment/${$("#hdDeletedAttach").val()}`, {username: "@UserDetail.Fullname"}, response => {
            alert(response.data);
        });


    }

    $(".viewFixPrice").click(function () {
        WorksheetitemID = $(this).data("value");
        $("#hdApproveStatusID").val() > 9 ? $("#btnAddWOItem").attr("disabled", 1) : null;
        $("#hdWorksheetitemID").val(WorksheetitemID);
        $("#VendorFixPriceModal").modal('show');
        //binding Price
        clearVendorFixPriceModal();
        bindingfixPrice(WorksheetitemID)
    });


    $(".PriceConfirm").click(function () {

        var date = new Date();
        var today = date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear();

        var txt = $(this).closest('tr').find("#PriceConfirmDate");
        //console.log(txt, today, $(this).is(":checked"))


        if ($(this).is(":checked")) {
            //alert(today);
            txt.val(today);
        }
        else {
            txt.val("");
        }
    });

    $(".StartFix").click(function () {

        var date = new Date();
        var today = date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear();

        var txt = $(this).closest('tr').find("#StartFixDate");
        //console.log(txt, today, $(this).is(":checked"))


        if ($(this).is(":checked")) {
            //alert(today);
            txt.val(today);
        }
        else {
            txt.val("");
        }

    });

    function validateEndFix(ItemID)
    {
        $.ajax({
            url: '@Url.Action("checkEndFix", "Worksheet")',
            type: "POST",
            data: '{"Reference_ID": ' + $("#hdWorksheetID").val() + ',"Reference_Item_ID": ' + ItemID + '}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {

            },
            success: function (response) {
                //console.log(response);
                if (response != "") {
                    modalWaring(response);
                    //console.log("not ok");
                    return false;
                } else {
                    //console.log("ok");
                    return true;
                }
            },


        });

    }

    $("#CalculateVendorFixPrice").click(function () {
        var TotalPrice = 0;
        if (document.getElementById('VendorFixPrice_MainMateria').checked) {
            TotalPrice = TotalPrice + ($("#VendorFixPrice_MainMateriaPrice").val() * $("#VendorFixPrice_Quantity").val());
        }
        if (document.getElementById('VendorFixPrice_MainWage').checked) {
            TotalPrice = TotalPrice + ($("#VendorFixPrice_MainWagePrice").val() * $("#VendorFixPrice_Quantity").val());
        }
        if (document.getElementById('VendorFixPrice_SpecialMateria').checked) {
            TotalPrice = TotalPrice + ($("#Vendor_SpecialMateriaPrice").val() * $("#VendorFixPrice_Quantity").val());
        }
        if (document.getElementById('VendorFixPrice_SpecialWage').checked) {
            TotalPrice = TotalPrice + ($("#VendorFixPrice_SpecialWagePrice").val() * $("#VendorFixPrice_Quantity").val());
        }

        $("#VendorFixPrice_TotalPrice").val(TotalPrice);


    });

    table = $('#tbvendor-list').DataTable({
        // "scrollX": true,
        "pageLength": 10,
        "columnDefs": [
            {

                "targets": 0,
                "render": function (value, type, row, meta) {
                    return `<input class="form-check-input" type="checkbox" id="poSelect_"${value.index} onclick="selectPOList(${value.index},this)">`;
                },
                "className": "text-center"
            },
            {
                "targets": 1,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                },
                "className": "text-center"
            },
            {
                "targets": 2,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                },
                "className": "text-center"
            },
            {

                "targets": 3,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                },
                "className": "text-center"
            },
            {
                "targets": 4,
                "render": function (data, type, row, meta) {
                    return  `${data}`;
                },
                "className": "text-center"
            },
            {
                "targets": 5,
                "render": function (data, type, row, meta) {
                    return `${data.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                },
                "className": "text-right"
            },
            {
                "targets": 6,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                },
                "className": "text-center"
            }
        ],
        "order": [[0, 'asc']],
        "language": {
            "search": "ค้นหา : ",
            "lengthMenu": "แสดง _MENU_ รายการ",
            "emptyTable": "ไม่พบข้อมูล",
            "info": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
            "infoEmpty": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
            "infoFiltered": "",
            "zeroRecords": "ไม่พบข้อมูล",
            "paginate": {
                "first": "หน้าแรก",
                "last": "หน้าสุดท้าย",
                "next": "ถัดไป",
                "previous": "ก่อนหน้า"
            }

        }

    });
    let sum = 0;
    tablePORetention = $('#tbVendorRetention-list').DataTable({
        "pageLength": 10,
        "columnDefs": [
            {
                //  PONUM
                "targets": 0,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                },
                "className": "text-center"
            },
            {
                //  VendorCode
                "targets": 1,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                },
                "className": "text-center"
            },
            {
                //  VendorName
                "targets": 2,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                },
                "className": "text-center"
            },
            {
                //  remaining Retention Amount of PO
                "targets": 3,
                "render": function (data, type, row, meta) {
                    return `${data.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                },
                "className": "text-right"
            },
            {
                //  deducting Retention Amount
                "targets": 4,
                "render": function (data, type, row, meta) {
                    return `<div>
                                    <input type="text" class="form-control input-sm allownumeric" name="retentionAmt_${data.index}" id="retentionAmt_${data.index}" value="${data.rettot}" style="text-align: right;" />
                                </div>
                                <span class="error text-danger" style="font-size:small;font-style: italic;">*เกินยอดเงินประกันคงเหลือ</span>`;
                },
                "className": "text-right "
            },
            {
                //  Date
                "targets": 5,
                "render": function (value, type, row, meta) {
                    return `<div class="bootstrap-datepicker">
                                        <div class="bootstrap-datepicker">
                                            <div class="input-group">
                                                <div class="input-group-addon">
                                                    <i class="fa fa-calendar"></i>
                                                </div>
                                                <input type="text" class="form-control datepicker" data-val="true"  name="RetentionDate_${value.index}" id="RetentionDate_${value.index}" style="width:100%;" onkeypress="return false">
                                            </div>
                                        </div>
                                    </div>`;
                },
                "className": "text-center"
            }
            ,
            {
                //  Remark
                "targets": 6,
                "render": function (value, type, row, meta) {
                    return `<input type="text" class="form-control input-sm"  id="retentionRemark_${value.index}" name="retentionRemark_${value.index}" maxlength="500" />`;
                },
                "className": "text-center"
            },
            {
                //  PO Type
                "targets": 7,
                "render": function (value, type, row, meta) {
                    return `<input type="hidden" value="${value.gsber}"  id="gsbr_${value.index}" name="gsbr_${value.index}"/>
                                <input type="hidden" value="${value.kostl}"  id="kostl_${value.index}" name="kostl_${value.index}"/>
                                ${value.bsart}`;
                },
                "className": "text-center"
            }
        ],
        "createdRow": function (row, data, index) {
            //Initial DatePicker
            const today = new Date().getDate();
            const thisMonth = new Date().getMonth() + 1;
            const thisYear = new Date().getFullYear();
            $('.datepicker', row).datepicker({
                autoclose: true,
                format: 'dd/mm/yyyy',
                endDate: '0d'
            }).datepicker("setDate", `${today}/${thisMonth}/${thisYear}`);


            $('td:eq(4)', row).addClass("sumMe");
            $('.error', row).css('display', 'none');
            $('input[name*="retentionAmt"]', row).addClass('SumRetAmount');
            $(".allownumeric").on("keypress keyup blur", function (event) {
                var charC = (event.which) ? event.which : event.keyCode;

                if (charC == 46) {
                    if (event.target.value.indexOf('.') === -1) {
                        return true;
                    } else {
                        event.preventDefault();
                    }
                } else {
                    if (charC > 31 && (charC < 48 || charC > 57))
                        event.preventDefault();
                }
                if (event.target.value.indexOf(".") > -1) {

                    if (event.target.value.split('.')[0].length <= 6 && event.target.value.split('.')[1].length < 2) {
                        return true;
                    }
                    else {
                        event.preventDefault();
                    }

                } else if (event.target.value.indexOf(".") === -1 && event.target.value.length >= 6) {

                    event.preventDefault();
                }

                return true;

            });
            ///  $('input[name*="retentionAmt"]', row).unbind();
            $('input[name*="retentionAmt"]', row).bind('keyup blur', function (e) {
                if (parseFloat(data[3]) < this.value) {
                    $('.error', row).css('display', 'inline');
                    $('#btnCreateRetention').prop('disabled', true);
                } else {
                    $('.error', row).css('display', 'none');
                    $('#btnCreateRetention').prop('disabled', false);
                }
                let mySum = 0;
                $('td.sumMe input').each(function () {
                    mySum += parseFloat($(this).val() === "" ? 0 : $(this).val() );
                });

                $('#txtSumRetention').text(mySum.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));

            });
            $('input[name*="retentionAmt"]', row).bind('blur ', function (e) {

                if (this.value == "") {
                    $('input[name*="retentionAmt"]', row).val(data[3]);
                }
                let mySum = 0;
                $('td.sumMe input').each(function () {

                    mySum += parseFloat($(this).val() === "" ? 0 : $(this).val());
                });
                $('#txtSumRetention').text(mySum.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));


            });

        },
        "order": [[0, 'asc']],
        "language": {
            "search": "ค้นหา : ",
            "lengthMenu": "แสดง _MENU_ รายการ",
            "emptyTable": "ไม่พบข้อมูล",
            "info": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
            "infoEmpty": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
            "infoFiltered": "",
            "zeroRecords": "ไม่พบข้อมูล",
            "paginate": {
                "first": "หน้าแรก",
                "last": "หน้าสุดท้าย",
                "next": "ถัดไป",
                "previous": "ก่อนหน้า"
            }

        }

    });

    tableWorksheetRetention = $('#tbWorksheetRetention-list').DataTable({
        "pageLength": 10,
        "columnDefs": [
            {
                "targets": 0,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                }
            },
            {
                "targets": 1,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                },
                "className": "text-center"
            },
            {
                "targets": 2,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                },
                "className": "text-center"
            },
            {
                "targets": 3,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                },
                "className": "text-center"
            },
            {
                "targets": 4,
                "render": function (data, type, row, meta) {
                    return `${data.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                },
                "className": "text-right"
            },
            {
                "targets": 5,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                },
                "className": "text-center"
            },
            {
                "targets": 6,
                "render": function (data, type, row, meta) {
                    return `${data}`;
                },
                "className": "text-center"
            }

        ],
        "order": [[0, 'asc']],
        "language": {
            "search": "ค้นหา : ",
            "lengthMenu": "แสดง _MENU_ รายการ",
            "emptyTable": "ไม่พบข้อมูล",
            "info": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
            "infoEmpty": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
            "infoFiltered": "",
            "zeroRecords": "ไม่พบข้อมูล",
            "paginate": {
                "first": "หน้าแรก",
                "last": "หน้าสุดท้าย",
                "next": "ถัดไป",
                "previous": "ก่อนหน้า"
            }

        }

    });

    CheckReadOnlyPermission();
    await UpdateRetentionStatus();


        //GetEditdata();
    });


    @*function GetEditdata() {
        ajaxGet(`${baseUrl}/homecare/api/v1/LineApprove/CheckHistoryEditDataFlow?id=${$("#hdWorksheetID").val()}&projectCode=${"@Model.Data_Unit.PJ_Code"}`, async response => {
            if (response.data.length > 0) {

            for (let key in response.data) {
                if (response.data[key].EditType == 'แก้ไขผู้รับเหมา') {
                    if (response.data.length > 0 && response.data[key].Detail_old != null) {
                        $('#iconwait').show();
                        $('#lbStatusEditData').show();
                        empApproveEditData = 'โดยคุณ' + response.data[key].EmpApproveName;
                        $('#lbEmpEditData').text(empApproveEditData).show();
                        flagEdit = true;
                        $('.lbVendor').addClass('hidden');
                        $('.itemAddVendor').addClass('hidden');

                    } else {

                        $('#iconwait').hide();
                        flagEdit = false;
                        $('.lbVendor').removeClass('hidden');
                        $('.itemAddVendor').removeClass('hidden');
                    }
                    break;
                } else {

                    $('#iconwait').hide();
                    flagEdit = false;
                    $('.lbVendor').removeClass('hidden');
                    $('.itemAddVendor').removeClass('hidden');
                }
            }
            } else {

                $('#iconwait').hide();
                flagEdit = false;
                $('.lbVendor').removeClass('hidden');
                $('.itemAddVendor').removeClass('hidden');
            }

    });

    }*@

    $('#btnRetRejt').click(function () {
        UpdateWorkSheetChangePaymentType();
    });
    function UpdateWorkSheetChangePaymentType() {
        var data = {
            worksheet_id: $("#hdWorksheetID").val(),
            systemType: 1,
            UserLogon:'@UserDetail.CodeName'
        }
        page.loading();
        ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/UpdateWorkSheetChangePaymentType`, data,async function(response) {
            if (response) {
                if (response.data.status) {
                    page.loaded();
                    $('#modalRetentionHistory').modal('hide');
                    modalSuccess(response.data.msg);
                    await reload();

                } else {
                    page.loaded();
                    modalWarning(response.data.msg);
                }
            }


        });
        page.loaded();

    }

    async function UpdateRetentionStatus() {
        var data = {
            worksheet_id: $("#hdWorksheetID").val(),
            systemType: 1,
            UserLogon:'@UserDetail.CodeName'
        }
        await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/UpdateRetentionStatus`, data, response => {
            if (response) {

            }
        });
    }

    function CheckReadOnlyPermission() {

        ajaxGet(`${baseUrl}/homecare/api/v1/User/@UserDetail.UserID/Permission`, response => {
            if (response) {
                if (!response.data.find(a => a.permissionDescription === 'AttachDocumentsF')) {

                    $("#AttachDocumentsF :input").attr('disabled', 'disabled');
                    $(".modal-header .close ").removeAttr('disabled');
                }
                if (!response.data.find(a => a.permissionDescription === 'AttachMemo')) {

                    $("#AttachMemo :input").attr('disabled', 'disabled');
                    $(".modal-header .close ").removeAttr('disabled');
                }
                if (!response.data.find(a => a.permissionDescription === 'AttachVendorDocuments')) {

                    $("#AttachVendorDocuments :input").attr('disabled', 'disabled');
                    $(".modal-header .close ").removeAttr('disabled');
                }
                if (response.data.find(a => a.permissionDescription === 'WorksheetReadOnly')) {

                    $("#divbtnsendApprove").css('display', 'none');
                    $("#btnExtendedRepair").css('display', 'none');
                    $("#btnSaveWO").css('display', 'none');

                    $("#Worksheet-Worksheet-detail :input").attr('disabled', 'disabled');
                    $("#apprveDetial :input").attr('disabled', 'disabled');
                    $("[name*='PriceConfirm']").each(function () {
                        $(this).attr("disabled", "disabled");
                    });
                    $("[name*='StartFix']").each(function () {
                        $(this).attr("disabled", "disabled");
                    });
                    $("[name*='EndFix']").each(function () {
                        $(this).attr("disabled", "disabled");
                    });

                    $(".btnaddWorksheetPic").each(function () {
                        $(this).attr("disabled", "disabled");
                    });
                    $("[name*='Cause_Text']").each(function () {
                        $(this).attr("disabled", "disabled");
                    });


                    $("[name*='viewFixPrice']").attr("hidden", "hidden");
                    $("[name*='itemAddVendor[]'").attr("hidden", "hidden");


                }
                if (response.data.find(a => a.accessDescription === 'CallCentreRole')) {
                    $("[name*='PriceConfirm']").each(function () {
                        $(this).attr("disabled", "disabled");
                    });
                    $("[name*='StartFix']").each(function () {
                        $(this).attr("disabled", "disabled");
                    });
                    $("[name*='EndFix']").each(function () {
                        $(this).attr("disabled", "disabled");
                    });
                    $("#divbtnsendApprove").css('display', 'none');

                    $(".btnaddWorksheetPic").each(function () {
                        $(this).attr("disabled", "disabled");
                    });
                    $("[name*='Cause_Text']").each(function () {
                        $(this).attr("disabled", "disabled");
                    });


                    $("[name*='viewFixPrice']").attr("hidden", "hidden");
                    $("[name*='itemAddVendor[]'").attr("hidden", "hidden");

                }
            }

        });
    }
    async function bindingInputFile() {
        if (!constructionApiToken) await getTokenAsync();

        $("[name*='file']").each(async function () {

            $(this).fileinput('refresh', {
                uploadAsync: true,
                uploadUrl: `${baseUrl}/homecare/api/v1/Attachment/UploadWarrantyAttatchment`,
                uploadExtraData: {
                    referenceId: $("#hdWorksheetID").val(),
                    referenceType: 'W',
                    referenceItemId: 0,
                    attachmentTypeId: $(this).closest('tr').find("#AttachmentTypeID").val(),
                    attachmentDetail:  $(this).closest('tr').find("#AttachmentDetail").val(),
                    userCode: '@UserDetail.Fullname'
                },
                ajaxSettings: {
                    headers: {
                        "Authorization": "Bearer " + constructionApiToken
                    },
                },
                allowedFileExtensions: ['jpg', 'png', 'gif', 'pdf', 'xlsx', 'xls', 'doc', 'docx'],
                maxFileCount: 5,
                elErrorContainer: '#kv-error-2',
            }).on('filebatchpreupload', function (event, data, id, index) {
                $('#kv-success-2').html('<h4>Upload Status</h4><ul></ul>').hide();
            })

        });
    }

    function updateReceivedItemID(ID,itemID,Type)
    {
        $.ajax({

            url: '@Url.Action("updateItemID", "Fileupload")',
            type: "POST",


            data: '{"ReferenceID": ' + ID + ',"ReferenceitemID": '+itemID+',"Type": "'+Type+'"}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {
                alert(response.responseText);

            },
            success: function (response) {
            }});
    }


    function updateAttachmentDetail(AttachmentID,AttachmentDetail)
    {
        //updateAttachmentDetail
        var requestData ={
            AttachmentID:AttachmentID,
            AttachmentDetail:AttachmentDetail,
            User: "@UserDetail.CodeName"
        }


        var Url = '@Url.Action("UpdateAttachmentDetail", "Fileupload")';

        var response = CallController_Ajax(requestData,Url);

    };

    function viewPicture(id,type,btn,btnDelete)
    {
        var ItemID = $("#hditemidUpload").val();

        ajaxGet(`${baseUrl}/homecare/api/v1/Images/Token`, token => {
            //$("#lblattrachgroupName").text();
            var imageToken = token.data;

            var body = {
                referenceId: $("#hdWorksheetID").val(),
                referenceType: "W",
                attachmentTypeId: type,
                referenceItemId: ItemID
            };

            ajaxPost(`${baseUrl}/homecare/api/v1/Attachment/List`, body, async response => {
                $(id+" option").remove();

            $.each(response.data, function (key, file) {
                //console.log(file);
                var fileicon = "@System.Configuration.ConfigurationManager.AppSettings["Iconpath"].ToString()";

                if (file.attachmentURL.indexOf(".pdf") != -1) {
                    fileicon = fileicon + "pdfIcon.png"
                } else if (file.attachmentURL.indexOf(".doc") != -1 || file.attachmentURL.indexOf(".docx") != -1) {
                    fileicon = fileicon + "docIcon.png"
                } else if (file.attachmentURL.indexOf(".xlsx") != -1 || file.attachmentURL.indexOf(".xls") != -1) {
                    fileicon = fileicon + "excelIcon.png"
                } else {
                    fileicon = `${baseUrl}/${file.attachmentURL}?Token=${imageToken}`; //path + file.Attachment_URL;
                    fileicon = fileicon.replace(/\s/g, "%20");
                }

                var filePath = `${baseUrl}/${file.attachmentURL}?Token=${imageToken}`;
                filePath = filePath.replace(/\s/g, "%20");

                if (key == 0) {
                    $(id).append(`<option data-img-src=${fileicon} value=${filePath} data-id=${file.attachmentId}>${file.attachmentDetail}</option>`);
                    $("#hdDeletedAttach").val(file.attachmentId);
                    //$(".image_picker_selector").append("<li><div class='thumbnail selected' style='width:200px;height:200px'><img class='image_picker_image' src='" + fileicon + "'></div><div>" + file.Attachment_Detail + "</div></li>");
                    $(btn).attr("href", filePath);
                    $(btn).attr("target", "_blank")
                } else {
                    //$(".image_picker_selector").append("<li><div class='thumbnail' style='width:200px;height:200px'><img class='image_picker_image' src='" + fileicon + "'></div><div>" + file.Attachment_Detail + "</div></li>");
                    $(id).append(`<option data-img-src=${fileicon} value=${filePath} data-id=${file.attachmentId}>${file.attachmentDetail}</option>`);
                }
            });
            $(id).imagepicker({
                hide_select: false,
                show_label: false
            })
            $(id).imagepicker({
                clicked: function () {
                    $("#hdDeletedAttach").val($(this).find(':selected').data('id'));
                    $(btn).attr("href", $(this).find("option[value='" + $(this).val() + "']").data('img-src'));
                    $(btn).attr("target", "_blank")
                }

            });

            $.each(response.data, function (key, file) {
                $('#img'+file.attachmentId).html("<b>Upload By: </b>"+file.attachmentUpdatedBy+'<br><b>Upload Date: </b>'+file.attachmentUpdateDate);
            });
        });
    });


    }
    $("[name*='itemAddVendor[]']").click(function () {

        addVendorRetFlag = false;
        itemAddvendor();
    });
    $('#itemAddVendorRetention').click(function () {
        addVendorRetFlag = true;
        itemAddvendorRetention();
    });
    $("#btnAddWOItem").click(function () {

        var hclist1 = $("#hclist1").val();
        var hclist2 = $("#hclist2").val();
        var hclist3 = $("#hclist3").val();
        var hclist4 = $("#hclist4").val();
        var VendorFixPrice_Quantity = $("#VendorFixPrice_Quantity").val();
        var txtVendorFixPrice_Remark = $("#txtVendorFixPrice_Remark").val();


        if (hclist1 == "" || hclist2 == "" || hclist3 == "" || hclist4 == "" || VendorFixPrice_Quantity == "") {
            modalWaring("กรุณาระบุ รายละเอียดราคางานซ่อม ให้ครบถ้วน");
            return false;
        }

        if ($("#chkVendor_SpecialMateria").prop('checked') || $("#chkVendorFixPrice_SpecialWage").prop('checked')) {
            if (txtVendorFixPrice_Remark == "") {
                modalWaring("กรุณาระบุ เหตุผลของราคาพิเศษ");
                return false;
            }
        }

        var total=0.00;

        //ค่าวัสดุ(ราคากลาง)
        var fixmateriaPrice;
        if ($("#chkVendorFixPrice_MainMateria").prop('checked')) {
            total += parseFloat($("#txtVendorFixPrice_MainMateriaPrice").val().replace(',', ''));
        } else
            //ค่าแรง (ราคากลาง)
            var fixmainwagePrice;
        if ($("#chkVendorFixPrice_MainWagePrice").prop('checked')) {
            total += parseFloat($("#txtVendorFixPrice_MainWagePrice").val().replace(',', ''));
        }

        //ค่าวัสดุ (ราคาพิเศษ)
        var spacialmateriaPrice;
        if ($("#chkVendor_SpecialMateria").prop('checked')) {
            total += parseFloat($("#txtVendor_SpecialMateriaPrice").val().replace(',', ''));
        }

        //ค่าแรง(ราคาพิเศษ)
        var spacialmainwagePrice;
        if ($("#chkVendorFixPrice_SpecialWage").prop('checked')) {
            total += parseFloat($("#txtVendor_SpecialWagePrice").val().replace(',', ''));
        }

        if((total*parseFloat(VendorFixPrice_Quantity.replace(',', '')))<=0.00)
        {
            modalWaring("ไม่สามารถเพิ่มรายการได้เนื่องจาก ราคารวมต้องมีค่ามากกว่า 0");
            return false;
        }


        if (btnAddWOItem)
            addWorksheetItem();


        clearVendorFixPriceModal();

    });
    $("#btnSearchVendor").on("click", function () {

        if ( $("#textCrivendorCode").val() == "" && $("#textCrivendorName").val() == "" && $("#textCriIDCard").val() == "" )
        {
            modalWaring("กรุณาระบุเงื่อนไขในการค้นหา");
        }else
        {
            SearchVendor();

        }
    });


    $("#btnSaveWO").on("click", async function () {

        $("#btnSaveWO").attr('disabled', 1);
        await page.loading();
        var values = {
            Worksheet_ID: $("#hdWorksheetID").val(),
            CloseJob_Date: $("#WorksheetCloseConfirmDate").val() == "" ? null : $("#WorksheetCloseConfirmDate").val(),
            Vendor_ID: $("#hdVendorID").val(),
            Vendor_Name: $("#lblVendorName").text(),
            VendorChangeRemark: $("#txtVendorchangeRemark").val(),
            RepairAppointmentFromDate: null,
            RepairAppointmentToDate: null,
            Operating_Percent: $("#txtOperatingPercent").val(),
            Vat_Percent: $("#txtVatPercent").val(),
            PaymentType: $('input[name=AprrovedType]:checked').val(),
            PaymentType_ID: $("#PaymentType").val(),
            User: "@UserDetail.CodeName",
            Unit_ID:"@Model.Data_Unit.Unit_ID",
            Unit_Code:"@Model.Data_Unit.Unit_Code",
            ProjectCode:"@Model.Data_Unit.PJ_Code",
        }

        await validateSaveWO();

        if (valid) {
            await updateWorksheetDetail(values);

            $("#AddReceiveTable tbody tr").each(async function () {

                var row = $(this);
                var pWorksheet_ID = $("#hdWorksheetID").val();
                var pWorksheet_Item_ID = row.find("#hdWorksheet_Item_ID").val();
                var pStatus = row.find("#ReceivedDetailItemsStatus").val();
                var txtCause_Text = row.find("#Cause_Text").val();
                var pConfirm_Price_Date = "";
                var chkPriceConfirm = row.find("#PriceConfirm");
                var txtPriceConfirmDate = row.find("#PriceConfirmDate");
                var chkStartFix = row.find("#StartFix");
                var txtStartFixDate = row.find("#StartFixDate");
                var chkEndFix = row.find("#EndFix");
                var txtEndFixDate = row.find("#EndFixDate");
                if (chkPriceConfirm.is(":checked")) {
                    pConfirm_Price_Date = txtPriceConfirmDate.val();
                }
                var pStartDate = "";
                if (chkStartFix.is(":checked")) {
                    pStartDate = txtStartFixDate.val();
                }
                var pFinishDate = "";
                if (chkEndFix.is(":checked")) {
                    pFinishDate = txtEndFixDate.val();
                }
                var values = {
                    Worksheet_ID: pWorksheet_ID,
                    Worksheet_Item_ID: pWorksheet_Item_ID,
                    Cause_Text: txtCause_Text,
                    Status: pStatus,
                    Confirm_Price_Date: pConfirm_Price_Date,
                    StartDate: pStartDate,
                    FinishDate: pFinishDate,
                    User: "@UserDetail.CodeName",
                    Unit_ID: "@Model.Data_Unit.Unit_ID",
                    Unit_Code: "@Model.Data_Unit.Unit_Code",
                    ProjectCode: "@Model.Data_Unit.PJ_Code",
                };
                await updateWorksheetItem(values);
            });

            $("#hdFlagchangeVendor").val(false);
            await reload();
            page.loaded();
            modalSuccess();
        } else {
            page.loaded();
        }

        $("#btnSaveWO").removeAttr('disabled');
    });


    function PostNotificationHSA() {
        var value = {
            WorkSheet_ID:$("#hdWorksheetID").val(),
            ReceiveJobNoText:"@Model.Data_Inform.Inform_JobNoText",
            ProjectCode:"@Model.Data_Unit.PJ_Code",
            UnitAddress:"@Model.Data_Unit.Unit_Address",
            Unit_Code:"@Model.Data_Unit.Unit_Code",
        }
        //console.log(value);
        $.ajax({
            url: "@Url.Action("PostNotificationHSA", "Worksheet")",
            type: "POST",
            data: value,
            success: function (data) {
            },
            error: function (data) {
            },
        });
    }

    function validateSaveWO() {

        var statusID = $("#hdMainProcessID").val();
        var ApproveStatusID = $("#hdApproveStatusID").val();

        var WorksheetCloseConfirmDate = $("#WorksheetCloseConfirmDate").val();
        var FlagchangeVendor = $("#hdFlagchangeVendor").val();
        var txtVendorchangeRemark = $("#txtVendorchangeRemark").val();
        const event = (e) => e.poStatus !== 2; //$("#hdPOStatus").val();
        var checkPOStatus = opDetail.some(event);

        var FlagPriceConfirm = false;

        $("[name*='PriceConfirm']").each(function () {
            //console.log($(this).prop('checked'));
            if($(this).prop('checked'))
            {
                FlagPriceConfirm=true;
            }
        });

        var FlagCloseConfirm = false;

        $("[name*='WorksheetCloseConfirm']").each(function () {
            //console.log($(this).prop('checked'));
            if($(this).prop('checked'))
            {
                FlagCloseConfirm=true;
            }
        });

        if (statusID > 8 && ApproveStatusID == 9 && FlagPriceConfirm == false) {

            modalWaring("กรุณายืนยันราคา");
            valid = false;
        }
        else if(FlagchangeVendor=="true" && txtVendorchangeRemark=="" )
        {
            modalWaring("กรุณากรอกเหตุผลการเปลี่ยนผู้รับเหมา");
            valid = false;
        }
        else if ((FlagCloseConfirm == true && checkPOStatus  && $('#hdPaymentType').val() == 'Y') && (parseFloat($('#lblBance').text().replace(/,/g, '')) > 0))
        {
            modalWaring("กรุณาตรวจสอบข้อมูลเลขที่ใบ PO");
            valid = false;

        }
        else if (statusID == 14 && FlagCloseConfirm == true) {

            $.ajax({
                url: '@Url.Action("checkCloseJob", "Worksheet")',
                type: "POST",
                data: '{"WorksheetID": ' + $("#hdWorksheetID").val() + '}',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                async: false,
                error: function (response) {
                    // console.log(response);
                },
                success: async function (response) {
                    //  console.log(response);
                    if (response.error != "") {
                        $("#WorksheetCloseConfirmDate").val("");
                        $("#WorksheetCloseConfirm").prop('checked', false);

                        modalWaring(response.error);
                        valid = false;
                    } else {
                        //  console.log('WF');
                        //await CreateRetentionWorkFlow();
                        valid = true;

                    }
                },

            });

    }
    else
    {

            valid = true;
    }

    }

    function sendCancelF(type) {
         ajaxGet(`${baseUrl}/homecare/api/v1/LineApprove/CheckHistoryEditDataFlow?id=${$("#hdWorksheetID").val()}&projectCode=${"@Model.Data_Unit.PJ_Code"}`, async response => {
             if (response.data.length > 0) {
                 for (let key in response.data) {
                     if (response.data[key].EditType == "ยกเลิกเอกสารF") {
                         if (response.data.length > 0 && response.data[key].Detail_old != null) {
                             empApproveEditData = 'รออนุมัติยกเลิกเอกสารโดยคุณ' + response.data[0].EmpApproveName;
                             $('#modalAlertUserApprove').modal('show');
                             $('#lbAlertUserApprove').text(empApproveEditData);

                         } else {

                             $('#lbType').text(type);
                             $('#modalRequestCancelF').modal('show');
                         }
                     } else {

                         $('#lbType').text(type);
                         $('#modalRequestCancelF').modal('show');
                     }
                 }
             } else {
                 $('#lbType').text(type);
                 $('#modalRequestCancelF').modal('show');
             }

        });
    };

    $('#confirmBtnCencelF').on("click", function () {


          var data = {
                ID: $("#hdWorksheetID").val(),
                ReceiveJobNo: $('#lbHdWorkSheet_JobNoText').text(),
                projectCode: "@Model.Data_Unit.PJ_Code",
                projectName: "@Model.Data_Unit.PJ_Code" + '-' + "@Model.Data_Unit.PJ_Name",
                EditType: "ยกเลิกเอกสารF",
                UserLogin: "@UserDetail.CodeName",
                DocumentF: $('#lbType').text(),
                Remark: $('#confirmReasonF').val(),
                DetailVendor_old: null,
                DetailVendor_new: null
          };
         page.loading();
         ajaxPost(`${baseUrl}/homecare/api/v1/Receive/SaveEditDataSendApprove`, data, response => {

             if (response) {
                 $('#modalRequestCancelF').modal('hide');
                 $('#modalInsertRoleSuccess').modal('show');
                 $('#lbStatusEditData').show();
                 $('#lbTxtSuccess').text('ส่งคำขอแก้ไขข้อมูลเรียบร้อยแล้ว');
                 page.loaded();
                } else {
                    showModalLineApprveWarning('เกิดข้อผิดพลาด บันทึกไม่สำเร็จ');
                }
         });



    });

    // Start Print F1
    $('#btnbtnprintF1').on("click", function () {

        var WorkSheet_ID = $("#hdWorksheetID").val();
        var FormType = "1";
        //DocumentPrint(WorkSheet_ID, FormType);
        ExportDocumentF1(WorkSheet_ID);

    });

    $('#btnbtnprintQT').on("click", function () {

        var WorkSheet_ID = $("#hdWorksheetID").val();
        var FormType = "12";
        //DocumentPrint(WorkSheet_ID, FormType);
        ExportDocumentQuotation(WorkSheet_ID);

    });


    function DocumentPrint(WorkSheet_ID, FormType) {
        $.ajax({
            url: "@Url.Action("DocumentByWorkSheetPrint", "Document")",
            type: "POST",
            data: '{"WorkSheet_ID": "' + WorkSheet_ID + '", "FormType": "' + FormType + '"}',
            contentType: "application/json; charset=utf-8",
            error: function (response) {
                //console.log(response);
            },
            success: function (response) {
                //console.log(response);
            }
        });

    }

    function ExportDocumentF1_2(WorkSheet_ID) {
        pleaseWaitDialog();
        $.ajax({
            url: "@Url.Action("ExportDocumentF1", "ExportFile")",
            type: "POST",
            data: '{"WorkSheetIDList": "' + WorkSheet_ID + '"}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {
                pleaseWaitDialogClose();
            },
            success: function (response) {
                jQuery.each(response, function (index, item) {
                    window.open(item, '_blank');
                });
                pleaseWaitDialogClose();
            }
        });
    }
    // End Print F1

    function ExportDocumentF1(WorkSheet_ID) {
        pleaseWaitDialog();

        ajaxGet(`${baseUrl}/homecare/api/v1/DocumentToken`, response => {
            var win = window.open(`${baseUrl}/homecare/Document/WarrantyF1Document/${WorkSheet_ID}?Token=${response.data}`, '_blank');
            if (win) {
                win.focus();
            }

            pleaseWaitDialogClose();
        });
    }

    function ExportDocumentQuotation_2(WorkSheet_ID) {
        var QuotationId = quotationList.data[quotationList.data.length - 1].quotationId;

        if (quotationList.data.length > 0) {
            ajaxGet(`${baseUrl}/homecare/api/v1/DocumentToken`, response => {
                var win = window.open(`${baseUrl}/homecare/Document/QuotationInWarranty/?WorksheetId=${WorkSheet_ID}&Token=${response.data}`, '_blank');
                if (win) {
                    win.focus();
                }
            });
        }
    }

    function ExportDocumentQuotation(WorkSheet_ID) {
        pleaseWaitDialog();
        $.ajax({
            url: "@Url.Action("ExportDocumentQuotation", "ExportFile")",
            type: "POST",
            data: '{"WorkSheetID": "' + WorkSheet_ID + '"}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {
                pleaseWaitDialogClose();
            },
            success: function (response) {
                jQuery.each(response, function (index, item) {
                    window.open(item, '_blank');
                });
                pleaseWaitDialogClose();
            }
        });
    }
    // End Print F1

    $("#btnsendApprove").on("click",async function () {

        if(parseFloat($("#lblFinalNetPrice").text().replace(',', ''))<=0)
        {
            modalWaring("ไม่สามรถส่งอนุมัติได้ เนื่องจากราคาสุทธิเท่ากับ 0 บาท");
            return;
        }

        if($('input[name=AprrovedType]:checked').val()=="Y" && $("#txtApproveRemark").val()=="")
        {
            modalWaring("กรุณาระบุ เหตุผลการขออนุมัติแบบมีค่าใช้จ่าย");
            return;
        }

        //Add Check Retention
        let totalPrice = parseFloat($("#txtTotalIncludeOperatingPercent").val().replace(/,/g, ''));

        let checkAttachFile = true;

        if (totalPrice >= 20000 && $('input[name=AprrovedType]:checked').val() == "Y") {
            await ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/checkAttachmentFile?id=${$("#hdWorksheetID").val()}`, response => {
                if (response) {
                    if (response.data === 0) {
                        checkAttachFile = false;

                    } else {
                        checkAttachFile = true;
                    }
                }

            });
        }

        //Check Retention Flag From Payment Type
        let vendorRetention = false;

        if ($('input[name=AprrovedType]:checked').val() == "Y")
        {
            let result = await ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/GetPaymentTypeRetentionFlag?value=${$("#PaymentType").val()}`);

            if (result)
            {
                vendorRetention = result.data;
            }

            if (totalPrice >= 5000 && !vendorRetention)
            {
                $('#hdVendorRetention').val(false);
                let totalNetPrice = (totalPrice - ((totalPrice * 5) / 100)).toFixed(2);
                let totalRetention = ((totalPrice * 5) / 100).toFixed(2);
                $('#frmRetention [name="txtRetentionPercent"]').val('5');
                $('#frmRetention [name="txtTotalRetention"]').val(totalRetention);
                $('#frmRetention [name="txtNetPriceWithRetention"]').val(totalNetPrice);
                confirmRetention = await openModalConfirmRetention();
            }
        }

        var requestData={Worksheet_ID: $("#hdWorksheetID").val()};

        var Url = '@Url.Action("checkBeforApprove", "WorkSheet")';

        var response = CallController_Ajax(requestData,Url);
        if(response!="")
        {
            modalWaring(response);
            return;
        }


        $(this).attr("hidden");
        if ($("#PaymentType").val() == "") {
            modalWaring("กรุณาระบุ รายละเอียดการอนุมัติ");
            return false;
        } else if (!checkAttachFile) {
            modalWaring("กรุณาแนบเอกสารใบเสนอราคา !");
            return false;
        }
        else {
            let totalvat = parseFloat($('#txtVatPercent').val().replace(/,/g, ''));
            let reCalNetPrice = parseFloat($('#txtNetPriceWithVat').val());
            if (confirmRetention) {

                let PriceWithRetention = parseFloat($('#frmRetention [name="txtNetPriceWithRetention"]').val().replace(/,/g, ''));
                let totalPriceOfVat = ((totalPrice * totalvat) / 100);
                reCalNetPrice = (totalPrice + totalPriceOfVat).toFixed(2);
            }

            var values = {
                Worksheet_ID: $("#hdWorksheetID").val(),
                PaymentType: $('input[name=AprrovedType]:checked').val(),
                PaymentType_ID: $("#PaymentType").val(),
                User: "@UserDetail.CodeName",
                Unit_Code: $("#hdUnitCode").val(),
                Unit_ID: $("#hdUnitID").val(),
                ApprovedRemark: $("#txtApproveRemark").val(),
                ApproveType: 1,
                Retention: confirmRetention ? $('#frmRetention [name="txtRetentionPercent"]').val() : 0,// $('#txtRetentionPercent').val(),
                Net_Price: confirmRetention ? reCalNetPrice : $("#txtNetPriceWithVat").val(),
                RetentionFlag: confirmRetention,
                Retention_Price: confirmRetention ? $('#frmRetention [name="txtTotalRetention"]').val() : 0

            }

            await pleaseWaitDialog();
            await sendApprovedWorksheet(values, vendorRetention);
            await reload();
            pleaseWaitDialogClose();
            modalSuccess("ระบบดำเนินการส่งอนุมัติเรียบร้อยแล้ว");
        }

    });
    $("#btnApproved").on("click",async function () {
        if ($("#ApprovalRemark").val() == "") {
            modalWarning("กรุณาระบุ เหตุผลอนุมัติ");
        } else {
            var approveStatus = $(this).val();
            pleaseWaitDialog();
            var response =  await ApprovedWorksheet(approveStatus, 2);
            await bindingApproveDetail();
            await bindingApproveitemDetail();
            await GetWorkSheetPODetail();
            validationworkOrderOnload();
            pleaseWaitDialogClose();

            if (response.result) {
                modalSuccess(response.msg);
            } else {
                modalWarning(response.msg);
            }

        }

    });

    $("#btnNotApproved").on("click", async function () {
        if ($("#ApprovalRemark").val() == "") {
            modalWaring("กรุณาระบุ เหตุผลไม่อนุมัติ");
        } else {
            var approveStatus = $(this).val();
            pleaseWaitDialog();
            await ApprovedWorksheet(approveStatus, 3);
            await bindingApproveDetail();
            await bindingApproveitemDetail();
            await GetWorkSheetPODetail();
            validationworkOrderOnload();
            pleaseWaitDialogClose();
            modalSuccess("ดำเนินการไม่อนุมัติเรียบร้อยแล้ว");
        }

    });

    $("#closeAlert").on("click", function () {
        validationworkOrder();
    });

    function validationworkOrderOnload() {

        //  pleaseWaitDialog();
        $.ajax({
            url: '@Url.Action("getworkorderCurrentStatus", "Worksheet")',
            type: 'POST',
            data: '{"WorksheetID": ' + $("#hdWorksheetID").val() + '}',
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //console.log(data);


                $("#lblWorksheetStatus").text(data.DescriptionEN+' - '+data.ApproveDescriptionEN);
                $("#hdMainProcessID").val(data.ID);
                $("#hdApproveStatusID").val(data.ApproveStatusID);


                var btnSaveWO = $("#btnSaveWO");
                if (data.ID == 8 || data.ApproveStatusID == 10 || data.ApproveStatusID == 12 || data.ID == 13 || data.ID == 14) {
                    $("#Worksheet-Worksheet-detail").removeAttr("hidden");
                    $("#Worksheet-Approval").attr("hidden");

                } else if (data.ApproveStatusID == 11) {
                    $("#Worksheet-Approval").removeAttr("hidden");
                    $("#Worksheet-Worksheet-detail").attr("hidden");
                }
                if (data.ID >= 15) {
                    $("#btnCancelWorkSheet").attr('disabled', 1);
                } else {
                    $("#btnCancelWorkSheet").removeAttr("disabled");
                }
                //console.log(data);

                if (data.ID == 8 && data.ApproveStatusID<11) {
                    $("#Worksheet-Worksheet-detail :input").attr("disabled", false);
                    //$("#divchangeVendor").removeAttr("hidden");



                } else {
                    $("#Worksheet-Worksheet-detail :input").attr("disabled", true);
                    //$("#divchangeVendor").attr("hidden", "hidden");


                }

                if (data.ID < 15) {
                    $("[name*='Cause_Text']").attr("disabled", false);
                } else {
                    $("[name*='Cause_Text']").attr("disabled", true);
                }


                if (data.ApproveStatusID != 11 && data.ApproveStatusID != 12)
                {
                    $("#divApprove").attr('hidden', 'hidden');
                    if (data.ApproveStatusID == 9)
                    {
                        $("#divchangeVendor").removeAttr("hidden");
                        $("#btnAddWOItem").attr("disabled", false);
                        $("[name*='PriceConfirm']").each(function () {
                            $(this).removeAttr("disabled");
                        });
                        $("#divPriceApprove :input").attr("disabled", false);
                    } else
                    {
                        $("#divchangeVendor").attr("hidden", "hidden");
                        $("#btnAddWOItem").attr("disabled", true);
                        $("[name*='PriceConfirm']").each(function () {
                            $(this).attr("disabled", "disabled");
                        });
                        $("#divPriceApprove :input").attr("disabled", true);
                    }

                    if (data.ApproveStatusID == 10) {
                        $("#apprveDetial :input").attr("disabled", false);
                        $("#divbtnsendApprove").removeAttr("hidden");
                        $("#divApprovedRemark").removeAttr("hidden");



                    } else {
                        $("#divbtnsendApprove").attr("hidden", "hidden");
                        $("#divApprovedRemark").attr("hidden", "hidden");
                    }

                } else {
                    if (data.ApproveStatusID == 12) {
                        $("#divApprove").attr('hidden', 'hidden');
                    }
                    $("#divbtnsendApprove").attr("hidden", "hidden");
                    $("#divApprovedRemark").attr("hidden", "hidden");

                }
                $("[name*='PriceConfirmDate']").each(function () {

                    if($(this).val()!="" && $(this).closest('tr').find("#StartFixDate").val()=="")
                    {
                        $(this).closest('tr').find("#StartFix").removeAttr("disabled");
                    }else
                    {
                        $(this).closest('tr').find("#StartFix").attr("disabled", "disabled");
                    }
                });


                if (data.ID == 14) {
                    $("#WorksheetCloseConfirm").prop("disabled", false);
                    // cal create wf


                } else {
                    $("#WorksheetCloseConfirm").prop("disabled", true);

                }

                //Enable EndFix
                $("[name*='EndFix']").each(function () {
                    $(this).removeAttr("disabled");
                });

                $("#AddReceiveTable tbody tr").each(function () {


                    if($(this).find("#StartFixDate").val()!=""&&$(this).find("#EndFixDate").val()=="")
                    {
                        //alert('X');
                        $(this).find("#EndFix").removeAttr("disabled");
                    }else
                    {
                        //alert('XX');
                        $(this).find("#EndFix").attr("disabled","disabled");
                    }

                });

                $(".btnaddWorksheetPic").removeAttr("disabled");

                if ((data.ID == 15 || data.ID == 16 || data.ID == 17 || data.ID == 18) && data.ApproveStatusID > 9) {
                    btnSaveWO.attr("disabled", "disabled");

                } else {
                    btnSaveWO.removeAttr("disabled");
                }
                if ((data.ID == 15 || data.ID == 16) && $('#WorksheetCloseConfirmDate').val() !== '') {
                    $('#btnRollbackWorkSheet').css('display', 'inline');
                } else {
                    $('#btnRollbackWorkSheet').css('display', 'none');
                }


                //Enable Questionnaire button
                $('#btnModalQuestionnaire').removeAttr('disabled');



            }, error: function (request, error) {

            },
        });

    }
    function CreateRetentionWorkFlow() {

        let data = {
            worksheet_id: $("#hdWorksheetID").val(),
            systemType: 1,
            UserLogon :  '@UserDetail.CodeName'
        }

        return new Promise(async function (resolve, reject) {
            await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/CreateRetentionWorkFlow`, data, response => {
                if (response) {
                    resolve(true);
                } else {
                    resolve(false);
                }
            });
        });

    }
    function validationworkOrder() {

        //  pleaseWaitDialog();
        $.ajax({
            url: '@Url.Action("getworkorderCurrentStatus", "Worksheet")',
            type: 'POST',
            data: '{"WorksheetID": ' + $("#hdWorksheetID").val() + '}',
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                //console.log(data);


                $("#lblWorksheetStatus").text(data.DescriptionEN+' - '+data.ApproveDescriptionEN);
                $("#hdMainProcessID").val(data.ID);
                $("#hdApproveStatusID").val(data.ApproveStatusID);


                var btnSaveWO = $("#btnSaveWO");
                if (data.ID == 8 || data.ApproveStatusID == 10 || data.ApproveStatusID == 12 || data.ID == 13 || data.ID == 14) {
                    $("#Worksheet-Worksheet-detail").removeAttr("hidden");
                    $("#Worksheet-Approval").attr("hidden");

                } else if (data.ApproveStatusID == 11) {
                    $("#Worksheet-Approval").removeAttr("hidden");
                    $("#Worksheet-Worksheet-detail").attr("hidden");
                }
                if (data.ID >= 15) {
                    $("#btnCancelWorkSheet").attr('disabled', 1);
                } else {
                    $("#btnCancelWorkSheet").removeAttr("disabled");
                }
                //console.log(data);

                if (data.ID == 8 && data.ApproveStatusID<11) {
                    $("#Worksheet-Worksheet-detail :input").attr("disabled", false);


                } else {
                    $("#Worksheet-Worksheet-detail :input").attr("disabled", true);


                }

                if (data.ID < 15) {
                    $("[name*='Cause_Text']").attr("disabled", false);
                } else {
                    $("[name*='Cause_Text']").attr("disabled", true);
                }

                if (data.ApproveStatusID != 11 && data.ApproveStatusID != 12) {
                    $("#divApprove").attr('hidden', 'hidden');
                    if (data.ApproveStatusID == 9) {
                        $("#divchangeVendor").removeAttr("hidden");
                        $("#btnAddWOItem").attr("disabled", false);

                        $("[name*='PriceConfirm']").each(function () {
                            $(this).removeAttr("disabled");
                        });

                        $("#divPriceApprove :input").attr("disabled", false);

                        bindingApproveDetail();

                    } else {

                        $("#divchangeVendor").attr("hidden", "hidden");
                        $("#btnAddWOItem").attr("disabled", true);

                        $("[name*='PriceConfirm']").each(function () {
                            $(this).attr("disabled", "disabled");
                        });

                        $("#divPriceApprove :input").attr("disabled", true);
                    }

                    if (data.ApproveStatusID == 10) {
                        $("#apprveDetial :input").attr("disabled", false);
                        $("#divbtnsendApprove").removeAttr("hidden");
                        $("#divApprovedRemark").removeAttr("hidden");

                        bindingApproveDetail();

                    } else {
                        $("#divbtnsendApprove").attr("hidden", "hidden");
                        $("#divApprovedRemark").attr("hidden", "hidden");
                    }

                } else {
                    if (data.ApproveStatusID == 12) {
                        $("#divApprove").attr('hidden', 'hidden');
                    }
                    bindingApproveDetail();
                }
                $("[name*='PriceConfirmDate']").each(function () {

                    //console.log($(this).val(),$(this).closest('tr').find("#StartFix").val())

                    if($(this).val()!="" && $(this).closest('tr').find("#StartFixDate").val()=="")
                    {
                        $(this).closest('tr').find("#StartFix").removeAttr("disabled");
                    }else
                    {
                        $(this).closest('tr').find("#StartFix").attr("disabled", "disabled");

                    }
                });


                if (data.ID == 14) {
                    $("#WorksheetCloseConfirm").prop("disabled", false);



                } else {
                    $("#WorksheetCloseConfirm").prop("disabled", true);

                }

                //Enable EndFix
                $("[name*='EndFix']").each(function () {
                    $(this).removeAttr("disabled");
                });

                $("#AddReceiveTable tbody tr").each(function () {


                    if($(this).find("#StartFixDate").val()!=""&&$(this).find("#EndFixDate").val()=="")
                    {
                        //alert('X');
                        $(this).find("#EndFix").removeAttr("disabled");
                    }else
                    {
                        //alert('XX');
                        $(this).find("#EndFix").attr("disabled","disabled");
                    }

                });

                $(".btnaddWorksheetPic").removeAttr("disabled");

                if ((data.ID == 15 || data.ID == 16 || data.ID == 17 || data.ID == 18) && data.ApproveStatusID > 9) {
                    btnSaveWO.attr("disabled", "disabled");

                } else {
                    btnSaveWO.removeAttr("disabled");
                }
                if ((data.ID == 15 || data.ID == 16) && $('#WorksheetCloseConfirmDate').val() !== '') {
                    $('#btnRollbackWorkSheet').css('display', 'inline');
                } else {
                    $('#btnRollbackWorkSheet').css('display', 'none');
                }


                //Enable Questionnaire button
                $('#btnModalQuestionnaire').removeAttr('disabled');



            }, error: function (request, error) {

            },
        });

    }

    function calculatePrice() {
        var total = 0.00
        var MatailF = 0.00
        var MatailS = 0.00
        var WageF = 0.00
        var WageS = 0.00
        var Quantity = $("#VendorFixPrice_Quantity").val();

        if ($("#chkVendorFixPrice_MainMateria").prop('checked')) {
            MatailF = $("#txtVendorFixPrice_MainMateriaPrice").val();
        }
        if ($("#chkVendor_SpecialMateria").prop('checked')) {
            MatailS = $("#txtVendor_SpecialMateriaPrice").val();
        }
        if ($("#chkVendorFixPrice_MainWagePrice").prop('checked')) {
            WageF = $("#txtVendorFixPrice_MainWagePrice").val();
        }
        if ($("#chkVendorFixPrice_SpecialWage").prop('checked')) {
            WageS = $("#txtVendor_SpecialWagePrice").val();
        }

        //alert(parseFloat(MatailF) + parseFloat(MatailS)+parseFloat(WageF) + parseFloat(WageS));
        total = (parseFloat(MatailF) + parseFloat(MatailS)+parseFloat(WageF) + parseFloat(WageS)) * parseFloat(!Quantity ? 0 : Quantity);
        //console.log(Matail, Wage, Quantity, total);

        $("#lblVendorFixPrice_TotalPrice").text(addCommas((total).toFixed(2)));

    }


    $("#VendorFixPrice_Quantity").keyup(function () {
        calculatePrice();
    });

    $("#txtVendor_SpecialMateriaPrice").keyup(function () {
        calculatePrice();
    });

    $("#txtVendor_SpecialWagePrice").keyup(function () {
        calculatePrice();
    });

    $("#chkVendorFixPrice_MainMateria").change(function () {

        if ($(this).prop('checked')) {
            $("#txtVendor_SpecialMateriaPrice").prop('disabled', 'disabled')
            $("#chkVendor_SpecialMateria").prop('checked', false);
            $("#chkVendor_SpecialMateria").prop('disabled', 'disabled')

        } else {
            $("#txtVendor_SpecialMateriaPrice").removeAttr('disabled');
            //$("#chkVendor_SpecialMateria").prop('checked', true);
            $('#chkVendor_SpecialMateria').removeAttr('disabled')

        }
        calculatePrice();
    });

    $("#chkVendorFixPrice_MainWagePrice").change(function () {
        if ($(this).prop('checked')) {
            $("#txtVendor_SpecialWagePrice").prop('disabled', 'disabled')
            $("#chkVendorFixPrice_SpecialWage").prop('checked', false);
            $("#chkVendorFixPrice_SpecialWage").prop('disabled', 'disabled')

        } else {
            $("#txtVendor_SpecialWagePrice").removeAttr('disabled');
            //$("#chkVendor_SpecialMateria").prop('checked', true);
            $('#chkVendorFixPrice_SpecialWage').removeAttr('disabled')

        }

        calculatePrice();
    });

    $("#chkVendor_SpecialMateria").change(function () {
        if ($(this).prop('checked')) {
            $("#chkVendorFixPrice_MainMateria").prop('checked', false);
            $("#chkVendorFixPrice_MainMateria").prop('disabled', 'disabled')
        } else {

            $('#chkVendorFixPrice_MainMateria').removeAttr('disabled')
        }

        calculatePrice();
    });


    $("#chkVendorFixPrice_SpecialWage").change(function () {
        if ($(this).prop('checked')) {
            $("#chkVendorFixPrice_MainWagePrice").prop('disabled', 'disabled')

        } else {


            $("#chkVendorFixPrice_MainWagePrice").prop('checked', false);
            $('#chkVendorFixPrice_MainWagePrice').removeAttr('disabled')

        }

        calculatePrice();
    });

    //สถานะผู้แจ้ง ถ้าเป็นเจ้าบ้านจะไม่แสดงชื่อผู้แจ้งและเบอร์ติดต่อ
    if ($("#Data_Inform_Inform_CustomerType_Name").val() == "เจ้าของบ้าน") {
        $("[name*='Inform_CustomerName']").hide();
        $("[name*='Inform_CustomerTel']").hide();
    }
    else {
        $("[name*='Inform_CustomerName']").show();
        $("[name*='Inform_CustomerTel']").show();
    }

    //inline function
    function bindingfixPrice(WorksheetitemID) {
        $.ajax({

            url: '@Url.Action("getlistWorksheetitemDetail", "Worksheet")',
            type: "POST",
            data: '{"WorksheetitemID": ' + WorksheetitemID + '}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {
                alert(response.responseText);

            },
            success: function (response) {
                $("#tbWorksheetitemDetail tbody tr").remove();
                //console.log(response.length);
                if (response.length == 0) {
                    $("#tbWorksheetitemDetail tbody").append("<tr></tr>");
                    $("#tbWorksheetitemDetail tbody tr").append("<td class='text-center Bold text-danger' colspan='14'>ไม่มีข้อมูล</td>");
                }
                else {
                    $.each(response, function (Index, Value) {
                        $("#tbWorksheetitemDetail tbody").append("<tr></tr>");
                        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-center'><label id='lblNo' name='No'>" + (Index + 1) + "</label><input id='hdWorksheetitemDetailID' type='hidden'  value='" + Value.ID + "'/></td>");
                        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><input type='hidden'  id='hdlist1'/><p type='text' id='list1' name='list1'>" + Value.Listname1 + "</p></td>");
                        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><input type='hidden'  id='hdlist2'/><p type='text' id='list2' name='list2'>" + Value.Listname2 + "</p></td>");
                        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><input type='hidden'  id='hdlist3'/><p type='text' id='list3' name='list3'>" + Value.Listname3 + "</p></td>");
                        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><input type='hidden'  id='hdlist4'/><p type='text' id='list4' name='list4'>" + Value.Listname4 + "</p></td>");


                        if(Value.PriceMaterialType=="@EnumConfiguration.PriceType.Std.GetHashCode()")
                        {
                            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right success'><label id='lblmainmateriaPrice' name='mainmateriaPrice'>" + addCommas((Value.MainMateria).toFixed(2)) + "</label></td>");


                        }else
                        {
                            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right'><label id='lblmainmateriaPrice' name='mainmateriaPrice'>" + addCommas((Value.MainMateria).toFixed(2)) + "</label></td>");

                        }


                        if(Value.PriceWageType=="@EnumConfiguration.PriceType.Std.GetHashCode()")
                        {

                            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right success'><label id='lblmainwagePrice' name='mainwagePrice'>" + addCommas((Value.MainWagePrice).toFixed(2)) + "</label></td>");

                        }else
                        {
                            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right'><label id='lblmainwagePrice' name='mainwagePrice'>" + addCommas((Value.MainWagePrice).toFixed(2)) + "</label></td>");

                        }


                        if(Value.PriceMaterialType=="@EnumConfiguration.PriceType.Extra.GetHashCode()")
                        {
                            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right success'><label id='lblspacialmateriaPrice' name='spacialmateriaPrice'>" + addCommas((Value.Special_Materia).toFixed(2)) + "</label></td>");

                        }else
                        {
                            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right'><label id='lblspacialmateriaPrice' name='spacialmateriaPrice'>" + addCommas((Value.Special_Materia).toFixed(2)) + "</label></td>");
                        }

                        if(Value.PriceWageType=="@EnumConfiguration.PriceType.Extra.GetHashCode()")
                        {
                            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right success'><label id='lblspacialmainwagePrice' name='spacialmainwagePrice'>" + addCommas((Value.Special_WagePrice).toFixed(2)) + "</label></td>");
                        }else
                        { $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right'><label id='lblspacialmainwagePrice' name='spacialmainwagePrice'>" + addCommas((Value.Special_WagePrice).toFixed(2)) + "</label></td>");

                        }


                        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><label id='lblpriceUnit' name='priceUnit'>" + Value.Unit + "</label></td>");
                        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><label id='lblpriceQuantity' name='priceQuantity'>" + Value.Quantity + "</label></td>");
                        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><label id='lblpriceTotal' name='priceTotal'>" + addCommas((Value.TotalPrice).toFixed(2)) + "</label></td>");
                        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><label id='lblpriceRemark' name='priceRemark'>" + Value.Remark + "</label></td>");
                        if ("@EnumConfiguration.Role.PMR.ToString()" != "@UserDetail.Role")

                        {
                            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-center'><a id='removeworkoderItem' name='removeworkoderItem' data-value='" + Value.ID + "'><i class='fa fa-remove' /></a></td>");
                        }
                    });
                }
                $("[name*='removeworkoderItem']").click(function () {
                    values = {
                        Worksheet_ID: $("#hdWorksheetID").val(),
                        Worksheet_Item_Detail_ID : $(this).data("value"),
                        TD_Worksheet_Item_ID: $("#hdWorksheetitemID").val(),
                        UpdateBy: "@UserDetail.CodeName",

                    }
                    deleteWorksheetitemDetail(values,$(this))
                });

                var sumPrice = 0.00;
                $("[name*='priceTotal']").each(function () {

                    sumPrice = sumPrice + parseFloat($(this).text().replace(',', ''));
                    //console.log(parseFloat($(this).text()));
                });

                $("#lbltotalPrice").text(addCommas((sumPrice).toFixed(2)));
            },

        });
    }

    function getList2() {

        var ddlList1 = $("[id*=hclist1]");


        $.ajax({
            url: "@Url.Action("getList2", "Master")",
            type: "POST",
            data: '{"List1ID": ' + ddlList1.val() + '}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {
                alert(response.responseText);

            },
            success: function (response) {

                var ddlList2 = $("[id*=hclist2]");
                var ddlList3 = $("[id*=hclist3]");
                var ddlList4 = $("[id*=hclist4]");

                ddlList2.empty().append('<option selected="selected" value="">กรุณาเลือกข้อมูล</option>');
                ddlList3.empty().append('<option selected="selected" value="">กรุณาเลือกข้อมูล</option>');
                ddlList4.empty().append('<option selected="selected" value="">กรุณาเลือกข้อมูล</option>');

                $.each(response, function (Index, Value) {

                    //console.log(Value);
                    ddlList2.append($("<option value=" + Value.value + ">" + Value.text + "</option>"))
                });

            }
        });
    }

    function getList3() {

        var ddlList2 = $("[id*=hclist2]");
        $.ajax({
            url: "@Url.Action("getList3", "Master")",
            type: "POST",
            data: '{"List2ID": ' + ddlList2.val() + '}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {
                alert(response.responseText);

            },
            success: function (response) {

                var ddlList3 = $("[id*=hclist3]");
                var ddlList4 = $("[id*=hclist4]");


                ddlList3.empty().append('<option selected="selected" value="">กรุณาเลือกข้อมูล</option>');
                ddlList4.empty().append('<option selected="selected" value="">กรุณาเลือกข้อมูล</option>');

                $.each(response, function (Index, Value) {

                    //console.log(Value);
                    ddlList3.append($("<option value=" + Value.value + ">" + Value.text + "</option>"))
                });

            }
        });
    }

    function getList4() {

        var ddlList3 = $("[id*=hclist3]");
        $.ajax({
            url: "@Url.Action("getList4", "Master")",
            type: "POST",
            data: '{"List3ID": ' + ddlList3.val() + '}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {
                alert(response.responseText);
            },
            success: function (response) {
                var ddlList4 = $("[id*=hclist4]");
                ddlList4.empty().append('<option selected="selected" value="">กรุณาเลือกข้อมูล</option>');

                $.each(response, function (Index, Value) {

                    //console.log(Value);
                    ddlList4.append($("<option value=" + Value.value + ">" + Value.text + "</option>"))
                });

            }
        });
    }
    function getList4Unit() {
        var ddlList4 = $("[id*=hclist4]");
        $.ajax({
            url: "@Url.Action("getList4Unit", "Master")",
            type: "POST",
            data: '{"List4ID": ' + ddlList4.val() + '}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {
                alert(response.responseText);
            },
            success: function (response) {
                $("#lblVendorFixPrice_Unit").text(response.Unit);

                if (response.GoodsPrice == null)
                    $("#txtVendorFixPrice_MainMateriaPrice").val("0.00");
                else
                    $("#txtVendorFixPrice_MainMateriaPrice").val(addCommas((response.GoodsPrice).toFixed(2)));

                if (response.WagePerUnit == null)
                    $("#txtVendorFixPrice_MainWagePrice").val("0.00");
                else
                    $("#txtVendorFixPrice_MainWagePrice").val(addCommas((response.WagePerUnit).toFixed(2)));
            }
        });
    }


    function addWorksheetItem() {

        //หมวดงานที่ ผรม. ต้องซ่อม
        var list1Text = $("#hclist1 option:selected").text();
        var list1Val = $("#hclist1 option:selected").val();
        //รายละเอียดที่ซ่อม
        var list2Text = $("#hclist2 option:selected").text();
        var list2Val = $("#hclist2 option:selected").val();
        //ลักษณะปัญหา
        var list3Text = $("#hclist3 option:selected").text();
        var list3Val = $("#hclist3 option:selected").val();
        //วิธีการซ่อม
        var list4Text = $("#hclist4 option:selected").text();
        var list4Val = $("#hclist4 option:selected").val();
        //ค่าวัสดุ(ราคากลาง)
        var fixmateriaPrice;
        if ($("#chkVendorFixPrice_MainMateria").prop('checked')) {
            fixmateriaPrice = $("#txtVendorFixPrice_MainMateriaPrice").val();
        } else {
            fixmateriaPrice = 0.00;
        }
        //ค่าแรง (ราคากลาง)
        var fixmainwagePrice;
        if ($("#chkVendorFixPrice_MainWagePrice").prop('checked')) {
            fixmainwagePrice = $("#txtVendorFixPrice_MainWagePrice").val();
        } else {
            fixmainwagePrice = 0.00;
        }

        //ค่าวัสดุ (ราคาพิเศษ)
        var spacialmateriaPrice;
        if ($("#chkVendor_SpecialMateria").prop('checked')) {
            spacialmateriaPrice = $("#txtVendor_SpecialMateriaPrice").val();
        } else {
            spacialmateriaPrice = 0.00;
        }

        //ค่าแรง(ราคาพิเศษ)
        var spacialmainwagePrice;
        if ($("#chkVendorFixPrice_SpecialWage").prop('checked')) {
            spacialmainwagePrice = $("#txtVendor_SpecialWagePrice").val();
        } else {
            spacialmainwagePrice = 0.00;
        }

        var PriceMaterialType;
        var PriceWageType;
        // PriceMaterialType = 1 stdPrice
        // PriceMaterialType = 2 SpecialPrice
        if ($("#chkVendorFixPrice_MainMateria").prop('checked')) {
            PriceMaterialType = 1
        } else {
            PriceMaterialType = 2
        }
        if ($("#chkVendorFixPrice_MainWagePrice").prop('checked')) {
            PriceWageType = 1
        } else {
            PriceWageType = 2
        }



        //หน่วย
        var priceUnit = $("#lblVendorFixPrice_Unit").text();
        //ปริมาณ

        var priceQuantity = $("#VendorFixPrice_Quantity").val();
        //ราคารวม
        var priceTotal = $("#lblVendorFixPrice_TotalPrice").text();
        //หมายเหตุ
        var priceRemark = $("#txtVendorFixPrice_Remark").val();



        if ($("#tbWorksheetitemDetail tbody tr:last").find("#lblNo").length == 0) {
            $("#tbWorksheetitemDetail tbody tr").remove();
        }
        var rowCount = $("#tbWorksheetitemDetail tbody tr").length;

        $("#tbWorksheetitemDetail tbody").append("<tr></tr>");
        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-center'><label id='lblNo' name='No'>" + (rowCount + 1) + "</label><input type='hidden'  value='0' id='hdWorksheetitemDetailID'></td>");
        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><input type='hidden' value='" + list1Val + "' id='hdlist1'/><p type='text' id='list1' name='list1'>" + list1Text + "</p></td>");
        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><input type='hidden' value='" + list2Val + "' id='hdlist2'/><p type='text' id='list2' name='list2'>" + list2Text + "</p></td>");
        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><input type='hidden' value='" + list3Val + "' id='hdlist3'/><p type='text' id='list3' name='list3'>" + list3Text + "</p></td>");
        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><input type='hidden' value='" + list4Val + "' id='hdlist4'/><p type='text' id='list4' name='list4'>" + list4Text + "</p></td>");
        if(PriceMaterialType==1)
        {
            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right success'><label id='lblmainmateriaPrice' name='mainmateriaPrice'>" + fixmateriaPrice + "</label></td>");
        }else
        {
            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right'><label id='lblmainmateriaPrice' name='mainmateriaPrice'>" + fixmateriaPrice + "</label></td>");
        }

        if(PriceWageType==1)
        {
            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right success'><label id='lblmainwagePrice' name='mainwagePrice'>" + fixmainwagePrice + "</label></td>");
        }else
        {
            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right'><label id='lblmainwagePrice' name='mainwagePrice'>" + fixmainwagePrice + "</label></td>");
        }
        if(PriceMaterialType==2)
        {
            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right success'><label id='lblspacialmateriaPrice' name='spacialmateriaPrice'>" + spacialmateriaPrice + "</label></td>");
        }else
        {
            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right'><label id='lblspacialmateriaPrice' name='spacialmateriaPrice'>" + spacialmateriaPrice + "</label></td>");
        }

        if(PriceWageType==2)
        {
            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right success'><label id='lblspacialmainwagePrice' name='spacialmainwagePrice'>" + spacialmainwagePrice + "</label></td>");
        }else
        {
            $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-right'><label id='lblspacialmainwagePrice' name='spacialmainwagePrice'>" + spacialmainwagePrice + "</label></td>");
        }


        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><label id='lblpriceUnit' name='priceUnit'>" + priceUnit + "</label></td>");
        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><label id='lblpriceQuantity' name='priceQuantity'>" + priceQuantity + "</label></td>");
        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><label id='lblpriceTotal' name='priceTotal'>" + priceTotal + "</label></td>");
        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-left'><label id='lblpriceRemark' name='priceRemark'>" + priceRemark + "</label></td>");
        $("#tbWorksheetitemDetail tbody tr:last").append("<td class='text-center'><a id='removeworkoderItem' name='removeworkoderItem' data-value='0'><i class='fa fa-remove' /></a></td>");

        $("[name*='removeworkoderItem']").click(function () {
            values = {
                Worksheet_ID: $("#hdWorksheetID").val(),
                Worksheet_Item_Detail_ID : $(this).data("value"),
                TD_Worksheet_Item_ID: $("#hdWorksheetitemID").val(),
                UpdateBy: "@UserDetail.CodeName",

            }
            deleteWorksheetitemDetail(values,$(this))
        });
        var sumPrice = 0.00;
        $("[name*='priceTotal']").each(function () {

            sumPrice = sumPrice + parseFloat($(this).text().replace(',', ''));
            //console.log(parseFloat($(this).text()));
        });
        //alert(sumPrice);
        $("#lbltotalPrice").text(addCommas((sumPrice).toFixed(2)));

        var Order = (rowCount + 1);
        var List1 = list1Val;
        var List2 = list2Val;
        var List3 = list3Val;
        var List4 = list4Val;
        //var mainmateriaPrice = fixmateriaPrice;
        //var mainwagePrice = $(this).find("#lblmainwagePrice").text();
        var SpacialmateriaPrice = spacialmateriaPrice;
        var SpacialmainwagePrice = spacialmainwagePrice;
        var Quantity = priceQuantity;
        var Remark = priceRemark;

        values = {
            Worksheet_ID: $("#hdWorksheetID").val(),
            Worksheet_Item_Detail_ID: 0,
            TD_Worksheet_Item_ID: $("#hdWorksheetitemID").val(),
            Order: Order,
            List1_ID: List1,
            List2_ID: List2,
            List3_ID: List3,
            List4_ID: List4,
            Special_Materia: SpacialmateriaPrice,
            Special_WagePrice: SpacialmainwagePrice,
            Quantity: Quantity,
            Remark: Remark,
            CreateBy: "@UserDetail.CodeName",
            PriceMaterialType: PriceMaterialType,
            PriceWageType: PriceWageType
        }

        insertWorksheetitemDetail(values);
    }

    async function bindingPaymentType(approveType, warrantyExpired) {
        //console.log(approveType, warrantyExpired)
        $.ajax({
            url: '@Url.Action("getListPaymentType", "Master")',
            type: 'POST',
            async:true,
            data: '{"approvedType": "' + approveType + '" , "warrantyExpired": ' + warrantyExpired + '}',
            contentType: "application/json; charset=utf-8",
            async: false,
            success: function (data) {
                if (data.length > 0) {
                    var PaymentType = $("[id*=PaymentType]");
                    PaymentType.empty().append('<option selected="selected" value="">Please select</option>');
                    $.each(data, function (Index, Value) {
                        PaymentType.append($("<option></option>").val(Value.Code).html(Value.Des));
                    });
                    if ($('input:radio[name="AprrovedType"]').filter('[value="' + approveType + '"]').prop('checked')) {
                        $(".boxPaymentType").removeClass('hidden');
                    }
                }
            },
            error: function (data) { },
        });
    }

    function itemAddvendor() {

        //Clear Vendor Search
        clearVendorSearch();

        $("#modalAddVendor").appendTo("body").modal('show');
        $("#tbAddvendor tbody tr").remove();

        $("#tbAddvendor tbody").append("<tr></tr>");
        $("#tbAddvendor tbody tr").append("<td class='text-center Bold text-danger' colspan='6'>ไม่มีข้อมูล</td>");


    }

    function itemAddvendorRetention() {

        //Clear Vendor Search
        clearVendorSearch();

        $("#modalAddVendor").appendTo("body").modal('show');
        $("#tbAddvendor tbody tr").remove();

        $("#tbAddvendor tbody").append("<tr></tr>");
        $("#tbAddvendor tbody tr").append("<td class='text-center Bold text-danger' colspan='6'>ไม่มีข้อมูล</td>");


    }

    async function updateWorksheetDetail(values) {
        var oldStatus = await ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/getworkorderCurrentStatus?id=${values.Worksheet_ID}`);
        return  new Promise(async function(resolve, reject) {
            $.ajax({
                url: '@Url.Action("updateWorksheet", "Worksheet")',
                type: 'POST',
                data: values,
                traditional: true,
                async: false,
                success: function (data) {
                    if (oldStatus) {
                        ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/SendMailCloseWorkSheet?id=${values.Worksheet_ID}&oldStatus=${oldStatus.data}`);
                    }

                    resolve(true);

                },
                error: function (data) {
                    resolve(false);
                },
            });
        });

    }

    function insertWorksheetitemDetail(values) {
        pleaseWaitDialog();
        $.ajax({
            url: '@Url.Action("insertWorksheetitemDetail", "Worksheet")',
            type: 'POST',
            data: values,
            traditional: true,
            success: function (data) {
                if ($('#chkVendorFixPrice_MainMateria').is(':checked')) {
                    $('#chkVendorFixPrice_MainMateria').prop('checked', false);
                    $('#txtVendorFixPrice_MainMateriaPrice').val(0);
                }

                if ($('#chkVendorFixPrice_MainWagePrice').is(':checked')) {
                    $('#chkVendorFixPrice_MainWagePrice').prop('checked', false);
                    $('#txtVendorFixPrice_MainWagePrice').val(0);
                }
                refreshTotalPrice(data);
                pleaseWaitDialogClose();
                modalSuccess();
                //if (data)
                //    modalSuccess();
            },
            error: function (data) {

            },
        });
    }
    function deleteWorksheetitemDetail(values,row) {
        pleaseWaitDialog();
        $.ajax({
            url: '@Url.Action("deleteWorksheetitemDetail", "Worksheet")',
            type: 'POST',
            data: values,
            traditional: true,
            success: function (data) {

                pleaseWaitDialogClose();
                //console.log(data.length)
                if(data.length<=10)
                {
                    refreshTotalPrice(data);
                    modalSuccess();

                    row.closest('tr').remove();

                    var rowCount = $("#tbWorksheetitemDetail tbody tr").length;
                    if(rowCount==0)
                    {
                        $("#tbWorksheetitemDetail tbody").append("<tr></tr>");
                        $("#tbWorksheetitemDetail tbody tr").append("<td class='text-center Bold text-danger' colspan='14'>ไม่มีข้อมูล</td>");
                    }

                    var sumPrice = 0.00;
                    $("[name*='priceTotal']").each(function () {

                        sumPrice = sumPrice + parseFloat($(this).text().replace(',', ''));
                        //console.log(parseFloat($(this).text()));
                    });

                    $("#lbltotalPrice").text(addCommas((sumPrice).toFixed(2)));

                }else
                {
                    modalWaring(data);
                }

            },
            error: function (data) {

            },
        });
    }

    function refreshTotalPrice(data) {
        $("#lblTotalUnit").text(data);
        calNetPricebyOperating($("#txtOperatingPercent"));
        //calNetPricebyVat($("#txtVatPercent"));
    }

    function updateWorksheetItem(values) {

        return  new Promise((resolve, reject) => {
            $.ajax({
                url: '@Url.Action("updateWorksheetitem", "Worksheet")',
                type: 'POST',
                data: values,
                traditional: true,
                async: false,
                success: function (data) {
                    resolve(true);
                },
                error: function (data) {
                    resolve(false);
                },
            });
        });
    }

    async function sendApprovedWorksheet(values,retentionFlag) {

        await InsertApprove(values);

        return  new Promise(async function (resolve, reject) {
            if ($('input[name=AprrovedType]:checked').val() === 'Y' && !retentionFlag) {
                let data = {
                    TD_WorkSheet_ID: values.Worksheet_ID,
                    Role: "@UserDetail.Role"
                }
                let isLastApprove = await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/CheckIsLastApprove`, data);
                if (isLastApprove) {
                    if (isLastApprove.data.lastApprove)
                    {
                        let dataPO = {
                            WorkSheetId: values.Worksheet_ID,
                            systemType: 1,
                            UserLogon: '@UserDetail.CodeName'
                        }
                        await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/SaveCreatePOHeader`, dataPO, response => {

                            if (response.status) {
                                resolve(true);
                            } else {
                                resolve(false);
                            }
                        });
                    } else {
                        resolve(false);
                    }
                } else {
                    resolve(false);
                }
            } else {
                resolve(false);
            }
        });
    }

    function ApprovedWorksheet(approveAction,approveType) {

        var values = {
            Worksheet_ID: $("#hdWorksheetID").val(),
            PaymentType: $('input[name=AprrovedType]:checked').val(),
            PaymentType_ID: $("#PaymentType").val(),
            Role: "@UserDetail.Role",
            Remark: $("#ApprovalRemark").val(),
            User: "@UserDetail.CodeName",
            ApproveVal: approveAction,
            Unit_Code: $("#hdUnitCode").val(),
            Unit_ID: $("#hdUnitID").val(),
            ApproveType:approveType
        }

        var resCreatePO ;
        let isLastApprove = {
            data: { lastApprove: false }
        };
        return  new Promise(async function (resolve, reject) {
            $.ajax({
                url: '@Url.Action("ApprovedWorksheet", "Worksheet")',
                type: 'POST',
                data: values,
                traditionPJ_ID: true,
                success: async function (data) {
                    var res;
                    if (data) {
                        if ($('#hdVendorRetention').val() == "false") {
                            let data = {
                                TD_WorkSheet_ID: $("#hdWorksheetID").val(),
                                Role :  "@UserDetail.Role"
                            }
                            isLastApprove = await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/CheckIsLastApprove`, data);
                            if (isLastApprove) {
                                if (isLastApprove.data.lastApprove) {
                                    let dataPO = {
                                        WorkSheetId: values.Worksheet_ID,
                                        systemType: 1,
                                        UserLogon :  '@UserDetail.CodeName'
                                    }
                                    resCreatePO = await callSapCreatePO(dataPO);

                                }

                            }
                        }

                        if (approveType == 2) {
                            if (isLastApprove.data.lastApprove) {
                                if (resCreatePO.data.type == "S") {
                                    res = {
                                        result : true,
                                        msg : "ระบบดำเนินการส่งอนุมัติ และ สร้างเลขที่ใบ PO เรียบร้อยแล้ว"
                                    }
                                    resolve(res);
                                } else {
                                    res = { result : false, msg : "สร้างเลขที่ใบ PO ไม่สำเร็จ, " + resCreatePO.data.message }
                                    resolve(res);
                                }
                            } else {
                                res = { result : true, msg : "ระบบดำเนินการส่งอนุมัติเรียบร้อยแล้ว" };
                                resolve(res);
                            }
                        }
                        else
                        {
                            //clear values
                            $("#AddReceiveTable tbody tr").each(function () {

                                var row = $(this);
                                //claer Is check confirm
                                var chkPriceConfirm = row.find("#PriceConfirm");
                                chkPriceConfirm.prop('checked',false);
                                chkPriceConfirm.prop( 'disabled', false );
                                //Clear Confirm
                                var txtPriceConfirmDate = row.find("#PriceConfirmDate");
                                txtPriceConfirmDate.val("");
                            });
                            res = { result: false, msg: "ระบบดำเนินการไม่อนุมัติเรียบร้อยแล้ว" }
                            resolve(res);
                            // resolve(true);
                        }

                    }
                },
            error: function (data,err) {
                reject(err);
            },
            });
    });

    }
    function bindingApproveDetail() {
        return  new Promise(async function (resolve, reject) {
            $.ajax({
                url: '@Url.Action("getApproveDetail", "Worksheet")',
                type: 'POST',
                async: true,
                data: '{"WorksheetID": ' + $("#hdWorksheetID").val() + '}',
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    if ($("#hdApproveStatusID").val() == (@EnumConfiguration.MainProcessStatus.WaitingForApproved.GetHashCode()))
                    {
                        if ("@UserDetail.Role" != data.NextRole)
                            {
                            $("#divApprove").attr('hidden', 'hidden');

                            if ("@UserDetail.Role" == "@EnumConfiguration.Role.HC.ToString()")
                            {
                                if (data.HcReject == 1)
                                {
                                    $("#divApprove").removeAttr('hidden');
                                    $("#btnApproved").hide();
                                }
                            }
                        }
                        else
                        {
                            $("#divApprove").removeAttr('hidden');
                        }
                    }

                    $("#hdApproveID").val(data.Approve_ID);
                    $("#lblApprove_JobNoText").text(data.Approve_JobNoText);
                    $("#lblApprove_Status").text(data.Approve_StatusText);
                    $("#lblApprove_CreatedDate").text(data.Approve_CreatedDate);
                    $("#lblApprove_CreatedBy").text(data.Approve_CreatedBy);
                    $('input[type=radio][name=AprrovedType]').attr('checked', false);
                    if (data.PaymentType != null) {
                        $('input:radio[name="AprrovedType"]').filter('[value="' + data.PaymentType + '"]').attr('checked', true);
                    }


                    bindingPaymentType(data.PaymentType, $("#hdWarrantyExpired").val())

                    $("#PaymentType option[value='" + data.PaymentTypeID + "']").prop('selected', true);
                    resolve(true);
                },
                error:  function (request, error) {
                    bindingPaymentType($('input[name=AprrovedType]:checked').val(), $("#hdWarrantyExpired").val())
                    //  console.log('error');
                    resolve(false);
                },
            });

        });

    }
    function showModalLineApprveWarning(msg) {
        $('#modalWaring').modal('show');
        $('#lbTxtWarning').text(msg);
    }
    function SearchVendor() {
        var values = {
            Name: $("#textCrivendorName").val(),
            TaxID: $("#textCriIDCard").val(),
            Vendor: $("#textCrivendorCode").val() == "" ? "": $("#textCrivendorCode").val()
        }
        pleaseWaitDialog();
        $.ajax({
            url: '@Url.Action("getListVendormaster", "Master")',
            type: 'POST',
            data: values,
            traditional: true,
            success: function (data) {
                $("#tbAddvendor tbody tr").remove();

                if (data.length == 0) {
                    $("#tbAddvendor tbody").append("<tr></tr>");
                    $("#tbAddvendor tbody tr").append("<td class='text-center Bold text-danger' colspan='6'>ไม่มีข้อมูล</td>");
                } else {
                    $.each(data, function (key, value) {
                        $("#tbAddvendor tbody").append("<tr></tr>");
                        $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\"><label id='VendorCode'>" + value.Vendor.substr(value.Vendor.length - 6) + "</label></td>");
                        $("#tbAddvendor tbody tr:last").append("<td class=\"text-left\"><label id='VendorName'>" + value.Name + "</lable></td>");
                        $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\">" + value.CardID + "</td>");
                        $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\">" + value.TaxID + "</td>");
                        $("#tbAddvendor tbody tr:last").append("<td class=\"text-left\"><label id='VendorAddrNew'>" + value.Address + "</lable></td>");
                        $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\"><a id='selectVendor' name='selectVendor[]'>เลือก</a></td>");
                    });


                    $("[name*='selectVendor[]']").each(function (idx, elem) {
                        $(this).click(function () {

                            @*if ($("#RemarkVendor").val() == "" && $("#RemarkVendor").is(":hidden") === true) {
                                modalWaring('กรุณาระบุเหตุผลในการเปลี่ยนผู้รับเหมา');
                                return;
                            }
                            var obj = {}
                            obj["vendorCode"] = $("#hdVendorID").val();
                            obj["vendorName"] = $('#lblVendorName').text();
                            myRows_old.push(obj)


                            var myRows_new = [];
                                var obj = {}
                                obj["vendorCode"] = $(this).closest('tr').find("#VendorCode").text();
                                obj["vendorName"] = $(this).closest('tr').find("#VendorName").text();
                                myRows_new.push(obj)

                                var data = {
                                    ID: $("#hdWorksheetID").val(),
                                    ReceiveJobNo: $('#lbHdWorkSheet_JobNoText').text(),
                                    projectCode: "@Model.Data_Unit.PJ_Code",
                                    projectName: "@Model.Data_Unit.PJ_Code" + '-' + "@Model.Data_Unit.PJ_Name",
                                    EditType: "แก้ไขผู้รับเหมา",
                                    Remark: $('#RemarkVendor').val(),
                                    UserLogin : "@UserDetail.CodeName",
                                    DetailVendor_old: myRows_old,
                                    DetailVendor_new: myRows_new
                            };

                                ajaxPost(`${baseUrl}/homecare/api/v1/Receive/SaveEditDataSendApprove`, data, response => {

                                    if (response) {
                                        page.loading();
                                        $('#lbStatusEditData').show();
                                        $("#modalAddVendor").appendTo("body").modal('hide');
                                        showModalLineApprveSuccess('ส่งคำขอแก้ไขข้อมูลเรียบร้อยแล้ว');
                                        page.loaded();

                                    } else {
                                        showModalLineApprveWarning('เกิดข้อผิดพลาด บันทึกไม่สำเร็จ');
                                    }
                                });*@
                            var VendorCode = $(this).closest('tr').find("#VendorCode").text();
                            var VendorName = $(this).closest('tr').find("#VendorName").text();
                            if (addVendorRetFlag) {
                                $('#vendorCode').val(VendorCode);
                                $("#vendorName").val(VendorName);

                            } else {

                                $("#hdVendorID").val(VendorCode);
                                $("#lblVendorName").text(VendorName);


                                //set show change vendor remark
                                $("#hdFlagchangeVendor").val(true);
                                $("#divchangeVendorRemark").removeAttr('hidden');
                            }
                            $("#modalAddVendor").modal('hide');
                            //Clear Textbox
                            $("#txtVendorchangeRemark").removeAttr('disabled');
                            $("#txtVendorchangeRemark").val("");

                        });

                    });

                }

                $("#modalAddVendor").appendTo("body").modal('show');
                pleaseWaitDialogClose();
            },
            error: function (data) {
                pleaseWaitDialogClose();
            },

        });
    }

    async function SearchVendorRetention() {
        if ($("#vendorCode").val() == "" && ($("#vendorName").val().trim() =="บริษัท")) {
            modalWaring("กรุณาระบุชื่อผู้รับเหมาที่ถูกต้อง");
            return false;
        }
        if ($("#vendorCode").val() == "" && ($("#vendorName").val()== "")) {
            modalWaring("กรุณาระบุรหัสผู้รับเหมา หรือ ชื่อผู้รับเหมา");
            return false;
        }

        var values = {
            Name: $("#vendorName").val(),
            TaxID: null,
            Vendor: $("#vendorCode").val() == "" ? "" : $("#vendorCode").val()
        }
        pleaseWaitDialog();
        $.ajax({
            url: '@Url.Action("getListVendormaster", "Master")',
            type: 'POST',
            data: values,
            traditional: true,
            success: function (data) {

                if (data.length > 0) {
                    $.each(data, function (key, value) {
                        $('#vendorCode').val(Number(value.Vendor).toString());
                        $("#vendorName").val(value.Name);
                    });

                }

                pleaseWaitDialogClose();
            },
            error: function (data) {
                pleaseWaitDialogClose();
            },

        });

    }


    $("#txtOperatingPercent").blur(function () {
        calNetPricebyOperating($(this));

    });

    function calNetPricebyOperating(e) {
        var OperatingPercent = 0.00;
        var totalUnit = parseFloat($("#lblTotalUnit").text().replace(',', ''));
        OperatingPercent = ((totalUnit * e.val()) / 100);

        $("#txtIncludeOperatingPercent").val(OperatingPercent.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        var totalIncludeOperation = totalUnit + OperatingPercent;

        $("#txtTotalIncludeOperatingPercent").val(totalIncludeOperation.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));

        //cal vat
        var VatPercent = parseFloat($("#txtVatPercent").val().replace(',', ''));

        //add retention
        var includeRetention = parseFloat($('#txtTotalRetention').val().replace(',', ''));
        var totalIncludeRetention = totalIncludeOperation - includeRetention;
        $("#txtNetPrice").val(totalIncludeRetention.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));


        var IncludeVat = (parseFloat(totalIncludeOperation) * parseFloat(VatPercent)) / 100

        $("#txtIncludeVatPercent").val((IncludeVat).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));

        var totalIncludeVat = totalIncludeOperation + IncludeVat;

        $("#txtNetPriceWithVat").val((totalIncludeVat).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        $("#lblFinalNetPrice").text((totalIncludeVat).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));

    }

    $("#txtVatPercent").blur(function () {
        calNetPricebyVat($(this));

    });

    function calNetPricebyVat(e) {
        var totalIncludeOperation = $("#txtTotalIncludeOperatingPercent").val().replace(',', '');

        //cal vat
        var VatPercent = parseFloat(e.val().replace(',', ''));

        //add retention
        var includeRetention = parseFloat($('#txtTotalRetention').val().replace(',', ''));
        var totalIncludeRetention = totalIncludeOperation - includeRetention;
        $("#txtNetPrice").val(totalIncludeRetention.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));

        var IncludeVat = (parseFloat(totalIncludeOperation) * parseFloat(VatPercent)) / 100

        $("#txtIncludeVatPercent").val(IncludeVat.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));

        var totalIncludeVat = parseFloat(totalIncludeOperation) + parseFloat(IncludeVat);

        $("#lblFinalNetPrice").text(totalIncludeVat.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        $("#txtNetPriceWithVat").val(totalIncludeVat.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));

    }
    function clearVendorFixPriceModal() {
        $("#hclist1").val("");
        $("#hclist2").val("");
        $("#hclist3").val("");
        $("#hclist4").val("");


        $('#chkVendorFixPrice_MainMateria').attr('checked', false);
        $('#chkVendorFixPrice_MainWagePrice').attr('checked', false);

        $('#chkVendorFixPrice_MainMateria').removeAttr('disabled');
        $('#chkVendorFixPrice_MainWagePrice').removeAttr('disabled');

        $('#chkVendor_SpecialMateria').attr('checked', false);
        $('#chkVendorFixPrice_SpecialWage').attr('checked', false);

        $('#chkVendor_SpecialMateria').removeAttr('disabled');
        $('#chkVendorFixPrice_SpecialWage').removeAttr('disabled');

        $("#txtVendor_SpecialMateriaPrice").removeAttr('disabled');
        $("#txtVendor_SpecialWagePrice").removeAttr('disabled');


        $("#txtVendor_SpecialMateriaPrice").val('0.00');
        $("#txtVendor_SpecialWagePrice").val('0.00');

        $("#VendorFixPrice_Quantity").val('');
        $("#txtVendorFixPrice_Remark").val('');


        $("#lblVendorFixPrice_Unit").text('-');
        $("#lblVendorFixPrice_TotalPrice").text('0.00');

    }



    //Extend Repair
    $(".btnExtendedRepair").click(function () {

        $("#ddlExtendedReasonID").val("");
        $("#RepairAppointmentFormDate").val("");
        $("#RepairAppointmentToDate").val("");
        $("#ExtRepairAppointmentFormDate").val("");
        $("#ExtRepairAppointmentToDate").val("");
        $("#txtExtendRemark").val("");

        var WorksheetitemID = $(this).data("value");

        //Check Extend Repair
        if ("@EnumConfiguration.Role.CallCentre.ToString()" != "@UserDetail.Role")
        {
            var requestData = {
                Job_ID:WorksheetitemID,
                Job_Code:"W"
            }
            var Url = '@Url.Action("CheckReceivedAppointment", "Received")';
            var response = CallController_Ajax(requestData,Url);

            if (response != "")
            {
                modalWaring(response);
                return false;
            }

        }


        //Get Extended Repair
        var requestData = {
            WorkSheet_Item_ID:WorksheetitemID
        }
        $("#hdRepairWorksheetItemID").val(WorksheetitemID);
        //console.log(requestData);
        var Url = '@Url.Action("GetWorksheetRepair", "WorkSheet")';
        var response = CallController_Ajax(requestData,Url);

        //console.log(response);
        if(response!=null)
        {
            $("#RepairAppointmentFormDate").val(response.RepairAppointmentDateFrom);
            $("#RepairAppointmentToDate").val(response.RepairAppointmentDateTo);
        }
        else
        {
            $("#RepairAppointmentFormDate").val("");
            $("#RepairAppointmentToDate").val("");
        }

        if(response!=null && "@EnumConfiguration.Role.CallCentre.ToString()" == "@UserDetail.Role")
        {
            $("#ExtRepairAppointmentFormDate").val(response.Ext_RepairAppointmentDateFrom);
            $("#ExtRepairAppointmentToDate").val(response.Ext_RepairAppointmentDateTo);


            $("#ddlExtendedReasonID").val(response.ExtendedReasonID);
            $("#txtExtendRemark").val(response.ExtendedRemark);
            $("#txtExtendRemarkCC").val(response.ExtendedRemarkCC);

            if("@EnumConfiguration.Role.CallCentre.ToString()" == "@UserDetail.Role" && (response.Ext_Receive_Repair_Date!='' && response.ExtendedApproveFlag==null))
            {
                $("[name='rdoConfirm']").prop('disabled', false);
                $("#txtExtendRemarkCC").prop('disabled', false);
                $('#btnUpdateExtended').prop('disabled', false);

            }else if("@EnumConfiguration.Role.CallCentre.ToString()" == "@UserDetail.Role" && (response.ExtendedApproveFlag==true || response.ExtendedApproveFlag==false))
            {

                $("[name='rdoConfirm']").prop('disabled', true);
                $("#txtExtendRemarkCC").prop('disabled', true);
                $('#btnUpdateExtended').prop('disabled', true);

            }
            else if("@EnumConfiguration.Role.CallCentre.ToString()" != "@UserDetail.Role")
            {
                $("[name='rdoConfirm']").prop('disabled', true);
                $('#btnUpdateExtended').prop('disabled', false);
                $("#txtExtendRemarkCC").prop('disabled', true);
            }
            else
            {
                $("[name='rdoConfirm']").prop('disabled', true);
                $("#txtExtendRemarkCC").prop('disabled', true);
                $('#btnUpdateExtended').prop('disabled', true);
            }

            if("@EnumConfiguration.Role.CallCentre.ToString()" == "@UserDetail.Role")
            {
                $("#ExtRepairAppointmentFormDate").prop('disabled', true);
                $("#ExtRepairAppointmentToDate").prop('disabled', true);
                $("#ddlExtendedReasonID").prop('disabled', true);
                $("#txtExtendRemark").prop('disabled', true);
            }

            $("input[name=rdoConfirm][value=" + response.ExtendedApproveFlag + "]").attr('checked', 'checked');


        }

        $("#modalExtendedRepair").modal('show');

    });

    $(".viewExtendedHistory").click(function () {
        $("#modalExtendedAppointmentHistory").modal('show');

        var WorksheetitemID = $(this).data("value");

        var requestData = {
            WorksheetitemID:WorksheetitemID
        }

        var Url = '@Url.Action("GetRepairAppointmentHistory", "WorkSheet")';
        var response = CallController_Ajax(requestData,Url);

        if(response.length>0)
        {
            $("#tbExtendedHistory tbody tr").remove();
            $.each(response, function (key, value) {
                $("#tbExtendedHistory tbody").append("<tr></tr>");
                if (response.length > 0) {

                    $("#tbExtendedHistory tbody tr:last").append("<td class='text-center'><label id='lblNo' name='No'>" + (key + 1) + "</label></td>");
                    $("#tbExtendedHistory tbody tr:last").append("<td class='text-left'>" + value.ExtendedApproveFlag + "</td>");
                    $("#tbExtendedHistory tbody tr:last").append("<td class='text-left'>" + value.CreatedBy + "</td>");
                    $("#tbExtendedHistory tbody tr:last").append("<td class='text-left'>" + value.Repair_Appointment_Old + "</td>");
                    $("#tbExtendedHistory tbody tr:last").append("<td class='text-left'>" + value.Repair_Appointment_New + "</td>");
                    $("#tbExtendedHistory tbody tr:last").append("<td class='text-left'>" + value.Reason + "</td>");
                    $("#tbExtendedHistory tbody tr:last").append("<td class='text-left'>" + value.ExtendedRemark + "</td>");
                    $("#tbExtendedHistory tbody tr:last").append("<td class='text-left'>" + value.ExtendedRemarkCC + "</td>");
                    $("#tbExtendedHistory tbody tr:last").append("<td class='text-left'>" + value.UpdatedBy + "</td>");
                } else {
                    $("#tbExtendedHistory tbody tr:last").append("<td class='text-center Bold text-danger' colspan='9'>ไม่มีข้อมูล</td>");

                }
            });
        }
        else
        {
            $("#tbExtendedHistory tbody tr").remove();
            $("#tbExtendedHistory tbody").append("<tr></tr>");
            $("#tbExtendedHistory tbody tr:last").append("<td class='text-center Bold text-danger' colspan='9'>ไม่มีข้อมูล</td>");
        }
    });


    //บันทึกเลื่อนนัด
    $("#btnUpdateExtended").on("click", function ()  {


        var txtExtRepairAppointmentFormDate=$("#ExtRepairAppointmentFormDate").val();
        var txtExtRepairAppointmentToDate=$("#ExtRepairAppointmentToDate").val();

        var date = new Date();
        var today = date.getFullYear() + '/' + (date.getMonth() + 1) + '/' + date.getDate();
        var ExtendedReceiveAppointmentFormDate = new Date(txtExtRepairAppointmentFormDate.substring(6,10) , txtExtRepairAppointmentFormDate.substring(3,5)-1 , txtExtRepairAppointmentFormDate.substring(0,2));
        var ExtendedReceiveAppointmentToDate = new Date(txtExtRepairAppointmentToDate.substring(6,10) , txtExtRepairAppointmentToDate.substring(3,5)-1 , txtExtRepairAppointmentToDate.substring(0,2));

        var ExtendedApproveFlag=null;

        if ('@EnumConfiguration.Role.CallCentre.ToString()' != "@UserDetail.Role")
        {
            if(new Date(today)>new Date(ExtendedReceiveAppointmentFormDate))
            {
                modalWaring("กรุณาระบุ วันที่เลื่อนนัดหมายเข้าซ่อม ต้องมากกว่าหรือเท่ากับ วันปัจจุบัน");
                return;
            }
            else if(new Date(ExtendedReceiveAppointmentFormDate)>new Date(ExtendedReceiveAppointmentToDate))
            {
                modalWaring("กรุณาระบุ วันนัดหมายเข้าซ่อมเริ่มต้น น้อยกว่าหรือเท่ากับ วันนัดหมายเข้าซ่อมสิ้นสุด");
                return;
            }
            else if ($("#ExtRepairAppointmentFormDate").val() == "" ||$("#ExtRepairAppointmentToDate").val() == "" ||$("#ddlExtendedReasonID").val() == "")
            {
                modalWaring("กรูณากรอกข้อมูลเลื่อนวันที่นัดหมายซ่อมให้ครบถ้วน");
                return;
            }
            else if($("#ddlExtendedReasonID").val()==4||$("#ddlExtendedReasonID").val()==5||$("#ddlExtendedReasonID").val()==6)
            {
                ExtendedApproveFlag=true;
            }
        }
        else
        {
            if ($("#ExtRepairAppointmentFormDate").val() == "" ||$("#ExtRepairAppointmentToDate").val() == "" ||$("#ddlExtendedReasonID").val() == ""|| $("#chkExtendedConfirm").prop('checked')==false
                || ($('input[name=rdoConfirm]:checked').val()!= "true" && $('input[name=rdoConfirm]:checked').val()!= "false")
                   ||($('input[name=rdoConfirm]:checked').val()== "false" && $("#txtExtendRemarkCC").val()==''))
            {
                modalWaring("กรูณากรอกข้อมูลเลื่อนนัดหมายตรวจสอบให้ครบถ้วน");
                return;
            }
            ExtendedApproveFlag=$('input[name=rdoConfirm]:checked').val();
        }

        var ExtRepairAppointmentFormDate = $("#ExtRepairAppointmentFormDate").val();
        var ExtRepairAppointmentToDate = $("#ExtRepairAppointmentToDate").val();
        var ExtendedResonID = $("#ddlExtendedReasonID").val();
        var ExtendRemark = $("#txtExtendRemark").val();
        var ExtendRemarkCC = $("#txtExtendRemarkCC").val();


        var requestValidate= {
            WorkSheetID:$("#hdWorksheetID").val()
        }

        var Url = '@Url.Action("CheckSpacialMemo", "WorkSheet")';
        var responseSpacialMemo = CallController_Ajax(requestValidate,Url);
        //console.log(responseSpacialMemo);
        if(($("#ddlExtendedReasonID").val()==4||$("#ddlExtendedReasonID").val()==5||$("#ddlExtendedReasonID").val()==6) && responseSpacialMemo!="")
        {
            //console.log(responseSpacialMemo);
            modalWaring(responseSpacialMemo);
        }else
        {
            var requestData = {
                WorkSheetID:$("#hdWorksheetID").val(),
                Worksheet_Item_ID: $("#hdRepairWorksheetItemID").val(),
                ExtRepairAppointmentFormDate:ExtRepairAppointmentFormDate,
                ExtRepairAppointmentToDate:ExtRepairAppointmentToDate,
                ExtendedResonID:ExtendedResonID,
                ExtendedReasonRemark:ExtendRemark,
                ExtendedReasonRemarkCC:ExtendRemarkCC,
                ExtendedApproveFlag:ExtendedApproveFlag,
                UserCode : "@UserDetail.CodeName"

            }
            var Url = '@Url.Action("InsertRepairAppointment", "WorkSheet")';
            var response = CallController_Ajax(requestData,Url);
            if(response==true)
            {
                modalSuccess();
                $("#modalExtendedRepair").modal('hide');
            }
        }

    });


    //Extend RepairAfter
    $(".btnExtendedRepairAfter").click(function () {

        var WorksheetitemID = $(this).data("value");

        //Check Extend RepairAfter
        var requestData = {
            Job_ID:WorksheetitemID,
            Job_Code:"W"
        }
        var Url = '@Url.Action("CheckReceivedAppointmentRepairAfter", "Received")';
        var response = CallController_Ajax(requestData,Url);
        if (response != "")
        {
            modalWaring(response);
            return false;
        }

        //Get Extended RepairAfter
        var requestData = {
            WorkSheet_Item_ID:WorksheetitemID
        }
        $("#hdRepairWorksheetItemID").val(WorksheetitemID);
        var Url = '@Url.Action("GetWorksheetRepairAfter", "WorkSheet")';
        var response = CallController_Ajax(requestData,Url);
        if(response != null)
        {
            $("#StartDateOld").val(response.StartDate);
            $("#ExpectDateOld").val(response.ExpectDateOld);
        }
        else
        {
            $("#StartDateOld").val("");
            $("#ExpectDateOld").val("");
        }


        $("#modalExtendedRepairAfter").modal('show');
    });


    $("#btnUpdateExtendedRepairAfter").on("click", function ()  {


        var StartDateOld=$("#StartDateOld").val();
        var ExpectDateOld=$("#ExpectDateOld").val();
        var RepairAppointmentDateOld=$("#RepairAppointmentDateOld").val();
        var RepairAppointmentDateNew=$("#RepairAppointmentDateNew").val();
        var ExpectDateNew=$("#ExpectDateNew").val();
        var ddlExtendedRepairAfterReasonID=$("#ddlExtendedRepairAfterReasonID").val();
        var ddlExtendedRepairAfterTimesID=$("#ddlExtendedRepairAfterTimesID").val();
        var txtExtendedRepairAfterRemark=$("#txtExtendedRepairAfterRemark").val();
        var ddlUserRequestID=$("#ddlUserRequestID").val();
        var ddlUserRequestCode=$("#ddlUserRequestID option:selected").text();
        var ddlUserApproveID=$("#ddlUserApproveID").val();
        var ddlUserApproveCode=$("#ddlUserApproveID option:selected").text();

        var Day = new Date();
        var ToDay = new Date(Day.getFullYear(), (Day.getMonth()), Day.getDate());
        var RemainDays = datediff(ToDay, parseDate(ExpectDateOld));

        if(StartDateOld=="" || ExpectDateOld=="" || RepairAppointmentDateOld=="" || RepairAppointmentDateNew==""
           || ExpectDateNew=="" || ddlExtendedRepairAfterReasonID=="" || ddlExtendedRepairAfterTimesID==""
           || txtExtendedRepairAfterRemark=="" || ddlUserRequestID=="-- กรุณาเลือก --" || ddlUserApproveID=="-- กรุณาเลือก --"){
            modalWaring("กรุณาระบุ ข้อมูลให้ครบถ้วน");
            return;
        }else if(RemainDays < 1){
            modalWaring("ไม่สามารถขยายได้ เนื่องจากเกิน Duedate แล้ว (ไม่มีวันเหลือให้ขยาย)");
            return;
        }else if(parseDate(RepairAppointmentDateNew).getTime() < ToDay || parseDate(RepairAppointmentDateNew).getTime() == ToDay.getTime()){
            modalWaring("กรุณาระบุวันที่นัดซ่อม(ใหม่) มากกว่า ปัจจุบัน");
            return;
        }else if(parseDate(RepairAppointmentDateNew).getTime() < parseDate(RepairAppointmentDateOld).getTime() || parseDate(RepairAppointmentDateNew).getTime() == parseDate(RepairAppointmentDateOld).getTime()){
            modalWaring("กรุณาระบุวันที่นัดซ่อม(ใหม่) มากกว่า วันที่นัดซ่อม(เดิม)");
            return;
        }else if(parseDate(RepairAppointmentDateNew).getTime() < parseDate(StartDateOld).getTime() || parseDate(RepairAppointmentDateNew).getTime() == parseDate(StartDateOld).getTime()){
            modalWaring("กรุณาระบุวันที่นัดซ่อม(ใหม่) มากกว่า วันเริ่มซ่อมครั้งแรก");
            return;
        }else
        {
            var requestData = {
                Worksheet_Item_ID:$("#hdRepairWorksheetItemID").val(),
                RepairAppointmentTimes:ddlExtendedRepairAfterTimesID ,
                RepairAppointmentDate_Old:RepairAppointmentDateOld,
                RepairAppointmentDate:RepairAppointmentDateNew ,
                ExpectDate_Old:ExpectDateOld ,
                ExpectDate:ExpectDateNew ,
                ExtendedReasonID:ddlExtendedRepairAfterReasonID ,
                ExtendedRemark:txtExtendedRepairAfterRemark ,
                ExtendedUserID:ddlUserRequestID ,
                ExtendedUserCode:ddlUserRequestCode ,
                ExtendedApproveFlag:true ,
                ExtendedRemarkCC:"" ,
                ExtendedUserIDCC:ddlUserApproveID ,
                ExtendedUserCodeCC:ddlUserApproveCode ,
                CreatedBy : "@UserDetail.CodeName"
            }

            var Url = '@Url.Action("InsertRepairAfterAppointment", "WorkSheet")';
            var response = CallController_Ajax(requestData,Url);
            if(response==true)
            {
                modalSuccess();
                $("#modalExtendedRepairAfter").modal('hide');
            }else
            {

            }
        }

    });


    function openModalConfirmWithReason(title, txt, func, require) {
        $('#confirmTitle').text(title);
        $('#confirmTxtReason').text(txt);
        require ? $('#confirmStarReason').show() : $('#confirmStarReason').hide();
        $('#confirmBtn').removeAttr('onclick');
        $('#confirmBtn').attr('onclick', func + `(); $('#modalConfirmWithReason').modal('hide')`);
        $('#modalConfirmWithReason').modal('show');
    }

    function cancelWorksheet() {
        pleaseWaitDialog()
        if ($('#confirmReason').val() == '') {
            pleaseWaitDialogClose();
            modalWaring('กรุณาระบุสาเหตุการยกเลิกใบงาน');
            return false;
        }
        var body = {
            WorkSheet_ID: '@Model.Data_WorkSheet.WorkSheet_ID',
            CancelRemark: $('#confirmReason').val()
        };
        $.ajax({
            url: '@Url.Action("cancelConfigWorksheet", "WorkSheet")',
            type: "POST",
            data: JSON.stringify(body),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {
                modalWaring('มีบางอย่างผิดพลาดกรุณาดำเนินการใหม่ในภายหลัง');
                pleaseWaitDialogClose();
            },
            success: function (response) {
                modalSuccess();
                GetWorkSheetPODetail();
                pleaseWaitDialogClose();
            }
        });
    }

    function setPublish(id) {
        // call api for set publish image to clients
        ajaxPost(`${baseUrl}/homecare/api/v1/Attachment/SetPublishImage?attachmentId=${id}&username=${"@UserDetail.CodeName"}`, null, async response => {
        //console.log(response);
    });
    }

    async function InsertApprove(data) {
        return new Promise(async function (resolve, reject){
            await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/InsertTDApprove`, data, response => {
                if (response) {
                    resolve(response);

                } else {
                    resolve(false);
                }

            });
        })

    }
    function GetWBS(data) {
        return new Promise(async function (resolve, reject) {
            await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/GetWBS`, data, response => {
                if (response) {
                    resolve(response);

                } else {
                    reject();
                }

            });
        })

    }

    function showModalLineApprveSuccess(msg) {
        $('#modalInsertRoleSuccess').modal('show');
        $('#lbTxtSuccess').text(msg);
    }

    function GetPOCancelReason() {
        return new Promise(async function (resolve, reject) {
            await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/GetPurchaseOrderCancelReason`, response => {
                if (response) {
                    resolve(response);

                } else {
                    resolve(false);
                }

            });
        })

    }

    function GetWorkSheetRollbackReason() {
        return new Promise(async function (resolve, reject) {
            await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/GetWorkSheetRollbackReasonList`, response => {
                if (response) {
                    resolve(response);

                } else {
                    resolve(false);
                }

            });
        })

    }

    function CancelPO(data) {
        return new Promise(async function (resolve, reject) {
            await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/CancelPO`, data, response => {
                if (response) {
                    resolve(response);

                } else {
                    reject();
                }

            });
        });

    }

    function RollbackWorkSheet(data) {
        return new Promise(async function (resolve, reject) {
            await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/WorkSheetRollback`, data, response => {
                if (response) {
                    resolve(response);

                } else {
                    resolve(false);
                }

            });
        });
    }

    async function GetCompanyList() {
        let option = ``;
        await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/GetCompanyList`, response => {
            if (response) {
                var ddlCompany = $('#searchCompany');

                option += `<option selected="selected" value="">Please select</option>`;
                $.each(response.data, function (Index, Value) {
                    option += `<option value="${Value.id}">
                                       ${Value.description}
                                  </option>`;
                });
                ddlCompany.empty().html(option);

            }

        });
    }

    async function GetDocumentTypeList() {
        let option = ``;
        await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/GetDocumentTypeList`, response => {
            if (response) {
                var ddlSystemType = $('#searchSystemType');

                option += `<option selected="selected" value="">Please select</option>`;
                $.each(response.data, function (Index, Value) {
                    option += `<option value="${Value.code}">
                                       ${Value.description}
                                  </option>`;
                });
                ddlSystemType.empty().html(option);

            }

        });
    }

    function callSapCreatePO(dataPO) {
        return new Promise(async function (resolve, reject) {
            await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/SaveCreatePOHeader`, dataPO, response => {
                if (response) {
                    if (response.data.type =='S')
                        resolve(response);
                    else
                        resolve(response);
                } else {

                    resolve(response);
                }
            });
        });

    }

    async function reload() {

        await bindingApproveDetail();
        await bindingApproveitemDetail();
        await UpdateRetentionStatus();
        validationworkOrderOnload();
        getExtendReason();
        getExtendedRepairAfterReason();
        await GetWorkSheetPODetail();
    }
    async function GetWorkSheetPODetail() {
        await ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/GetWorkSheetPODetail?id=${$("#hdWorksheetID").val()}&approveId=${$("#hdApproveID").val()}`, response => {
            if (response.data.length > 0) {
                opDetail = response.data;

                var ddlPONumber = $('#ddlPONumber');
                ddlPONumber.empty();
                $.each(response.data, function (Index, Value) {
                    ddlPONumber.append($("<option></option>").val(Value.poNumber).html(Value.poStatus === 0 ? "-" :Value.poNumber));
                });
            }
            setPODetail();
        });
    }

    function setPODetail() {
        let response;
        let opDetailFilter = opDetail.filter(x => x.poNumber === $('#ddlPONumber').val());
        if (opDetailFilter.length > 0)
        {
            response = opDetailFilter[0];
        }

        let Totalretention_price = opDetail.map(o => o.retention_price).reduce((a, c) => { return a + c });

        console.log(Totalretention_price);

        if (response  !== undefined && response !== null) {

            $('#txtRetentionPercent').val(response.retention_percent);
            $('#hdVendorRetention').val(response.vendorRetention);
            $('#hdVendorRetentionAmount').val(response.retAmount);

            let totalPrice = parseFloat($("#txtTotalIncludeOperatingPercent").val().replace(/,/g, ''));
            let vat = parseFloat($('#txtVatPercent').val());

            $('#txtTotalRetention').val(Totalretention_price.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
            var totalIncludeRetention = totalPrice - Totalretention_price;
            $("#txtNetPrice").val((totalIncludeRetention).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
            let totalVat = ((totalPrice * vat) / 100);
            let NetPriceWithVat = totalPrice + totalVat;
            $('#txtIncludeVatPercent').val(totalVat.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","))
            $("#txtNetPriceWithVat").val((NetPriceWithVat).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
            $("#lblFinalNetPrice").text((NetPriceWithVat).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));

            if (response.approveStatusID === 12 && response.paymentType === "Y") {

                if (response.vendorRetention) {
                    $('#divRetentionPanel').css('display', 'block');
                    $('#lblBance').text(response.balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                    $("#lblRetPrice").text((response.retention_vendor_price).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                    if (vendorPOList.length > 0) {
                        $('#dvSumRetVendor').css('display', 'block');
                    } else {
                        $('#dvSumRetVendor').css('display', 'none');
                    }
                } else {
                    $('#divRetentionPanel').css('display', 'none');
                    $('#lblBance').text(response.balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                    $("#lblRetPrice").text(response.retention_price.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                }

                if (response.retAmount < parseFloat($('#txtNetPriceWithVat').val().replace(/,/g, ''))) {
                    if (response.poStatus === 0 || response.is_active === false) {
                        $('#btnCreatePO').css('display', 'inline');
                        $('#btnCancelPO').css('display', 'none');
                        $('#btnApprovePO').css('display', 'none');
                        $('#lbPONumber').text("-");
                        $('#lblPOStatus').text("-");
                        $('#txtPOType').text(response.po_gen_type);
                        if (opDetail.length > 1) {
                            $('#ddlPONumber').css('display', 'inline');
                            $('#textShowPO').css('display', 'none');
                        } else {
                            $('#ddlPONumber').css('display', 'none');
                            $('#textShowPO').css('display', 'block');
                        }
                    } else if (response.poStatus === 1) {
                        $('#btnCreatePO').css('display', 'none');
                        $('#btnCancelPO').css('display', 'none');
                        $('#btnApprovePO').css('display', 'inline');
                        $('#lbPONumber').text(response.poNumber);
                        $('#lblPOStatus').text(response.poStatusDesc);
                        $('#txtPOType').text(response.po_gen_type);
                        if (opDetail.length > 1) {
                            $('#ddlPONumber').css('display', 'inline');
                            $('#textShowPO').css('display', 'none');
                        } else {
                            $('#ddlPONumber').css('display', 'none');
                            $('#textShowPO').css('display', 'block');
                        }

                    } else {

                        $('#btnCreatePO').css('display', 'none');
                        $('#btnCancelPO').css('display', 'inline');
                        $('#btnApprovePO').css('display', 'none');
                        $('#lbPONumber').text(response.poNumber).trigger('change');
                        $('#lblPOStatus').text(response.poStatusDesc);
                        $('#btnActionPO-Retention').prop('disabled', true);
                        $('#btnCreateRetention').prop('disabled', true);
                        $('#txtPOType').text(response.po_gen_type);
                        if (opDetail.length > 1) {
                            $('#ddlPONumber').css('display', 'inline');
                            $('#textShowPO').css('display', 'none');
                        } else {
                            $('#ddlPONumber').css('display', 'none');
                            $('#textShowPO').css('display', 'block');
                        }
                    }
                }
                else
                {
                    $('#btnCreatePO').css('display', 'none');
                    $('#btnCancelPO').css('display', 'none');
                    $('#btnApprovePO').css('display', 'none');
                    $('#lbPONumber').text("-");
                    $('#lblPOStatus').text("-");
                    $('#btnActionPO-Retention').prop('disabled', true);
                    $('#btnCreateRetention').prop('disabled', true);
                    $('#txtPOType').text("");
                    if (opDetail.length > 1) {
                        $('#ddlPONumber').css('display', 'inline');
                        $('#textShowPO').css('display', 'none');
                    } else {
                        $('#ddlPONumber').css('display', 'none');
                        $('#textShowPO').css('display', 'block');
                    }
                }

            } else {
                $('#btnCreatePO').css('display', 'none');
                $('#btnCancelPO').css('display', 'none');
                $('#btnApprovePO').css('display', 'none');
                $('#lbPONumber').text("-");
                $('#lblPOStatus').text("-");
                $('#divRetentionPanel').css('display', 'none');
                $('#lblBance').text("-");
                $("#lblRetPrice").text("-");
                $('#txtPOType').text("");
                if (opDetail.length > 1) {
                    $('#ddlPONumber').css('display', 'inline');
                    $('#textShowPO').css('display', 'none');
                } else {
                    $('#ddlPONumber').css('display', 'none');
                    $('#textShowPO').css('display', 'block');
                }
            }
            $('#hdPOStatus').val(response.poStatus);
            $('#hdPaymentType').val(response.paymentType);
            $('#hdPOGentype').val(response.po_gen_type_code);
        } else  {
            $('#btnCreatePO').css('display', 'inline');
            $('#btnCancelPO').css('display', 'none');
            $('#btnApprovePO').css('display', 'none');
            $('#lbPONumber').text("-");
            $('#lblPOStatus').text("-");
            $('#hdPOStatus').val('0');
            $('#divRetentionPanel').css('display', 'none');
            $('#textShowPO').css('display', 'block');
            $('#txtPOType').text("");


        }

    }
    $('#ddlPONumber').change(function () {
        setPODetail();
    });

    $('#btnClearSearchVendorList').click(function () {
        vendorPOList = [];
        selectVendorPOList = [];
        $('#vendorCode').val('');
        $('#vendorName').val('');
        $('#poNumber-retention').val('');
        $('#searchCompany').val('').trigger('change');
        $('#searchSystemType').val('').trigger('change');
        table.rows().remove().draw(false);
    });

    $('#btnSearchVendorList').click(async function () {
        vendorPOList = [];
        selectVendorPOList = [];
        if ($('#vendorCode').val() === '') {
            modalWaring("กรุณาระบุ รหัส/ชื่อผู้รับเหมา");
            return;
        }
        let data = {
            Vendor: $("#vendorCode").val(),
            CompanyCode: $('#searchCompany').val() === "" ? "*" : $('#searchCompany').val(),
            DocumentType: $('#searchSystemType').val() === "" ? "*" : $('#searchSystemType').val(),
            PONumber: $('#poNumber-retention').val() === "" || $('#poNumber-retention').val() === undefined ? "*" : $('#poNumber-retention').val()
        }

        let option = ``;
        let retRemain = 0.00;
        await page.loading();
        await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/SearchPOList`, data, response => {

            currentPage = table.page();
            vendorPOListResult = response.data;
            table.rows().remove().draw(false);
            if (response.data.length > 0) {
                $.each(response.data, function (index, value) {
                    value.index = index;
                    retRemain = value.rettot - value.waitdeduct;
                    table.row.add([
                        value,
                        value.ebeln,
                        value.gsber,
                        value.lifnr,
                        $('#vendorName').val(),
                        retRemain,
                        value.bsart
                    ]).page(currentPage).draw(false);
                });

                $("#tbvendor-list tbody").append(option);
            }

            page.loaded();
        });
        page.loaded();

    });

    var selectPORetention = [];
    function selectPOList(value, ele) {
        $(ele).val(ele.checked ? "true" : "false");
        let idx = selectVendorPOList.indexOf(value);

        if (idx > -1) {
            selectVendorPOList.splice(idx, 1);
        } else {
            selectVendorPOList.push(value);
        }
        //console.log(selectVendorPOList);

    }
    $('#btnActionPO-Retention').click(function () {

        jQuery.grep(selectVendorPOList, function (n, i) {

            return vendorPOList.push(vendorPOListResult[n]);
        });
        tablePORetention.rows().remove().draw(false);
        let sumRetention = 0;
        const today = new Date().getDate();
        const thisMonth = new Date().getMonth() + 1;
        const thisYear = new Date().getFullYear();
        $.each(vendorPOList, function (index, value) {
            value.index = index;
            tablePORetention.row.add([
                value.ebeln,
                value.lifnr,
                $('#vendorName').val(),
                value.rettot,
                value,
                value,
                value,
                value
            ]).page(currentPage).draw(false);
            sumRetention = sumRetention + parseFloat(value.rettot);
        });


        if (vendorPOList.length > 0) {
            $('#txtSumRetention').text(sumRetention.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","));
            $('#lblOldRetAmt').text($('#hdVendorRetentionAmount').val().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
            $('#dvSumRetVendor').css('display', 'block');
        } else {
            $('#dvSumRetVendor').css('display', 'none');
        }
        $('#btnCreateRetention').prop('disable', false);
        activaTab('listVendor', 'tab-listPO');
    });

    $("#itemCheckProjectBudget").click(function () {
        checkProjectBudject($("#hdWorksheetID").val(),1);

    });

    $('#btnCreateRetention').click(async function () {

        $('#frmConfirm [name="headerModal"]').addClass('bg-light-blue');
        $('#frmConfirm [name="titleModal"]').text('ยืนยันการหักเงินประกันผู้รับเหมา');
        $('#frmConfirm [name="questionDesc"]').text('คุณต้องการหักเงินประกันผู้รับเหมา ใช่หรือไม่ ?');
        var createRetconfirm = await openModalConfirmPopUP();
        if (createRetconfirm) {
            let sumRettot = 0;
            let checkErr = false;
            $('#tbVendorRetention-list').find("tr").each(function (x, el) {
                if (x !== 0) {
                    var $tds = $(this);
                    let chkPostingDate = $tds.find("td:eq(5) input[type='text']").val();

                    if (chkPostingDate === "" || chkPostingDate === null || chkPostingDate === undefined) {
                        checkErr = true;
                        modalWarning("กรุณาระบุวันที่");
                        return false;
                    } else {
                        checkErr = false;
                    }

                    let chkRetRemark = $tds.find("td:eq(6) input[type='text']").val();
                    if (chkRetRemark === "" || chkRetRemark === null || chkRetRemark === undefined) {
                        checkErr = true;
                        modalWarning("กรุณาระบุหมายเหตุ");
                        return false;
                    } else {
                        checkErr = false;
                    }
                    sumRettot = sumRettot + parseFloat($tds.find("td:eq(4) input[type='text']").val());
                }
            });
            let oldRetAmt = parseFloat($('#hdVendorRetentionAmount').val().replace(/,/g, ''));
            sumAllRetention = oldRetAmt + sumRettot;
            //console.log(sumAllRetention);

            if (sumAllRetention > parseFloat($('#txtNetPriceWithVat').val().replace(/,/g, ''))) {
                $('#btnCreateRetention').prop('disable', true);
                modalWarning("ยอดรวมหักเงินประกันต้องไม่เกินราคาสุทธิ");
                return false;
            } else {
                $('#btnCreateRetention').prop('disable', false);
                let dataList = [];
                if (!checkErr) {
                    await page.loading();
                    var sumRetention = 0;
                    $('#tbVendorRetention-list').find("tr").each(function (i, el) {
                        if (i !== 0) {
                            var $tds = $(this);
                            let data = {
                                Vendor: Number($tds.find("td:eq(1)").text()),
                                CompanyCode: "10",
                                DocumentType: $tds.find("td:eq(7)").text().trim(),
                                Gsber: $tds.find("td:eq(7) input[name*='gsbr']").val(),
                                Kostl: $tds.find("td:eq(7) input[name*='kostl']").val(),
                                RetentionAmount: $tds.find("td:eq(4) input[type='text']").val(),
                                RetentionRemark: $tds.find("td:eq(6) input[type='text']").val(),
                                PostingDate: dateFormat($tds.find("td:eq(5) input[type='text']").val()),
                                PONumber: $tds.find("td:eq(0)").text(),
                                UserLogon:  '@UserDetail.CodeName'
                            }
                            dataList.push(data);
                            selectPORetention.push($tds.find("td:eq(0)").text());
                            sumRetention = sumRetention + parseFloat($tds.find("td:eq(4) input[type='text']").val() === "" ? 0 : $tds.find("td:eq(4) input[type='text']").val());
                        }

                    });

                    var body = {
                        worksheet_id: $("#hdWorksheetID").val(),
                        approve_job_id: $("#hdApproveID").val(),
                        vendor_to: $('#hdVendorID').val(),
                        vendorFrom: $('#vendorCode').val(),
                        vendorFromDesc: $('#vendorName').val(),
                        UserLogon: '@UserDetail.CodeName',
                        systemType:1,
                        RetentionDataList: dataList
                    }

                    await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/CreateRetention`, body,async function(response) {

                        let totalAmt = 0;
                        if (response.data.status) {
                            modalSuccess(response.data.msg);
                            tableWorksheetRetention.rows().remove().draw(false);
                            $.each(response.data.data, function (index, value) {
                                value.index = index;
                                tableWorksheetRetention.row.add([
                                    value.retention_number,
                                    value.po_number,
                                    value.retention_from_vendor,
                                    $('#vendorName').val(),
                                    value.retention_amount,
                                    value.retention_posting_date,
                                    value.retention_remark
                                ]).page(currentPage).draw(false);
                            });

                            activaTab('listRetention', 'tab-listRetention');
                            selectPORetention = [];
                            $('#btnCreateRetention').prop('disabled', true);
                            await GetWorkSheetPODetail();
                            page.loaded();

                        } else {
                            modalWaring(response.data.msg);
                            await GetWorkSheetPODetail();
                            page.loaded();
                            tableWorksheetRetention.rows().remove().draw(false);
                            $.each(response.data.data, function (index, value) {
                                value.index = index;
                                tableWorksheetRetention.row.add([
                                    value.retention_number,
                                    value.po_number,
                                    value.retention_to_vendor,
                                    $('#vendorName').val(),
                                    value.retention_amount,
                                    value.retention_posting_date,
                                    value.retention_remark
                                ]).page(currentPage).draw(false);
                            });

                            activaTab('listRetention', 'tab-listRetention');
                        }


                    });
                    page.loaded();

                }

            }
        }
    });

    $('#viewPOHistory').click(async function () {

        await openModalPO_History($("#hdWorksheetID").val(), 'inwarranty');

    });

    let retentionVendorFlag = false;

    $('#btnCreatePO').click(async function () {
        $('#frmConfirm [name="headerModal"]').addClass('bg-light-blue');
        $('#frmConfirm [name="titleModal"]').text('ยืนยันการสร้างเลขที่ใบ PO');
        $('#frmConfirm [name="questionDesc"]').text('คุณต้องการสร้างเลขที่ใบ PO ใช่หรือไม่ ?');
        var createPOconfirm = await openModalConfirmPopUP();
        if (createPOconfirm) {
            let retVendorFlag = $('#hdVendorRetention').val();

            //Check Retention Flag From Payment Type
            let confirmRetentionVendor = false;
            if (retVendorFlag === "true") {
                let totalBalance = parseFloat($('#lblBance').text().replace(/,/g, ''));
                if (totalBalance >= 5000 ) {
                    let totalNetPrice = (totalBalance - ((totalBalance * 5) / 100)).toFixed(2);
                    let totalRetention = ((totalBalance * 5) / 100).toFixed(2);
                    $('#frmRetention [name="txtRetentionPercent"]').val('5');
                    $('#frmRetention [name="txtTotalRetention"]').val(totalRetention);
                    $('#frmRetention [name="txtNetPriceWithRetention"]').val(totalNetPrice);
                    confirmRetentionVendor = await openModalConfirmRetention();
                }

            }

            if (confirmRetentionVendor === true || confirmRetentionVendor === false) {

                let value = {
                    WorksheetId: $("#hdWorksheetID").val(),
                    retention_vendor_percent: confirmRetentionVendor ? $('#frmRetention [name="txtRetentionPercent"]').val() : 0,
                    retention_vendor_price: confirmRetentionVendor ? $('#frmRetention [name="txtTotalRetention"]').val() : 0,
                    UpdatedBy: '@UserDetail.CodeName'
                }
                await UpdateWorksheetRetentionVendor(value);

                await page.loading();
                let data = {
                    WorkSheetId: $("#hdWorksheetID").val(),
                    systemType: 1,
                    UserLogon: '@UserDetail.CodeName',
                    POGenType: $("#hdPOGentype").val()
                }
                await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/SaveCreatePOHeader`, data, async function (response) {

                    if (response) {
                        if (response.data.type === 'S') {
                            await GetWorkSheetPODetail();
                            page.loaded();
                            modalSuccess("สร้างเลขที่ PO สำเร็จ");
                            // GetWorkSheetPODetail();
                        } else {
                            page.loaded();
                            modalWaring(response.data.msg);
                        }
                    }
                });

            }

            page.loaded();
        }
    });

    function UpdateWorksheetRetentionVendor(data) {
        return new Promise(async function (resolve, reject){
            await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/UpdateWorksheetRetentionVendor`, data, response => {

                if (response) {
                    resolve(true);

                } else {
                    resolve(false);
                }
            });
        });
    }

    $('#btnCancelPO').click(async function () {
        $('#frmCancelPO [name="header"]').addClass('bg-light-blue');
        var result = await GetPOCancelReason();

        let option = ``;
        $.each(result.data, function (Index, Value) {
            option += `<option value="${Value.id}">
                                   ${Value.description}
                              </option>`;


        });
        var ddlReasonType = $('#frmCancelPO [name="reasonId"]');
        ddlReasonType.empty().html(option);
        var confirmCancel = await openModalConfirmCancelPO();

        if (confirmCancel) {
            page.loading();
            let data = {
                WorkSheetId: $("#hdWorksheetID").val(),
                ApproveJobId: $("#hdApproveID").val(),
                PONumber: $('#lbPONumber').text(),
                SystemType:1,
                ResonCancelId: confirmCancel.reasonId,
                ReasonRemark: confirmCancel.remark,
                UserLogon: "@UserDetail.CodeName",
                UnitCode: $('#customerUnitCode').text().split('(')[0].trim()
            }
            let cancelResult = await CancelPO(data);

            if (cancelResult.data.status) {
                //clear values
                $('#WorksheetCloseConfirm').prop('checked', false);
                $('#WorksheetCloseConfirmDate').val('');
                $("#AddReceiveTable tbody tr").each(function () {

                    var row = $(this);
                    //claer Is check confirm
                    var chkPriceConfirm = row.find("#PriceConfirm");
                    chkPriceConfirm.prop('checked', false);
                    chkPriceConfirm.prop('disabled', false);
                    //Clear Confirm
                    var txtPriceConfirmDate = row.find("#PriceConfirmDate");
                    txtPriceConfirmDate.val("");

                });
                await reload();
                page.loaded();
                modalSuccess("ยกเลิกเลขที่ PO เรียบร้อยแล้ว");
            } else {
                page.loaded();
                modalWarning(cancelResult.data.msg);
            }

        }
    });

    $('#btnRollbackWorkSheet').click(async function () {
        $('#frmWorkSheetRollback [name="header"]').addClass('bg-light-blue');
        var result = await GetWorkSheetRollbackReason();
        // console.log(result);
        let option = ``;
        $.each(result.data, function (Index, Value) {
            option += `<option value="${Value.id}">
                                   ${Value.description}
                              </option>`;


        });
        var ddlReasonType = $('#frmWorkSheetRollback [name="reasonId"]');
        ddlReasonType.empty().html(option);
        var confirmRollback = await openModalConfirmRollbackTimeSheet();

        if (confirmRollback) {

            let data = {
                WorkSheetId: $("#hdWorksheetID").val(),
                ResonCancelId: confirmRollback.reasonId,
                ReasonRemark: confirmRollback.remark,
                UserLogon: "@UserDetail.CodeName",
            }
            // console.log(data);
            page.loading();
            let rollbackResult = await RollbackWorkSheet(data);

            if (rollbackResult.data.status) {

                $('#WorksheetCloseConfirm').prop('checked', false);
                $('#WorksheetCloseConfirmDate').val('');
                await reload();
                page.loaded();
                modalSuccess("ถอยสถานะปิดใบงานเรียบร้อยแล้ว");

            }
            else {
                page.loaded();
                modalWaring("ถอยสถานะปิดใบงานไม่สำเร็จ");
            }
        }
    });

    $('#frmRetention [name="txtRetentionPercent"]').on("change keyup paste ", function (e) {

        if ($('#hdVendorRetention').val() === "false") {
            let totalPrice = parseFloat($("#txtTotalIncludeOperatingPercent").val().replace(/,/g, ''));
            let retention = e.target.value;

            let totalNetPrice = (totalPrice - ((totalPrice * retention) / 100)).toFixed(2);
            let totalRetention = ((totalPrice * retention) / 100).toFixed(2);

            $('#frmRetention [name="txtTotalRetention"]').val(totalRetention.replace(/\B(?=(\d{3})+(?!\d))/g, ","));
            $('#frmRetention [name="txtNetPriceWithRetention"]').val(totalNetPrice.replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        } else {
            let totalBalance = parseFloat($('#lblBance').text().replace(/,/g, ''));
            let retention = e.target.value;

            let totalNetPrice = (totalBalance - ((totalBalance * retention) / 100)).toFixed(2);
            let totalRetention = ((totalBalance * retention) / 100).toFixed(2);

            $('#frmRetention [name="txtTotalRetention"]').val(totalRetention.replace(/\B(?=(\d{3})+(?!\d))/g, ","));
            $('#frmRetention [name="txtNetPriceWithRetention"]').val(totalNetPrice.replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        }
    });

    $('#btnApprovePO').click(async function () {

        let dataPO = {
            WorkSheetId: $("#hdWorksheetID").val(),
            PONumber: $('#lbPONumber').text(),
            systemType: 1,
            UserLogon :  '@UserDetail.CodeName'
        }
        await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/ApprovePO`, dataPO, response => {

            if (response) {
                if (response.data.approveStatus === 'S') {
                    GetWorkSheetPODetail();
                    modalSuccess(response.data.msg);
                    pleaseWaitDialogClose();

                } else {
                    modalWarning(response.data.msg);
                }
            }
        });
    });

    $('#viewRetentionHistory').click(async function () {
        await getRetentionHistory($("#hdWorksheetID").val(),1);
        $('#modalRetentionHistory').modal('show');
    });

    function activaTab(tab, actTab) {
        $('#' + actTab).show();
        $('.nav-tabs a[href="#' + tab + '"]').tab('show');
    }

    function dateFormat(date) {
        if (!date) { return '' }
        var temp = date.trim().split('/');
        return `${temp[2]}${temp[1]}${temp[0]}`
    }

</script>

@using HomeCare_4_0.ClassLib
@using HomeCare_4_0.Common
@model HomeCare_4_0.Models.WorkSheetIndexViewModel
@{
    ViewBag.Title = "WorkSheetRepair";
    Layout = "~/Views/Shared/_MasterLayout.cshtml";
}
@section AddToHead
{
    <style type="text/css">
        .thumbnails li img {
            width: 350px;
            height: 350px;
        }

        .theme-explorer .file-upload-indicator, .theme-explorer .file-drag-handle,
        .theme-explorer .explorer-frame .kv-file-content, .theme-explorer .file-actions,
        .explorer-frame .file-preview-other {
            text-align: center;
        }

        .theme-explorer .file-thumb-progress .progress, .theme-explorer .file-thumb-progress .progress-bar {
            height: 13px;
            font-size: 11px;
            line-height: 13px;
        }

        .theme-explorer .file-upload-indicator, .theme-explorer .file-drag-handle {
            position: absolute;
            display: inline-block;
            top: 0;
            right: 3px;
            width: 16px;
            height: 16px;
            font-size: 16px;
        }

        fieldset.scheduler-border {
            border: 1px groove #ddd !important;
            padding: 0 1.4em 1.4em 1.4em !important;
            margin: 0 0 1.5em 0 !important;
            -webkit-box-shadow: 0px 0px 0px 0px #000;
            box-shadow: 0px 0px 0px 0px #000;
            border-radius: 13px;
        }

        .theme-explorer .file-thumb-progress .progress, .theme-explorer .explorer-caption {
            display: block;
        }

        .theme-explorer .explorer-frame td {
            vertical-align: middle;
            text-align: left;
        }

        .theme-explorer .explorer-frame .kv-file-content {
            width: 80px;
            height: 80px;
            padding: 5px;
        }

        .theme-explorer .file-actions-cell {
            position: relative;
            width: 120px;
            padding: 0;
        }

        .theme-explorer .file-thumb-progress .progress {
            margin-top: 5px;
        }

        .theme-explorer .explorer-caption {
            color: #777;
        }

        .theme-explorer .kvsortable-ghost {
            opacity: 0.6;
            background: #e1edf7;
            border: 2px solid #a1abff;
        }

        .theme-explorer .file-preview .table {
            margin: 0;
        }

        .theme-explorer .file-error-message ul {
            padding: 5px 0 0 20px;
        }

        .explorer-frame .file-preview-text {
            display: inline-block;
            color: #428bca;
            border: 1px solid #ddd;
            font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
            outline: none;
            padding: 8px;
            resize: none;
        }

        .explorer-frame .file-preview-html {
            display: inline-block;
            border: 1px solid #ddd;
            padding: 8px;
            overflow: auto;
        }

        .explorer-frame .file-other-icon {
            font-size: 2.6em;
        }

        @@media only screen and (max-width: 767px) {
            .theme-explorer .table, .theme-explorer .table tbody, .theme-explorer .table tr, .theme-explorer .table td {
                display: block;
                width: 100% !important;
            }

            .theme-explorer .table {
                border: none;
            }

                .theme-explorer .table tr {
                    margin-top: 5px;
                }

                    .theme-explorer .table tr:first-child {
                        margin-top: 0;
                    }

                .theme-explorer .table td {
                    text-align: center;
                }

                .theme-explorer .table .kv-file-content {
                    border-bottom: none;
                    padding: 4px;
                    margin: 0;
                }

                    .theme-explorer .table .kv-file-content .file-preview-image {
                        max-width: 100%;
                        font-size: 20px;
                    }

            .theme-explorer .file-details-cell {
                border-top: none;
                border-bottom: none;
                padding-top: 0;
                margin: 0;
            }

            .theme-explorer .file-actions-cell {
                border-top: none;
                padding-bottom: 4px;
            }

            .theme-explorer .explorer-frame .explorer-caption {
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
                left: 0;
                right: 0;
                margin: auto;
            }
        }

        .file-preview {
            min-height: 24vh;
            max-height: 62vh;
        }

        .file-preview-image {
            object-fit: cover;
        }

        .file-drop-zone {
            overflow-y: auto;
            min-height: 30vh;
            max-height: 56vh;
        }

        .file-zoom-dialog .explorer-frame .file-other-icon {
            font-size: 22em;
            font-size: 50vmin;
        }

        .fileinput-remove {
            display: none;
        }

        .flag-china {
            height: 21.74px;
            border-radius: 3px;
            position: relative;
            bottom: 1px;
        }

        .modal-dialog-center {
            margin-top: 10%;
        }

        .myCard {
            border-radius: 20px;
            border: 1.5px solid rgba(128, 128, 128, 0.70);
            box-shadow: 2px 2px 4px 2px rgba(0,0,0,0.1);
            transition: 0.3s;
            max-width: 95%;
            padding: 15px 2px;
        }

            .myCard:hover {
                border: 1.5px solid rgba(128, 128, 128, 0.90);
                box-shadow: 3px 3px 12px 3px rgba(0, 111, 206, 0.3);
            }

        .mb-0 {
            margin-bottom: 20px;
        }

        .mb-1 {
            margin-bottom: 10px;
        }

        .mb-2 {
            margin-bottom: 5px;
        }

        .mb-15 {
            margin-bottom: 15px;
        }

        .pt-5 {
            padding-top: 5px;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .width60 {
            width: 60%;
        }

        #tBodyWorksheetItem tr td {
            text-align: center;
        }

        .slider {
            display: none;
        }

        .error {
            color: #ff0000;
            font-weight: 300;
            font-style: italic;
            font-size: 1.2rem;
        }

        /*.checkbox:checked:before {
            background-color: green;
        }*/
    </style>
}
<div class="main">
    <div class="main-inner">
        <h2 class="page-header">
            <span class="text text-blue text-bold"><i class="fa fa-file-text-o"></i> ใบงาน <label id="flagUrgent" style="display: none; color: crimson">(งานเร่งด่วน)!</label></span>
        </h2>
        @*ข้อมูลลูกค้า*@
        <div class="box box-default" id="Received-customer">
            <div class="box-header with-border cursor-pointer collapsed" data-toggle="collapse" data-target="#Received-Customer-Detail" aria-expanded="false" aria-controls="Received-customer-detail">
                <a data-toggle="collapse" data-target="#Received-customer-detail">
                    <i class="fa fa-user"></i>
                    <h3 class="box-title">
                        ข้อมูลลูกค้า

                    </h3>

                </a>
                <h3 class="box-title" id="customerInfo"></h3>

            </div>

            <div class="box-body collapse" id="Received-Customer-Detail">
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-lg-4">
                        <label class="control-label">ชื่อ-สกุล</label>
                        <div id="customerName" class="controls text-primary"></div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4">
                        <label class="control-label">ข้อมูลติดต่อ</label>
                        <div id="customerMobile" class="controls text-primary"></div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4" id="DivOptionalEmail" style="display: none">
                        <label class="control-label">อีเมลติดต่อ (เพิ่มเติม)</label>
                        <div id="customerEmail" class="controls text-primary"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-lg-4">
                        <label class="control-label">โครงการ <input type="hidden" value="" id="hdProjectCode" /> </label>
                        <div id="customerProject" class="controls text-primary">
                            
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4">
                        <label class="control-label">แปลง</label>
                        <div id="customerUnitCode" class="controls text-primary">
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4">
                        <label class="control-label">แบบบ้าน</label>
                        <div id="customerUnitModel" class="controls text-primary">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-lg-4">
                        <label class="control-label">วันที่เริ่มประกัน</label>
                        <div id="customerStartGuaranteeDate" class="controls text-primary">
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4">
                        <label class="control-label">วันที่หมดประกัน</label>
                        <div id="customerEndGuaranteeDate" class="controls text-primary">
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4">
                        <label class="control-label">วันที่ขยายประกัน</label>
                        <div id="customerExtraGuaranteeDate" class="controls text-primary">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @*ข้อมูลรับเรื่อง*@
        <div class="box box-default" id="Received-Receive">
            <div class="box-header with-border cursor-pointer collapsed" data-toggle="collapse" data-target="#Received-Receive-Detail" aria-expanded="false" aria-controls="Received-Receive-detail">
                <a>
                    <h3 class="box-title " id="headerReceive"><i class="fa fa-phone" style="position: relative; top: 2px;"></i> ข้อมูลรับเรื่อง</h3>
                </a>
            </div>

            <div class="box-body collapse" id="Received-Receive-Detail">
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <label class="control-label">สถานะรับเรื่อง </label>
                        <div id="receivedStatusName" class="controls text-primary"></div>
                    </div>

                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <label class="control-label ">ผู้รับเรื่อง </label>
                        <div id="receiveUser" class="text-primary"> </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <label class="control-label ">HC รับเรื่องวันที่ </label>
                        <div id="receiveHCDate" class="text-primary"> </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <label class="control-label ">หมายเหตุ HC </label>
                        <div id="receiveHCRemark" class="text-primary"> </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <label class="control-label ">CC รับเรื่องวันที่ </label>
                        <div id="receiveCCDate" class="text-primary"> </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <label class="control-label ">หมายเหตุ CC </label>
                        <div id="receiveCCRemark" class="text-primary"> </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <label class="control-label ">วันที่นัดหมายตรวจสอบ </label>
                        <div id="receiveAppointmentDate" class="text-primary"> </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <label class="control-label ">เวลา </label>
                        <div id="receiveAppointmentTimeFrom" class="text-primary"> </div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <label class="control-label ">ถึง </label>
                        <div id="receiveAppointmentTimeTo" class="text-primary"> </div>
                    </div>
                </div>
            </div>
        </div>


        @*ข้อมูลแจ้งซ่อม*@
        <div class="box box-default" id="Received-Inform">
            <div class="box-header with-border cursor-pointer" data-toggle="collapse" data-target="#Received-Inform-Detail" aria-expanded="true" aria-controls="Received-Inform-detail">
                <a>
                    <h3 class="box-title"><i class="fa fa-pencil"></i> ข้อมูลแจ้งซ่อม</h3>
                </a>
            </div>
            <div class="box-body collapse" id="Received-Inform-Detail">
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <h5><label class="control-label">รหัสงานซ่อม</label></h5>
                        <div class="controls text-primary" id="receiveJobNoText"></div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <h5><label class="control-label">ประเภทงานซ่อม</label></h5>
                        <div class="controls text-danger text-bold" id="receiveRepairType" style="color: red"></div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <h5><label class="control-label">สถานะ</label></h5>
                        <div class="controls text-danger text-bold" id="receiveMainProcessName" style="color: red"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <h5><label class="control-label">วันที่รับแจ้ง</label></h5>
                        <div class="controls text-primary" id="receiveinformDate"></div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <h5><label class="control-label">ผู้รับแจ้ง</label></h5>
                        <div class="controls text-primary" id="receiveInformUser"></div>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <h5><label class="control-label">หมายเหตุ Call Centre</label></h5>
                        <div class="controls text-danger" id="receiveInformRemark" style="color: red"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-6 col-lg-4 ">
                        <h5><label class="control-label">สถานะผู้แจ้ง</label></h5>
                        <div class="controls text-primary" id="receiveInformCustomerTypeName"></div>
                    </div>
                    <div id="DivOptionalNameTel" style="display:none">
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <h5><label class="control-label">ชื่อผู้แจ้ง</label></h5>
                            <div class="controls text-primary" id="receiveInformCustomerName"></div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <h5><label class="control-label">เบอร์ติดต่อ</label></h5>
                            <div class="controls text-primary" id="receiveInformCustomerTel"></div>
                        </div>
                    </div>
                </div>
                <br />
            </div>
        </div>

        @*ข้อมูลใบงาน*@
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="box box-default">
                    <div class="box-header with-border cursor-pointer collapsed" data-toggle="collapse" data-target="#Worksheet-Worksheet-Detail" aria-expanded="false" aria-controls="Worksheet-Worksheet-Detail">
                        <a>
                            <h3 class="box-title"><i class="fa fa-file-text-o"></i> ข้อมูลใบงาน</h3>
                        </a>
                    </div>
                    <div class="box-body collapse" id="Worksheet-Worksheet-Detail">

                        @*ใบงาน : ส่วนข้อมูลทั่วไป AddReceiveTable*@
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <label class="control-label ">รหัสใบงาน </label>
                                <div class="text-primary" id="worksheetJobText"> </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <label class="control-label ">สถานะ </label>
                                <div class="text-primary" id="worksheetStatus"></div>
                            </div>
                            @if (@EnumConfiguration.Role.VENDOR.ToString() != @UserDetail.Role)
                            {
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label ">ยืนยันปิดใบงาน</label>
                                    <div class="input-group" style="width: 80%">
                                        <span class="input-group-addon">
                                            <input type="checkbox" id="worksheetCloseConfirm" onclick="bindEnddateProject(this)">
                                        </span>
                                        <input type="text" class="form-control" id="worksheetFlagCloseDate" value="" readonly>
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <label class="control-label ">วันที่เปิดใบงาน  </label>
                                <div class="text-primary" id="worksheetCreatedDate"> </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <label class="control-label ">ผู้เปิดใบงาน</label>
                                <div class="text-primary" id="worksheetCreatedUser"> </div>
                            </div>
                            @if (@EnumConfiguration.Role.VENDOR.ToString() != @UserDetail.Role)
                            {
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label">ออกเอกสาร</label>

                                    <div>

                                        <span class="cursor-pointer" onclick="genDocumentFOne()" id="DivDocFOne"><label class="control-label text-primary cursor-pointer">F1:</label> <i class="fa fa-print fa-lg cursor-pointer" style="color:brown"></i>&nbsp;</span>
                                        <span class="cursor-pointer" onclick="genQuotationPDF('vendor')"><label class="control-label text-primary cursor-pointer">ใบเสนอราคา (ผรม):</label> <i class="fa fa-print fa-lg cursor-pointer" style="color:brown"></i></span>
                                        @*<span>  <input id="vat" type="checkbox" name="NoVAT"><label class="control-label text-primary"> ยกเว้นค่า VAT.</label></span>*@
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <label class="control-label ">ผู้รับเหมา</label>
                                <div class="text-primary">
                                    <label id="worksheetVendorName"></label>
                                    <span class="glyphicon glyphicon-time" id="iconwait"></span>
                                    <label id="lbStatusEditData" hidden>รออนุมัติแก้ไขข้อมูล</label>
                                    <label id="lbEmpEditData" hidden></label>
                                    <input type="hidden" value="" id="hdVendorID" />
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4" id="DivChangeVendor">

                                <label class="control-label lbVendor hidden">เปลี่ยนผู้รับเหมา</label>
                                <div class="text-primary">
                                    <span><a class="itemAddVendor hidden" id="itemAddVendor" onclick="itemAddvendor()"><i class="fa fa-user fa-lg cursor-pointer"></i></a></span>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4" id="divchangeVendorRemark" style="display: none">
                                <label class="control-label">หมายเหตุเปลี่ยนผู้รับเหมา<label style="color: crimson">*</label></label>
                                <input type="text" class="form-control" name="txtVendorchangeRemark" id="txtVendorchangeRemark">
                                <input type="hidden" id="hdFlagchangeVendor" value="false" />
                            </div>
                            @if (@EnumConfiguration.Role.CallCentre.ToString() == @UserDetail.Role)
                            {
                                @*ใบงาน : ปุ่ม Questionnaire Modal*@
                                <div class="col-xs-12 col-sm-6 col-lg-4" id="questionnaireDisplayDiv" style="display: none">
                                    <label class="control-label ">แบบสอบถาม</label>
                                    <div class="text">
                                        <span><button onclick="openModalQuestionnaire(); return false" id="btnModalQuestionnaire" class="btn btn-default questionnaire">แบบสอบถาม <img src="../../Images/questionnaire_icon.png" style="width:20px;height:20px;" /></button></span>
                                        <label id="displayReason" class="text-red" style="margin-left: 5px; display: none"></label>
                                    </div>
                                </div>
                            }


                            <div class="col-xs-12 col-sm-6 col-lg-4" id="WorkSheetRollbackDisplayDiv" style="display:none;">
                                <label class="control-label "></label>
                                <div class="text">
                                    <span><button id="btnWorkSheetRollback" class="btn btn-danger">ถอยสถานะ ปิดใบงาน</button></span>

                                </div>
                            </div>



                        </div>

                        @*ใบงาน : ส่วนตาราง AddReceiveTable*@
                        <div class="row" style="margin: 15px 0 0 0">
                            <div style="overflow: auto; margin: 10px 2%; max-width: 96%; border: 1px solid lightgray; padding:0; max-height: 300px; " class="col-lg-12">
                                <table class="nowrap table table-striped table-bordered table-hover" id="worksheetItemTable" style="width: 2000px;  white-space: nowrap; margin-bottom: 0">
                                    <thead>
                                        <tr class="">
                                            <th class="text-center">
                                                No.
                                            </th>
                                            <th class="text-center">
                                                สถานะ
                                            </th>
                                            <th class="text-center">
                                                หมวดงาน
                                            </th>
                                            <th class="text-center">
                                                ลักษณะงานหลัก
                                            </th>
                                            <th class="text-center">
                                                ลักษณะงานรอง
                                            </th>
                                            <th class="text-center">
                                                ลักษณะการประเมิน
                                            </th>
                                            <th class="text-center">
                                                ตำแหน่งที่เกิด
                                            </th>
                                            <th class="text-center">
                                                สาเหตุการเกิดปัญหา
                                            </th>
                                            <th class="text-center">
                                                อธิบายสาเหตุ
                                            </th>
                                            <th class="text-center">
                                                วันที่นัดหมายซ่อม
                                            </th>
                                            <th class="text-center">
                                                เลื่อนวันที่นัดหมายซ่อม
                                            </th>
                                            <th class="text-center">
                                                Priority
                                            </th>
                                            <th class="text-center">
                                                กำหนดแล้วเสร็จ
                                            </th>
                                            <th class="text-center">
                                                รายการสั่งซื้อ
                                            </th>
                                            <th class="text-center">
                                                วันที่อนุมัติ
                                            </th>
                                            <th class="text-center">
                                                วันที่เริ่มซ่อม
                                            </th>
                                            <th class="text-center">
                                                วันที่ซ่อมเสร็จ
                                            </th>
                                            <th class="text-center">
                                                ไฟล์ภาพ
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="tBodyWorksheetItem"></tbody>
                                </table>
                            </div>
                        </div>
                        <br />


                        @*ใบงาน : ส่วนราคารวม divPriceApprove*@
                        <div id="divPriceApprove">
                            <div class="row from-group">
                                <div class="col-xs-12 col-sm-6 col-lg-12">
                                    <label class="control-label ">ราคารวมตามรายการ&nbsp; </label><label class="text-danger" id="lblTotalUnit"> </label>
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="col-sm-6 control-label" for="txtOperatingPercent">ค่าดำเนินการ (%)</label>
                                    <div class="col-sm-4">
                                        <input type="number" value="15" id="txtOperatingPercent" class="form-control input-sm" max="100" min="0" readonly>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="col-sm-6 control-label">เป็นจำนวนเงิน</label>
                                    <div class="col-sm-6">
                                        <input type="text" id="txtIncludeOperatingPercent" class="form-control input-sm" readonly>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="col-sm-6 control-label">รวมได้</label>
                                    <div class="col-sm-6">

                                        <input type="text" id="txtTotalIncludeOperatingPercent" class="form-control input-sm" readonly>
                                    </div>
                                </div>
                            </div>


                            <!--Add retention-->
                            <div class="row form-group">
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="col-sm-6 control-label" for="txtVatPercent">Retention (%)</label>
                                    <div class="col-sm-4">

                                        <input type="number" value="15" id="txtRetentionPercentOnetime" class="form-control input-sm" readonly>
                                    </div>

                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="col-sm-6 control-label">เป็นจำนวนเงิน</label>
                                    <div class="col-sm-6">
                                        <input type="text" value="" id="txtTotalRetentionOnetime" class="form-control input-sm" readonly>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="col-sm-6 control-label">รวมได้</label>
                                    <div class="col-sm-6">
                                        <input type="text" value="" id="txtNetPrice" class="form-control input-sm" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="row form-group">
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="col-sm-6 control-label" for="txtVatPercent">Vat (%)</label>
                                    <div class="col-sm-4">
                                        <input type="number" value="7" id="txtVatPercent" class="form-control input-sm" readonly>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="col-sm-6 control-label">เป็นจำนวนเงิน</label>
                                    <div class="col-sm-6">
                                        <input type="text" id="txtIncludeVatPercent" class="form-control input-sm" readonly>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="col-sm-6 control-label">รวมได้</label>
                                    <div class="col-sm-6">
                                        <input type="text" id="txtNetPriceWithVat" class="form-control input-sm" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="row form-group">
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="col-sm-6 control-label Bold text-danger Bold">ราคาสุทธิ</label>
                                    <div class="col-sm-6">
                                        <label class="col-sm-6 control-label Bold text-danger Bold" id="lblFinalNetPrice"></label>
                                    </div>
                                </div>
                            </div>

                            @*ใบงาน : ส่วนเลือกประเภทค่าใช้จ่าย apprveDetial*@

                            <div class="row form-group" id="apprveDetial">
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <h5><label class="control-label">ประเภทการอนุมัติ(*)</label></h5>
                                    <input type="radio" id="AprrovedType" name="AprrovedType" onchange="bindingPaymentType('N');" value="N" class="checked"> ไม่มีค่าใช้จ่าย
                                    <input type="radio" id="AprrovedType  " name="AprrovedType" onchange="bindingPaymentType('Y');" value="Y"> มีค่าใช้จ่าย
                                </div>
                                <div class="col-xs-12 col-sm-12 col-lg-6 boxPaymentType hidden">
                                    <h5><label class="control-label">รายละเอียดการอนุมัติ(*)</label></h5>
                                    <select id="PaymentType" name="PaymentType" class="form-control"></select>
                                </div>
                            </div>

                        </div>
                        <br />
                    </div>
                </div>
            </div>
        </div>

        @*ข้อมูลPO*@
        <div class="row" id="panelPurchesOrder">
            <div class="col-md-12 col-xs-12">
                <div class="box box-default">
                    <div class="box-header with-border cursor-pointer collapsed" data-toggle="collapse" data-target="#Worksheet-PurchaseOrder-Detail" aria-expanded="false" aria-controls="Worksheet-Worksheet-Detail">
                        <a>
                            <h3 class="box-title"><i class="fa fa-file-text-o"></i><label id="po_count">&nbsp;ข้อมูลเลขที่ใบ PO</label></h3>
                        </a>
                    </div>
                    <div class="box-body collapse" id="Worksheet-PurchaseOrder-Detail">
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <label class="control-label ">เลขที่ใบ PO </label>
                                @*<div class="text-primary" id="PO_No"> </div>*@
                                <select id="PO_No2" name="PO_No2" class="form-control" style="width:200px"></select>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <label class="control-label ">สถานะ </label>
                                <div class="text-primary" id="po_status">อนุมัติ</div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <label class="control-label ">วันที่เปิด </label>
                                <div class="text-primary" id="po_date"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <label class="control-label ">ตรวจสอบงบโครงการ</label>
                                <div class="text-primary">
                                    <span><a id="itemCheckProjectBudget"><i class="fa fa-table fa-lg"></i></a></span>
                                </div>

                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <label class="control-label ">ประวัติเลขที่ใบ PO</label>
                                <div class="text-primary">
                                    <span><a id="itemPoHistory" onclick="openModalPO_HistoryClient(worksheetId,'2')"><i class="fa fa-book fa-lg"></i></a></span>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4">

                            </div>
                        </div>
                        <div class="row" id="showPanelRetentionVendor">
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <label class="control-label ">จำนวนเงินเปิด PO </label>
                                <div class="text-primary">
                                    <div class="text-primary" id="priceAfterUseRetention"></div>
                                </div>

                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <label class="control-label ">จำนวนเงิน Retention</label>
                                <div class="text-primary">
                                    <div class="text-primary" id="priceRetentionVendor"></div>
                                </div>
                            </div>
                        </div>
                        <br />

                        <div class="row" id="divPOManage" style="display:none">
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <span><button id="btnCancelPO" class="btn btn-danger">ยกเลิกเลขที่ใบ PO </button></span>
                                <span><button id="createPO_NO" class="btn btn-success">สร้างเลขที่ใบ PO</button></span>
                                <span><button id="createWorkFlow" class="btn btn-success">สร้าง WorkFlow</button></span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>


        @*ข้อมูลหัก Retention*@

        <div class="row" id="panelRetention" hidden>
            <div class="col-md-12 col-xs-12">
                <div class="box box-default">
                    @* <div class="box-header with-border">*@
                    <div class="box-header with-border cursor-pointer collapsed" data-toggle="collapse" data-target="#Worksheet-Retention" aria-expanded="false" aria-controls="Worksheet-Retention">
                        <a data-toggle="collapse" data-target="#Worksheet-Retention">
                            <i class="fa fa-file"></i>
                            <h3 class="box-title">ข้อมูลการหักเงินประกัน</h3>
                        </a>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body" id="Worksheet-Retention">
                        <ul class="nav nav-tabs" id="tabs-retention">
                            <li id="tab-searchPO" class="active"><a data-toggle="tab" href="#searchVendor">ค้นหา PO ผู้รับเหมา</a></li>
                            <li id="tab-listPO"><a data-toggle="tab" href="#listVendor">รายการ PO ผู้รับเหมา</a></li>
                            <li id="tab-listRetention" class="disabled"><a data-toggle="tab" href="#listRetention">รายการหัก Retention สำเร็จ</a></li>
                        </ul>
                        <div class="tab-content">
                            <div id="searchVendor" class="tab-pane fade in active">
                                <div class="container-fluid" style="margin-top:40px;">
                                    <div class="box box-default">
                                        <div class="box-header with-border cursor-pointer collapsed" data-toggle="collapse" aria-expanded="false">
                                        </div>

                                        <fieldset class="scheduler-border">
                                            <br />
                                            <div class="row">
                                                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                                    <label>รหัส/ชื่อผู้รับเหมา<span class="text-danger">*</span></label>
                                                    <form class="form-inline">
                                                        <input class="form-control" type="text" id="vendorCode" maxlength="20" style="width: 20%" readonly>
                                                        <input class="form-control " type="text" id="vendorName" maxlength="100" style="width: 75%" readonly>
                                                        <a id="itemAddVendorRetention" name="itemAddVendorRetention" onclick="itemAddvendor_retention()"><i class="fa fa-user fa-lg"></i></a>
                                                    </form>
                                                </div>
                                                <div class="form-group col-xs-12 col-md-6 col-lg-3">
                                                    <label>เลขที่ใบ PO</label>
                                                    <input class="form-control " type="text" id="poNumber-retention" style="width: 100%" />
                                                </div>
                                                <div class="form-group col-xs-12 col-md-6 col-lg-3">
                                                    <label>ประวัติข้อมูลหักเงินประกัน</label>
                                                    <div><a id="viewRetentionHistoryVendor"><i class="fa fa-book fa-lg"></i></a></div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="form-group col-xs-12 col-md-6 col-lg-3">
                                                    <label>บริษัท</label>
                                                    <select class="col-lg-12 form-control select2" id="searchCompany" data-placeholder="-- กรุณาคลิกเพื่อเลือกโครงการ --" style="width: 70%">
                                                        <option selected>Please select</option>
                                                    </select>

                                                </div>
                                                <div class="form-group col-xs-12 col-md-6 col-lg-3">
                                                    <label>ประเภทระบบ</label>
                                                    <select class="col-lg-12 form-control select2" id="searchSystemType" data-placeholder="-- กรุณาเลือก --" style="width: 70%">
                                                        <option selected>-- กรุณาเลือก --</option>
                                                    </select>

                                                </div>
                                                <div class="text-left">
                                                    <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                                        <label style="height:39px;"> </label>
                                                        <button type="button" class="btn btn-success" id="btnSearchVendorList" onclick="getPOList()"><i class="fa fa-search"> </i> ค้นหาผู้รับเหมา</button>
                                                        <button type="button" class="btn btn-danger" id="btnClearSearchVendorList"><i class="fa fa-refresh"> </i> ล้างข้อมูล</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </fieldset>

                                    </div>
                                    <div class="container-fluid" style="margin-top:40px;">
                                        <div class="row">
                                            <div class="table-responsive" style="margin-bottom: 0;">
                                                <table class="table table-striped table-bordered table-hover quotation-item-detail" id="vendor-list" style="margin-bottom: 0;">
                                                    <thead>
                                                        <tr>
                                                            <th class="text-center" style="min-width:30px;">เลือก</th>
                                                            <th class="text-center" style="min-width:100px;">เลขที่ PO</th>
                                                            <th class="text-center" style="min-width:50px;">โครงการ</th>
                                                            <th class="text-center" style="min-width:75px;">รหัสผู้รับเหมา</th>
                                                            <th class="text-center" style="min-width:350px;">ชื่อผู้รับเหมา</th>
                                                            <th class="text-center" style="min-width:100px;">เงินประกันคงเหลือ</th>
                                                            <th class="text-center" style="min-width:50px;">ประเภทระบบ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <br />
                                    <div class="row">
                                        <div class="form-group col-xs-12 col-md-6 col-lg-12 text-center">
                                            <button type="button" class="btn btn-success" id="btnAction"><i class="fa fa-search"> </i> ดำเนินการ </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="listVendor" class="tab-pane fade">
                                <div class="container-fluid" style="margin-top:40px;">
                                    <div class="row">
                                        <div class="form-group col-xs-12 col-md-6 col-lg-12 ">
                                            <table class="table  table-striped table-bordered" id="Po_retention_List" style="margin-bottom: 0;">
                                                <thead>
                                                    <tr>
                                                        <th class="text-center" style="min-width:50px;">เลขที่ PO</th>
                                                        <th class="text-center" style="min-width:50px;">โครงการ</th>
                                                        <th class="text-center" style="min-width:50px;">รหัสผู้รับเหมา</th>
                                                        <th class="text-center" style="min-width:130px;">ชื่อผู้รับเหมา</th>
                                                        <th class="text-center" style="min-width:80px;">เงินประกันคงเหลือ</th>
                                                        <th class="text-center" style="min-width:80px;">ยอดเงินที่ต้องการหัก<span class="text-danger">*</span></th>
                                                        <th class="text-center" style="min-width:80px;">วันที่<span class="text-danger">*</span></th>
                                                        <th class="text-center" style="min-width:90px;">หมายเหตุ<span class="text-danger">*</span></th>
                                                        <th class="text-center" style="min-width:50px;">ประเภทระบบ</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>

                                    </div>

                                    <div class="row" id="dvSumRetVendor">
                                        <div class="form-group col-xs-12 col-md-6 col-lg-6 text-danger">
                                            <div><label>เงินประกันรวม : <span id="lblUerSumRetentionPrice"></span></label></div>
                                            <div><label>ยอดรวมที่ต้องการหักเงินประกัน : <span id="lblNetRetentionPrice"></span></label></div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="form-group col-xs-12 col-md-6 col-lg-12 text-center">
                                            <button type="button" class="btn btn-success" id="btnCreateRetention"><i class="fa fa-save"> </i> บันทึก </button>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div id="listRetention" class="tab-pane fade">
                                <div class="container-fluid" style="margin-top:40px;">
                                    <div class="row">
                                        <div class="form-group col-xs-12 col-md-6 col-lg-12 ">
                                            <table class="table  table-striped table-bordered" id="tbWorksheetRetention-list" style="margin-bottom: 0;">
                                                <thead>
                                                    <tr>
                                                        <th class="text-center">เลขที่ใบ หักเงินประกัน</th>
                                                        <th class="text-center">เลขที่ PO</th>
                                                        <th class="text-center">รหัสผู้รับเหมา</th>
                                                        <th class="text-center">ชื่อผู้รับเหมา</th>
                                                        <th class="text-center">ยอดเงินที่หัก Retention</th>
                                                        <th class="text-center">วันที่</th>
                                                        <th class="text-center">หมายเหตุ</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>

                                        </div>
                                    </div>

                                </div>

                            </div>

                        </div>

                    </div>

                </div>

                <!-- /.box-body -->
            </div>
        </div>

    </div>


    @*ข้อมูลการแนบเอกสาร*@
    <div class="row">
        <div class="col-md-12 col-xs-12">
            <div class="box box-default">
                <div class="box-header with-border cursor-pointer text text-primary" data-toggle="collapse" data-target="#Worksheet-Attach-detail">
                    <i class="fa fa-paperclip"></i>
                    <h3 class="box-title">ข้อมูลการแนบเอกสาร</h3>
                </div>
                <!-- /.box-header -->
                <div class="box-body collapse" id="Worksheet-Attach-detail">
                    @*group 1*@

                    <div class="row">
                        <div class="col-md-12 col-xs-12">
                            <div class="box box-default">
                                <div class="box-header with-border cursor-pointer text text-primary" data-toggle="collapse" data-target="#Worksheet-Attach-detail-Group1">
                                    <i class="fa fa-photo"></i>
                                    <h3 class="box-title">รูปภาพ</h3>
                                </div>
                                <!-- /.box-header -->
                                <div class="box-body collapse" id="Worksheet-Attach-detail-Group1">
                                    <div class="row">
                                        <div class="col-sm-12 col-lg-6">
                                            <table class="table table-bordered table-hover" id="AddAttarchGroup1" style="margin: 8px 8px 0px 8px; width:auto;">
                                                <thead>
                                                    <tr class="">
                                                        <th class="text-center">
                                                            สถานะ
                                                        </th>
                                                        <th class="text-center">
                                                            ประเภท
                                                        </th>
                                                        <th class="text-center ">
                                                            ไฟล์ภาพ
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td class="text-center">
                                                            <span id="flagImageBefore" class="fa fa-times" style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">

                                                            <label type="text" id="lbldocName">รูปก่อน</label>
                                                        </td>
                                                        <td class="text-center cursor-pointer" onclick="openModalViewImage(1)">
                                                            <i class="fa fa-search fa-lg viewFile"></i>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            <span id="flagImageDuring" class="fa fa-times " style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">
                                                            <label type="text" id="lbldocName">รูประหว่าง</label>

                                                        </td>
                                                        <td class="text-center  cursor-pointer" onclick="openModalViewImage(2)">
                                                            <i class="fa fa-search fa-lg viewFile"></i>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            <span id="flagImageAfter" class="fa fa-times " style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">

                                                            <label type="text" id="lbldocName">รูปหลัง</label>
                                                        </td>
                                                        <td class="text-center cursor-pointer" onclick="openModalViewImage(3)">
                                                            <i class="fa fa-search fa-lg viewFile"></i>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    @*group 2*@
                    <div class="row" id="AttachDocumentsF">
                        <div class="col-md-12 col-xs-12">
                            <div class="box box-default">
                                <div class="box-header with-border  cursor-pointer text text-primary" data-toggle="collapse" data-target="#Worksheet-Attach-detail-Group2">
                                    <i class="fa fa-file-text-o"></i>
                                    <h3 class="box-title">เอกสาร F</h3>
                                </div>
                                <!-- /.box-header -->
                                <div class="box-body collapse" id="Worksheet-Attach-detail-Group2">
                                    <div class="row">
                                        <div class="col-sm-12 col-lg-12">
                                            <table class="table table-bordered table-hover" id="AddAttarchGroup2" style="margin: 8px 8px 0px 8px; width:100%;">
                                                <thead>
                                                    <tr class="">
                                                        <th class="text-center">
                                                            สถานะ
                                                        </th>
                                                        <th class="text-center col-sm-2">
                                                            ประเภท
                                                        </th>
                                                        <th class="text-center ">
                                                            รายละเอียด
                                                        </th>
                                                        <th class="text-center ">
                                                            ผู้แนบ
                                                        </th>
                                                        <th class="text-center ">
                                                            วันที่แนบ
                                                        </th>
                                                        <th class="text-center">
                                                            แนบไฟล์
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        @* value 4  *@
                                                        <td class="text-center">
                                                            <span id="flagImage4" class="fa fa-times " style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">
                                                            <label type="text" id="lbldocName">F1</label>
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="text" value="" id="AttachmentDetail4" class="form-control">
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateBy4">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateDate4">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            @* ใบ HCF1 พร้อมรายเซ็นลูกค้า *@
                                                            @if (@EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
                                                            {
                                                                <input id="fileInput4" type="file" name="file" multiple>
                                                            }
                                                        </td>

                                                    </tr>
                                                    <tr>
                                                        @* value 5  *@
                                                        <td class="text-center">
                                                            <span onclick="sendCancelF('F2')" class="fa fa-times " style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">
                                                            <label type="text" id="lbldocName">F2</label>
                                                        </td>
                                                        <td class="text-center">
                                                            -
                                                        </td>
                                                        <td class="text-center">
                                                            -
                                                        </td>
                                                        <td class="text-center">
                                                            -
                                                        </td>
                                                        <td class="text-center">
                                                            -
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            <span class="fa fa-times onclick=" sendCancelF('F5')"" style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">
                                                            <label type="text" id="lbldocName">F5</label>
                                                        </td>
                                                        <td class="text-center">
                                                            -
                                                        </td>
                                                        <td class="text-center">
                                                            -
                                                        </td>
                                                        <td class="text-center">
                                                            -
                                                        </td>
                                                        <td class="text-center">
                                                            -
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            <span class="fa fa-times " style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">

                                                            <label type="text" id="lbldocName">F9</label>
                                                        </td>
                                                        <td class="text-center">
                                                            -
                                                        </td>
                                                        <td class="text-center">
                                                            -
                                                        </td>
                                                        <td class="text-center">
                                                            -
                                                        </td>
                                                        <td class="text-center">
                                                            -
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            <span id="flagImage8" class="fa fa-times " style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">
                                                            <label type="text" id="lbldocName">ใบประเมินงานซ่อม</label>
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="text" value="" id="AttachmentDetail8" class="form-control">
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateBy8">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateDate8">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <input id="fileInput8" type="file" name="file" multiple>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                </div>

                                <!-- /.box-body -->
                            </div>
                        </div>
                    </div>
                    @*group 3*@
                    <div class="row" id="AttachMemo">
                        <div class="col-md-12 col-xs-12">
                            <div class="box box-default">
                                <div class="box-header with-border cursor-pointer text text-primary" data-toggle="collapse" data-target="#Worksheet-Attach-detail-Group3">
                                    <i class="fa fa-file"></i>
                                    <h3 class="box-title">Memo</h3>
                                </div>
                                <!-- /.box-header -->
                                <div class="box-body collapse" id="Worksheet-Attach-detail-Group3">
                                    <div class="row">
                                        <div class="col-sm-12 col-lg-12">
                                            <table class="table table-bordered table-hover" id="AddAttarchGroup3" style="margin: 8px 8px 0px 8px; width:auto;">
                                                <thead>
                                                    <tr class="">
                                                        <th class="text-center">
                                                            สถานะ
                                                        </th>
                                                        <th class="text-center col-sm-2">
                                                            ประเภท
                                                        </th>
                                                        <th class="text-center">
                                                            รายละเอียด
                                                        </th>
                                                        <th class="text-center">
                                                            ผู้แนบ
                                                        </th>
                                                        <th class="text-center">
                                                            วันที่แนบ
                                                        </th>
                                                        <th class="text-center">
                                                            แนบไฟล์
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td class="text-center">
                                                            <span id="flagImage9" class="fa fa-times " style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">
                                                            <label type="text">Memo ส่งของ</label>
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="text" value="" id="AttachmentDetail9" class="form-control">
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateBy9">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateDate9">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <input id="fileInput9" type="file" name="file" multiple>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            <span id="flagImage10" class="fa fa-times " style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">
                                                            <label type="text">Memo ไม่มีรูประหว่าง</label>
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="text" value="" id="AttachmentDetail10" class="form-control">
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateBy10">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateDate10">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <input id="fileInput10" type="file" name="file" multiple>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            <span id="flagImage11" class="fa fa-times " style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">
                                                            <label type="text">Memo พิจารณาพิเศษ</label>
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="text" value="" id="AttachmentDetail11" class="form-control">
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateBy11">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateDate11">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <input id="fileInput11" type="file" name="file" multiple>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    @*group4*@
                    <div class="row" id="AttachVendorDocuments">
                        <div class="col-md-12 col-xs-12">
                            <div class="box box-default">
                                <div class="box-header with-border cursor-pointer text text-primary" data-toggle="collapse" data-target="#Worksheet-Attach-detail-Group4">
                                    <i class="fa fa-file-text"></i>
                                    <h3 class="box-title" id="lbldocName">เอกสารผู้รับเหมา</h3>
                                </div>
                                <!-- /.box-header -->
                                <div class="box-body collapse" id="Worksheet-Attach-detail-Group4">
                                    <div class="row">
                                        <div class="col-sm-12 col-lg-12">
                                            <table class="table table-bordered table-hover" id="AddAttarchGroup4" style="margin: 8px 8px 0px 8px; width:auto;">
                                                <thead>
                                                    <tr class="">
                                                        <th class="text-center">
                                                            สถานะ
                                                        </th>
                                                        <th class="text-center col-sm-2">
                                                            ประเภท
                                                        </th>
                                                        <th class="text-center">
                                                            รายละเอียด
                                                        </th>
                                                        <th class="text-center">
                                                            ผู้แนบ
                                                        </th>
                                                        <th class="text-center">
                                                            วันที่แนบ
                                                        </th>
                                                        <th class="text-center">
                                                            แนบไฟล์
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td class="text-center">
                                                            <span id="flagImage12" class="fa fa-times " style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">
                                                            <label type="text">ใบเสนอราคา</label>
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="text" value="" id="AttachmentDetail12" class="form-control">
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateBy12">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateDate12">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <input id="fileInput12" type="file" name="file" multiple>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            <span id="flagImage13" class="fa fa-times " style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">
                                                            <label type="text">ใบเแจ้งหนี้</label>
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="text" value="" id="AttachmentDetail13" class="form-control">
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateBy13">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateDate13">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <input id="fileInput13" type="file" name="file" multiple>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="text-center">
                                                            <span id="flagImage14" class="fa fa-times " style="color:red;"></span>
                                                        </td>
                                                        <td class="text-center">
                                                            <label type="text">ใบตรวจรับงานผู้รับเหมา</label>
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="text" value="" id="AttachmentDetail14" class="form-control">
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateBy14">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <p type="text" id="fileCreateDate14">-</p>
                                                        </td>
                                                        <td class="text-center">
                                                            <input id="fileInput14" type="file" name="file" multiple>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (@EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
    {
        <div class="row" id="actionpanel">
            <div class="text-center">
                <button type="submit" class="btn btn-success" id="btnSaveWO" onclick="updateWorksheet()">บันทึกข้อมูล</button>
            </div>
        </div>
    }
</div>

@*Modal Extended Appointment*@
<div tabindex="-1" class="modal fade" id="modalExtendDateRepair" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
    <div class="modal-dialog" style="width:60%">
        <div class="modal-content" style="border-radius:6px;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">เลื่อนวันที่นัดหมายซ่อม </h4>
            </div>
            <div class="modal-body text-center" style="padding-bottom: 0;">
                <div class="row">
                    <div class="col-xs-12">
                        <div class="row">
                            <div class="col-xs-5  text-right">
                                <h5><label class="control-label"> เลื่อนวันที่นัดหมายซ่อมเริ่ม (เดิม): </label></h5>
                            </div>
                            <div class="col-xs-3">
                                <div class="bootstrap-datepicker">
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" class="form-control datepicker" id="repairAppointmentFromDate" style="width:100%;" disabled />
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-1  text-right">
                                <h5><label class="control-label"> ถึง: </label></h5>
                            </div>
                            <div class="col-xs-3">
                                <div class="bootstrap-datepicker">
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" class="form-control datepicker" id="repairAppointmentToDate" style="width:100%;" disabled />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <hr />
                    </div>
                    <div class="col-xs-12 mb-15">
                        <div class="row">
                            <div class="col-xs-5  text-right">
                                <h5><label class="control-label"> เลื่อนวันที่นัดหมายซ่อมเริ่ม (ใหม่): </label></h5>
                            </div>
                            <div class="col-xs-3">
                                <div class="bootstrap-datepicker">
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" class="form-control datepicker" id="extRepairAppointmentDateFrom" style="width:100%;" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-1  text-right">
                                <h5><label class="control-label"> ถึง: </label></h5>
                            </div>
                            <div class="col-xs-3">
                                <div class="bootstrap-datepicker">
                                    <div class="bootstrap-datepicker">
                                        <div class="input-group">
                                            <div class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </div>
                                            <input type="text" class="form-control datepicker" id="extRepairAppointmentDateTo" style="width:100%;" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12  mb-15">
                        <div class="row">
                            <div class="col-xs-5 text-right">
                                <h5><label class="control-label"> สาเหตุเลื่อนนัดหมายฯ: </label></h5>
                            </div>
                            <div class="col-xs-4">
                                <select id="ddlExtendedReasonID" class="form-control"></select>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12  mb-15">
                        <div class="row">
                            <div class="col-xs-5 text-right">
                                <h5><label class="control-label"> หมายเหตุ HC: </label></h5>
                            </div>
                            <div class="col-xs-6">
                                <div class="bootstrap-timepicker">
                                    <div class="input-group">
                                        <textarea class="form-control" cols="30" rows="2" data-val="true" id="txtExtendRemark" name="txtExtendRemark" style="width:100%;" type="text" maxlength="512"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (@EnumConfiguration.Role.CallCentre.ToString() == @UserDetail.Role)
                    {
                        <div class="col-xs-12 mb-15">
                            <div class="row">
                                <div class="col-xs-5 text-right">
                                    <h5><label class="control-label"> หมายเหตุ CC: </label></h5>
                                </div>
                                <div class="col-xs-6">
                                    <div class="bootstrap-timepicker">
                                        <div class="input-group">
                                            <textarea class="form-control" cols="30" rows="2" data-val="true" id="txtExtendRemarkCc" name="txtExtendRemarkCc" style="width:100%;" type="text" maxlength="512"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xs-12">
                            <div class="row">
                                <div class="col-xs-5 text-right">
                                    <h5><label class="control-label"> ยืนยัน: </label></h5>
                                </div>
                                <div class="col-xs-6 text-left">

                                    <div class="form-check">
                                        <label class="radio-inline"><input type="radio" name="rdoConfirm" value="true" style="width:20px;height:20px">ยืนยัน</label>
                                        <label class="radio-inline"><input type="radio" name="rdoConfirm" value="false" style="width:20px;height:20px">ไม่ยืนยัน</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-lg-12 text-center">
                        <button type="button" class="btn btn-default" id="btnUpdateExtended" onclick="savePostponeRepairAppointment()"><i class="fa fa-floppy-o"> </i> บันทึก</button>
                        <button type="button" class="btn btn-default" id="btnCancelxtended" data-dismiss="modal"><i class="fa fa-remove"> </i> ยกเลิก</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

@*Modal Extended Appointment History*@
<div tabindex="-1" class="modal fade" id="modalExtendedAppointmentHistory" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
    <div class="modal-dialog" style="width:70%">
        <div class="modal-content" style="border-radius:6px;">
            <div class="modal-header bg-light-blue">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">ประวัติการขอเลื่อนนัด</h4>
            </div>
            <div class="modal-body text-center">
                <form class="widget-content">
                    <div class="row">
                        <div class="col-lg-12" style="overflow:auto">


                            <table class="table table-striped table-bordered table-hover " id="tbExtendedHistory" style="margin: 8px 8px 0px 8px; width:100%">
                                <thead>
                                    <tr class="">
                                        <th class="text-center">
                                            ลำดับ
                                        </th>
                                        <th class="text-center">
                                            สถานะ
                                        </th>
                                        <th class="text-center">
                                            ผู้ขอเลื่อน
                                        </th>
                                        <th class="text-center">
                                            วันเดิม
                                        </th>
                                        <th class="text-center">
                                            วันใหม่
                                        </th>
                                        <th class="text-center" width="200px">
                                            สาเหตุ
                                        </th>
                                        <th class="text-center">
                                            หมายเหตุ HC
                                        </th>
                                        <th class="text-center">
                                            หมายเหตุ CC
                                        </th>
                                        <th class="text-center">
                                            ผู้อนุมัติ CC
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyAppointmentRepairHistory">
                                    <tr>
                                        <td class="text-center Bold text-danger" colspan="9">ไม่มีข้อมูล</td>
                                    </tr>

                                </tbody>
                            </table>
                        </div>
                    </div>
                    <br>
                </form>
            </div>
        </div>
    </div>
</div>

@*Modal Extended Appointment RepairAfter For P'Prajak*@
<div class="modal fade" id="modalExtendedRepairAfter" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
    <div class="modal-dialog" style="width:60%">
        <div class="modal-content" style="border-radius:6px;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">ขยายกำหนดแล้วเสร็จของงานต่อเนื่อง</h4>
            </div>
            <div class="modal-body text-center">
                <div class="row">
                    <div class="col-xs-12">
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                <h5><label class="control-label"> วันเริ่มซ่อมครั้งแรก: </label></h5>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <div class="bootstrap-datepicker">
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  StartDate must be a date." id="StartDateOld"
                                               name="StartDateOld" style="width:100%;" onkeypress="return false" disabled>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                <h5><label class="control-label"> กำหนดแล้วเสร็จ (เดิม): </label></h5>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <div class="bootstrap-datepicker">
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  Appointment must be a date." id="ExpectDateOld"
                                               name="ExpectDateOld" style="width:100%;" onkeypress="return false" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <hr />
                    </div>

                    <div class="col-xs-12">
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                <h5><label class="control-label"> วันที่นัดซ่อม (เดิม): </label></h5>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <div class="bootstrap-datepicker">
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  Appointment must be a date." id="RepairAppointmentDateOld"
                                               name="RepairAppointmentDateOld" style="width:100%;" onkeypress="return false">
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="col-xs-12">
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                <h5><label class="control-label"> วันที่นัดซ่อม (ใหม่): </label></h5>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <div class="bootstrap-datepicker">
                                    <div class="bootstrap-datepicker">
                                        <div class="input-group">
                                            <div class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </div>
                                            <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  Appointment must be a date." id="RepairAppointmentDateNew"
                                                   name="RepairAppointmentDateNew" style="width:100%;" onkeypress="return false">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                <h5><label class="control-label"> กำหนดแล้วเสร็จ (ใหม่): </label></h5>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <div class="bootstrap-datepicker">
                                    <div class="bootstrap-datepicker">
                                        <div class="input-group">
                                            <div class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </div>
                                            <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field  ExpectDate must be a date." id="ExpectDateNew"
                                                   name="ExpectDateNew" style="width:100%;" onkeypress="return false" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                <h5><label class="control-label"> สาเหตุการ: </label></h5>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <select id="ddlExtendedRepairAfterReasonID" class="form-control">
                                    <option value="">-- กรุณาเลือก --</option>
                                </select>
                            </div>
                            <div id="PostponePart">
                                <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                    <h5><label class="control-label"> เข้าซ่อมครั้งที่: </label></h5>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-3">
                                    <select id="ddlExtendedRepairAfterTimesID" class="form-control text-center">
                                        <option value="" class="text-center">-- กรุณาเลือก --</option>
                                        <option value="2" class="text-center">-- 2 --</option>
                                        <option value="3" class="text-center">-- 3 --</option>
                                        <option value="4" class="text-center">-- 4 --</option>
                                        <option value="5" class="text-center">-- 5 --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <div class="row">
                            <br />
                        </div>
                    </div>

                    <div class="col-xs-12">
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-3 text-right">
                                <h5><label class="control-label"> หมายเหตุ: </label></h5>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <textarea class="form-control" cols="30" rows="2" data-val="true" id="txtExtendedRepairAfterRemark" name="txtExtendedRepairAfterRemark" style="width:100%;" type="text" maxlength="512"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <div class="row">
                            <br />
                        </div>
                    </div>

                    <div class="col-xs-12">
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-2 text-right">
                                <h5><label class="control-label"> ผู้ขอขยายฯ: </label></h5>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <select class="col-lg-12 form-control select2" id="ddlUserRequestID" data-placeholder="Choose User Request...">
                                    <option selected>-- กรุณาเลือก --</option>
                                </select>
                            </div>


                            <div class="col-xs-12 col-sm-6 col-lg-2 text-right">
                                <h5><label class="control-label"> ผู้อนุมัติ: </label></h5>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <select class="col-lg-12 form-control select2" id="ddlUserApproveID" data-placeholder="Choose User Approve...">
                                    <option selected>-- กรุณาเลือก --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <div class="row">
                            <br />
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <div class="row">
                            <br />
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <div class="row">
                            <br />
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-lg-12 text-center">
                        <button type="button" class="btn btn-default" id="btnUpdateExtendedRepairAfter"><i class="fa fa-floppy-o"> </i> บันทึก</button>
                        <button type="button" class="btn btn-default" id="btnCancelExtendedRepairAfter" data-dismiss="modal"><i class="fa fa-remove"> </i> ยกเลิก</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalQuestionnaire" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width:60%; min-width: 450px">
        <div class="modal-content" style="border-radius:6px;">
            <div class="modal-header bg-light-blue">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">แบบสอบถามประเมินความพึงพอใจคุณภาพงานซ่อมและการให้บริการ</h4>
            </div>
            <div class="modal-body text-center" id="contentQuestionnaire">

            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-lg-12 text-center">
                        <button type="button" class="btn btn-default" id="btnSaveQuestionnaire" onclick="saveQuestionnaire()"><i class="fa fa-floppy-o"> </i> บันทึก</button>
                        <button type="button" class="btn btn-default" id="btnCancelQuestionnaire" data-dismiss="modal"><i class="fa fa-remove"> </i> ยกเลิก</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="confirmQuestionnaire" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-center" style="width:40%; min-width: 450px">
        <div class="modal-content" style="border-radius:6px;">
            <div class="modal-header bg-light-blue">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">แจ้งเตือน</h4>
            </div>
            <div class="modal-body text-center">
                <h4 id="contentConfirmQuestionnaire"></h4>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-lg-12 text-center">
                        <button type="button" class="btn btn-default" data-dismiss="modal"> ตกลง</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Modal Upload Image  *@
<div tabindex="-1" class="modal fade" id="modalUploadImageBefore" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 6px;">
            <div class="modal-header bg-light-blue">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">แนบ รูปภาพก่อนซ่อม,รูปภาพระหว่างซ่อม,รูปภาพหลังซ่อม</h4>
            </div>
            <div class="modal-body text-center" style="max-height: 85vh; overflow-y: auto;">
                <div class="box box-default">
                    <div class="box-header with-border cursor-pointer" data-toggle="collapse" data-target="#beforeImageInput" aria-expanded="true" aria-controls="beforeImageInput">
                        <a>
                            <h3 class="box-title"><i class="fa fa-picture-o"></i> รูปภาพก่อนซ่อม </h3>
                        </a>
                    </div>
                    <div class="box-body collapse in" id="beforeImageInput">
                        <div class="row">
                            <div class="col-xs-12">
                                <input id="fileInputBefore" name="file" type="file" multiple />
                            </div>
                        </div>
                    </div>
                </div>
                <br>
                <div class="box box-default">
                    <div class="box-header with-border  cursor-pointer" data-toggle="collapse" data-target="#duringImageInput" aria-expanded="true" aria-controls="duringImageInput">
                        <a>
                            <h3 class="box-title"><i class="fa fa-picture-o"></i> รูปภาพระหว่างก่อนซ่อม </h3>
                        </a>
                    </div>
                    <div class="box-body collapse in" id="duringImageInput">
                        <div class="row">
                            <div class="col-xs-12">
                                <input id="fileInputDuring" name="file" type="file" multiple />
                            </div>
                        </div>
                    </div>
                </div>
                <br>
                <div class="box box-default">
                    <div class="box-header with-border  cursor-pointer" data-toggle="collapse" data-target="#afterImageInput" aria-expanded="true" aria-controls="afterImageInput">
                        <a>
                            <h3 class="box-title"><i class="fa fa-picture-o"></i> รูปภาพหลังซ่อม </h3>
                        </a>
                    </div>
                    <div class="box-body collapse in" id="afterImageInput">
                        <div class="row">
                            <div class="col-xs-12">
                                <input id="fileInputAfter" name="file" type="file" multiple />
                            </div>
                        </div>
                    </div>
                </div>
                <br>
            </div>
        </div>
    </div>
</div>

@* Modal view Image BeforeDuringAfter = BDA*@
<div tabindex="-1" class="modal fade" id="modalViewImageBDA" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 6px;">
            <div class="modal-header bg-light-blue">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">ดูรูปภาพ</h4>
            </div>
            <div class="modal-body text-center" style="max-height: 85vh; overflow-y: auto;">
                <div class="box box-default">
                    <div class="box-header with-border cursor-pointer" data-toggle="collapse" data-target="#DivImageInput" aria-expanded="true" aria-controls="DivImageInput">
                        <a>
                            <h3 class="box-title"><i class="fa fa-picture-o"></i> รูปภาพ </h3>
                        </a>
                    </div>
                    <div class="box-body collapse in" id="DivImageInput">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@*Modal รายละเอียดราคางานซ่อม*@
<div tabindex="-1" class="modal fade" id="modalDetailPriceRepair" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog" style="width:95%">
        <div class="modal-content" style="border-radius:6px;">
            <div class="modal-header bg-light-blue">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">รายละเอียดราคางานซ่อม</h4>
            </div>

            <div class="modal-body" style="max-height: 83vh; overflow-y: auto;">
                <form class="widget-content">
                    <div class="row margin">
                        <div class="col-xs-12 col-sm-6 col-lg-3">
                            <label class="control-label ">โครงการ: </label>
                            <div class="text-primary" id="txtPriceRepairProject"></div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-3">
                            <label class="control-label ">แปลง: </label>
                            <div class="text-primary" id="txtPriceRepairUnit"></div>
                        </div>
                    </div>
                </form>
                <form class="widget-content">
                    <div class="row">
                        <div class="table-responsive" style="padding:0; margin:0 15px ; overflow: auto; max-height: 300px; margin-top: 10px">
                            <table class="table table-striped table-bordered table-hover quotation-item-detail" id="tbWorksheetitemDetail" style=" width:auto ; min-width 1600px">
                                <thead>
                                    <tr>
                                        <th>
                                            No.
                                        </th>
                                        <th>
                                            หมวดงานที่ ผรม. ต้องซ่อม
                                        </th>
                                        <th>
                                            รายละเอียดที่ซ่อม
                                        </th>
                                        <th>
                                            อัตรางานเหมา (ราคากลาง)
                                        </th>
                                        <th>
                                            ค่าแรง (ราคากลาง)
                                        </th>
                                        <th>
                                            อัตรางานเหมา (ราคาพิเศษ)
                                        </th>
                                        <th>
                                            ค่าแรง (ราคาพิเศษ)
                                        </th>
                                        <th>
                                            ค่าวัสดุ (ราคาพิเศษ)
                                        </th>
                                        <th>
                                            หน่วย
                                        </th>
                                        <th>
                                            ปริมาณ
                                        </th>
                                        <th>
                                            ราคารวม
                                        </th>
                                        <th>
                                            เหตุผลของราคาพิเศษ
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="quotationItemDetailTBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-lg-3">
                            <label class="control-label ">รวมราคาตามรายการ: </label>
                            <label class="control-label" id="lblTotalPrice">0.00</label>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@* Modal Confirm With Reason *@
<div tabindex="-1" class="modal fade" id="modalConfirmWithReason" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
    <div class="modal-dialog modal-dialog-centered" style="margin-top: 25vh">
        <div class="modal-content" style="border-radius: 6px;">
            <div class="modal-header bg-light-blue" style="border-top-left-radius: 3px;border-top-right-radius: 3px;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="confirmTitle"></h4>
            </div>
            <div class="modal-body " style="padding-bottom: 0">
                <div class="row form-group">
                    <div style="margin: 0 5%">
                        <label id="confirmTxtReason"></label><label style="color: crimson" id="confirmStarReason">*</label>
                        <input class="form-control" type="text" value="" id="confirmReason" />
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background-color:whitesmoke; text-align:center; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; padding: 10px">
                <button type="button" class="btn btn-success" id="confirmBtn" onclick="" style="margin-right: 5px">ยืนยัน</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>


@* Modal Confirm Use Retention *@
<div tabindex="-1" class="modal fade" id="modalConfirmUseRetention" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
    <div class="modal-dialog modal-dialog-centered" style="margin-top: 25vh">
        <div class="modal-content" style="border-radius: 6px;">
            <div class="modal-header bg-light-blue" style="border-top-left-radius: 3px;border-top-right-radius: 3px;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="confirmUseRetentionTitle">ยืนยันการหักเงินเประกันผลงาน</h4>
            </div>
            <div class="modal-body " style="padding-bottom: 0">
                <div></div><h4><label>คุณต้องการหักเงินประกันผลงานผู้รับเหมาหลัก หรือไม่ ?</label></h4>
                <br />
            </div>
            <div class="modal-footer" style="background-color:whitesmoke; text-align:center; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; padding: 10px">
                <button type="button" class="btn btn-success" id="confirmBtn" onclick="" style="margin-right: 5px">ต้องการ</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">ไม่ต้องการ</button>
            </div>
        </div>
    </div>
</div>


<!--  Modal Insert Success -->
<div class="modal fade" id="modalInsertRoleSuccess" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <!-- Change class .modal-sm to change the size of the modal -->
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header bg-green" id="headerModal">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title white"><label id="titleModal">ข้อความ</label></h4>
            </div>
            <div class="modal-body text-center">
                <img src="~/images/success.png" height="100" width="100" id="alertPic" />
                <div>
                    <label id="lbTxtSuccess" class="green">ระบบบันทึกข้อมูลสำเร็จ</label>
                </div>
            </div>
            <div class="modal-footer">
                <button data-dismiss="modal" class="btn btn-success" type="button" name="closeModal" id="closeAlert" onclick="redirectURL()">ปิด</button>
            </div>




        </div>
    </div>
</div>

<div tabindex="-1" class="modal fade" id="modalAlertLineApprove" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
    <div class="modal-dialog modal-dialog-centered" style="margin-top: 25vh">
        <div class="modal-content" style="border-radius: 6px;">
            <div class="modal-header bg-light-blue" style="border-top-left-radius: 3px;border-top-right-radius: 3px;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="confirmTitleProjectApprove"></h4>
            </div>
            <div class="modal-body " style="padding-bottom: 0">
                <label>ไม่สามารถทำการแก้ไขข้อมูลได้ เนื่องจากยังไม่ได้ทำการ Set Workflow กรุณาติดต่อ Admin HC</label>
            </div>
            <div class="modal-footer" style="background-color:whitesmoke; text-align:center; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; padding: 10px">
                <button type="button" class="btn btn-danger" data-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>

<div tabindex="-1" class="modal fade" id="modalRequestCancelF" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
    <div class="modal-dialog modal-dialog-centered" style="margin-top: 25vh">
        <div class="modal-content" style="border-radius: 6px;">
            <div class="modal-header bg-light-blue" style="border-top-left-radius: 3px;border-top-right-radius: 3px;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">กรุณาระบุเหตุผลการยกเลิกเอกสาร</h4>
                <label id="lbType"></label>
            </div>
            <div class="modal-body " style="padding-bottom: 0">
                <div class="row form-group">
                    <div style="margin: 0 5%">
                        <label id="confirmTxtReason"></label><label style="color: crimson">*หมายเหตุการขอยกเลิกเอกสาร</label>
                        <input class="form-control" type="text" value="" id="confirmReasonF" />
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background-color:whitesmoke; text-align:center; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; padding: 10px">
                <button type="button" class="btn btn-success" id="confirmBtnCencelF" onclick="" style="margin-right: 5px">ยืนยัน</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>

@* Modal Alert Siri Piority *@
@{Html.RenderPartial("_DisplaySiriPiority");}




@section Script
{
    <link href="~/Content/theme_green.css" rel="stylesheet" type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.5.1/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/piexif.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.5.1/js/fileinput.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.5.1/themes/explorer/theme.js"></script>


    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

    @*dataTable*@
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <link href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css" rel="stylesheet">

    @*dataTable*@

    <link rel="stylesheet" href="~/assets/plugins/datatables/dataTables.bootstrap-1.10.12.min.css" />
    <link rel="stylesheet" href="~/assets/plugins/datatables/responsive.bootstrap.min.css" />

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.9.3/js/bootstrap-select.min.js" type="text/javascript"></script>



    <script>
		// Declare global variable
		let baseUrl = '@System.Configuration.ConfigurationManager.AppSettings["Construction_API"]';
		let root = '@System.Configuration.ConfigurationManager.AppSettings["BasePath"]';
		let worksheetId = window.location.href.split('/')[window.location.href.split('/').length - 1];
		let receiveId = 0;
		let worksheetItemList = [];
		let quotationList = [];
		let quotationItemList = [];
		let ddlWorkStatus = [];
		let ddlExtendedReason = [];
		let receiveItemList = [];
		let inputNumList = [4, 8, 9, 10, 11, 12, 13, 14];
		let receiveData = {};
		let customerData = {};
		let tempWorksheetItemId;
		let tempVendorName = "";
		let tempVendorCode = "";
		let closeJobFlag = false;
		// questionniar
		let EvaluationDetail = {};
		let EvaluationReason = {};
		let questionnaireData
        let rowCoutQuestionnaire = 0;
        let projectIDCheckbudget = null;
        let receiveItemdetailID = "";

        let vendorRetention = false;


        // PurchesOrder
        let price;
        let OperatingPercent;
        let total_OperatingPercent;
        let VatPercent;
        let total_vat;

        let retentionPercent;
        let totalRetention;
        let totalPrice;
        let AttachFlag = false;
        let po_number = null;
        let checkPo_status = false;
        let totalPricebyWorksheet = 0;

        let po_selectedList = [];
        let po_ListFromSearch = []
        let NetUseRetentionPrice = 0;

        let userRetentionPrice = 0;


        let show_confirmRetention = false;
        let is_autoPO = false;
        let is_haveUseRetention = false;
        let is_doc_completed = false;

        let table, tableWorksheetRetention;

        let worksheetStatusId = null;

        let checkPaymentSelect = false;

        //เปิด Auto 2 PO
        let vendorWagePrice = 0;
        let vendorMaterialPrice = 0
        let POListFor2PO = [];
        let ApproveID = null;
        let POGentype = null;

        var myRows_old = [];
        var empApproveEditData = null;
        var request_token = null;
        //checkRetention()

		// ========================================================================== Initial ==========================================================================
		window.onload = initialize;
		async function initialize(event, pageLoading = true, showSuccess = false) {
			if (pageLoading) {
				await page.loading();
			}
			if (!(+worksheetId)) {
				window.location.href = `${root}/`
				return false;
            }

             request_token = $.ajax({
            url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/login/getTokenCode',
            type: 'GET',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    $.ajaxSetup({
                        headers: {
                            'Authorization': "Bearer " + data.response
                        }
                    });

                }
            });
			//$('.datepicker').datepicker({
			//	autoclose: true,
			//	format: 'dd/mm/yyyy',
			//	startDate: new Date(),
			//	todayHighlight: true
   //         });

            //Initial DatePicker


            const today = new Date().getDate();
            const thisMonth = new Date().getMonth() + 1;
            const thisYear = new Date().getFullYear();
            $('.datepicker').datepicker({
                autoclose: true,
                format: 'dd/mm/yyyy',
                //endDate: '0d'
            });


			$(".timepicker").timepicker({
				showInputs: false,
				showMeridian: false,
			});
			//Get PostponeAppointmentReason
			ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/PostponeAppointmentReason/2`, response => {
				ddlExtendedReason = response;
			})

			// Get WorksheetItem tBodyWorksheetItem
			await ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/GetWorksheetItem/${worksheetId}`, async response => {
				//console.log('WorksheetItem', response);
				worksheetItemList = response;
				// Get ddlWorkStatus
				await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/WorksheetItemStatus`, response => {
					ddlWorkStatus = response;
				});
				receiveId = worksheetItemList.data[0].receiveId;
                bindTbodyWorksheetItem(response.data);
                receiveItemdetailID = response.data[0].receiveItemId;
				// Get receive
				receiveData = await ajaxGet(`${baseUrl}/homecare/api/v1/Receive/${receiveId}`, response => {
					//console.log('receiveData', response);
					$('#receiveJobNoText').text(response.data.receiveJobNoText);
					$('#receivedStatusName').text(response.data.receiveStatusDescription);
					$('#receiveRepairType').text(response.data.repairTypeDescription);
					$('#receiveMainProcessName').text(response.data.mainProcessDescription);
					$('#receiveinformDate').text(thaiFormatDate(response.data.informDate));
					$('#receiveInformUser').text(response.data.informUser);
					$('#receiveInformRemark').text(response.data.informRemark);
					$('#receiveInformCustomerTypeName').text(response.data.informCustomerTypeDescription);
					$('#receiveHCDate').text(thaiFormatDate(response.data.receiveHcDate));
					$('#receiveHCRemark').text(response.data.receiveHcRemark);
                    $('#receiveUser').text(response.data.receiveHcUser);
                    if (response.data.receiveCcDate != null) {
                        $('#receiveCCDate').text(response.data.receiveCcDate);
                    } else {
                        $('#receiveCCDate').text("-");
                    }
					$('#receiveCCRemark').text(response.data.receiveCcRemark);
					$('#receiveAppointmentDate').text(thaiFormatDate(response.data.receiveAppointmentDate, false));
					$('#receiveAppointmentTimeFrom').text(response.data.receiveAppointmentTimeFrom);
					$('#receiveAppointmentTimeTo').text(response.data.receiveAppointmentTimeTo);
					// Toggle Receive-Detail and Inform-Detail info pane
					//$('#Received-Receive-Detail').collapse();
					//$('#Received-Inform-Detail').collapse();
					// Show informer info if informer is not owner
					if (response.data.informCustomerTypeId != 1) {
						$('#DivOptionalNameTel').show();
						$('#receiveInformCustomerName').text(response.data.informCustomerName);
						$('#receiveInformCustomerTel').text(response.data.informCustomerTelephone);
					}
					// If a receive has informer email then show it
					if (response.data.informCustomerEmail) {
						$('#DivOptionalEmail').show();
						$('#customerEmail').text(response.data.informCustomerEmail);
					}
					// Check flagUrgent
					if (response.data.flagUrgent) {
						$('#flagUrgent').show();
					}

					// Check flagChina
					if (response.data.flagChina) {
						$('#headerReceive').find('img').remove();
						$('#headerReceive').append(`
							<img class="flag-china" src="https://s3-ap-southeast-1.amazonaws.com/sansiri-conss-ro77/www/public/images/flag-china.svg" alt="China flag" />
						`);
					}
					// Check vip status
					ajaxGet(`${baseUrl}/homecare/api/v1/Customer/CheckVipStatus/${response.data.prospectId}`, response => {
					    if (response.data.vipStatus)
					    {
					        if (response.data.vipStatus.includes('Priority'))
					        {
					            $('#customerInfo').append(` <span class="label label-danger tag-label">${response.data.vipStatus}</span>`);
					        }
                            else {
                                $('#customerInfo').append(' <a class="label label-warning DisplaySiriPiority">VIP</a>');
                            }
                            $(".DisplaySiriPiority").on('click', function () {

                                $('#modalDisplaySiriPiority').modal('show');

                            });
						}
					});

					return response;
                });

				//Get QuotationList
			    await ajaxGet(`${baseUrl}/homecare/api/v1/Quotation/GetQuotationGoods/${receiveId}`, quotationListRes => {
					quotationList = quotationListRes;
					var quotationPaid = quotationList.data.filter(item => item.paymentStatusId == 2 && (item.insertType == 'V' || item.insertType == null));
					quotationItemList = [];

					//Get AllQuotationItemList
					for (var i = 0; i < quotationPaid.length; i++)
					{
						ajaxGet(`${baseUrl}/homecare/api/v1/Quotation/GetQuotationGoodsItem/${quotationPaid[i].quotationGoodsId}`, response => {
                            quotationItemList = quotationItemList.concat(response.data);
						})
					}
		     });


				ajaxGet(`${baseUrl}/homecare/api/v1/Receive/GetReceiveItem/${receiveId}`, async response => {
					receiveItemList = response;
					//console.log('receiveItemList', receiveItemList);
				});
			});
			// Get Worksheet
			ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/${worksheetId}`, response => {
				//console.log('Worksheet', response);
                closeJobFlag = response.data.worksheetCloseJobFlag;
                if (response.data.vatPercent == 0) {
                    $("#vat"). prop("checked", true);
                }
                if (response.data.vatPercent == 7) {
                   $("#vat"). prop("checked", false);
                }
				$('#Worksheet-Worksheet-Detail').collapse();
				$('#worksheetJobText').text(response.data.worksheetJobNoText);
				$('#worksheetStatus').text(response.data.worksheetStatus);
				$('#worksheetCreatedDate').text(response.data.worksheetCreatedDate.split(' ')[0]);
				$('#worksheetCreatedUser').text(response.data.worksheetCreatedBy);
				$('#worksheetVendorName').text(response.data.vendorName);
                $('#hdVendorID').val(response.data.vendorId);
                $('#hdProjectCode').val(response.data.projectCode);
                worksheetStatusId = response.data.worksheetStatusId; //เช็ค Status ใบงานในการทำ WorkFlow Retention
                ajaxGet(`${baseUrl}/homecare/api/v1/LineApprove/CheckHistoryEditDataFlow?id=${worksheetId}&projectCode=${response.data.projectCode}`, async response => {
                    if (response.data.length > 0 && response.data[0].Detail_old != null) {
                        $('#iconwait').show();
                        $('#lbStatusEditData').show();
                        empApproveEditData = 'โดยคุณ' + response.data[0].EmpApproveName;
                        $('#lbEmpEditData').text(empApproveEditData).show();
                        flagEdit = true;
                        $('.lbVendor').addClass('hidden');
                        $('.itemAddVendor').addClass('hidden');

                    } else {

                        $('#iconwait').hide();
                        flagEdit = false;
                        $('.lbVendor').removeClass('hidden');
                        $('.itemAddVendor').removeClass('hidden');
                    }
                });

                if (response.data.worksheetCloseJobFlag) {
                    $('#worksheetCloseConfirm').attr({ checked: true, disabled: true });
                    $('#worksheetFlagCloseDate').val(response.data.worksheetCloseJobDate);
                    $('#btnWorkSheetRollback').css("display", "block");
                }
                else {
                    $('#btnWorkSheetRollback').css("display", "none");

                }
				tempVendorName = response.data.vendorName;
				tempVendorCode = response.data.vendorId;
				//console.log('worksheetStatusId', response.data.worksheetStatusId);
				//Initail Questionnair
				if (response.data.worksheetStatusId == 15 || response.data.worksheetStatusId == 16) {
					getToken().then(token => {
						var body = {
							"TokenCode": token.response,
							"WorksheetID": worksheetId,
						}
						var bodyM = {
							"Typename": "HC_CC_Contact_Reason",
							"TokenCode": token.response
						}
						$.ajax({
							url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Master/GetMasterData',
							type: 'POST',
							contentType: "application/json",
							data: JSON.stringify(bodyM),
							cache: false
						}).done(data => {
							EvaluationReason = data.response;
							var request = $.ajax({
								url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/GetEvaluationDetail',
								type: 'POST',
								data: JSON.stringify(body),
								async: true,
								crossDomain: true,
								headers: {
									"Content-Type": "application/json",
									"Cache-Control": "no-cache",
								}
							});
							request.done(data => {
								//console.log(data);
								EvaluationDetail = data.response;
								if (EvaluationDetail.evaluate_cc_contact) {
									$.each(EvaluationReason, (i, d) => {
										if (EvaluationDetail.evaluate_cc_reasonID == d.ValueID) {
											$('#displayReason').text('*' + d.DescriptionTH);
											$('#displayReason').show();
											return false;
										}
									})
								}
							})
						});
					});
					$('#questionnaireDisplayDiv').show();
				}

				// Get customer
				ajaxGet(`${baseUrl}/homecare/api/v1/Customer/${response.data.unitId}`, response => {

                    customerData = response.data;
                    $('#customerName').text(customerData.fullNameTh);
                    $('#customerMobile').text(customerData.mobile + ', ' + customerData.contactInformation);
					$('#customerProject').text(customerData.projectNameTh);
					$('#customerUnitCode').text(customerData.unitCodeAddress);
					$('#customerUnitModel').text(customerData.unitModel);
					$('#customerStartGuaranteeDate').text(customerData.startGuaranteeDate);
					$('#customerEndGuaranteeDate').text(customerData.endGuaranteeDate);
					$('#customerExtraGuaranteeDate').text(customerData.extraGuaranteeDate);
					// Toggle customer info pane
					//$('#Received-Customer-Detail').collapse();
					if (closeJobFlag) {
                        $('.main').find('input, select, textarea').attr('disabled', 1);
                        $('#vat').removeAttr('disabled');
					}
					page.loaded();
					if (showSuccess) {
						modalSuccess()
                    }
                    projectIDCheckbudget = customerData.projectCode;
				});
			})
			var promises = [
				checkFileImage(0, 1),
				checkFileImage(0, 2),
				checkFileImage(0, 3)
			];
			var [before, during, after] = await Promise.all(promises);
			if (before) {
				$('#flagImageBefore').removeClass('fa-times').addClass('fa-check-square-o').css('color', 'green');
			}
			if (during) {
				$('#flagImageDuring').removeClass('fa-times').addClass('fa-check-square-o').css('color', 'green');
			}
			if (after) {
				$('#flagImageAfter').removeClass('fa-times').addClass('fa-check-square-o').css('color', 'green');
			}
			//Initail all FileUploadDocument
            initailFileUploadDocument(showSuccess);

            $("#saveCancelPO").css("display", "none");
            $("#createPO_NO").css("display", "none");
            $("#createWorkFlow").css("display", "none");

            await  calTotalPrice(quotationItemList.filter(item => item.receiveItemId == receiveItemdetailID)); // คำนวณราคา
            //await cal_worksheet_checked_attach_file(quotationItemList.filter(item => item.receiveItemId == receiveItemdetailID)); // ตรวจสอบการ Attach File
            var quotationPrice = quotationItemList.filter(item => item.receiveItemId == receiveItemdetailID)
            var total = 0;
            $.each(quotationPrice, (i, d) => {
                total += (d.vendorPackagePrice + d.vendorWagePrice + d.vendorMaterialPrice) * d.quantity
            })

            if ('@EnumConfiguration.Role.VENDOR.ToString()' != '@UserDetail.Role') {

                await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/GetPaymentByWorkSeetID?worksheetID=${worksheetId}`, async response => {
                    if (response.data.length > 0) {
                        ApproveID = response.data[0].id
                        $('input:radio[name="AprrovedType"]').filter('[value="' + response.data[0].paymentType + '"]').attr('checked', true);
                        await bindingPaymentType(response.data[0].paymentType);
                        $("#PaymentType option[value='" + response.data[0].paymentType_ID + "']").prop('selected', true);

                        if (response.data[0].paymentType != "Y") {
                            is_autoPO = false;
                            checkPaymentSelect = false;
                            checkPo_status = true;
                            show_confirmRetention = false;
                        }
                        else {

                            if ($("[id *= PaymentType]").val() != '0') {
                                checkPaymentSelect = true;
                            } else {
                                //เลือก Y มีค่าใช้จ่ายแต่ไม่ได้เลือกเหตุผล ยังไม่ทำการ
                                show_confirmRetention = false;
                                is_autoPO = false;
                            }
                        }
                    } else {
                        show_confirmRetention = false;
                        is_autoPO = false;
                    }
                });

                UpdateRetentionStatus();
                await calPriceWorkSheet(0);

                await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/GetPurchaseOrderHistory?worksheetID=${worksheetId}`, purcheOrder => {
                    var po_no = purcheOrder;

                    if (po_no.data.length == 0) {

                        //  show_confirmRetention = true;//ถามRetention
                        is_autoPO = true; //ต้องทำ AutoPO
                        //กรณี ดึงไม่มีข้อมูล = worksheet นี้ไม่เคย Auto สร้างใบ PO มาก่อน ต้องยิงไปสร้าง ถ้าสร้างไม่สำเร็จ PO No. = 0
                        //createPO_Manual();

                    } else {
                        var po_no_active = po_no.data.filter(item => item.is_active == "True");
                        if (po_no_active.length == 0) {
                            $('#PO_No').text("");
                            $('#po_status').text("ยกเลิกใบ PO เดิม");
                            $("#createPO_NO").css("display", "block");
                            $("#btnCancelPO").css("display", "none");
                            $("#createWorkFlow").css("display", "none");
                            checkPo_status = false;

                            //  show_confirmRetention = true;//ถามRetention
                            is_autoPO = false;

                        } else {

                            if (po_no_active[0].ponumber == 0 || po_no_active[0].ponumber == "-") { //ถ้า PO No. = 0 หมายถึงเคยยิงสร้าง Auto PO ไปแล้วแต่ไม่สำเร็จ ต้องแสดงปุ่ม Create PO Manual ให้ User กดสร้างเองอีกครั้ง

                                $('#PO_No').text("");
                                $('#po_status').text("สร้าง PO ไม่สำเร็จ");
                                $("#createPO_NO").css("display", "block");
                                $("#btnCancelPO").css("display", "none");
                                $("#createWorkFlow").css("display", "none");
                                checkPo_status = false;

                                //  show_confirmRetention = true;//ถามRetention
                                is_autoPO = false;
                            }
                            else { // ถ้ามี PO แล้วให้แสดงหมายเลข PO และแสดง ปุ่ม Cancel ไว้เผื่อ User ทำการ Cancel

                                /*for (var i = 0; i < po_no.data.length; i++) {*/
                                if (po_no_active.length == 0) {
                                    //$('#PO_No').text("");
                                    $('#po_status').text("ยกเลิกใบ PO เดิม");
                                    $("#createPO_NO").css("display", "block");
                                    $("#btnCancelPO").css("display", "none");
                                    $("#createWorkFlow").css("display", "none");
                                    checkPo_status = false;

                                    //  show_confirmRetention = true;//ถามRetention
                                    is_autoPO = false;

                                }
                                else {
                                    is_doc_completed = true;
                                    var x = document.getElementById("panelRetention");
                                    x.style.display = "none";
                                    if (po_no_active[0].po_status == 2) {

                                        $.each(po_no_active, function (Index, Value) {
                                            $('#PO_No2').append($("<option></option>").val(Value.ponumber).html(Value.ponumber));
                                        });
                                        po_number = po_no_active[0].ponumber;
                                        //$('#PO_No').text(po_no_active[0].ponumber);
                                        $('#po_date').text(po_no_active[0].createDate);
                                        $('#po_status').text(po_no_active[0].approveDesc);
                                        $("#btnCancelPO").css("display", "block");
                                        $("#createPO_NO").css("display", "none");
                                        checkPo_status = true;

                                    } else { // กรณีที่สร้าง WorkFlow ไม่สำเร็จ จะต้องมีปุ่มกดสร้าง WorkFlow เอง

                                        //$('#PO_No').text(po_no_active[0].ponumber);
                                        $.each(po_no_active, function (Index, Value) {
                                            $('#PO_No2').append($("<option></option>").val(Value.ponumber).html(Value.ponumber));
                                        });

                                        po_number = po_no_active[0].ponumber;
                                        $('#po_date').text(po_no_active[0].createDate);
                                        $('#po_status').text('สร้าง WorkFlow ไม่สำเร็จ');
                                        $("#btnCancelPO").css("display", "none");
                                        $("#createPO_NO").css("display", "none");
                                        $("#createWorkFlow").css("display", "block");
                                        checkPo_status = false;

                                    }
                                }
                            }
                        }
                    }
                });
                $('#tab-listRetention').hide();
                if ($("[id *= PaymentType]").val() != '0') {
                    checkPaymentSelect = true;
                } else {
                    //เลือก Y มีค่าใช้จ่ายแต่ไม่ได้เลือกเหตุผล ยังไม่ทำการ Show POPUP จนกว่าจะเลือกและบันทึกผล
                    show_confirmRetention = false;
                    is_autoPO = false;
                }
                //ปิดใบงานแล้วไม่ต้อง POPUP ถาม
                if (document.getElementById('worksheetCloseConfirm').checked) {
                    show_confirmRetention = false;
                    is_autoPO = false;
                }

                await checkRetention();
                var name = localStorage.getItem("name");

                if ($('#PaymentType').val() === "46") {
                    show_confirmRetention = false;
                }

                if ($("[name*=AprrovedType]:checked").val() == "Y") {
                    if (show_confirmRetention && (name == "OK" || name == null || "SAVEAPR")) {
                        //ถ้าหากหัก Retention ไม่เท่ากับ 0 ก็ถาม User เพื่อยืนยันจะใช้ Retention ต่อ หรือจะเปิด PO เลย
                        var confirmUseRetention = await openModalConfirmUserRetention(); // จะเป็น Fasle ได้ก็ต่อเมื่อ User กดไม่หัก Retention
                        $('#modalConfirmUseRetention').modal('hide');
                        if (!confirmUseRetention) {
                            if (is_haveUseRetention) {
                                var x = document.getElementById("panelRetention");
                                x.style.display = "block";

                            } else {
                                var x = document.getElementById("panelRetention");
                                x.style.display = "none";

                            }

                            var y = document.getElementById("panelPurchesOrder");
                            y.style.display = "block";

                            if (is_autoPO) {
                                if (!is_doc_completed) {
                                    createPO_Manual();
                                }


                            }
                            if (is_doc_completed) {
                                $("[id*=PaymentType]").attr('disabled', 'disabled');
                                $("[name*=AprrovedType]").attr('disabled', 'disabled');
                            }

                        }
                        else {
                            //if (is_haveUseRetention) {
                            var x = document.getElementById("panelRetention");
                            x.style.display = "block";

                            var y = document.getElementById("panelPurchesOrder");
                            y.style.display = "none";

                            await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/UpdateRetentionDataOnetime?worksheetID=${worksheetId}&RetentionPercent=0&RetentionPrice=0`, response => {
                                console.log(response);
                                if (response) {


                                }
                            });

                        }

                    }
                    else {
                        if (is_haveUseRetention) {
                            await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/UpdateRetentionDataOnetime?worksheetID=${worksheetId}&RetentionPercent=0&RetentionPrice=0`, response => {
                                console.log(response);
                                if (response) {

                                    var sumUseRetention = parseFloat($('#lblUerSumRetentionPrice').text());
                                }
                            });
                        }
                        if (is_autoPO) {
                            if (!is_doc_completed) {
                                createPO_Manual();
                            }
                        }

                        if (is_haveUseRetention) {
                            var x = document.getElementById("panelRetention");
                            x.style.display = "block";

                        } else {
                            var x = document.getElementById("panelRetention");
                            x.style.display = "none";

                        }
                        var sumUseRetention = parseFloat($('#lblUerSumRetentionPrice').text());
                        var lblFinalNetPrice = parseFloat($('#lblFinalNetPrice').text());
                        if ((lblFinalNetPrice - sumUseRetention) > 0) {
                            var y = document.getElementById("panelPurchesOrder");
                            y.style.display = "block";
                        } else {
                            if (is_haveUseRetention == false) {
                                var y = document.getElementById("panelPurchesOrder");
                                y.style.display = "block";
                            } else {
                                var y = document.getElementById("panelPurchesOrder");
                                y.style.display = "none";
                            }
                            is_doc_completed = true;
                            checkPo_status = true;
                        }

                    }
                    await showUseRetentionDeteail();
                    await GetWorkSheetPODetail();
                    if (is_doc_completed) {
                        $("[id*=PaymentType]").attr('disabled', 'disabled');
                        $("[name*=AprrovedType]").attr('disabled', 'disabled');
                    }
                }
                else {
                    var y = document.getElementById("panelPurchesOrder");
                    y.style.display = "none";
                    var x = document.getElementById("panelRetention");
                    x.style.display = "none";
                    is_doc_completed = true;
                    checkPo_status = true;
                }

                await GetDocumentTypeList();
                await GetCompanyList();

                await checkDocComplete();
                $('#vendor-list').DataTable().destroy();
                $('#vendor-list').DataTable({
                    "createdRow": function (row, data, index) {
                        $('.datepicker', row).datepicker({
                            autoclose: true,
                            format: 'dd/mm/yyyy'
                        });
                    },
                    "processing": true,
                    "language": {
                        "search": "ค้นหา : ",
                        "lengthMenu": "แสดง _MENU_ รายการ",
                        "emptyTable": "ไม่พบข้อมูล",
                        "info": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                        "paginate": {
                            "first": "หน้าแรก",
                            "last": "หน้าสุดท้าย",
                            "next": "ถัดไป",
                            "previous": "ก่อนหน้า"
                        }
                    }
                });

            } else {
                await calPriceWorkSheet(0);
            }

            localStorage.setItem("name", "OK");
            CheckReadOnlyPermission();
        }

        function CheckReadOnlyPermission() {
            console.log('checkper');
            ajaxGet(`${baseUrl}/homecare/api/v1/User/@UserDetail.UserID/Permission`, response => {
                if (response) {
                    if (!response.data.find(a => a.permissionDescription === 'AttachDocumentsF')) {
                        console.log('disable');
                        $("#AttachDocumentsF :input").attr('disabled', 'disabled');
                        $(".modal-header .close ").removeAttr('disabled');
                    }

                    if (!response.data.find(a => a.permissionDescription === 'AttachMemo')) {
                        console.log('disable');
                        $("#AttachMemo :input").attr('disabled', 'disabled');
                        $(".modal-header .close ").removeAttr('disabled');
                    }

                    if (!response.data.find(a => a.permissionDescription === 'AttachVendorDocuments')) {
                        //console.log('disable');
                        $("#AttachVendorDocuments :input").attr('disabled', 'disabled');
                        $(".modal-header .close ").removeAttr('disabled');
                    }

                    if (!response.data.find(a => a.permissionDescription === 'RollbackWorksheet') && ('@EnumConfiguration.Role.SUPPORT_HC.ToString()' !== '@UserDetail.Role')) {
                        console.log('disable');
                        $('#WorkSheetRollbackDisplayDiv').css("display", "none");

                    } else {
                        $('#WorkSheetRollbackDisplayDiv').css("display", "block");
                    }

                    if (!response.data.find(a => a.permissionDescription === 'POManagement') && ('@EnumConfiguration.Role.SUPPORT_HC.ToString()' !== '@UserDetail.Role')) {
                        console.log('disable');
                        $('#divPOManage').css("display", "none");

                    } else {
                        $('#divPOManage').css("display", "block");
                    }

                    if (response.data.find(a => a.accessDescription === 'CallCentreRole')) {
                        $("[name*='hdConfirmDate']").each(function () {
                            $(this).attr("disabled", "disabled");
                        });
                        $("[name*='chkDateStart']").each(function () {
                            $(this).attr("disabled", "disabled");
                        });
                        $("[name*='chkDateEnd']").each(function () {
                            $(this).attr("disabled", "disabled");
                        });

                        $("[name*='btnWorksheetPic']").each(function () {
                            $(this).attr("disabled", "disabled");
                        });

                        $("[name*='worksheetCauseText']").each(function () {
                            $(this).attr("disabled", "disabled");
                        });

                        $("#itemAddVendor").attr("hidden", "hidden");

                    }

                    if (response.data.find(a => a.accessDescription === 'VENDORRole')) {

                        $("#Worksheet-Worksheet-Detail :input").attr('disabled', 'disabled');
                        $("#Worksheet-Worksheet-Detail :button").attr('disabled', 'disabled');
                        $("#Worksheet-Retention :input").attr('disabled', 'disabled');
                        $("#Worksheet-Retention :button").attr('disabled', 'disabled');

                        $("[name*='btnWorksheetPic']").each(function () {
                            $(this).attr("disabled", false);
                        });
                    }

                    if (response.data.find(a => a.accessDescription === 'SUPPORT_QCRole')) {

                        $("#Received-Receive :input").attr('disabled', 'disabled');
                        $("#Received-Receive :button").attr('disabled', 'disabled');

                        $("#Received-Inform :input").attr('disabled', 'disabled');
                        $("#Received-Inform :button").attr('disabled', 'disabled');

                        $("#Worksheet-Worksheet-Detail :input").attr('disabled', 'disabled');
                        $("#Worksheet-Worksheet-Detail :button").attr('disabled', 'disabled');

                        $("#panelPurchesOrder :input").attr('disabled', 'disabled');
                        $("#panelPurchesOrder :button").attr('disabled', 'disabled');

                        $("#panelRetention :input").attr('disabled', 'disabled');
                        $("#panelRetention :button").attr('disabled', 'disabled');

                        $("#actionpanel :input").attr('disabled', 'disabled');
                        $("#actionpanel :button").attr('disabled', 'disabled');
                    }
                }
            });
        }

       async function checkRetention() {

           await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/getSumUseRetention?worksheetID=${worksheetId}`, retentionDetail => {
               var retentionData = retentionDetail.data;
               if (retentionDetail.data.length > 0) {
                   show_confirmRetention = false;
                   //if (retentionData[0].calBefeforNotINclueVat == 0 || retentionData[0].calBefeforNotINclueVat < 0) {
                   if (retentionData[0].calBefeforNotINclueVat <= 0) {
                       is_doc_completed = true;
                       var y = document.getElementById("panelPurchesOrder");
                       y.style.display = "none";
                   }
                   //lblUerSumRetentionPrice = retentionData[0].calBefeforNotINclueVat
                   $('#lblUerSumRetentionPrice').text(retentionData[0].sum_retention.toFixed(2));
                   $('#showPanelRetentionVendor').css("display", "block");
                   is_haveUseRetention = true;
               }
               else {

                   $('#lblUerSumRetentionPrice').text(0);
                   $('#showPanelRetentionVendor').css("display", "block");
                   is_haveUseRetention = false;
               }
            });


        }

        async function checkDocComplete() {
            if (is_doc_completed) {
                document.getElementById("btnAction").disabled = true;
                //document.getElementById("btnSearchVendor").disabled = true;
                document.getElementById("btnCreateRetention").disabled = true;


            } else {
                document.getElementById("btnAction").disabled = false;
                document.getElementById("btnCreateRetention").disabled = false;

            }


        }


		// =========================================================================== Events ===========================================================================
		// วันเข้าตรวจสอบจริง
		function bindTodayDate(ele) {
			var input = $(ele).parent().parent().find('input');
			if ($(ele).prop('checked')) {
				var date = new Date().toJSON().slice(0, 10).replace(/-/g, '/').split('/');
                input.val(`${date[2]}/${date[1]}/${date[0]}`);
                return true;
		    } else {
                input.val('');
                return false;
		    }
        }

		function bindStartRepair(ele, row, statusId) {
			if (!validateBindStart(statusId, row)) {
				$('#chkDateStart' + row).prop('checked', 0);
				return false;
			}
			if ($(ele).prop('checked')) {
				$('#ddlWorkSheetStatus' + row).attr('disabled', 1);
			} else {
				$('#ddlWorkSheetStatus' + row).removeAttr('disabled');
			}
            bindTodayDate(ele);
            if (!$("#chkDateStart" + row).prop('checked')) {
                if ($("#chkDateEnd" + row).prop('checked')) {
                    $("#chkDateEnd" + row).prop('checked', false);
                    $("#chkDateEnd" + row).val("");
                }
                if ($("#worksheetDateEnd" + row).val()) {
                    $("#worksheetDateEnd" + row).val("");
                }
            }
        }

		async function bindEndRepair(ele, row, worksheetItemId, receiveItemId) {
			if ($("#chkDateEnd" + row).prop('checked')) {
				$("#chkDateEnd" + row).prop('checked', 0);
				if (!($("#worksheetDateStart" + row).val() && $("#chkDateStart" + row).prop('checked'))) {
					modalWaring("กรุณาเลือก \"วันที่เริ่มซ่อม\" ก่อน");
					return false;
				}
				if (!await validateEnddate(worksheetItemId, receiveItemId)) {
					return false;
				}
				$("#chkDateEnd" + row).prop('checked', 1);
				bindTodayDate(ele);
			} else {
				bindTodayDate(ele);
			}
        }

		// Vendor by พี่สืบ
        function itemAddvendor() {
             $.get(`${baseUrl}/homecare/api/v1/LineApprove/GetLineApproveEditData?projectId=${customerData.projectId}`, function (data) {
                 if (data.data.length > 0) {
                     $(".boxVendorRemark").removeClass('hidden');
                clearVendorSearch();
                $("#modalAddVendor").appendTo("body").modal('show');
                $("#tbAddvendor tbody tr").remove();
                $("#tbAddvendor tbody").append("<tr></tr>");
                $("#tbAddvendor tbody tr").append("<td class='text-center Bold text-danger' colspan='6'>ไม่มีข้อมูล</td>");

            } else {
                $('#modalAlertLineApprove').modal('show');
                var title = "โครงการ " + customerData.projectCode + " - " + customerData.projectName;
                $('#confirmTitleProjectApprove').text(title);


            }
             });



        }
        $("#btnSearchVendor").on("click", function () {
            if ( $("#textCrivendorCode").val() == "" && $("#textCrivendorName").val() == "" && $("#textCriIDCard").val() == "" ) {
                modalWaring("กรุณาระบุเงื่อนไขในการค้นหา");
            } else {
                if (vendorRetention == true) {
                    //$("#modalAddVendor").appendTo("body").modal('show');
                    //SearchVendor_retention();
                    SearchVendor();
                } else {
                    SearchVendor();
                }

            }

           var table4 = $('#vendor-list').DataTable();
            table4.clear();
            $('#lblNetRetentionPrice').text(0);
            $('#lblNetRetentionPrice').val(0);
        });
        async function SearchVendor() {
            await page.loading();
            var body = {
                Name: $("#textCrivendorName").val(),
                TaxID: $("#textCriIDCard").val(),
                Vendor: $("#textCrivendorCode").val() == "" ? "" : $("#textCrivendorCode").val()
            };
            $.ajax({
                url: '@Url.Action("getListVendormaster", "Master")',
                type: 'POST',
                data: body,
                traditional: true,
                success: function (data) {
                    $("#tbAddvendor tbody tr").remove();
                    if (data.length == 0) {
                        $("#tbAddvendor tbody").append("<tr></tr>");
                        $("#tbAddvendor tbody tr").append("<td class='text-center Bold text-danger' colspan='6'>ไม่มีข้อมูล</td>");
                    } else {
                        $.each(data, function (key, value) {
                            $("#tbAddvendor tbody").append("<tr></tr>");
                            $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\"><label id='VendorCode'>" + value.Vendor.substr(value.Vendor.length - 6) + "</label></td>");
                            $("#tbAddvendor tbody tr:last").append("<td class=\"text-left\"><label id='VendorName'>" + value.Name + "</lable></td>");
                            $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\">" + value.CardID + "</td>");
                            $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\">" + value.TaxID + "</td>");
                            $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\"></td>");
                            $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\"><a id='selectVendor' name='selectVendor[]'>เลือก</a></td>");
                        });
                        $("[name*='selectVendor[]']").each(function (idx, elem) {

                            var obj = {}
                            obj["vendorCode"] = $("#hdVendorID").val();
                            obj["vendorName"] = $('#worksheetVendorName').text();
                            myRows_old.push(obj)

                            $(this).click(function () {
                                if ($("#RemarkVendor").val() == "") {
                                modalWaring('กรุณาระบุเหตุผลในการเปลี่ยนผู้รับเหมา');
                                return;
                                }
                                var myRows_new = [];
                                var obj = {}
                                obj["vendorCode"] = $(this).closest('tr').find("#VendorCode").text();
                                obj["vendorName"] = $(this).closest('tr').find("#VendorName").text();
                                myRows_new.push(obj)

                                var data = {
                                    ID: worksheetId,
                                    ReceiveJobNo: $('#worksheetJobText').text(),
                                    projectCode: $('#customerUnitCode').text().split('-')[0],
                                    projectName: $('#customerUnitCode').text().split('-')[0] + '-' + $('#customerProject').text(),
                                    EditType: "แก้ไขผู้รับเหมา",
                                    Remark: $('#RemarkVendor').val(),
                                    UserLogin : "@UserDetail.CodeName",
                                    DetailVendor_old: myRows_old,
                                    DetailVendor_new: myRows_new
                                };

                                ajaxPost(`${baseUrl}/homecare/api/v1/Receive/SaveEditDataSendApprove`, data, response => {

                                    if (response) {
                                        $('#lbStatusEditData').show();
                                        $("#modalAddVendor").appendTo("body").modal('hide');
                                        showModalLineApprveSuccess('ส่งคำขอแก้ไขข้อมูลเรียบร้อยแล้ว');

                                    } else {
                                        showModalLineApprveWarning('เกิดข้อผิดพลาด บันทึกไม่สำเร็จ');
                                    }
                                });



                                //var VendorCode = $(this).closest('tr').find("#VendorCode").text()
                                //var VendorName = $(this).closest('tr').find("#VendorName").text()
                                //if (vendorRetention) {
                                //    $("#vendorCode").val(VendorCode);
                                //    $("#vendorName").val(VendorName);
                                //    $("#modalAddVendor").modal('hide');
                                //    vendorRetention = false;
                                //} else {
                                //    $("#worksheetVendorName").text(VendorName);
                                //    $("#hdVendorID").val(VendorCode);
                                //    $("#modalAddVendor").modal('hide');
                                //    $("#divchangeVendorRemark").show();
                                //    $("#hdFlagchangeVendor").val(true);
                                //    if (tempVendorName == $("#worksheetVendorName").text() && tempVendorCode == $("#hdVendorID").val()) {
                                //        $("#divchangeVendorRemark").hide();
                                //        $("#hdFlagchangeVendor").val(false);
                                //    }


                                //}



                            });
                        });
                    }
                    page.loaded();

                },
            });
        }

        function itemAddvendor_retention() {
            clearVendorSearch();
            $("#modalAddVendor").appendTo("body").modal('show');
            $("#tbAddvendor tbody tr").remove();
            $("#tbAddvendor tbody").append("<tr></tr>");
            $("#tbAddvendor tbody tr").append("<td class='text-center Bold text-danger' colspan='6'>ไม่มีข้อมูล</td>");
            vendorRetention = true;

        }

    function genQuotationPDF(quotationType) {
            // var NoVat =  $('#vat').prop('checked') !== undefined ?  $('#vat').prop('checked') : false;

			var rightQuotationGoodsId = quotationItemList.find(d => d.receiveItemId == worksheetItemList.data[0].receiveItemId).quotationGoodsId;
			//console.log('rightQuotationGoodsId', rightQuotationGoodsId);
            if (quotationList.data.length > 0) {

				ajaxGet(`${baseUrl}/homecare/api/v1/DocumentToken`, response => {
					var win = window.open(`${baseUrl}/homecare/Document/QuotationGoods/R/${rightQuotationGoodsId}?QuotationType=${quotationType}&Token=${response.data}&WorksheetId=${worksheetId}`, '_blank');
					if (win) {
						win.focus();
					}
				});
			}
		}
		function genDocumentFOne() {
			ajaxGet(`${baseUrl}/homecare/api/v1/DocumentToken`, response => {
				var win = window.open(`${baseUrl}/homecare/Document/F1Document/${worksheetId}?Token=${response.data}`, '_blank');
				if (win) {
					win.focus();
				}
			});
		}

		// ========================================================================= OpenModal =========================================================================
		// Opem ModalExtendedAppointment
		async function openModalExtendedAppointment(worksheetItemId) {
			tempWorksheetItemId = worksheetItemId;
			bindingDdlist('ddlExtendedReasonID', ddlExtendedReason.data, 0);
			$("#ddlExtendedReasonID").val(0);
			$("#repairAppointmentFromDate").val('');
			$("#repairAppointmentToDate").val('');
			$("#extRepairAppointmentDateFrom").val('');
			$("#extRepairAppointmentDateTo").val('');
			$("#txtExtendRemark").val('');

			//Check Extend Repair
			if ("@EnumConfiguration.Role.CallCentre.ToString()" != "@UserDetail.Role")
			{
				var cannotExtend = await ajaxGet(`${baseUrl}/homecare/api/v1/Appointment/CheckChangeAppointment/W/${worksheetItemId}`, response => {
					if (response && response.data) {
						modalWaring(response.data);
						return true;
					}
					return false;
				});
				if (cannotExtend) {
					return false;
				}
			}


			//Get Extended Repair
			var AppointmentRepair = await ajaxGet(`${baseUrl}/homecare/api/v1/Appointment/PostponeRepairAppointmentHistory/${worksheetItemId}`);
			var lastAppointmentRepair;
			var extendApproveFlag;
			//console.log('AppointmentRepair', AppointmentRepair);
			if (AppointmentRepair.data.length > 0) {
				lastAppointmentRepair = AppointmentRepair.data[AppointmentRepair.data.length - 1];
				extendApproveFlag = lastAppointmentRepair.extendApproveFlag == 'รอลูกค้ายืนยัน' ? null : lastAppointmentRepair.extendApproveFlag == 'ลูกค้ายืนยันเรียบร้อยแล้ว';
				var oldDateFrom = lastAppointmentRepair.repairAppointmentOld.split(' - ')[0];
				var oldDateTo = lastAppointmentRepair.repairAppointmentOld.split(' - ')[1];
				var newDateFrom = lastAppointmentRepair.repairAppointmentNew.split(' - ')[0];
				var newDateTo = lastAppointmentRepair.repairAppointmentNew.split(' - ')[1];
				var ddlExtendedReasonId = ddlExtendedReason.data.filter(ele => ele.description == lastAppointmentRepair.description)[0].id;
			}
			if (lastAppointmentRepair)
			{

				$("#repairAppointmentFromDate").val(oldDateFrom);
				$("#repairAppointmentToDate").val(oldDateTo);
			}
			else
			{
				$("#repairAppointmentFromDate").val("");
				$("#repairAppointmentToDate").val("");
			}

			if (lastAppointmentRepair && "@EnumConfiguration.Role.CallCentre.ToString()" == "@UserDetail.Role")
			{
				$("#extRepairAppointmentDateFrom").val(newDateFrom);
				$("#extRepairAppointmentDateTo").val(newDateTo);


				$("#ddlExtendedReasonID").val(ddlExtendedReasonId);
				$("#txtExtendRemark").val(lastAppointmentRepair.extendRemark);
				$("#txtExtendRemarkCc").val(lastAppointmentRepair.extendRemarkCc);

				if ("@EnumConfiguration.Role.CallCentre.ToString()" == "@UserDetail.Role" && (lastAppointmentRepair.repairAppointmentNew != '' && extendApproveFlag == null))
				{
					$("[name='rdoConfirm']").prop('disabled', false);
					$("#txtExtendRemarkCc").prop('disabled', false);
					$('#btnUpdateExtended').prop('disabled', false);

				} else if ("@EnumConfiguration.Role.CallCentre.ToString()" == "@UserDetail.Role" && (extendApproveFlag == true || extendApproveFlag == false))
				{

					$("[name='rdoConfirm']").prop('disabled', true);
					$("#txtExtendRemarkCc").prop('disabled', true);
					$('#btnUpdateExtended').prop('disabled', true);

				}
				else if("@EnumConfiguration.Role.CallCentre.ToString()" != "@UserDetail.Role")
				{
					$("[name='rdoConfirm']").prop('disabled', true);
					$('#btnUpdateExtended').prop('disabled', false);
					$("#txtExtendRemarkCc").prop('disabled', true);
				}
				else
				{
					$("[name='rdoConfirm']").prop('disabled', true);
					$("#txtExtendRemarkCc").prop('disabled', true);
					$('#btnUpdateExtended').prop('disabled', true);
				}

				if("@EnumConfiguration.Role.CallCentre.ToString()" == "@UserDetail.Role")
				{
					$("#extRepairAppointmentDateFrom").prop('disabled', true);
					$("#extRepairAppointmentDateTo").prop('disabled', true);
					$("#ddlExtendedReasonID").prop('disabled', true);
					$("#txtExtendRemark").prop('disabled', true);
				}

				$("input[name=rdoConfirm][value=" + extendApproveFlag + "]").attr('checked', 1);


			}
			$('#modalExtendDateRepair').modal('show');
		}
		// Open ModalExtendedAppointmentHistory
		function openModalExtendedHistory(worksheetItemId) {
			ajaxGet(`${baseUrl}/homecare/api/v1/Appointment/PostponeRepairAppointmentHistory/${worksheetItemId}`, response => {
				if (response.data.length > 0) {
					$('#tbodyAppointmentRepairHistory').empty();
				$.each(response.data, (i, d) => {
					$('#tbodyAppointmentRepairHistory').append(`
						<tr>
							<td>${d.row}</td>
							<td>${d.extendApproveFlag}</td>
							<td>${d.createdBy} </td>
							<td>${d.repairAppointmentOld}</td>
							<td>${d.repairAppointmentNew}</td>
							<td>${d.description}</td>
							<td>${d.extendRemark}</td>
							<td>${d.extendRemarkCc}</td>
							<td>${d.updatedBy}</td>
						</tr>
					`)
				})
			}
			});
			$('#modalExtendedAppointmentHistory').modal('show');
		}
		// Open upload image before modal
		async function openModalUploadWorkImage(worksheetItemId, receiveItemId = 0) {
			await page.loading();
			drawFileInputRow('Before');
			drawFileInputRow('During');
			drawFileInputRow('After');
			var promises = [
				InitailModalFileUpload(worksheetItemId, 'Before', 1, true, receiveItemId),
				InitailModalFileUpload(worksheetItemId, 'During', 2, true),
				InitailModalFileUpload(worksheetItemId, 'After', 3, true)
			];
			await Promise.all(promises);
			$('#modalUploadImageBefore').on('shown.bs.modal', function () {
				//$('.kv-file-remove.btn.btn-sm.btn-kv.btn-default.btn-outline-secondary').hide();
				page.loaded();
			});
			$('#modalUploadImageBefore').modal('show');
		}
		// open ModalViewImageByType
		async function openModalViewImage(attId) {
			$('#DivImageInput').empty();
			$('#DivImageInput').append(`
				<div class="row">
					<div class="col-xs-12">
						<input id="fileInputView" name="file" type="file" multiple />
					</div>
				</div>
			`)
			await InitailModalFileUpload(0, 'View', attId, false);
			$('#modalViewImageBDA').on('shown.bs.modal', function () {
				$('.kv-file-remove.btn.btn-sm.btn-kv.btn-default.btn-outline-secondary').hide();
				page.loaded();
			});
			$('#modalViewImageBDA').modal('show');
		}
		//open ModalViewQuotation
		function openModalViewQuotation(receiveItemId) {
			var tempReceiveItem = receiveItemList.data.filter(item => item.receiveItemId == receiveItemId);
			$('#DdlReceiveItemList').empty();
			$('#DdlReceiveItemList').append(`<option value="0" selected>${tempReceiveItem[0].guaranteeDescription}</option>`);
			$('#txtPriceRepairProject').text(customerData.projectNameTh);
			$('#txtPriceRepairUnit').text(customerData.unitCodeAddress);
			bindTBodyQuotationItemDetail(quotationItemList.filter(item => item.receiveItemId == receiveItemId));
			calTotalPrice(quotationItemList.filter(item => item.receiveItemId == receiveItemId));
			$('#modalDetailPriceRepair').modal('show');
		}

		// open ModalQuestionnaire
		function openModalQuestionnaire() {
			page.loading();
			var request = $.ajax({
				url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/login/getTokenCode',
				type: 'GET',
				contentType: "application/json; charset=utf-8"
			});
			request.done(function (data) {
				var body = {
					"WorksheetID": worksheetId,
					"TokenCode": data.response
				}
				var bodyM = {
					"Typename": "HC_CC_Contact_Reason",
					"TokenCode": data.response
				}
				$.ajax({
					url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/GetQuestionnaire',
					type: 'POST',
					data: JSON.stringify(body),
					async: true,
					crossDomain: true,
					headers: {
						"Content-Type": "application/json",
						"Cache-Control": "no-cache",
					}
				}).done(function (data) {
					questionnaireData = data;
					//console.log(data);
					$('#contentQuestionnaire').empty();
					var tempdiv = '';
					tempdiv =	`<div class="row" id="rowReason">
									<div class="col-sm-12 col-xs-12" style="padding-left: 30px; text-align: left;">
										<div style="display: inline-flex; width: auto">
											<div class="form-check float-left" style="margin-right: 10px; padding-top: 5px; min-width: 130px;">
												<input class="form-check-input" type="checkbox" id="CBNoComment" onclick="NoCommentEffect();" />
												<label class="form-check-label" for="CBNoComment">
													ไม่สะดวกประเมิน
												</label>
										     </div>
											<select id="DDLNoCommentReason" class="form-control" style="min-width: 250px; display: none;">
											</select>
										</div>
									</div>
									<hr style="margin-top: 15px; margin-bottom: 15px; width: 95%" />
								</div>`

					$('#contentQuestionnaire').append(tempdiv);
					if (data.response.Completed) {
						$('#modalQuestionnaire').find('#btnSaveQuestionnaire').attr('disabled', '');
						$('#rowReason').hide();
					}
					if (EvaluationDetail.evaluate_cc_contact) {
						$('#DDLNoCommentReason').show();
						$('#CBNoComment').attr('checked', 'true');
					}
					$.ajax({
						url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Master/GetMasterData',
						type: 'POST',
						contentType: "application/json",
						data: JSON.stringify(bodyM),
						cache: false
					}).done(data => {
						$('#DDLNoCommentReason').empty();
						if (!EvaluationDetail.evaluate_cc_contact) {
							$('#DDLNoCommentReason').append(
								'<option selected disabled value="0">---กรุณาระบุเหตุผล---</option>'
							);
						}
						else {
							$('#DDLNoCommentReason').append(
								'<option disabled value="0">---กรุณาระบุเหตุผล---</option>'
							);
						}
						$.each(data.response, (i, d) => {
							if (EvaluationDetail.evaluate_cc_contact && d.ValueID == EvaluationDetail.evaluate_cc_reasonID) {
								$('#DDLNoCommentReason').append(
									`<option value="${d.ValueID}" selected>${d.DescriptionTH}</option>`
								);
							}
							else {
								$('#DDLNoCommentReason').append(
									`<option value="${d.ValueID}">${d.DescriptionTH}</option>`
								);
							}
						})
						page.loaded();
					})
					$.each(data.response.Evaluation_Item, (index, question) => {
						drawContentQuestionnaire(index, question, data.response.Completed);
						rowCoutQuestionnaire++;
					})
				});
			})
			$("#modalQuestionnaire").modal('show')
		}
		function openConfirmModal(message) {
			$('#confirmQuestionnaire').modal('show');
			$('#contentConfirmQuestionnaire').text(message);
		}

		// ======================================================================= AllSave =======================================================================
		function savePostponeRepairAppointment() {
			var body = {
				worksheetItemId: tempWorksheetItemId,
				extRepairAppointmentFromDate: reorganizeDateFormat($('#extRepairAppointmentDateFrom').val()),
				extRepairAppointmentToDate: reorganizeDateFormat($('#extRepairAppointmentDateTo').val()),
				extendReasonId: $('#ddlExtendedReasonID').val() || 0,
				extendReasonRemark: $('#txtExtendRemark').val(),
				extendedReasonRemarkCC: $('#txtExtendRemarkCc').val() || '',
				extendedApproveFlag: $('input[name="rdoConfirm"]:checked').val() || null,
				createdBy: '@UserDetail.CodeName'
			}
			//console.log(body);
			ajaxPost(`${baseUrl}/homecare/api/v1/Appointment/PostponeRepairAppointment`, body, response => {
				modalSuccess();
				$('#notificationModal').on('hidden.bs.modal', () => {
					$("#modalExtendDateRepair").modal("hide");
				})
			})
        }

        async function updateWorksheet() {
            $("#btnSaveWO").attr('disabled', 1);
			await page.loading();
            var success = true;
            var checkCloseJobValid = true;
            var savePaymentAppr = false;

            if (localStorage.getItem("name") == "SAVEAPR") {
                if ($("[name*=AprrovedType]:checked").val() == "N" || $("[name*=AprrovedType]:checked").val() == "Y") {
                    if ($("[id *= PaymentType]").val() != 0) {
                        savePaymentAppr = true;
                        SaveAPPR();
                    }
                    else {
                        modalWarning("กรุณาเลือกรายละเอียดการอนุมัติ");
                        page.loaded();
                        return;
                    }
                }
            }
            else {
                savePaymentAppr = false;
                if ($("[name*=AprrovedType]:checked").val() == "N" || $("[name*=AprrovedType]:checked").val() == "Y") {
                    if ($("[id *= PaymentType]").val() != 0) {
                        savePaymentAppr = true;
                        SaveAPPR();
                    }
                    else {
                        modalWarning("กรุณาเลือกรายละเอียดการอนุมัติ");
                        page.loaded();
                        return;
                    }
                }
            }

			var bodyW = {
				worksheetId: worksheetId,
				closeJobDate: reorganizeDateFormat($('#worksheetFlagCloseDate').val()),
				vendorId: $('#hdVendorID').val(),
				vendorName: $('#worksheetVendorName').text(),
				vendorChangeRemark: $('#txtVendorchangeRemark').val() || '',
				worksheetRepairAppointmentFromDate: null,
				worksheetRepairAppointmentToDate: null,
				operatingPercent: 0,
                //vatPercent: $('#vat').prop('checked') == true ? 0 : 7, Fix bug Vat 19.04.2021
                vatPercent: $(txtVatPercent).val(),
				paymentType: 0,
				paymentTypeId: 0,
				updatedBy: '@UserDetail.CodeName'
			}

			var response = await ajaxPut(`${baseUrl}/homecare/api/v1/Worksheet/UpdateWorksheet`, bodyW);
			if (!response) {
				success = false
            }

			for (var i = 0; i < $('#tBodyWorksheetItem tr').length; i++) {
				if ($('#ddlWorkSheetStatus' + i).val()) {
					var bodyWD = {
						worksheetId: worksheetId,
						worksheetItemId: $('#worksheetItemId' + i).val(),
						status: $('#ddlWorkSheetStatus' + i).val(),
						causeText: $('#worksheetCauseText' + i).val(),
						confirmPriceDate: reorganizeDateFormat($('#hdConfirmDate' + i).val()),
						startDate: reorganizeDateFormat($('#worksheetDateStart' + i).val()),
						finishDate: reorganizeDateFormat($('#worksheetDateEnd' + i).val()),
						updatedBy: '@UserDetail.CodeName'
					}
					var response = await ajaxPut(`${baseUrl}/homecare/api/v1/Worksheet/UpdateWorksheetItem`, bodyWD);
					if (!response) {
						success = false
                    }
				}
            }
            if (document.getElementById('worksheetCloseConfirm').checked) { // Check ปิดจบงานทุกใบ
                checkCloseJobValid = true;
            }
            if (worksheetStatusId == 14) {
                if (checkCloseJobValid == true ) { // ถ้าปิดใบงานแล้ว
                    if ($("[name*=AprrovedType]:checked").val() == "Y") { // ถ้าไม่มีค่าใช้จ่ายไม่ต้องสร้าง Retention
                        //await CreateRetentionWorkFlow();
                    }
                }
            }

            if (success) {
                if (savePaymentAppr) {
                    page.loaded();
                    showModalLineApprveSuccess("บันทึกข้อมูลเรียบร้อยแล้ว")
                } else {
                    initialize("initialize", false, true);
                }
                localStorage.setItem("name", "Save");
            }
            $("#btnSaveWO").removeAttr('disabled');
        }

        function sendCancelF(type) {
            ajaxGet(`${baseUrl}/homecare/api/v1/LineApprove/CheckHistoryEditDataFlow?id=${worksheetId}&projectCode=${response.data.projectCode}`, async response => {
                for (let key in response.data) {
                    if (response.data[key].EditType == "ยกเลิกเอกสารF") {
                        if (response.data.length > 0 && response.data[key].Detail_old != null) {
                            empApproveEditData = 'รออนุมัติยกเลิกเอกสารโดยคุณ' + response.data[0].EmpApproveName;
                            $('#modalAlertUserApprove').modal('show');
                            $('#lbAlertUserApprove').text(empApproveEditData);
                        } else {
                            $('#lbType').text(type);
                            $('#modalRequestCancelF').modal('show');
                        }
                    } else {
                        $('#lbType').text(type);
                        $('#modalRequestCancelF').modal('show');
                    }
                }
            });
        };

        $('#confirmBtnCencelF').on("click", function () {
            var data = {
                ID: worksheetId,
                ReceiveJobNo: $('#worksheetJobText').text(),
                projectCode: $('#customerUnitCode').text().split('-')[0],
                projectName: $('#customerUnitCode').text().split('-')[0] + '-' + $('#customerProject').text(),
                EditType: "ยกเลิกเอกสารF",
                DocumentF: $('#lbType').text(),
                Remark: $('#confirmReasonF').val(),
                UserLogin : "@UserDetail.CodeName",
                DetailVendor_old: myRows_old,
                DetailVendor_new: myRows_new
            };

            page.loading();
            ajaxPost(`${baseUrl}/homecare/api/v1/Receive/SaveEditDataSendApprove`, data, response => {

                if (response) {
                    $('#modalRequestCancelF').modal('hide');
                    $('#modalInsertRoleSuccess').modal('show');
                    $('#lbStatusEditData').show();
                    $('#lbTxtSuccess').text('ส่งคำขอแก้ไขข้อมูลเรียบร้อยแล้ว');
                    page.loaded();
                } else {
                    showModalLineApprveWarning('เกิดข้อผิดพลาด บันทึกไม่สำเร็จ');
                }
            });
        });

		function saveQuestionnaire() {
			var request = $.ajax({
				url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/login/getTokenCode',
				type: 'GET',
				contentType: "application/json; charset=utf-8"
			});
			request.done(function (Token) {
				var name = "@UserDetail.Fullname"
				var token = Token.response;
				var body = {}
				if ($('#CBNoComment').prop('checked')) {
					if ($('#DDLNoCommentReason option:selected').val() === '0') {
						modalWaring('กรุณาระบุเหตุผลไม่สะดวกประเมิน');
						$('#warningModal').on('hidden.bs.modal', () => {
							$('#DDLNoCommentReason').focus();
						})
						return;
					}
					else {
						body = {
							WorksheetID: worksheetId,
							Channel: '2',
							ReasonID: $('#DDLNoCommentReason option:selected').val(),
							Evaluate_CC_Contact: true,
							CreatedBy: name,
							TokenCode: token
                        }

						var request = $.ajax({
							url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/UpdateCCEvaluation',
							type: 'POST',
							data: JSON.stringify(body),
							async: true,
							crossDomain: true,
							headers: {
								"Content-Type": "application/json",
								"Cache-Control": "no-cache",
							}
						});
						request.done(function (data) {
							var bodyget = {
								TokenCode: token,
								WorksheetID: worksheetId,
							}
							var request = $.ajax({
								url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/GetEvaluationDetail',
								type: 'POST',
								data: JSON.stringify(bodyget),
								async: true,
								crossDomain: true,
								headers: {
									"Content-Type": "application/json",
									"Cache-Control": "no-cache",
								}
							});
							request.done(data => {
								EvaluationDetail = data.response;
								$.each(EvaluationReason, (i, d) => {
									if (EvaluationDetail.evaluate_cc_reasonID == d.ValueID) {
										$('#displayReason').text('*' + d.DescriptionTH);
										$('#displayReason').show();
										return false;
									}
								})
							});
							openConfirmModal('บันทึกข้อมูลสำเร็จ');
							$('#modalQuestionnaire').modal('hide');
						})
						request.fail(function (data) {
							openConfirmModal('เกิดข้อผิดพลาด กรุณาตรวจสอบความถูกต้องและลองใหม่อีกครั้ง');
						})
					}
				}
				else {
					body = {
						WorkSheetID: worksheetId,
						QN_HeaderID: questionnaireData.response.QN_HeaderID,
						QuestionnaireItem: [],
						CreatedBy: name,
						TokenCode: token,
						Channel: 2
					}
					let quit = false;
					$.each(questionnaireData.response.Evaluation_Item, function (index, data) {
						if (data.Type === "SCORE") {
							var question
							for (var i = 1; i <= data.MaxScore + 1; i++) {

								if ($('#mark' + data.QN_ItemID + i).prop("checked")) {
									if (i === data.MaxScore + 1) {
										question = {
											QN_ItemID: data.QN_ItemID,
											Value: 0
										}
									}
									else {
										question = {
											QN_ItemID: data.QN_ItemID,
											Value: i
										}
									}
									break;
								}
							}
							if (!question) {
								modalWaring('กรุณาประเมิณรายการให้ครบถ้วนก่อนทำการบันทึก');
								quit = true;
								return false;
							}
						}
						else if (data.Type === "REMARK") {
							var remark = $('#mark' + data.QN_ItemID).val() || null;
							var question = {
								QN_ItemID: data.QN_ItemID,
								Remark: remark
							}
						}
						body.QuestionnaireItem.push(question);

					});
					if (quit) { return false;}
					var request = $.ajax({
						url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/UpdateCCEvaluation',
						type: 'POST',
						data: JSON.stringify(body),
						async: true,
						crossDomain: true,
						headers: {
							"Content-Type": "application/json",
							"Cache-Control": "no-cache",
						}
					});
					request.done(function (data) {
						var bodyget = {
							"TokenCode": token,
							"WorksheetID": worksheetId,
						}
						var request = $.ajax({
							url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/GetEvaluationDetail',
							type: 'POST',
							data: JSON.stringify(bodyget),
							async: true,
							crossDomain: true,
							headers: {
								"Content-Type": "application/json",
								"Cache-Control": "no-cache",
							}
						});
						request.done(data => {
							EvaluationDetail = data.response;
						});
					})
					request.fail(function (data) {
						openConfirmModal('เกิดข้อผิดพลาด กรุณาตรวจสอบความถูกต้องและลองใหม่อีกครั้ง');
					})
					var request = $.ajax({
						url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/Questionnaire/InsertQuestionnaire',
						type: 'POST',
						data: JSON.stringify(body),
						async: true,
						crossDomain: true,
						headers: {
							"Content-Type": "application/json",
							"Cache-Control": "no-cache",
						}
					});
					request.done(function (data) {
						if (body.QuestionnaireItem.length !== questionnaireData.response.Evaluation_Item.length) { return false }
						$('#displayReason').text('');
						$('#displayReason').hide();
						openConfirmModal('บันทึกข้อมูลสำเร็จ');
						$('#modalQuestionnaire').modal('hide');
					})
					request.fail(function (data) {
						if (body.QuestionnaireItem.length !== questionnaireData.response.Evaluation_Item.length) { return false }
						openConfirmModal('เกิดข้อผิดพลาด กรุณาตรวจสอบความถูกต้องและลองใหม่อีกครั้ง');
					})
				}
			});
		}
		// ======================================================================= OtherFunctions =======================================================================
		// Date format for post
		function reorganizeDateFormat(date) {
			if (!date) { return '' }
			var temp = date.trim().split('/');
			var newDate = new Date(`${temp[2]}-${temp[1]}-${temp[0]}`);
			return thaiTimeInUTC(newDate);
		}
		// Date format for display
		function thaiFormatDate(date, withTime = true) {
			if (!date) { return '' }
			date = UTCToLocal(date);
			var [y, m, d] = date.split('T')[0].split('-');
			var [t, z] = date.split('T')[1].split('.');
			return `${d}/${m}/${y} ${withTime ? t : ''}`.trim();;
        }

		function UTCToLocal(date) {
			var localeDate = new Date(date);
			return date = new Date(localeDate.setHours(localeDate.getHours() + 7)).toJSON();
        }

		function thaiTimeInUTC(date) {
			return new Date(date.setHours(date.getHours() + date.getTimezoneOffset() / 60 + 7));
        }

		// Bind dropdown list
		function bindingDdlist(ddlId, ddlData, selectedVal) {
			$(`#${ddlId}`).empty();
			$.each(ddlData, (i, d) => {
				if (d.id == 0) {
					$(`#${ddlId}`).append(`<option value="${d.id}" selected disabled>${d.description}</option>`);
				} else if (selectedVal == d.id) {
					$(`#${ddlId}`).append(`<option value="${d.id}" selected>${d.description}</option>`);
				} else {
					$(`#${ddlId}`).append(`<option value="${d.id}" >${d.description}</option>`);
				}
			})
        }

		// Create ddlist in form string
		function createDdlStringForm(id, ddlData, selectedVal, disabled = false, func = false) {
			var tempstr = `<select id="${id}" class="form-control" ${disabled ? 'disabled' : ''} ${func ? 'onchange="onChangeReceivedItemStatusID(this.value, this)"' : ''}>`;
			$.each(ddlData, (i, d) => {
				tempstr += `<option value="${d.id}" ${selectedVal == d.id ? 'selected' : ''} ${d.id == 0 ? 'disabled' : ''}>${d.description}</option>`
			});
			return tempstr + '</select>';
        }

		function bindTbodyWorksheetItem(data) {
			$('#tBodyWorksheetItem').empty();
			for (var i = 0; i < data.length; i++) {
				d = data[i];
				var ddlWorkStatusStr = createDdlStringForm(`ddlWorkSheetStatus${i}`, ddlWorkStatus.data, d.statusId == 1 ? 2 : d.statusId);
				$('#tBodyWorksheetItem').append(`
					<tr>
						<td>
							${i + 1}
							<input type="hidden" value="${d.worksheetItemId}" id="worksheetItemId${i}"/>
						</td>
						<td style="min-width: 140px">
							${ddlWorkStatusStr}
						</td>
						<td>
							${d.guaranteeDescription}
						</td>
						<td>
							${d.mainWorkType}
						</td>
						<td>
							${d.subWorkType}
						</td>
						<td>
							${d.workDetail}
						</td>
						<td>
							${d.location}
						</td>
						<td>
							${d.causeDescription}
						</td>
						<td style="min-width: 200px">
							 <textarea class="form-control" cols="30" rows="2" data-val="true" id="worksheetCauseText${i}" name="worksheetCauseText" type="text" maxlength="512" >${d.causeText || ''}</textarea>
						</td>
						<td>
							${thaiFormatDate(d.repairAppointmentDateFrom, false)} - ${thaiFormatDate(d.repairAppointmentDateTo, false)}
						</td>
						<td>
							<a id="btnExtendedAppointment"onclick="openModalExtendedAppointment(${d.worksheetItemId})"><i class="fa fa-calendar-plus-o cursor-pointer" style="color:chocolate; font-size: 1.75em;"></i></a>
							<a id="viewExtendedHistory" onclick="openModalExtendedHistory(${d.worksheetItemId})"><i class="fa fa-book cursor-pointer" style="font-size: 1.75em;"></i></a>
						</td>
						<td>
							${d.priorityDescription}
						</td>
						<td>
							${thaiFormatDate(d.expectDate, false)}
						</td>
						<td>
							<a name="viewFixPrice"><i class="fa fa-folder-open cursor-pointer" style="font-size: 1.75em;" onclick="openModalViewQuotation(${d.receiveItemId})"></i></a>
						</td>
						<td>
							<input type="text" class="form-control" value="${thaiFormatDate(d.confirmPriceDate, false)}" id="hdConfirmDate${i}" name="hdConfirmDate" readonly style="min-width: 100px" />
						</td>
						<td>
							<div class="input-group">
                                <span class="input-group-addon" style="background-color:whitesmoke">
                                    <input type="checkbox" id="chkDateStart${i}" name="chkDateStart" onclick="bindStartRepair(this,${i},${d.statusId})" ${d.startDate ? "checked disabled" : ""}>
                                </span>
                                <input type="text" class="form-control" id="worksheetDateStart${i}" name="worksheetDateStart" value="${thaiFormatDate(d.startDate, false)}" readonly style="width:100px;background-color:whitesmoke" disabled>
                            </div>
						</td>
						<td>
							<div class="input-group">
                                <span class="input-group-addon" style="background-color:whitesmoke">
                                    <input type="checkbox" id="chkDateEnd${i}" name="chkDateEnd" onclick="bindEndRepair(this, ${i}, ${d.worksheetItemId}, ${d.receiveItemId})" ${d.finishDate ? "checked disabled" : ""}>
                                </span>
                                <input type="text" class="form-control" id="worksheetDateEnd${i}" value="${thaiFormatDate(d.finishDate, false)}" readonly style="width:100px;background-color:whitesmoke" disabled>
                            </div>
						</td>
						<td>
							<button id="btnWorksheetPic${i}" name="btnWorksheetPic" onclick=openModalUploadWorkImage(${d.worksheetItemId},${d.receiveItemId})><i class="fa fa-photo fa-lg"></i></button>
						</td>
					</tr>
				`)
				// disabled ddlWorkSheetStatus
				if (d.startDate) {
					$('#DivChangeVendor').hide();
					$(`#ddlWorkSheetStatus${i}`).attr('disabled', 1);
                }
			}
        }

		// reDraw html fileInput
		function drawFileInputRow(name) {
			$(`#${name.toLowerCase()}ImageInput`).empty();
			$(`#${name.toLowerCase()}ImageInput`).append(`
				<div class="row">
					<div class="col-xs-12">
						<input id="fileInput${name}" name="file" type="file" multiple />
					</div>
				</div>
			`);
        }

		// Initial file input
        function InitailModalFileUpload(referenceItemId, name, attType, canUpload, receiveItemId = 0) {
            var body = {
				referenceId: worksheetId,
                referenceType: "W",
				attachmentTypeId: attType,
                referenceItemId: referenceItemId
            }
			ajaxPost(`${baseUrl}/homecare/api/v1/Attachment/List`, body, async response => {
                var imageList = [];
				var imageListConfig = [];
				var receiveImageList = [];
				// Get token Image
				var responseToken = await ajaxGet(`${baseUrl}/homecare/api/v1/Images/Token`);
				var imageToken = responseToken.data;
				// Display beforeImage of receiveItem
				if (attType == 1) {
					var bodyR = {
						referenceId: receiveId,
						referenceType: "R",
						attachmentTypeId: attType,
						referenceItemId: receiveItemId
					}
					receiveImageList = await ajaxPost(`${baseUrl}/homecare/api/v1/Attachment/List`, bodyR);
				}
				var tempImageList = receiveImageList.data ? receiveImageList.data.concat(response.data) : response.data;
				$.each(tempImageList, (i, d) => {
					imageList.push(`${baseUrl}/${d.attachmentURL}?imageToken=${imageToken}`);
					imageListConfig.push({
						caption: name + '-Picture-' + (i + 1),
						url: `${baseUrl}/homecare/api/v1/Attachment/${d.attachmentId}`,
						width: '120px',
						key: `${d.attachmentURL}?imageToken=${imageToken}`
					});
				});
				$("#fileInput" + name).fileinput({
					showUpload: canUpload,
					showBrowse: canUpload,
					dropZoneEnabled: canUpload,
					maxFileSize: 25000,
					maxFileCount: 0,
					showRemove: false,
					msgSelected: '{n} ไฟล์',
					initialCaption: imageList.length + ' ไฟล์',
					msgPlaceholder: 'กรุณาเลือกไฟล์',
					allowedFileTypes: ['image'],
					autoOrientImage: false,
					theme: 'explorer',
					uploadAsync: true,
					uploadUrl: `${baseUrl}/homecare/api/v1/Attachment/UploadAttatchmentImages`,
					uploadExtraData: {
						referenceId: worksheetId,
						referenceType: 'W',
						referenceItemId: referenceItemId,
						attachmentTypeId: attType,
						userCode: '@UserDetail.CodeName'
					},
					initialPreview: imageList,
					initialPreviewConfig: imageListConfig,
					initialPreviewAsData: true,
					initialPreviewDownloadUrl: '' + baseUrl + '/{key}',
					validateInitialCount: true,
					overwriteInitial: false,
					ajaxSettings: {
						headers: {
							"Authorization": "Bearer " + constructionApiToken
						}
					},
					ajaxDeleteSettings: {
						method: 'DELETE',
						headers: {
							"cache-control": "no-cache",
							"Content-Type": "application/json",
							"Authorization": "Bearer " + constructionApiToken
						},
						data: JSON.stringify({ username: '@UserDetail.CodeName' })
					}
				}).on('fileuploaded', () => {
					// ซ่อนปุ่มลบหลังจาก upload
					//$('.kv-file-remove:not([data-key])').css('display', 'none');
					// Toggle icon to checked
					//switch (attType) {
					//case 1:
					//	$('#flagImageBefore').removeClass('fa-times').addClass('fa-check-square-o').css('color', 'green');
					//	break;
					//case 2:
					//	$('#flagImageDuring').removeClass('fa-times').addClass('fa-check-square-o').css('color', 'green');
					//	break;
					//case 3:
					//	$('#flagImageAfter').removeClass('fa-times').addClass('fa-check-square-o').css('color', 'green');
					//	break;
					//}
				})
            });
            if (closeJobFlag) {
                $('.kv-file-remove.btn.btn-sm.btn-kv.btn-default.btn-outline-secondary').hide()
            }
        };

        async function bindEnddateProject(ele) {
            if ($('#worksheetCloseConfirm').prop('checked')) {
                $('#worksheetCloseConfirm').prop('checked', 0);
                // Check no item inProceed return false
                if (worksheetItemList.data.filter(w => w.statusId == 2).length == 0) {
                    modalWaring('กรุณาทำรายการอย่างน้อยหนึ่งรายการก่อนทำการปิดใบงาน');
                    return false;
                }
                // Check item on Proceed is not finish
                var tempWorksheetItem = worksheetItemList.data.filter(w => w.statusId == 2 && !w.finishDate);
                if (tempWorksheetItem.length) {
                    modalWaring('กรุณากรอกข้อมูลใบงานรายการที่ ' + tempWorksheetItem[0].worksheetNo + ' ให้ครบถ้วนก่อนทำการปิดใบงาน');
                    return false;
                }
                if ($("[name*=AprrovedType]:checked").val() === undefined) {
                    modalWaring('กรุณาเลือกประเภทการอนุมัติ');
                    return false;
                }
                console.log($('#PO_No2').val());
                if ($("[name*=AprrovedType]:checked").val() === 'Y') {
                    if ($('#PO_No2').val() === null) {
                        modalWaring('กรุณาตรวจสอบใบเลขที่ PO ให้เรียบร้อยก่อนทำการปิดใบงาน');
                        return false;
                    }
                }

                if ($("[id *= PaymentType]").val() == 0) {

                    modalWarning("กรุณาเลือกรายละเอียดการอนุมัติ");
                    return;
                }
                // Check closeJob with API
                var checkMessage = await ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/CheckCloseJob/${worksheetId}`);
                if (checkMessage.data.error) {
                    modalWaring(checkMessage.data.error);
                    return false;
                }
                $('#worksheetCloseConfirm').prop('checked', 1);
                bindTodayDate(ele);
            } else {
                bindTodayDate(ele);
            }
        }

		// Initial file input ส่วนเอกสาร
		function initailFileUploadDocument(reload) {
			for (var i = 0; i < inputNumList.length; i++) {
				setConfigFileUploadDocument(inputNumList[i], reload);
			}
        }

		function setConfigFileUploadDocument(attType, reload) {
            var body = {
				referenceId: worksheetId,
                referenceType: "W",
				attachmentTypeId: attType,
                referenceItemId: 0
            }
			ajaxPost(`${baseUrl}/homecare/api/v1/Attachment/List`, body, async response => {
                var imageList = [];
				var imageListConfig = [];
				// getToken Image
				var responseToken = await ajaxGet(`${baseUrl}/homecare/api/v1/DocumentToken`);
				var imageToken = responseToken.data;
				$.each(response.data, (i, d) => {
					var extension = d.attachmentURL.split('.')[d.attachmentURL.split('.').length - 1].toLowerCase();
					var fileType = 'object';
					var types = ['jpg', 'png', 'gif', 'tiff', 'jpeg', 'bmp'];
					if (types.indexOf(extension) >= 0) {
						fileType = 'image';
					}
					imageList.push(`${baseUrl}/${d.attachmentURL}?Token=${imageToken}`);
					imageListConfig.push({
						caption: 'file-' + (i + 1),
						type: fileType,
						url: `${baseUrl}/homecare/api/v1/Attachment/${d.attachmentId}`,
						width: '120px',
						key: `${d.attachmentURL}?Token=${imageToken}`
					});
                });

				if (imageList.length > 0) {
					var lastImage = response.data[imageList.length - 1];
					$('#AttachmentDetail' + attType).val(lastImage.attachmentDetail || '');
					$('#fileCreateBy' + attType).text(lastImage.attachmentUpdatedBy || '');
					$('#fileCreateDate' + attType).text(lastImage.attachmentUpdateDate ? lastImage.attachmentUpdateDate.split(' ')[0] : '');
                    $('#flagImage' + attType).removeClass('fa-times').addClass('fa-check-square-o').css('color', 'green');
                    if (closeJobFlag) {
                        $('.kv-file-remove.btn.btn-sm.btn-kv.btn-default.btn-outline-secondary').hide()
                    }
                }
				//if (reload) {
				$("#fileInput" + attType).fileinput('destroy');
				//}
				$("#fileInput" + attType).fileinput({
					showUpload: !closeJobFlag,
					showBrowse: !closeJobFlag,
					dropZoneEnabled: !closeJobFlag,
					maxFileSize: 25000,
					maxFileCount: 0,
					showRemove: true,
					msgSelected: '{n} ไฟล์',
					initialCaption: imageList.length + ' ไฟล์',
					msgPlaceholder: 'กรุณาเลือกไฟล์',
					autoOrientImage: false,
					theme: 'explorer',
					uploadAsync: true,
					uploadUrl: `${baseUrl}/homecare/api/v1/Attachment/UploadAttatchment`,
					uploadExtraData: () => {
						return {
							referenceId: worksheetId,
							referenceType: 'W',
							referenceItemId: 0,
							attachmentTypeId: attType,
							attachmentDetail: $('#AttachmentDetail' + attType).val() || '',
							userCode: '@UserDetail.CodeName'
						}
					},
					initialPreview: imageList,
					initialPreviewFileType: 'image',
					initialPreviewConfig: imageListConfig,
					initialPreviewAsData: true,
					initialPreviewDownloadUrl: '' + baseUrl + '/{key}',
					validateInitialCount: true,
					overwriteInitial: false,
					previewFileIcon: '<i class="fa fa-file-pdf-o text-danger"></i>',
					preferIconicPreview: true,
					ajaxSettings: {
						headers: {
							"Authorization": "Bearer " + constructionApiToken
						}
					},
					ajaxDeleteSettings: {
						method: 'DELETE',
						headers: {
							"cache-control": "no-cache",
							"Content-Type": "application/json",
							"Authorization": "Bearer " + constructionApiToken
						},
						data: JSON.stringify({ username: '@UserDetail.CodeName' })
					}
				}).on('fileuploaded', () => {
					// ซ่อนปุ่มลบหลังจาก upload
					@*$('.kv-file-remove:not([data-key])').css('display', 'none');
					$('#flagImage' + attType).removeClass('fa-times').addClass('fa-check-square-o').css('color', 'green');
					$('#fileCreateBy' + attType).text('@UserDetail.CodeName');
					$('#fileCreateDate' + attType).text(thaiFormatDate(new Date().toISOString(), false));*@
				});
            });
            if (closeJobFlag) {
                $('.kv-file-remove.btn.btn-sm.btn-kv.btn-default.btn-outline-secondary').hide()
            }
        };

		// Check Have fileImage
		async function checkFileImage(referenceItemId, attType, receiveItemId = 0) {
			var haveFile = false;
			if (attType == 1) {
				var Rbody = {
					referenceId: receiveId,
					referenceType: "R",
					attachmentTypeId: attType,
					referenceItemId: receiveItemId
				}
				//console.log('Rbody', Rbody)
				await ajaxPost(`${baseUrl}/homecare/api/v1/Attachment/List`, Rbody, response => {
					if (response.data.length > 0) {
						haveFile = true;
					}
					//console.log(attType, response);
				});
			}
			var body = {
				referenceId: worksheetId,
				referenceType: "W",
				attachmentTypeId: attType,
				referenceItemId: referenceItemId
			}
			await ajaxPost(`${baseUrl}/homecare/api/v1/Attachment/List`, body, response => {
				if (response.data.length > 0) {
					haveFile = true;
				}
			});
			return haveFile;
		}
		//Binding tBodyQuotationItem on view modal
		function bindTBodyQuotationItemDetail(data) {
			$('#quotationItemDetailTBody').empty();
			$.each(data, (i, d) => {
				$('#quotationItemDetailTBody').append(`
					<tr>
						<td>
							${$('#quotationItemDetailTBody tr').length + 1}
						</td>
						<td>
							${d.workCategoryDescription}
						</td>
						<td>
							${d.workDetailDescription}
						</td>
						<td>
							${roundFixed(d.packagePriceType == 1 ? d.vendorPackagePrice : 0.00)}
						</td>
						<td>
							${roundFixed(d.wagePriceType == 1 ? d.vendorWagePrice : 0.00)}
						</td>
						<td>
							${roundFixed(d.packagePriceType == 2 ? d.vendorPackagePrice : 0.00)}
						</td>
						<td>
							${roundFixed(d.wagePriceType == 2 ? d.vendorWagePrice : 0.00)}
						</td>
						<td>
							${roundFixed(d.vendorMaterialPrice)}
						</td>
						<td>
							${d.workDetailUnits}
						</td>
						<td>
							${(Math.round(d.quantity * 100) / 100).toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}
						</td>
						<td>
							${(Math.round((d.vendorPackagePrice + d.vendorWagePrice + d.vendorMaterialPrice) * d.quantity * 100) / 100).toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}
						</td>
						<td>
							${d.remark}
						</td>
					</tr>
				`)
			})
        }

		// คำนวนราคารวมค่าวัสดุ
        async function calTotalPrice(data) {
            var total = 0;
            $.each(data, (i, d) => {
                total += (d.vendorPackagePrice + d.vendorWagePrice + d.vendorMaterialPrice) * d.quantity
                if (d.wagePriceType == 1 || d.wagePriceType == 2) {
                    vendorWagePrice = vendorWagePrice + d.vendorWagePrice;
                }
                vendorMaterialPrice = vendorMaterialPrice + d.vendorMaterialPrice;
            })
            $('#lblTotalPrice').text(roundFixed(total).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        }

        async function cal_worksheet_checked_attach_file(data) {
            var total = 0;
            $.each(data, (i, d) => {
                total += (d.vendorPackagePrice + d.vendorWagePrice + d.vendorMaterialPrice) * d.quantity
            })
            //Check เอกสารใบเสนอราคา
            if (total >= 20000) {
                await ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/checkAttachmentFile?id=${worksheetId}`, response => {
                    if (response) {
                        if (response.data === 0) {
                            modalWaring("กรุณาแนบเอกสารใบเสนอราคา !");
                            AttachFlag = false;
                            return;
                        }
                        else {
                            AttachFlag = true;
                            return;
                        }
                    }
                });
            }
            else {
                AttachFlag = true;
                return;
            }
        }

        async function calPriceWorkSheet(rententionpercent) {

            await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/getPODetail?worksheetID=${worksheetId}&system_type=2`, response => {
                if (response.data) {
                    //haveFile = true;
                    totalPricebyWorksheet = response.data.net_Price;

                    var price = response.data.net_Price;
                    var OperatingPercent = roundFixed((price * response.data.operating_Percent) / 100);
                    var priceInclueOperting = roundFixed(parseFloat(price) + parseFloat(OperatingPercent));

                    var retentionPercent = roundFixed((priceInclueOperting * response.data.retention_percent) / 100);
                    var totalRetention = roundFixed(parseFloat(priceInclueOperting) - parseFloat(retentionPercent));

                    var VatPercent = roundFixed((priceInclueOperting * response.data.vat_Percent) / 100);
                    var priceInclueOperetingInclueVat = roundFixed(parseFloat(priceInclueOperting) + parseFloat(VatPercent));

                    /*txtOperatingPercent*/
                    $('#lblTotalUnit').text(roundFixed(price).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                    $('#txtOperatingPercent').val(response.data.operating_Percent);
                    $('#txtIncludeOperatingPercent').val(OperatingPercent);
                    $('#txtTotalIncludeOperatingPercent').val(priceInclueOperting.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));

                    $('#txtIncludeVatPercent').val(VatPercent);
                    $('#txtNetPriceWithVat').val(priceInclueOperetingInclueVat.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));

                    $('#txtRetentionPercentOnetime').val(response.data.retention_percent.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                    $('#txtTotalRetentionOnetime').val(retentionPercent);
                    $('#txtVatPercent').val(response.data.vat_Percent);
                    $('#txtNetPrice').val(totalRetention.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));

                    $('#lblFinalNetPrice').text(priceInclueOperetingInclueVat.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));

                }
            });

        }
		// Math.round().toFixed(2)
		function roundFixed(data, decimal = 2) {
			return (Math.round(data * 100) / 100).toFixed(decimal)
		}

		function drawContentQuestionnaire(index, question, Completed) {
			$('#contentQuestionnaire').append(`
			<div class="row justify-content-around" id="row${index}">
                <div class="col-xs center-block" style="float:none;align-items:center;">
                    <div class="card myCard" style="margin:5px auto">
                        <div class="container container-fluid" style="max-width:95%;">
							<label>
								${question.QN_ItemText}
							</label>
                            <div class="table-responsive">
							    <table class="table" style="margin-bottom:0px" >
								    <tr>
									    ${darwScorecontent(question)}
								    </tr>
							    </table>
                            </div>
						</div>
                    </div>
                </div>
			</div>
		`)
			if (EvaluationDetail.evaluate_cc_contact) {
				$('#row' + index).children().toggleClass('slider');
			}
			if (Completed) {
				$('#contentQuestionnaire').find('input,textarea').attr('disabled', '');
			}
		}
		function darwScorecontent(question) {
			var str = '<tr></tr>';
			if (question.Type === 'SCORE')
				for (var i = 1; i <= question.MaxScore + 1; i++) {
					if (question.Value === i) {
						str += '<td><input type="radio" id="mark' + question.QN_ItemID + i + '" name="mark' + question.QN_ItemID + '" value="' + i + '" checked/> <label for="mark' + question.QN_ItemID + i + '">' + i + 'คะแนน</label> </td>';
					}
					else if (question.Value === 0 && i === question.MaxScore + 1) {
						str += '<td><input type="radio" id="mark' + question.QN_ItemID + i + '" name="mark' + question.QN_ItemID + '" value="0" checked/> <label for="mark' + question.QN_ItemID + i + '">' + 'ไม่สะดวกประเมิน' + '</label> </td>';
					}
					else if (i === question.MaxScore + 1) {
						str += '<td><input type="radio" id="mark' + question.QN_ItemID + i + '" name="mark' + question.QN_ItemID + '" value="0" /> <label for="mark' + question.QN_ItemID + i + '">' + 'ไม่สะดวกประเมิน' + '</label> </td>';
					}
					else {
						str += '<td><input type="radio" id="mark' + question.QN_ItemID + i + '" name="mark' + question.QN_ItemID + '" value="' + i + '" /> <label for="mark' + question.QN_ItemID + i + '">' + i + 'คะแนน</label> </td>';
					}
				}
			else if (question.Type === 'REMARK') {
				if (question.Remark) {
					str += '<td><textarea id="mark' + question.QN_ItemID + '" rows="3" style="width: 100%">' + question.Remark + '</textarea></td>'
				}
				else {
					str += '<td><textarea id="mark' + question.QN_ItemID + '" rows="3" style="width: 100%"></textarea></td>'
				}
			}
			return str
		}
		function NoCommentEffect() {
			if ($('#CBNoComment').prop('checked')) {
				$('#DDLNoCommentReason').show();
				for (var i = 0; i < rowCoutQuestionnaire; i++) {
					$('#row' + i).children().toggleClass('slider');
				}
			}
			else {
				$('#DDLNoCommentReason').hide();
				for (var i = 0; i < rowCoutQuestionnaire; i++) {
					$('#row' + i).children().toggleClass('slider');
				}
			}
		}

		// ======================================================================= AllValidate =======================================================================
		async function validateEnddate(worksheetItemId, receiveItemId) {
			var promises = [
				checkFileImage(worksheetItemId, 1, receiveItemId),
				checkFileImage(worksheetItemId, 2),
				checkFileImage(worksheetItemId, 3)
			];
			var [before, during, after] = await Promise.all(promises);
			if (!before) {
				modalWaring('กรุณาอัพโหลดรูปก่อนซ่อม ก่อนทำการบันทึกวันซ่อมเสร็จ');
				return false;
			}if (!during) {
				modalWaring('กรุณาอัพโหลดรูประหว่างซ่อม ก่อนทำการบันทึกวันซ่อมเสร็จ');
				return false;
			}
			if (!after) {
				modalWaring('กรุณาอัพโหลดรูปหลังซ่อม ก่อนทำการบันทึกวันซ่อมเสร็จ');
				return false;
			}
			return true;
		}
		function validateBindStart(statusId, index) {
			if (statusId != 2) {
				modalWaring('กรุณาเลือกสถานะเป็น"ดำเนินการ"และกดบันทึกก่อนกรอกวันที่เริ่มซ่อม');
				$('#warningModal').on('hidden.bs.modal', () => {

					$('#ddlWorkSheetStatus' + index).get(0).scrollIntoView({ block: 'nearest', behavior: 'smooth' })
					setTimeout(() => $('#ddlWorkSheetStatus' + index).focus(), 800)
					$('#warningModal').off();
				})

				return false
			}
			return true;
		}
        function enAblePO_List(e){
            confirm("คุณต้องการยกเลิกใบ PO?");
            setDDLPO_List();
        }

        async function setDDLPO_List() {
            $("#DDLPO_List option").remove();
            await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/GetPurchaseOrderCancelReason`, response => {
                if (response.data.length > 0) {
                    bindingDdlist('DDLPO_List', response.data,'')
                }

                $("#saveCancelPO").css('display', 'block');
                //$("#createPO_NO").css("display", "block");

            });
        }
        async function saveCanlePO() {

            $("#saveCancelPO").css('display', 'none');
            $("#createPO_NO").css("display", 'block');
            $('#po_status').text('ยกเลิกเลขที่ใบ PO');


            $("#DDLPO_List").attr("disabled", "disabled");
            $("#PO_CancelConfirm").attr("disabled", "disabled");

        }


        function callModalCheckProjectBudget() {
            checkProjectBudject(worksheetId,'2');
        }

        $("#itemCheckProjectBudget").click(function () {
            checkProjectBudject(worksheetId,'2');
        });

        function openModalPO_HistoryClient(worksheetid, systype) {
            openModalPO_History(worksheetId, '2');
        }

        async function createPO_Manual() {
            await calPriceWorkSheet(0)
            var price = 0;
            //var calBeforNotIncludeVat

            await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/getSumUseRetention?worksheetID=${worksheetId}`, retentionDetail => {
                var retentionData = retentionDetail.data;
                if (retentionDetail.data.length > 0) {
                    price = retentionData[0].retentionPrice;
                    userRetentionPrice = retentionData[0].retentionPrice;
                    $('#priceAfterUseRetention').text(userRetentionPrice);
                    $('#priceRetentionVendor').text(retentionData[0].retention_price);
                    if (retentionData[0].sum_retention > 0) {
                        is_haveUseRetention = true;
                    }
                    else {

                        $('#priceAfterUseRetention').text("-");
                        $('#priceRetentionVendor').text("-");
                    }
                }
                else {
                    price = $('#txtTotalIncludeOperatingPercent').val();
                    userRetentionPrice = 0;
                    //txtTotalIncludeOperatingPercent
                }
            });

            //Check เอกสารใบเสนอราคา
            if (price >= 20000) {
                await ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/checkAttachmentFile?id=${worksheetId}`, response => {
                    if (response) {
                        if (response.data === 0) {
                            modalWaring("กรุณาแนบเอกสารใบเสนอราคา !");
                            AttachFlag = false;
                            $('#PO_No').text("");
                            $('#po_status').text("สร้าง PO ไม่สำเร็จ - ยังไม่มีการ Attach ใบเสนอราคา");
                            $("#createPO_NO").css('display', 'block');
                            $("#btnCancelPO").css('display', 'none');
                            $("#createWorkFlow").css('display', 'none');
                            checkPo_status = false;
                            return
                        }
                        else {
                            AttachFlag = true;

                        }
                    }
                });
            }
            else
            {
                AttachFlag = true;
            }

            if (AttachFlag) {

                var confirmRetention = false;
                if (price >= 5000) {
                    let totalNetPrice = (price - ((price * 5) / 100)).toFixed(2);
                    $('#frmRetention [name="txtRetentionPercent"]').val('5');
                    $('#frmRetention [name="txtNetPriceWithRetention"]').val(totalNetPrice);
                    var cal = ((price * 5) / 100).toFixed(2);
                    $('#frmRetention [name=txtTotalRetention]').val(cal);

                    confirmRetention = await openModalConfirmRetention();
                    if (confirmRetention == true) {
                        openModalConfirmRetentionOnetime(confirmRetention)
                    } else {
                        openModalConfirmRetentionOnetime(confirmRetention)
                    }
                }
                page.loading();
                let data = {
                    WorkSheetId: worksheetId,
                    systemType: 2,
                    UserLogon: '@UserDetail.CodeName'
                }
                await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/SaveCreatePOHeader`,data,purcheOrder => {
                    var ponumberList = purcheOrder;
                    if (ponumberList.data.status == false) {

                        //$('#PO_No').text("");
                        $('#po_status').text("สร้าง PO ไม่สำเร็จ");
                        $("#createPO_NO").css('display', 'block');
                        $("#btnCancelPO").css('display', 'none');
                        $("#createWorkFlow").css('display', 'none');

                        checkPo_status = false
                        modalWaring(ponumberList.data.msg);

                        showUseRetentionDeteail();
                        is_doc_completed = false;
                        checkDocComplete();

                        page.loaded();

                    } else {
                        //$('#PO_No').text(ponumberList.data.message);
                        GetWorkSheetPODetail();
                        checkPo_status = true;
                        showUseRetentionDeteail();
                        showModalLineApprveSuccess();
                        is_doc_completed = true;
                        checkDocComplete();
                        page.loaded();
                    }
                });
            }
            $("#createPO_NO").attr('disabled', 0);
        }

        async function showUseRetentionDeteail() {
            if ($('#PaymentType').val() != "46") {
                await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/getSumUseRetention?worksheetID=${worksheetId}`, retentionDetail => {
                    var retentionData = retentionDetail.data;
                    if (retentionDetail.data.length > 0) {
                        if (retentionData[0].sum_retention > 0) {
                            $('#priceAfterUseRetention').text(retentionData[0].retentionPrice);
                            $('#priceRetentionVendor').text(retentionData[0].retention_vendor_price);
                        }
                        else {

                            $('#priceAfterUseRetention').text($("#txtTotalIncludeOperatingPercent").val(0));
                            $('#priceRetentionVendor').text($("#txtTotalRetentionOnetime").val(0));
                        }
                    }
                    else {
                        $('#priceAfterUseRetention').text($("#txtTotalIncludeOperatingPercent").val());
                        $('#priceRetentionVendor').text($("#txtTotalRetentionOnetime").val());
                    }
                });
            }
        }

        $("#createPO_NO").click(async function () {

            $("#createPO_NO").attr('disabled', 1);
            $('#frmConfirm [name="headerModal"]').addClass('bg-green');
            $('#frmConfirm [name="titleModal"]').text('สร้าง PO ใบงาน');
            $('#frmConfirm [name="questionDesc"]').text('ยืนยันการสร้าง PO ใบงาน ?');
            var createPO_confirm = await openModalConfirmPopUP();
            if (createPO_confirm) {
                createPO_Manual();
            }
        });

        $('#btnWorkSheetRollback').click(async function () {
            var result = await GetWorkSheetRollbackReason();
            console.log(result);
            let option = ``;
            $.each(result.data, function (Index, Value) {
                option += `<option value="${Value.id}">
                                        ${Value.description}
                                    </option>`;
            });

            var ddlReasonType = $('#frmWorkSheetRollback [name="reasonId"]');
            ddlReasonType.empty().html(option);
            var confirmRollback = await openModalConfirmRollbackTimeSheet();
            console.log(confirmRollback);

            if (confirmRollback) {
                let data = {
                    WorkSheetId: worksheetId,
                    ResonCancelId: confirmRollback.reasonId,
                    ReasonRemark: confirmRollback.remark,
                    UserLogon: "@UserDetail.CodeName",
                }
                console.log(data);
                let rollbackResult = await RollbackWorkSheet(data);
                console.log(rollbackResult);
                if (rollbackResult.data.status) {
                    showModalLineApprveSuccess('บันทึกข้อมูลถอยสถานะเรียบร้อยแล้ว');
                    $('#btnWorkSheetRollback').css("display", "none");
                    $('#worksheetCloseConfirm').attr({ checked: false, disabled: false });
                    $('#worksheetCloseConfirm').prop('checked', 0);
                    $('#worksheetFlagCloseDate').val('');
                    ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/${worksheetId}`, response => {
                        $('#worksheetStatus').text(response.data.worksheetStatus);
                    });
                }
                else {
                    modalWaring("ถอยสถานะใบงานไม่สำเร็จ");
                    $('#btnWorkSheetRollback').css("display", "block");
                }
            }
        });

        function RollbackWorkSheet(data) {
            if (!document.getElementById('worksheetCloseConfirm').checked) { // ถ้าหากใบงานไม่ได้ปิดอยู่ก็ไม่ต้องถอยสถานะ
                return;
            }
            return new Promise(async function (resolve, reject) {
                await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/WorkSheetRollback`, data, response => {
                    if (response) {
                        resolve(response);
                        //window.location.reload(true)

                        //เมื่อถอยใบงานต้อง Update Retention Status รองรับกรณีที่ Retention โดน Cancel
                        UpdateRetentionStatus();

                    } else {
                        reject();
                    }

                });
            })
        }

        $('#btnCancelPO').click(async function () {
            var result = await GetPOCancelReason();
            console.log(result);
            let option = ``;
            $.each(result.data, function (Index, Value) {
                option += `<option value="${Value.id}">
                                       ${Value.description}
                           </option>`;
            });
            var ddlReasonType = $('#frmCancelPO [name="reasonId"]');
            ddlReasonType.empty().html(option);
            var confirmCancel = await openModalConfirmCancelPO();

            if (confirmCancel) {
                let data = {
                    WorkSheetId: worksheetId,
                    ApproveJobId: ApproveID,
                    ResonCancelId: confirmCancel.reasonId,
                    ReasonRemark: confirmCancel.remark,
                    UnitCode: $('#customerUnitCode').text().split('(')[0].trim(),
                    UserLogon: "@UserDetail.CodeName",
                    SystemType: 2,
                    PONumber: $('#PO_No2').val()
                }
                console.log(data);
                let cancelResult = await CancelPO(data);
                console.log(cancelResult);
                if (cancelResult.data.status) {
                    showModalLineApprveSuccess("ยกเลิกเลขที่ PO เรียบร้อยแล้ว");
                }
                else {
                    modalWarning(cancelResult.data.msg);
                }

                if (document.getElementById('worksheetCloseConfirm').checked) { // ถ้าหากใบงานไม่ได้ปิดอยู่ก็ไม่ต้องถอยสถานะ
                    let dataRollback = {
                        WorkSheetId: worksheetId,
                        ResonCancelId: "1",
                        ReasonRemark: "",
                        UserLogon: "@UserDetail.CodeName",
                    }

                    RollbackWorkSheet(dataRollback)
                }
                GetWorkSheetPODetail();
            }
        });

        async  function CancelPO(data) {
            return new Promise(async function (resolve, reject) {
                await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/CancelPO`, data, response => {
                    if (response) {
                        resolve(response);
                        //window.location.reload(true)
                        $('#PO_No').text("");
                        $('#po_status').text("ยกเลิกเลขที่ใบ PO");
                        $("#btnCancelPO").css("display", "none");
                        $("#createPO_NO").css("display", "block");
                        $("#createWorkFlow").css("display", "none");
                        checkPo_status = false;

                        if (document.getElementById('worksheetCloseConfirm').checked) { // ถ้าหากใบงานไม่ได้ปิดอยู่ก็ไม่ต้องถอยสถานะ
                            CancelworksheetByCancelPO();
                        }

                        // ต้อง Reset Retention ที่เคยหักสร้างของที่เหลือจาก หักใช้ Retention ด้วย
                        let data_retention = {
                            "worksheetId": worksheetId,
                            "retention_vendor_percent": 0,
                            "retention_vendor_price": 0,
                            "updatedBy": '@UserDetail.CodeName'
                        }

                        ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/UpdateWorksheetRetentionVendor`, data_retention, response => {
                            console.log(response);
                            if (response) {

                            }
                        });
                        //$('#priceAfterUseRetention').text("-");
                        $('#priceRetentionVendor').text("0");
                        is_doc_completed = false;
                        checkDocComplete();

                    } else {
                        reject();
                    }
                });
            })
        }

        function openModalConfirmWithReason(title, txt, func, require) {
            $('#confirmTitle').text(title);
            $('#confirmTxtReason').text(txt);
            require ? $('#confirmStarReason').show() : $('#confirmStarReason').hide();
            $('#confirmBtn').removeAttr('onclick');
            $('#confirmBtn').attr('onclick', func + `(); $('#modalConfirmWithReason').modal('hide')`);
            $('#modalConfirmWithReason').modal('show');
        }

        function GetWorkSheetRollbackReason() {
            return new Promise(async function (resolve, reject) {
                await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/GetWorkSheetRollbackReasonList`, response => {
                    if (response) {
                        resolve(response);
                    } else {
                        reject();
                    }
                });
            })
        }

        $('#btnRollbackWorkSheet').click(async function () {
            var result = await GetWorkSheetRollbackReason();
            console.log(result);
            let option = ``;
            $.each(result.data, function (Index, Value) {
                option += `<option value="${Value.id}">
                                       ${Value.description}
                           </option>`;
            });
            var ddlReasonType = $('#frmWorkSheetRollback [name="reasonId"]');
            ddlReasonType.empty().html(option);
            var confirmRollback = await openModalConfirmRollbackTimeSheet();
            console.log(confirmRollback);

            if (confirmRollback) {
                let data = {
                    WorkSheetId: worksheetId,
                    ResonCancelId: confirmRollback.reasonId,
                    ReasonRemark: confirmRollback.remark,
                    UserLogon: "@UserDetail.CodeName",
                }
                console.log(data);
                let rollbackResult = await RollbackWorkSheet(data);
                console.log(rollbackResult);
                if (rollbackResult.data.status) {
                    modalSuccess();
                    pleaseWaitDialogClose();
                }
            }
        });

        function GetPOCancelReason() {
            return new Promise(async function (resolve, reject) {
                await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/GetPurchaseOrderCancelReason`, response => {
                    if (response) {
                        resolve(response);
                    } else {
                        reject();
                    }
                });
            })
        }

        async function GetWorkSheetPODetail() {

            if ($('#PaymentType').val() === "46") {
                $('#PO_No2').empty();
                await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/GetWorkSheetPODetail?id=${worksheetId}`, response => {
                    console.log(response);
                    if (response) {

                        POListFor2PO = response.data;
                        if (response.data[0].poStatus === 0 || response.data[0].is_active === false) {
                            $('#createPO_NO').css('display', 'block');
                            $('#btnCancelPO').css('display', 'none');
                            $("#createWorkFlow").css("display", 'none');
                            $('#po_status').text("-");

                        } else {

                            $.each(POListFor2PO, function (Index, Value) {
                                $('#PO_No2').append($("<option></option>").val(Value.poNumber).html(Value.poNumber + '(' + Value.po_gen_type +')'));
                            });

                            if (response.data[0].poStatus != 2 && response.data[0].poNumber != "") {
                                $('#createPO_NO').css('display', 'none');
                                $('#btnCancelPO').css('display', 'none');
                                $("#createWorkFlow").css('display', 'block');
                                $('#lbPONumber').text(response.data[0].poNumber);
                                $('#po_status').text(response.data[0].poStatusDesc);


                            }
                            else {
                                $("#PO_No2 option[value='" + response.data[0].poNumber + "']").prop('selected', true);
                                $('#createPO_NO').css('display', 'none');
                                $('#btnCancelPO').css('display', 'block');
                                $("#createWorkFlow").css("display", 'none');
                                $('#po_status').text(response.data[0].poStatusDesc);
                                $('#priceRetentionVendor').text(response.data[0].retention_price.toFixed(2))
                                $('#priceAfterUseRetention').text(response.data[0].balance.toFixed(2))
                                po_number = response.data[0].poNumber;

                            }
                        }
                    }
                });

            } else {
                await ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/GetWorkSheetPODetail?id=${worksheetId}`, response => {
                    console.log(response);
                    if (response) {


                        if (response.data[0].poStatus === 0 || response.data[0].is_active === false) {
                            $('#createPO_NO').css('display', 'block');
                            $('#btnCancelPO').css('display', 'none');
                            $("#createWorkFlow").css("display", 'none');
                            $('#lbPONumber').text("-");
                            $('#po_status').text("-");
                            calPriceWorkSheet(0);

                        } else {
                            if (response.data[0].poStatus != 2 && response.data[0].poNumber != "") {
                                $('#createPO_NO').css('display', 'none');
                                $('#btnCancelPO').css('display', 'none');
                                $("#createWorkFlow").css('display', 'block');
                                $('#lbPONumber').text(response.data[0].poNumber);
                                $('#po_status').text(response.data[0].poStatusDesc);
                                calPriceWorkSheet(response.data[0].retention_percent)
                                po_number = response.data[0].poNumber;

                            }
                            else {

                                $('#createPO_NO').css('display', 'none');
                                $('#btnCancelPO').css('display', 'block');
                                $("#createWorkFlow").css("display", 'none');
                                $('#lbPONumber').text(response.data[0].poNumber);
                                $('#po_status').text(response.data[0].poStatusDesc);
                                po_number = response.data[0].poNumber;
                                calPriceWorkSheet(response.data[0].retention_percent)
                            }
                        }
                    }
                });
            }
        }

        async function openModalConfirmRetentionOnetime(confrim) {
            return new Promise(async function (resolve, reject) {
                $('#modalValidateRetention').modal('show');
                if (confrim) {
                    var percent_retention = $('#modalValidateRetention [name="txtRetentionPercent"]').val();
                    var retention_price = $('#modalValidateRetention [name="txtTotalRetention"]').val()

                    if (is_haveUseRetention) {
                        let data_retention = {
                            "worksheetId": worksheetId,
                            "retention_vendor_percent": percent_retention,
                            "retention_vendor_price": retention_price,
                            "updatedBy": '@UserDetail.CodeName'
                        }

                        await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/UpdateWorksheetRetentionVendor`, data_retention, response => {
                            console.log(response);
                            if (response) {

                            }
                        });
                    } else {
                        var percent_retention = $('#modalValidateRetention [name="txtRetentionPercent"]').val();
                        var retention_price = $('#modalValidateRetention [name="txtTotalRetention"]').val()

                        calPriceWorkSheet(percent_retention)
                        await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/UpdateRetentionDataOnetime?worksheetID=${worksheetId}&RetentionPercent=${percent_retention}&RetentionPrice=${retention_price}`, response => {
                            console.log(response);
                            if (response) {

                            }
                        });
                    }
                } else {

                    if (is_haveUseRetention) {
                        let data_retention = {
                            "worksheetId": worksheetId,
                            "retention_vendor_percent": 0,
                            "retention_vendor_price": 0,
                            "updatedBy": '@UserDetail.CodeName'
                        }

                        await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/UpdateWorksheetRetentionVendor`, data_retention, response => {
                            console.log(response);
                            if (response) {
                            }
                        });

                    } else {
                        var percent_retention = $('#modalValidateRetention [name="txtRetentionPercent"]').val();
                        var retention_price = $('#modalValidateRetention [name="txtTotalRetention"]').val()
                        calPriceWorkSheet(0);
                        var percent_retention = 0;
                        var retention_price = 0;
                        await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/UpdateRetentionDataOnetime?worksheetID=${worksheetId}&RetentionPercent=${percent_retention}&RetentionPrice=${retention_price}`, response => {
                            console.log(response);
                            if (response) {
                            }
                        });
                    }
                }
                $('#btnConfirmRetention').removeAttr('onclick');
            });
        }

        $('#frmRetention [name="txtRetentionPercent"]').change(function () {
            var price = 0;
            if (is_haveUseRetention) {
                price = userRetentionPrice;
                var txtRetentionPercent = $('#frmRetention [name=txtRetentionPercent]').val();
                var cal = ((price * txtRetentionPercent) / 100).toFixed(2);
                var netprice_withretention = (price - cal).toFixed(2);
                $('#frmRetention [name=txtTotalRetention]').val(cal);
                $('#frmRetention [name="txtNetPriceWithRetention"]').val(netprice_withretention);
            } else {
                price = $('#txtTotalIncludeOperatingPercent').val();
                //var price = $('#txtTotalIncludeOperatingPercent').val();
                var txtRetentionPercent = $('#frmRetention [name=txtRetentionPercent]').val();
                var cal = ((price * txtRetentionPercent) / 100).toFixed(2);
                var netprice_withretention = (price - cal).toFixed(2);
                $('#frmRetention [name=txtTotalRetention]').val(cal);
                $('#frmRetention [name="txtNetPriceWithRetention"]').val(netprice_withretention);
            }
        })

        $('#createWorkFlow').click(async function () {

           let dataPO = {
               WorkSheetId: worksheetId,
               PONumber: $('#PO_No').text(),
               systemType: 2,
               UserLogon :  '@UserDetail.CodeName'
           }
            await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/ApprovePO`, dataPO, response => {
               console.log(response);
               if (response) {
                   if (response.data.approveStatus === 'S') {
                       GetWorkSheetPODetail();
                       modalSuccess(response.data.msg);
                       pleaseWaitDialogClose();
                       checkPo_status = true;

                   } else {
                       modalWarning(response.data.msg);
                       checkPo_status = false;
                   }
               }
           });
        });

        async  function CancelworksheetByCancelPO() {
            let data = {
                WorkSheetId: worksheetId,
                ResonCancelId: "1",
                ReasonRemark: "Cancel PO",
                UserLogon: "@UserDetail.CodeName",
            }

            RollbackWorkSheet(data);
            $('#btnWorkSheetRollback').css("display", "none");
            $('#worksheetCloseConfirm').attr({ checked: false, disabled: false });
            $('#worksheetCloseConfirm').prop('checked', 0);
            $('#worksheetFlagCloseDate').val('');
            ajaxGet(`${baseUrl}/homecare/api/v1/Worksheet/${worksheetId}`, response => {
                $('#worksheetStatus').text(response.data.worksheetStatus);
            });
        }

        async function getTotalPrice() {
            await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/getPODetail?worksheetID=${worksheetId}&system_type=2`, response => {
                if (response.data) {
                    //haveFile = true;
                    totalPricebyWorksheet = response.data.net_Price;
                }
            });
        }

        function showModalLineApprveSuccess(msg) {
            $('#modalInsertRoleSuccess').modal('show');
            $('#lbTxtSuccess').text(msg);
        }

        function redirectURL() {

            window.location.href = window.location.pathname;
        }

        async function GetCompanyList() {
            let option = ``;
            await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/GetCompanyList`, response => {
                if (response) {
                    var ddlCompany = $('#searchCompany');

                    option += `<option selected="selected" value="">Please select</option>`;
                    $.each(response.data, function (Index, Value) {
                        option += `<option value="${Value.id}">
                                       ${Value.description}
                                  </option>`;
                    });
                    ddlCompany.empty().html(option);
                }
            });
        }

        async function GetDocumentTypeList() {
            let option = ``;

            await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/GetDocumentTypeList`, response => {
                if (response) {
                    var ddlSystemType = $('#searchSystemType');

                    option += `<option selected="selected" value="">Please select</option>`;
                    $.each(response.data, function (Index, Value) {
                        option += `<option value="${Value.code}">
                                       ${Value.description}
                                  </option>`;
                    });

                    ddlSystemType.empty().html(option);
                }
            });
        }

        async function getPOList() {
            if ($('#vendorCode').val() === '') {
                modalWaring("กรุณาระบุ รหัส/ชื่อผู้รับเหมา");
                return;
            }
            var table3 = $('#vendor-list').DataTable();
            table3.destroy();

            $('lblNetRetentionPrice').text(0);
            $('lblNetRetentionPriceBeforPO').text(0);

            await page.loading();

            let data = {
                Vendor: $('#vendorCode').val(),
                CompanyCode: $('#searchCompany').val() === "" ? "*" : $('#searchCompany').val(),
                DocumentType: $('#searchSystemType').val() === "" ? "*" : $('#searchSystemType').val(),
                PONumber: $('#poNumber-retention').val() === "" || $('#poNumber-retention').val() === undefined ? "*" : $('#poNumber-retention').val()
            }

            $("#Po_retention_List tbody tr").remove();
            await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/SearchPOList`, data, response => {
                console.log(response);
                var row = 0
                if (response) {
                    $("#vendor-list tbody tr").remove();
                    $.each(response.data, (i, d) => {

                        $('#vendor-list tbody').append(`
						    <tr>
							    <td class="text-center" style="vertical-align: middle;width: "50px">
                                    <input type="checkbox" id="selectPO_${row}">
                                </td>
							    <td class="text-center" style="vertical-align: middle;width: "50px">${d.ebeln}</td>
							    <td class="text-center" style="vertical-align: middle;width: "50px">${d.gsber}</td>
							    <td class="text-center" style="vertical-align: middle;width: "50px"">${$('#vendorCode').val()}</td>
							    <td class="text-left" style="vertical-align: middle;width: "50px"">${$('#vendorName').val()}</td>
							    <td class="text-right" style="vertical-align: middle;width: "50px"">${d.rettot.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td>
							    <td class="text-right" style="vertical-align: middle;width: "50px"">${d.bsart}
                                    <input type="hidden" value="${d.gsber}"  id="gsbr_${d.index}" name="gsbr_${d.index}"/>
                                    <input type="hidden" value="${d.kostl}"  id="kostl_${d.index}" name="kostl_${d.index}"/>
                                </td>
						    </tr>
					    `)

                        po_ListFromSearch.push({
                            "ponumber": d.ebeln,
                            "vendor_no": $('#vendorCode').val(),
                            "vednor_name": $('#vendorName').val(),
                            "retenion_remaining": d.rettot,
                            "retention_type": d.bsart
                        });
                        row++;
                    })
                }
            });

            var t = $('#vendor-list').DataTable({
                "processing": true,
                "language": {
                    "search": "ค้นหา : ",
                    "lengthMenu": "แสดง _MENU_ รายการ",
                    "emptyTable": "ไม่พบข้อมูล",
                    "info": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                    "paginate": {
                        "first": "หน้าแรก",
                        "last": "หน้าสุดท้าย",
                        "next": "ถัดไป",
                        "previous": "ก่อนหน้า"
                    }
                }
            });
            page.loaded();
        }

        $('#btnAction').click(async function () {
            {
                var today = new Date();
                var dd = String(today.getDate()).padStart(2, '0');
                var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
                var yyyy = today.getFullYear();

                today = dd + '/' + mm + '/' + yyyy;
                var netTotalRetentionPrice = 0;
                var table3 = $('#Po_retention_List').DataTable();
                table3.destroy();

                var table4 = $('#vendor-list').DataTable();
                table4.destroy();
                const table = document.getElementById('vendor-list');
                $("#Po_retention_List tbody tr").remove();

                if (table.rows.length == 0) {
                    $('lblNetRetentionPrice').text(0);
                    $('lblNetRetentionPriceBeforPO').text(0);
                }

                for (var r = 1, n = table.rows.length; r < n; r++) {

                    var chk = document.getElementById("selectPO_" + (r - 1)).checked
                    if (chk) {

                        $('#Po_retention_List tbody').append(`
						<tr>
							<td class="text-center" style="vertical-align: middle;">
                                ${table.rows[r].cells[1].innerHTML}
                            </td>
							<td class="text-center" style="vertical-align: middle;">${table.rows[r].cells[2].innerHTML}</td>
							<td class="text-center" style="vertical-align: middle;">${table.rows[r].cells[3].innerHTML}</td>
							<td class="text-left" style="vertical-align: middle;">${table.rows[r].cells[4].innerHTML}</td>
							<td class="text-right" style="vertical-align: middle;">${table.rows[r].cells[5].innerHTML}</td>
							<td class="text-right" style="vertical-align: middle;">
                                <input type="number" class="form-control"  id="retention_amount_${(r - 1)}" value="${table.rows[r].cells[5].innerHTML.replace(",", "")}"
                                    onchange ='CheckPrice(this.value.replace(",", ""),${table.rows[r].cells[5].innerHTML.replace(",", "")},this.id)'
                                    style="vertical-align: middle;text-align:right;">
                            </td>
    						<td class="text-right" style="vertical-align: middle;">
                                        <div class="bootstrap-datepicker">
                                        <div class="input-group">
                                            <div class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </div>
                                            <input class="form-control datepicker" type="text" id="extenddate_${(r - 1)}" name="extenddate_${(r - 1)}" class="form-control datepicker" value="${today}" style="text-align:center;">
                                        </div>
                                    </div>
                            </td>
							<td class="text-right" style="vertical-align: middle;"><input type="text" class="form-control"  id="retention_Remark_${(r - 1)}"/></td>
    				        <td class="text-center" style="vertical-align: middle;">
                                ${table.rows[r].cells[6].innerHTML}
                            </td>
						</tr>
					    `)

                        var price = table.rows[r].cells[5].innerHTML
                        price = price.replace(",", "")
                        netTotalRetentionPrice = netTotalRetentionPrice + parseFloat(price);
                    }
                }
            }

            table =   $('#Po_retention_List').DataTable({
                "createdRow": function (row, data, index) {
                    $('.datepicker', row).datepicker({
                        autoclose: true,
                        format: 'dd/mm/yyyy'
                    });
                },
                "processing": true,
                "language": {
                    "search": "ค้นหา : ",
                    "lengthMenu": "แสดง _MENU_ รายการ",
                    "emptyTable": "ไม่พบข้อมูล",
                    "info": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                    "paginate": {
                        "first": "หน้าแรก",
                        "last": "หน้าสุดท้าย",
                        "next": "ถัดไป",
                        "previous": "ก่อนหน้า"
                    }
                }
             });

            $('#vendor-list').DataTable({
                "createdRow": function (row, data, index) {
                    $('.datepicker', row).datepicker({
                        autoclose: true,
                        format: 'dd/mm/yyyy'
                    });
                },
                "processing": true,
                "language": {
                    "search": "ค้นหา : ",
                    "lengthMenu": "แสดง _MENU_ รายการ",
                    "emptyTable": "ไม่พบข้อมูล",
                    "info": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                    "paginate": {
                        "first": "หน้าแรก",
                        "last": "หน้าสุดท้าย",
                        "next": "ถัดไป",
                        "previous": "ก่อนหน้า"
                    }
                }
            });

            var link = $('#tabs-retention .active').next().children('a').attr('href');
            $('#tabs-retention a[href="' + link + '"]').tab('show');

            $('#lblNetRetentionPrice').text(netTotalRetentionPrice.toFixed(2));

            var sumUseRetention = parseFloat($('#lblUerSumRetentionPrice').text());
            var netRententionPrice = parseFloat($('#lblNetRetentionPrice').text());
            var sumAll = sumUseRetention + netRententionPrice;
            $('#lblNetRetentionPriceBeforPO').text(sumAll.toFixed(2));
        });

        $('#btnCreateRetention').click(async function () {

            $('#frmConfirm [name="headerModal"]').addClass('bg-green');
            $('#frmConfirm [name="titleModal"]').text('ยืนยันการหักเงินประกันผู้รับเหมา');
            $('#frmConfirm [name="questionDesc"]').text('คุณต้องการหักเงินประกันผู้รับเหมา ใช่หรือไม่ ?');
            var createRetconfirm = await openModalConfirmPopUP();
            if (createRetconfirm) {
                createUseRetention();
            }
        });

        async function createUseRetention() {
            var SumUserRetion
            let dataList = [];
            let ErrorMsg = null;
            console.log($('#Po_retention_List').find('tr'));

            if ($('#lblNetRetentionPrice').text() == "")
            {
                SumUserRetion = 0;
            } else {
                SumUserRetion = parseFloat($('#lblNetRetentionPrice').text());
            }

            if (SumUserRetion == 0)
            {
                modalWaring("กรุณาตรวจสอบรายการที่ต้องการหัก Retention ให้เรียบร้อยก่อนทำรายการ")
                return;
            }
            await ajaxGet(`${baseUrl}/homecare/api/v1/PurchaseOrder/getSumUseRetention?worksheetID=${worksheetId}`, response => {
                console.log(response);
                if (response.data.length > 0) {
                    if (response.data[0].sum_retention != 0) {
                        SumUserRetion = parseFloat(SumUserRetion) + parseFloat(response.data[0].sum_retention)
                    }
                }
            });

            var NetPrice = parseFloat($('#lblFinalNetPrice').text())

            if (SumUserRetion > NetPrice)
            {
                modalWaring("กรุณาตรวจสอบจำนวนเงินหักเงินประกันไม่เกินราคาตามใบงาน")
                return;
            }

            var validate = true;
            $('#Po_retention_List').find("tr").each(function (i, el) {
                var $tds = $(this);
                if (i !== 0) {
                    if ($tds.find("td:eq(6) input[type='text']").val() == "") {
                        modalWaring("กรุณาระบุวันที่ให้เรียบร้อยก่อนทำรายการ")
                        validate = false;
                        return;
                    }
                    if ($tds.find("td:eq(5) input[type='number']").val() == "") {
                        modalWaring("กรุณาระบุจำนวนเงินในการหักเงินประกันให้เรียบร้อยก่อนทำรายการ")
                        return;
                    }
                    if ($tds.find("td:eq(7) input[type='text']").val() == "") {
                        modalWaring("กรุณาระบุหมายเหตุให้เรียบร้อยก่อนทำรายการ")
                        validate = false;
                        return;
                    }

                    let data = {
                        Vendor: Number($tds.find("td:eq(2)").text()),
                        CompanyCode: "10",
                        DocumentType: $tds.find("td:eq(8)").text().trim(),
                        Gsber: $tds.find("td:eq(1)").text(),
                        Kostl: $tds.find("td:eq(8) input[name*='kostl']").val(),
                        RetentionAmount: $tds.find("td:eq(5) input[type='number']").val(),
                        RetentionRemark: $tds.find("td:eq(7) input[type='text']").val(),
                        PostingDate: dateFormat($tds.find("td:eq(6) input[type='text']").val()),
                        PONumber: $tds.find("td:eq(0)").text().trim(),
                        UserLogon:  '@UserDetail.CodeName'
                    }
                    dataList.push(data);
                }
            });

            if (validate) {
                await page.loading();

                $('#tbWorksheetRetention-list').DataTable().destroy();
                //tableWorksheetRetention.re
                tableWorksheetRetention = $('#tbWorksheetRetention-list').DataTable({
                    "pageLength": 10,
                    "columnDefs": [
                        {
                            "targets": 0,
                            "render": function (data, type, row, meta) {
                                return `${data}`;
                            }
                        },
                        {
                            "targets": 1,
                            "render": function (data, type, row, meta) {
                                return `${data}`;
                            },
                            "className": "text-center"
                        },
                        {
                            "targets": 2,
                            "render": function (data, type, row, meta) {
                                return `${data}`;
                            },
                            "className": "text-center"
                        },
                        {
                            "targets": 3,
                            "render": function (data, type, row, meta) {
                                return `${data}`;
                            },
                            "className": "text-center"
                        },
                        {
                            "targets": 4,
                            "render": function (data, type, row, meta) {
                                return `${data.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                            },
                            "className": "text-right"
                        },
                        {
                            "targets": 5,
                            "render": function (data, type, row, meta) {
                                return `${data}`;
                            },
                            "className": "text-center"
                        },
                        {
                            "targets": 6,
                            "render": function (data, type, row, meta) {
                                return `${data}`;
                            },
                            "className": "text-center"
                        }

                    ],
                    "order": [[0, 'asc']],
                    "language": {
                        "search": "ค้นหา : ",
                        "lengthMenu": "แสดง _MENU_ รายการ",
                        "emptyTable": "ไม่พบข้อมูล",
                        "info": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                        "infoEmpty": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                        "infoFiltered": "",
                        "zeroRecords": "ไม่พบข้อมูล",
                        "paginate": {
                            "first": "หน้าแรก",
                            "last": "หน้าสุดท้าย",
                            "next": "ถัดไป",
                            "previous": "ก่อนหน้า"
                        }
                    }
                });

            var    currentPage = table.page();

            var body = {
                    worksheet_id: worksheetId,
                    approve_job_id: 0,
                    vendor_to: $('#hdVendorID').val(),
                    UserLogon: '@UserDetail.CodeName',
                    systemType:2,
                    RetentionDataList: dataList,
                vendorFromDesc: $('#vendorName').val(),
                    vendorFrom: $('#vendorCode').val()
            }

            console.log(dataList);
            await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/CreateRetention`, body, response => {
                console.log(response);
                page.loaded();
                if (response.data.status != false) {
                    if (SumUserRetion != NetPrice) {
                        $('#panelPurchesOrder').css("display", "block");

                        //showModalLineApprveSuccess("บันทึกข้อมูลเรียบร้อยแล้ว(ราคาหักจ่าย Retention ยังไม่ครบตามราคาใบงาน)")

                        tableWorksheetRetention.rows().remove().draw(false);
                        $.each(response.data.data, function (index, value) {
                            value.index = index;
                            tableWorksheetRetention.row.add([
                                value.retention_number,
                                value.po_number,
                                value.retention_from_vendor,
                                $('#vendorName').val(),
                                value.retention_amount,
                                value.retention_posting_date,
                                value.retention_remark
                            ]).page(currentPage).draw(false);
                        });

                        activaTab('listRetention', 'tab-listRetention');
                        showUseRetentionDeteail();
                        GetWorkSheetPODetail();

                    } else {
                        tableWorksheetRetention.rows().remove().draw(false);
                        $.each(response.data.data, function (index, value) {
                            value.index = index;
                            tableWorksheetRetention.row.add([
                                value.retention_number,
                                value.po_number,
                                value.retention_from_vendor,
                                $('#vendorName').val(),
                                value.retention_amount,
                                value.retention_posting_date,
                                value.retention_remark
                            ]).page(currentPage).draw(false);
                        });
                        activaTab('listRetention', 'tab-listRetention');
                        showUseRetentionDeteail();
                        GetWorkSheetPODetail();
                    }
                } else {

                    tableWorksheetRetention.rows().remove().draw(false);
                    $.each(response.data.data, function (index, value) {
                        value.index = index;
                        tableWorksheetRetention.row.add([
                            value.retention_number,
                            value.po_number,
                            value.retention_to_vendor,
                            $('#vendorName').val(),
                            value.retention_amount,
                            value.retention_posting_date,
                            value.retention_remark
                        ]).page(currentPage).draw(false);
                    });

                    activaTab('listRetention', 'tab-listRetention');
                    showUseRetentionDeteail();
                    GetWorkSheetPODetail();
                    ErrorMsg = response.data.msg;
                }
            });
                if (ErrorMsg !== null)
                {
                    page.loaded();
                    modalWaring(ErrorMsg);
                }
                else
                {
                    page.loaded();
                    modalSuccess();
                }
            }
        }

        function activaTab(tab, actTab) {
            $('#' + actTab).show();
            $('.nav-tabs a[href="#' + tab + '"]').tab('show');
        }

        function CheckPrice(val1, val2, id) {
            var table3 = $('#Po_retention_List').DataTable();
            table3.destroy();

            $('.error').hide();
            if (val1 == "")
            {
                //modalWaring("กรุณาตรวจสอบข้อมูลจำนวนเงินที่ต้องการหักเงินประกัน");
                document.getElementById(id).value = val2;
                $('#' + id).after('<span class="error text-danger" style="font-size:small;font-style: italic;">*กรุณาตรวจสอบข้อมูลจำนวนเงินที่ต้องการหักเงินประกัน</span>')
            }
         
            if (val1 > val2) {
                //modalWaring("กรุณาระบุราคาไม่เกินราคาตามรายการ");
                $('#' + id).after('<span class="error text-danger" style="font-size:small;font-style: italic;">*กรุณาระบุราคาไม่เกินราคาตามรายการ</span>');
                document.getElementById(id).value = val2;
                var calNetPrice = 0;
                $('#Po_retention_List').find("tr").each(function (i, el) {
                    var $tds = $(this);
                    if (i !== 0) {
                        //$tds.find("td:eq(4) input[type='number']").val()
                        calNetPrice = calNetPrice + parseFloat($tds.find("td:eq(5) input[type='number']").val())
                    }

                });
                $('#lblNetRetentionPrice').text(calNetPrice.toFixed(2));

                var sumUseRetention = parseFloat($('#lblUerSumRetentionPrice').text());
                var netRententionPrice = parseFloat($('#lblNetRetentionPrice').text());
                var sumAll = sumUseRetention + netRententionPrice;
                $('#lblNetRetentionPriceBeforPO').text(sumAll.toFixed(2));

            } else {

                var calNetPrice = 0;
                $('#Po_retention_List').find("tr").each(function (i, el) {
                    var $tds = $(this);
                    if (i !== 0) {
                        //$tds.find("td:eq(4) input[type='number']").val()
                        calNetPrice = calNetPrice + parseFloat($tds.find("td:eq(5) input[type='number']").val())
                    }

                });
                $('#lblNetRetentionPrice').text(calNetPrice.toFixed(2));
                var sumUseRetention = parseFloat($('#lblUerSumRetentionPrice').text());
                var netRententionPrice = parseFloat($('#lblNetRetentionPrice').text());
                var sumAll = sumUseRetention + netRententionPrice;
                $('#lblNetRetentionPriceBeforPO').text(sumAll.toFixed(2));
            }

            $('#Po_retention_List').DataTable({
                "createdRow": function (row, data, index) {
                    $('.datepicker', row).datepicker({
                        autoclose: true,
                        format: 'dd/mm/yyyy'
                    });
                },
                "processing": true,
                "language": {
                    "search": "ค้นหา : ",
                    "lengthMenu": "แสดง _MENU_ รายการ",
                    "emptyTable": "ไม่พบข้อมูล",
                    "info": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                    "paginate": {
                        "first": "หน้าแรก",
                        "last": "หน้าสุดท้าย",
                        "next": "ถัดไป",
                        "previous": "ก่อนหน้า"
                    }
                }
            });
        }

        function openModalConfirmUserRetention() {
            return new Promise(function (resolve, reject) {
                $('#modalConfirmUseRetention').modal('show');
                $('#modalConfirmUseRetention .btn-success').click(function () {
                    resolve(true);
                });
                $('#modalConfirmUseRetention .btn-danger').click(function () {
                    resolve(false);
                });
            });
            $('#modalConfirmUseRetention').removeAttr('onclick');
        }

        $('#viewRetentionHistory').click(async function () {
            await getRetentionHistory(worksheetId);
            $('#modalRetentionHistory').modal('show');
        });

        $('#viewRetentionHistoryVendor').click(async function () {
            await getRetentionHistory(worksheetId,2);
            $('#modalRetentionHistory').modal('show');
        });

        $('#tabs-retention').click(async function () {
            showVendorRetentionTab();
        });

        $('#btnClearSearchVendorList').click(function () {
            $('#vendorCode').val('');
            $('#vendorName').val('');
            $('#poNumber-retention').val('');
            $('#searchCompany').val('').trigger('change');
            $('#searchSystemType').val('').trigger('change');
            var table3 = $('#vendor-list').DataTable();
            table3.clear();
            var table4 = $('#Po_retention_List').DataTable();
            table4.clear();
            table3.rows().remove().draw(false);
            table4.rows().remove().draw(false);
            $('#lblNetRetentionPrice').text("0.00")
        });

        function CreateRetentionWorkFlow() {
            let data = {
                worksheet_id: worksheetId,
                systemType: 2,
                UserLogon :  '@UserDetail.CodeName'
            }

            return new Promise(async function (resolve, reject){
                await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/CreateRetentionWorkFlow`, data, response => {
                    console.log(response);
                    if (response) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                });
            })
        }

        function dateFormat(date) {
            if (!date) { return '' }
            var temp = date.trim().split('/');
            return `${temp[2]}${temp[1]}${temp[0]}`
        }

        async function SearchVendorRetention() {
            if ($("#vendorCode").val() == "" && ($("#vendorName").val().trim() =="บริษัท")) {
                modalWaring("กรุณาระบุชื่อผู้รับเหมาที่ถูกต้อง");
                return false;
            }
            if ($("#vendorCode").val() == "" && ($("#vendorName").val()== "")) {
                modalWaring("กรุณาระบุรหัสผู้รับเหมา หรือ ชื่อผู้รับเหมา");
                return false;
            }

            var values = {
                Name: $("#vendorName").val(),
                TaxID: null,
                Vendor: $("#vendorCode").val() == "" ? "" : $("#vendorCode").val()
            }
            pleaseWaitDialog();
            $.ajax({
                url: '@Url.Action("getListVendormaster", "Master")',
                type: 'POST',
                data: values,
                traditional: true,
                success: function (data) {
                    console.log(data);
                    if (data.length > 0) {
                        $.each(data, function (key, value) {
                            $('#vendorCode').val(Number(value.Vendor).toString());
                            $("#vendorName").val(value.Name);
                        });
                    }
                    pleaseWaitDialogClose();
                },
                error: function (data) {
                    pleaseWaitDialogClose();
                },

            });

        }

        // Search vendor by press enter
        $('#vendorCode').keyup(function (e) {
            if (e.keyCode == 13) {
                SearchVendorRetention();
            }
        });

        $('#vendorName').keyup(function (e) {
            if (e.keyCode == 13) {
                SearchVendorRetention();
            }
        });

        async function bindingPaymentType(approveType) {
            await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/Get_PaymentType_ONE_TIM?paymentType=${approveType}&systemID=2`, response => {
                if (response.data.length > 0) {

                    var PaymentType = $("[id*=PaymentType]");
                    PaymentType.empty();

                    $.each(response.data, function (Index, Value) {
                        PaymentType.append($("<option></option>").val(Value.id).html(Value.description));
                    });

                    $(".boxPaymentType").removeClass('hidden');
                }
            });
            localStorage.setItem("name", "SAVEAPR");
        }

        async function SaveAPPR() {
            let data = {
                "tD_WorkSheet_ID": worksheetId,
                "role": "@UserDetail.Role",
                "paymentType": $("[name*=AprrovedType]:checked").val(),
                "paymentType_ID": $("[id *= PaymentType]").val(),
                "userId": "@UserDetail.CodeName"
            }

            await ajaxPost(`${baseUrl}/homecare/api/v1/PurchaseOrder/InsertPaymentTypeWorksheetOnetimeYearly`, data, response => {
                console.log(response);
                if (response) {

                }
            });
        }

        function  UpdateRetentionStatus() {
            let data = {
                worksheet_id: worksheetId,
                systemType: 2,
                UserLogon :  '@UserDetail.CodeName'
            }
            return new Promise(async function (resolve, reject){
                await ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/UpdateRetentionStatus`, data, response => {
                    console.log(response);
                    if (response) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                });
            })
        }

        $("#PO_No2").change(function () {
            if ($('#PaymentType').val() === "46") {
                var poShowDetail = POListFor2PO.filter(item => item.poNumber == $("#PO_No2").val());
                $('#po_status').text(poShowDetail[0].poStatusDesc);
                $('#priceRetentionVendor').text(poShowDetail[0].retention_price.toFixed(2))
                $('#priceAfterUseRetention').text(poShowDetail[0].balance.toFixed(2))
                $('#po_date').text(poShowDetail[0].poStatusDesc);
                POGentype = poShowDetail.po_gen_type_code;

            }
        });


    </script>
}
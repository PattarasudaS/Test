@using HomeCare_4_0.ClassLib
@using HomeCare_4_0.Common
@{
    ViewBag.Title = "ReceivedRepair";
    Layout = "~/Views/Shared/_MasterLayout.cshtml";
}
@section AddToHead
{
    <style>
        .QuotationTableTh th {
            white-space: pre-wrap;
            vertical-align: middle;
        }

        .mb-0 {
            margin-bottom: 20px;
        }

        .mb-1 {
            margin-bottom: 10px;
        }

        .mb-2 {
            margin-bottom: 5px;
        }

        .pt-5 {
            padding-top: 5px;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .width60 {
            width: 60%;
        }

        .theme-explorer .file-upload-indicator, .theme-explorer .file-drag-handle,
        .theme-explorer .explorer-frame .kv-file-content, .theme-explorer .file-actions,
        .explorer-frame .file-preview-other {
            text-align: center;
        }

        .theme-explorer .file-thumb-progress .progress, .theme-explorer .file-thumb-progress .progress-bar {
            height: 13px;
            font-size: 11px;
            line-height: 13px;
        }

        .theme-explorer .file-upload-indicator, .theme-explorer .file-drag-handle {
            position: absolute;
            display: inline-block;
            top: 0;
            right: 3px;
            width: 16px;
            height: 16px;
            font-size: 16px;
        }

        .theme-explorer .file-thumb-progress .progress, .theme-explorer .explorer-caption {
            display: block;
        }

        .theme-explorer .explorer-frame td {
            vertical-align: middle;
            text-align: left;
        }

        .theme-explorer .explorer-frame .kv-file-content {
            width: 80px;
            height: 80px;
            padding: 5px;
        }

        .theme-explorer .file-actions-cell {
            position: relative;
            width: 120px;
            padding: 0;
        }

        .theme-explorer .file-thumb-progress .progress {
            margin-top: 5px;
        }

        .theme-explorer .explorer-caption {
            color: #777;
        }

        .theme-explorer .kvsortable-ghost {
            opacity: 0.6;
            background: #e1edf7;
            border: 2px solid #a1abff;
        }

        .theme-explorer .file-preview .table {
            margin: 0;
        }

        .theme-explorer .file-error-message ul {
            padding: 5px 0 0 20px;
        }

        .explorer-frame .file-preview-text {
            display: inline-block;
            color: #428bca;
            border: 1px solid #ddd;
            font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
            outline: none;
            padding: 8px;
            resize: none;
        }

        .explorer-frame .file-preview-html {
            display: inline-block;
            border: 1px solid #ddd;
            padding: 8px;
            overflow: auto;
        }

        .explorer-frame .file-other-icon {
            font-size: 2.6em;
        }

        @@media only screen and (max-width: 767px) {
            .theme-explorer .table, .theme-explorer .table tbody, .theme-explorer .table tr, .theme-explorer .table td {
                display: block;
                width: 100% !important;
            }

            .theme-explorer .table {
                border: none;
            }

                .theme-explorer .table tr {
                    margin-top: 5px;
                }

                    .theme-explorer .table tr:first-child {
                        margin-top: 0;
                    }

                .theme-explorer .table td {
                    text-align: center;
                }

                .theme-explorer .table .kv-file-content {
                    border-bottom: none;
                    padding: 4px;
                    margin: 0;
                }

                    .theme-explorer .table .kv-file-content .file-preview-image {
                        max-width: 100%;
                        font-size: 20px;
                    }

            .theme-explorer .file-details-cell {
                border-top: none;
                border-bottom: none;
                padding-top: 0;
                margin: 0;
            }

            .theme-explorer .file-actions-cell {
                border-top: none;
                padding-bottom: 4px;
            }

            .theme-explorer .explorer-frame .explorer-caption {
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
                left: 0;
                right: 0;
                margin: auto;
            }
        }

        .file-preview {
            min-height: 24vh;
            max-height: 62vh;
        }

        .file-preview-image {
            object-fit: cover;
        }

        .file-drop-zone {
            overflow-y: auto;
            min-height: 30vh;
            max-height: 56vh;
        }

        .file-zoom-dialog .explorer-frame .file-other-icon {
            font-size: 22em;
            font-size: 50vmin;
        }

        .fileinput-remove {
            display: none;
        }

        .flag-china {
            height: 21.74px;
            border-radius: 3px;
            position: relative;
            bottom: 1px;
        }

        .quotation-item-detail thead tr th {
            text-align: center;
        }

        #preQuotationItemDetailTBody td {
            text-align: center;
        }

        #quotationItemDetailTBody td {
            text-align: center;
        }

        #discountTable tbody td {
            text-align: center;
        }

        #discountTable thead th {
            text-align: center;
        }

        .input-group-text {
            width: 79%;
            display: inline;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            margin-right: 0;
            float: left;
        }

        .input-group-select {
            width: 20%;
            display: inline;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-left: none;
            float: left;
        }

        .input-group-text-right {
            width: 79%;
            display: inline;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            margin-right: 0;
            float: left;
        }

        .input-group-select-left {
            width: 20%;
            display: inline;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
            float: left;
        }

        .div-quotation-item-detail {
            padding: 0;
            margin: 0 3%;
            overflow: auto;
            max-height: 300px;
            border: 1px solid lightgray;
        }

        #quotationHistoryTable th {
            text-align: center;
        }

        #quotationHistoryTable td {
            text-align: center;
        }
    </style>
}
<div class="main">
    <div class="main-inner">
        <div id="receivedRepaireInform">
            <h2 class="page-header">
                <span class="text text-blue text-bold"><i class="fa fa-wrench"></i> รับเรื่องแจ้งซ่อม (One Time) <label id="flagUrgent" style="display: none; color: crimson">(งานเร่งด่วน)!</label></span>
            </h2>
            @*ข้อมูลลูกค้า*@
            <div class="box box-default" id="Received-customer">
                <div class="box-header with-border">
                    <a data-toggle="collapse" data-target="#Received-customer-detail">
                        <i class="fa fa-user"></i>
                        <h3 class="box-title">
                            ข้อมูลลูกค้า
                        </h3>
                    </a>
                    <h3 class="box-title" id="customerInfo"></h3>
                </div>

                <div class="box-body collapse" id="Received-Customer-Detail">
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <label class="control-label">ชื่อ-สกุล</label>
                            <div id="CustomerName" class="controls text-primary"></div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <label class="control-label">ข้อมูลติดต่อ</label>
                            <div id="CustomerMobile" class="controls text-primary"></div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4" id="DivOptionalEmail">
                            <label class="control-label">อีเมลติดต่อ (เพิ่มเติม)</label>&nbsp;
                            <div class="fa fa-edit cursor-pointer" id="editEmailButton" style="color:red; font-size:120%; position:relative; top:2px;" onclick="changeEmailPanel()"></div>
                            <div class="fa fa-close cursor-pointer" id="editEmailCancelButton" style="color:red; font-size:100%; position:relative; top:2px; display:none;" onclick="changeEmailPanel()"> ยกเลิก</div>
                            <div class="form-inline">
                                <input class="form-control" type="email" id="editEmailInput" placeholder="กรุณากรอก Email ใหม่" style="display:none; max-width:220px;" />
                                <button class="btn btn-success" id="editEmailSave" onclick="saveReceiveEmail()" style="display:none;">บันทึก</button>
                            </div>
                            <div id="CustomerEmail" class="controls text-primary"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <label class="control-label">โครงการ</label>
                            <div id="CustomerProject" class="controls text-primary">
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <label class="control-label">แปลง</label>
                            <div id="CustomerUnitCode" class="controls text-primary">
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <label class="control-label">แบบบ้าน</label>
                            <div id="CustomerUnitModel" class="controls text-primary">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <label class="control-label">วันที่เริ่มประกัน</label>
                            <div id="CustomerStartGuaranteeDate" class="controls text-primary">
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <label class="control-label">วันที่หมดประกัน</label>
                            <div id="CustomerEndGuaranteeDate" class="controls text-primary">
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <label class="control-label">วันที่ขยายประกัน</label>
                            <div id="CustomerExtraGuaranteeDate" class="controls text-primary">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            @*ข้อมูลใบเสนอราคา งานบริการและสำรวจ*@
            @*<div class="box box-default" id="Received-Survey">
                    <div class="box-header with-border cursor-pointer collapsed" data-toggle="collapse" data-target="#Received-Survey-detail" aria-expanded="false" aria-controls="Received-Survey-detail">
                        <a>
                            <h3 class="box-title "><i class="fa fa-user"></i> ข้อมูลใบเสนอราคา งานบริการและสำรวจ</h3>
                        </a>
                    </div>
                    <div class="box-body collapse" id="Received-Survey-detail">
                        <div class="row" style="padding-left: 30px;">
                            <div class="form-group">
                                <label class="form-label" style="float: left;padding-top: 5px">ประเภทการคิดค่าบริการ : </label>
                                <div class="col-xs-6 col-sm-4 col-lg-3">
                                    <select class="form-control" id="ddlReceivedSurvey" disabled>
                                        <option value="0">--กรุณาเลือก--</option>
                                        <option value="1" selected>ยกเว้นค่าบริการ</option>
                                    </select>
                                </div>
                                <div class="col-xs-6 col-sm-4 col-lg-3" style="padding-top: 7px; display: none">
                                    <label class="control-label">เปิดใบเสนอราคา : </label>
                                    <i class="fa fa-folder-open fa-lg viewFile text-primary cursor-pointer" style="font-size: 1.5em; width: auto; margin-right: 3px;" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>
                        <div id="DivQuotationSurvey" style="padding-left: 15px; margin-top: 15px; margin-bottom: 10px; display: none;">
                            <div class="row">
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label"> รหัสใบเสนอราคา </label>
                                    <div id="quotationSurveyCode" class="controls text-primary"></div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label"> อัตราค่าบริการ </label>
                                    <div class="row">
                                        <div class="col-xs-6" style="margin-right: 0px; float: left">
                                            <input type="number" id="quotationSurveyCost" class="form-control" />
                                        </div>
                                        <div class="col-xs-6" style="padding-left: 0px; padding-top: 5px">
                                            <label> บาท</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label"> ออกรายงาน </label>
                                    <div class="controls text-danger">
                                        <span class="cursor-pointer" onclick=""><label class="control-label text-primary cursor-pointer">ใบเสนอราคา: </label> <i class="fa fa-print fa-lg cursor-pointer" style="color:brown"></i></span>
                                    </div>
                                </div>
                            </div>
                            <div class="row" style="margin-top: 15px">
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label"> ผู้เปิดใบเสนอราคา </label>
                                    <div id="quotationSurveyCreateBy" class="controls text-primary">testhc</div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label"> วันที่เปิดใบเสนอราคา </label>
                                    <div id="quotationSurveyCreateDate" class="controls text-primary">9/11/2018 13:32:33</div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4">
                                    <label class="control-label"> สถานะการชำระ </label>
                                    <div id="quotationSurveyPaymentStatus" class="controls text-primary">รอการชำระ</div>
                                </div>
                            </div>
                            <div class="row" style="margin-top: 15px">
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label"> ยืนยันการชำระ </label>
                                    <div id="quotationSurveyCreateBy" class="controls text-primary">งง</div>
                                </div>
                                <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                    <label class="control-label"> หมายเหตุ </label>
                                    <select class="form-control">
                                        <option value="0">กรุณาเลือก</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>*@
            @*ข้อมูลรับเรื่อง*@
            <div class="box box-default" id="Received-Receive">
                <div class="box-header with-border cursor-pointer collapsed" data-toggle="collapse" data-target="#Received-Receive-detail" aria-expanded="false" aria-controls="Received-Receive-detail">
                    <a>
                        <h3 class="box-title " id="HeaderReceive"><i class="fa fa-phone" style="position: relative; top: 2px;"></i> ข้อมูลรับเรื่อง</h3>
                    </a>
                </div>
                <div class="box-body collapse" id="Received-Receive-detail">
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <h5><label class="control-label">สถานะรับเรื่อง</label></h5>
                            <select id="ddlReceivedStatusID" class="form-control" style="width: auto;" onchange="onChangeddlReceivedStatus()"></select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label"> HC รับเรื่องวันที่ </label></h5>
                            <div id="ReceiveHCDate" class="controls text-primary"></div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label"> หมายเหตุ HC </label></h5>
                            <div class="controls width60">
                                <input id="ReceiveHCRemark" class="form-control" type="text" disabled />
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <h5><label class="control-label"> HC ผู้รับเรื่อง </label></h5>
                            <div id="ReceiveHCUser" class="controls text-primary"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label"> Call Centre รับเรื่องวันที่ </label></h5>
                            <div class="controls" id="Receive_CC_Date">
                                <div id="ReceiveCCDate" class="controls text-primary"></div>
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label"> หมายเหตุ Call Centre </label></h5>
                            <div class="controls width60">
                                <input id="ReceiveCCRemark" class="form-control" type="text" disabled />
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4">
                            <h5><label class="control-label"> Call Centre ผู้รับเรื่อง </label></h5>
                            <div class="controls">
                                <div id="ReceiveCCUser" class="controls text-primary"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label"> วันที่นัดหมายตรวจสอบ </label></h5>
                            <div class="bootstrap-datepicker">
                                <div class="input-group" id="ReceiveAppointmentGroup">
                                    <div class="input-group-addon">
                                        <i class="fa fa-calendar"></i>
                                    </div>
                                    <input type="text" class="form-control datepicker" id="ReceiveAppointmentDate"
                                           name="ReceiveAppointmentDate" style="width:60%;" onchange="bindRealAppointmentDateWithType(); onchangeAppointmentDate()" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label"> เวลา </label></h5>
                            <div class="bootstrap-timepicker">
                                <div class="input-group width60">
                                    <input class="form-control timepicker width60" id="ReceiveAppointmentTimeForm" name="ReceiveAppointmentTimeForm" style="width:100%;" type="text" disabled>
                                    <div class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label"> ถึง </label></h5>
                            <div class="bootstrap-timepicker">
                                <div class="input-group width60">
                                    <input class="form-control timepicker" id="ReceiveAppointmentTimeTo" name="ReceiveAppointmentTimeTo" style="width:100%;" type="text" disabled>
                                    <div class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label ">สาเหตุวันนัดเกินกำหนด </label></h5>
                            <select id="ddlReceiveOverAppointmentDateReason" class="form-control" disabled></select>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4 " id="DivRealRepairDate">
                            <h5><label class="control-label ">วันเข้าตรวจสอบจริง * </label></h5>
                            <div class="input-group">
                                <span class="input-group-addon" style="background-color:whitesmoke">
                                    <input type="checkbox" id="chkAPDateReal" onclick="bindRealAppointmentDate()">
                                </span>
                                <input type="text" class="form-control" id="ReceiveAppointmentDateReal" value="" readonly style="width:100px;background-color:whitesmoke" disabled>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            @*ข้อมูลใบเสนอราคา งานสั่งซื้อสินค้า*@
            <div class="box box-default" id="Received-Inform">
                <div class="box-header with-border cursor-pointer" data-toggle="collapse" data-target="#Received-Quotation-detail" aria-expanded="true" aria-controls="Received-Quotation-detail">
                    <a>
                        <h3 class="box-title "><i class="fa fa-pencil"></i> ข้อมูลใบเสนอราคา งานสั่งซื้อสินค้า</h3>
                    </a>
                </div>
                <div class="box-body collapse in" id="Received-Quotation-detail">
                    @*แนบรูป*@
                    <div class="row" style="margin: 10px auto 20px auto" id="DivImageAttachment">
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <div class="controls">
                                <label class="control-label">แนบรูปถ่าย :</label>
                                <button class="fa fa-picture-o fa-lg" id="btnUploadFile" style="font-size: 1.5em; padding: 4px 6px;" onclick="openModalUploadImageBefore()"></button>
                                <label class="control-label" id="FlagImageBeforeText" style="color: red">ยังไม่ได้อัพโหลด </label>
                            </div>
                        </div>
                    </div>
                    @*ImageBeforeFlagTrue*@
                    <div id="DivOfferPrice" style="padding-left: 10px;display: none;">
                        @*Edit by Adisorn*@
                        @*<div class="form-group row">
                            <div>
                            <label class="col-xs-6 col-sm-2 col-lg-2 col-form-label" style="text-align: right; padding-top: 5px">ประเภทการสั่งซื้อ : </label>
                            <div class="col-xs-6 col-sm-3 col-lg-3">
                            <select class="form-control" id="DdlGoodsType"></select>
                            </div>
                            </div>
                            <div>
                            <label for="" class="col-xs-6 col-sm-2 col-lg-2 col-form-label" style="text-align: right; padding-top: 5px">เงื่อนไขการสั่งซื้อ : </label>
                            <div class="col-xs-6 col-sm-3 col-lg-3">
                            <select class="form-control" id="DdlGoodsOrderCondition"></select>
                            </div>
                            </div>
                            </div>

                            <div class="form-group row">
                            <div>
                            <label class="col-xs-6 col-sm-2 col-lg-2 col-form-label" style="text-align: right; padding-top: 5px">สถานะการสั่งซื้อ : </label>
                            <div class="col-xs-6 col-sm-3 col-lg-3">
                            <select class="form-control" id="DdlGoodsOrderStatus"></select>
                            </div>
                            </div>
                            <div>
                            <label for="" class="col-xs-6 col-sm-2 col-lg-2 col-form-label" style="text-align: right; padding-top: 5px">หมายเหตุ : </label>
                            <div class="col-xs-6 col-sm-3 col-lg-3">
                            <input type="text" class="form-control" name="txtGoodsRemark" id="txtGoodsRemark" value="" />
                            </div>
                            </div>
                            </div>*@
                        @*Edit by Adisorn*@
                        <div class="row mb-1">
                            <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                <label class="control-label">เปิด/แก้ไข ใบเสนอราคา</label>
                                <div class="controls" id="btnPriceRepair">
                                    <i class="fa fa-folder-open fa-lg viewFile text-primary cursor-pointer " id="btndetailPriceRepair" style="font-size: 1.5em; width: auto; margin-right: 3px;" aria-hidden="true" onclick="openModalConfirmWOR('หน้าต่างยืนยันการเปิดใบเสนอราคา', 'ต้องการเปิดใบเสนอราคาใหม่ใช่หรือไม่', 'createQuotation')"></i>
                                    <i class="fa fa-wrench fa-lg viewFile text-primary cursor-pointer" id="btndetailPriceRepairEdit" style="font-size: 1.5em; width: auto; display: none" aria-hidden="true" onclick="openModaldetailPriceRepair()"></i>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                <label class="control-label">ประวัติใบเสนอราคา</label>
                                <div class="controls">
                                    <i id="btnQuotationHistory" class="fa fa-book viewFile text-primary cursor-pointer " style="font-size: 1.5em; width: auto; padding-top: 5px" aria-hidden="true" onclick="openModalQuotationHistory()"></i>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                <label class="control-label">ออกรายงาน</label>
                                <div id="DivGenQuotationPDF" style="display: none">
                                    <div class="controls text-danger">
                                        <span class="cursor-pointer" onclick="genQuotation('customer')"><label class="control-label text-primary cursor-pointer">ใบเสนอราคา (ลูกค้า):</label> <i class="fa fa-print fa-lg cursor-pointer" style="color:brown"></i></span>
                                    </div>
                                    <div class="controls text-danger">
                                        <span class="cursor-pointer" onclick="genQuotation('vendor')"><label class="control-label text-primary cursor-pointer">ใบเสนอราคา (ผรม):</label> <i class="fa fa-print fa-lg cursor-pointer" style="color:brown"></i></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-1">
                            <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                <label class="control-label">รหัสใบเสนอราคา</label>
                                <div class="row">
                                    <div class="col-xs-8" style="padding-right: 0">
                                        <select class="form-control" id="ddlQuotationGoodsName" onchange="onChangeQuotationGoodsName()"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                <label class="control-label">ผู้เปิดใบเสนอราคา</label>
                                <div class="controls">
                                    <label class="control-label text-primary" id="txtQuotationCreatedBy"></label>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                <label class="control-label">วันที่เปิดใบเสนอราคา</label>
                                <div class="controls text-danger">
                                    <label class="control-label text-primary" id="txtQuotationCreatedDate"></label>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-1">
                            <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                <label class="control-label">สถานะการสั่งซื้อ</label>
                                <div class="controls">
                                    <label class="control-label text-primary" id="txtQuotationOrderStatus"></label>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                <label class="control-label">สถานะการชำระ</label>
                                <div class="controls">
                                    <label class="control-label text-danger" id="txtQuotationPaymentStatus" style="color: red"></label>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                <label class="control-label">สถานะการอนุมัติ</label>
                                <div class="controls">
                                    <label class="control-label text-primary" id="txtQuotationApproveStatus"></label>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-0">
                            <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                <label class="control-label">หมายเหตุ</label>
                                <div class="controls">
                                    <label class="control-label text-primary" id="txtQuotationRemark"></label>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4 ">
                                @* TODO สามารถยกเลิกได้แม้อนุมัติไปแล้ว*@
                                <label class="control-label">ลูกค้าขอเปลี่ยนแปลง / ยกเลิก</label>
                                <div class="controls">
                                    <div class="input-group">
                                        <span class="input-group-addon" style="background-color: whitesmoke">
                                            <input type="checkbox" name="flagChangeRequest" id="flagChangeRequest" onchange="onchangeflagChangeRequest()">
                                        </span>
                                        <select class="form-control" id="DdlCustomerCancelQuotationReason" style="width: 67%;" disabled></select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4 " id="DivQuotationApprove">
                                <div class="col-xs-12 col-sm-12 col-lg-9" style="padding-left: 0px">
                                    <label class="control-label">การอนุมัติ</label>
                                    <div id="DivApprove">
                                        <button class="btn btn-success" onclick="openModalConfirmWithReason('หน้าต่างยืนยันการอนุมัติ', 'เหตุผลประกอบการอนุมัติ', 'saveApproveQuotation', false)">&nbsp;&nbsp;อนุมัติ&nbsp;&nbsp;</button>
                                        <button class="btn btn-danger" onclick="openModalConfirmWithReason('หน้าต่างยืนยันการไม่อนุมัติ', 'กรุณากรอกเหตุผลการไม่อนุมัติ', 'saveRejectQuotation', true)">ไม่อนุมัติ</button>
                                    </div>
                                    <div id="DivApplyApprove" style="display : none;">
                                        <button class="btn btn-success" onclick="openModalConfirmWithReason('หน้าต่างยืนยันการขออนุมัติ', 'เหตุผลประกอบการขออนุมัติ', 'applyApproveQuotation', false)">&nbsp;&nbsp;ส่งอนุมัติ&nbsp;&nbsp;</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <fieldset id="fsCustomer">
                            <label style="font-weight: bold; font-size: 15px; font-style: italic; top: -10px; left: 28px;">สำหรับเรียกเก็บลูกค้า</label>
                            <div class="panel panel-default">
                                <div class="panel-body">
                                    <div class="row" style="margin-top: 10px; margin-bottom: 10px">
                                        <div class="div-quotation-item-detail">
                                            <table class="display table table-striped table-bordered table-hover  quotation-item-detail" id="InformTable" style="margin-bottom: 0px; min-width: 1000px">
                                                <thead>
                                                    <tr>
                                                        <th>No.</th>
                                                        <th>หมวดงาน</th>
                                                        <th>รายละเอียดงาน</th>
                                                        <th>ราคาต่อหน่วย</th>
                                                        <th>ราคาพิเศษต่อหน่วย</th>
                                                        <th>ปริมาณ</th>
                                                        <th>หน่วย</th>
                                                        <th>รวมเป็นเงิน</th>
                                                        <th>หมายเหตุ</th>
                                                    </tr>
                                                </thead>

                                                <tbody id="preQuotationItemDetailTBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="row mb-1" style="margin: 15px auto">
                                        <div class="col-lg-4 col-sm-4 col-xs-4" style="text-align: left; font-size: 15px">
                                            <label>ราคารวมตามรายการ : &nbsp;</label>
                                            <label id="preTotalPrice"></label>
                                            <label>&emsp;บาท</label>
                                        </div>
                                    </div>
                                    <div id="DivCost" style="display: none">
                                        <div class="row" style="margin-top: 10px; margin-bottom: 10px;">
                                            <div style="padding:0; margin:0 3% ;">
                                                <table class="table table-bordered table-hover" id="discountTable">
                                                    <thead>
                                                        <tr>
                                                            <th>No.</th>
                                                            <th>ประเภทส่วนลด</th>
                                                            <th>ส่วนลด</th>
                                                            <th>เป็นจำนวนเงิน</th>
                                                            <th>ลบ</th>
                                                        </tr>
                                                    </thead>

                                                    <tbody id="discountTBody">
                                                        <tr>
                                                            <td><p class="pt-5">1</p></td>
                                                            <td>
                                                                <select class="form-control" id="ddlCostType1" onchange="onChangeCostType(this)" onfocus="beforeCostTypeChange = this.value"></select>
                                                            </td>
                                                            <td>
                                                                <div>
                                                                    <input type="number" class="form-control input-group-text" id="costValue1" placeholder="0.00" min="0" max="100" onkeyup="calCostValueNet()" onclick="calCostValueNet()" readonly>
                                                                    <select class="form-control input-group-select" id="ddlCostUnit1" onchange="calCostValueNet()"></select>
                                                                </div>
                                                            </td>
                                                            <td><label class="pt-5" id="costValueNet1"></label></td>
                                                            <td><i class="fa fa-close pt-5" onclick="removeTableRow(this)"></i></td>
                                                        </tr>
                                                    </tbody>
                                                    <tfoot>
                                                        <tr>
                                                            <th class="text-right" colspan="5">
                                                                <span class="glyphicon glyphicon-plus addBtn" onclick="addTableRow()" id="btnAddRowCost" style="display: none"></span>
                                                            </th>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                            <div class="row mb-1" id="DivPriceAfterDiscount">
                                                <div class="col-lg-5 col-sm-6 col-xs-6" style="text-align: left; font-size: 15px">
                                                    <label style="color: red; margin-left: 20px">ราคาสุทธิหลังหักส่วนลด : &nbsp;</label>
                                                    <label id="totalPriceAfterDiscount"></label>
                                                    <label>&emsp;บาท</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-1">
                                        <div class="col-lg-2 col-sm-2 col-xs-2 col-xs-offset-1">

                                        </div>
                                        <div class="col-lg-3 col-sm-3 col-xs-3">

                                        </div>
                                        <div class="col-lg-3 col-sm-3 col-xs-3">
                                            <label>เป็นจำนวนเงิน</label>
                                        </div>
                                        <div class="col-lg-3 col-sm-3 col-xs-3">
                                            <label>ราคา</label>
                                        </div>
                                    </div>
                                    <div id="DivChargeDetail" class="mb-1"> </div>
                                    <div class="row mb-1" style="margin-top: 30px">
                                        <div class="col-lg-4 col-sm-4 col-xs-4" style="text-align: left; font-size: 15px">
                                            <label style="color: red; margin-left: 20px">รวมราคาสุทธิ : &nbsp;</label>
                                            <label id="totalPriceNet"></label>
                                            <label>&emsp;บาท</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset id="fsVendor">
                            <label style="font-weight: bold; font-size: 15px; font-style: italic; top: -10px; left: 28px;">สำหรับผู้รับเหมา</label>
                            <div class="panel panel-default">
                                <div class="panel-body">
                                    <div class="row mb-1">
                                        <div class="col-lg-4 col-sm-4 col-xs-4" style="text-align: left; font-size: 15px">
                                            <label>ราคารวมตามรายการ : &nbsp;</label>
                                            <label id="preVendorTotalPrice"></label>
                                            <label>&emsp;บาท</label>
                                        </div>
                                    </div>
                                    <div class="row mb-1" style="margin-left: 70px">
                                        <div class="col-xs-4 col-sm-4">
                                            <div>
                                                <h5><label class="control-label">ค่าดำเนินการ (%) </label></h5>
                                                <div class="input-group" style="width:60%">
                                                    <span class="input-group-addon">
                                                        <input type="checkbox" name="flagVendorOpt" id="flagVendorOpt" onclick="calVendorTotalPrice()" checked>
                                                    </span>
                                                    <input type="number" id="vendorOperateValue" class="form-control text-right" min="0" onkeyup="calVendorTotalPrice()">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-xs-4 col-sm-4">
                                            <div>
                                                <h5><label class="control-label">ภาษีมูลค่าเพิ่ม (%) </label></h5>
                                                <div class="input-group" style="width:60%">
                                                    <span class="input-group-addon" style="background-color: whitesmoke">
                                                        <input type="checkbox" name="flagVendorVat" id="flagVendorVat" onclick="calVendorTotalPrice()" checked>
                                                    </span>
                                                    <input type="number" id="vendorVatValue" class="form-control text-right" min="0" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mb-1" style="margin-top: 30px">
                                        <div class="col-lg-4 col-sm-4 col-xs-4" style="text-align: left; font-size: 15px">
                                            <label style="color: red; margin-left: 20px">รวมราคาสุทธิ : &nbsp;</label>
                                            <label id="vendorTotalPriceNet"></label>
                                            <label>&emsp;บาท</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>
            @*ข้อมูลแจ้งซ่อม*@
            <div class="box box-default" id="Received-Inform">
                <div class="box-header with-border cursor-pointer" data-toggle="collapse" data-target="#Received-Inform-detail" aria-expanded="true" aria-controls="Received-Inform-detail">
                    <a>
                        <h3 class="box-title"><i class="fa fa-pencil"></i> ข้อมูลแจ้งซ่อม</h3>
                    </a>
                </div>
                <div class="box-body collapse in" id="Received-Inform-detail">
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label">รหัสงานซ่อม</label></h5>
                            <div class="controls text-primary" id="ReceiveJobNoText"></div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label">ประเภทงานซ่อม</label></h5>
                            <div class="controls text-primary" id="ReceiveRepairType"></div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label">สถานะ</label></h5>
                            <div class="controls text-danger text-bold" id="ReceiveMainProcessName" style="color: red"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label">วันที่รับแจ้ง</label></h5>
                            <div class="controls text-primary" id="ReceiveinformDate"></div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label">ผู้รับแจ้ง</label></h5>
                            <div class="controls text-primary" id="ReceiveInformUser"></div>
                        </div>
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label">หมายเหตุ Call Centre</label></h5>
                            <div class="controls text-danger" id="ReceiveInformRemark" style="color: red"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 col-sm-6 col-lg-4 ">
                            <h5><label class="control-label">สถานะผู้แจ้ง</label></h5>
                            <div class="controls text-primary" id="ReceiveInformCustomerTypeName"></div>
                        </div>
                        <div id="DivOptionalNameTel" style="display:none">
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <h5><label class="control-label">ชื่อผู้แจ้ง</label></h5>
                                <div class="controls text-primary" id="ReceiveInformCustomerName"></div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <h5><label class="control-label">เบอร์ติดต่อ</label></h5>
                                <div class="controls text-primary" id="ReceiveInformCustomerTel"></div>
                            </div>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-lg-12">
                            <table class="table table-striped table-bordered table-hover" id="InformTable" style="width:100%">
                                <thead>
                                    <tr class="">
                                        <th width="1%">
                                            <h5 class="text-center">No.</h5>
                                        </th>
                                        <th width="12%">
                                            <h5 class="text-center">สถานะ</h5>
                                        </th>
                                        <th width="24%">
                                            <h5 class="text-center">หมวดงาน</h5>
                                        </th>
                                        <th width="10%">
                                            <h5 class="text-center">รายละเอียดการแจ้ง</h5>
                                        </th>
                                        <th width="10%">
                                            <h5 class="text-center">หมายเหตุ HC (แสดงบน HomeApp)</h5>
                                        </th>
                                        <th width="12%">
                                            <h5 class="text-center">ประเภทการซ่อม</h5>
                                        </th>
                                        <th width="5%">
                                            <h5 class="text-center">สร้างรายการซ่อม</h5>
                                        </th>
                                        <th width="5%">
                                            <h5 class="text-center">ไฟล์ภาพ</h5>
                                        </th>
                                        <th width="21%">
                                            <h5 class="text-center">สาเหตุกรณีไม่ดำเนินการ หรือ Pending</h5>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="ReceiveItemTBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="pull-right">
                        @if (@UserDetail.Role != @EnumConfiguration.Role.PMR.ToString())
                        {
                            <button class="btn btn-sm btn-primary" id="btnAddReceivedItem" onclick="addTableReceiveItemRow(); toggleReceiveItemBtn()">
                                <i class="ace-icon fa fa-plus bigger-125"></i> เพิ่มรายการ
                            </button>
                            <button class="btn btn-sm btn-success" id="btnSaveReceivedItem" onclick="insertReceiveItem()" disabled>
                                <i class="ace-icon fa fa-floppy-o bigger-125"></i> บันทึก
                            </button>
                            <button class="btn btn-sm btn-danger" id="btnRemoveReceivedItem" onclick="removeReceiveItem(); toggleReceiveItemBtn()" disabled>
                                <i class="ace-icon fa fa-times bigger-125"></i> ยกเลิก
                            </button>
                        }
                    </div>
                </div>
            </div>
            @*ปุ่มบันทึกข้อมูลและปุ่มเปิดใบงาน*@
            @if (@EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
            {
                <div class="row" id="actionPanel">
                    <div class="col-xs-12 col-sm-12">
                        <button type="button" class="btn btn-success" id="btninsertReceived" onclick="saveReceiveRepair()">บันทึกข้อมูล</button>
                        <button type="button" id="btnPreviewWO" class="btn btn-success" onclick="previewWorkSheet()">&nbsp;เปิดใบงาน&nbsp;</button>
                        <button type="button" id="btnCloseReceived" class="btn btn-danger" onclick="openModalConfirmWithReason('หน้าต่างยืนยันการปิดใบรับเรื่อง', 'กรุณากรอกเหตุผลการปิดใบรับเรื่อง', 'closeReceiveRepair', true)">ปิดใบรับเรื่อง</button>
                    </div>
                </div>
            }
        </div>
    </div>
    @*Modal สร้างรายการซ่อม*@
    <div tabindex="-1" class="modal fade" id="modalReceivedItemsDetail" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog" style="width:95%">
            <div class="modal-content" style="border-radius:6px;">
                <div class="modal-header bg-light-blue">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">ข้อมูลแจ้งซ่อม</h4>
                </div>
                <div class="modal-body text-left">
                    <div class="box-header with-border cursor-pointer" style="background-color: forestgreen; margin-top:5px; border-radius: 7px 7px 0px 0px;" data-toggle="collapse" data-target="#boxReceivedRepair" aria-expanded="true" aria-controls="boxReceivedRepair" onclick="collapseToggleIcon('boxReceivedRepair')">
                        <h3 class="box-title" style="color: white">ข้อมูลแจ้งซ่อม</h3>
                        <span class="pull-right" id="boxReceivedRepairMinus" style="margin-right:10px; color: whitesmoke; display:none; ">
                            <i class="fa fa-plus"></i>
                        </span>
                        <span class="pull-right" id="boxReceivedRepairPlus" style="margin-right:10px; color: whitesmoke;">
                            <i class="fa fa-minus"></i>
                        </span>
                    </div>
                    <div class="box-body collapse in" id="boxReceivedRepair">
                        <div class="row text text-purple">
                            <div class="col-xs-12 col-sm-6 col-lg-4">
                                <h5> โครงการ: <span class="text text-primary" id="txtReceiveItemProject"></span></h5>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-2">
                                <h5> แปลง: <span class="text text-primary" id="txtReceiveItemUnit"></span></h5>
                            </div>
                            <div id="MainDataInModal"></div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <table class="table table-striped table-bordered table-hover" id="ReceiveTable" style="margin: 2px 0px; max-width: 100%">
                                    <thead>
                                        <tr>
                                            <th class="text-center" width="15%">
                                                ลักษณะงานหลัก
                                            </th>
                                            <th class="text-center" width="15%">
                                                ลักษณะงานรอง
                                            </th>
                                            <th class="text-center" width="20%">
                                                ลักษณะการประเมิน
                                            </th>
                                            <th class="text-center" width="15%">
                                                ตำแหน่งที่เกิด
                                            </th>
                                            <th class="text-center" width="15%">
                                                สาเหตุการเกิดปัญหา
                                            </th>
                                            <th class="text-center" width="5%">
                                                การซ่อมซ้ำ
                                            </th>
                                            <th class="text-center" width="15%">
                                                Priority
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr onchange="checkDupFix()">
                                            <td class="text-center">
                                                <select class="form-control" id="ddlReceiveItemMainWorkType" onchange="onChangeMainWorkType(this.value)"></select>
                                            </td>
                                            <td class="text-center">
                                                <select class="form-control" id="ddlReceiveItemSubWorkType" onchange="onChangeSubWorkType(this.value)"></select>
                                            </td>
                                            <td class="text-center">
                                                <select class="form-control" id="ddlReceiveItemWorkDetail" onchange="onChangeWorkDetail(this.value)"></select>
                                            </td>
                                            <td class="text-center">
                                                <select class="form-control" id="ddlReceiveItemLocation"></select>
                                            </td>
                                            <td class="text-center">
                                                <select class="form-control" id="ddlReceiveItemWorkIssue"></select>
                                            </td>
                                            <td class="text-center">
                                                <i class="fa fa-lg fa-check" id="flagReceiveItemDuplicateFix" style="display: none"></i>
                                            </td>
                                            <td class="text-center">
                                                <input class="form-control" id="txtReceiveItemPriority" readonly type="text">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        @*@if (ReceivedController.checkPermission("EditReceiveItemModal"))
        {*@
                        <div class="col-lg-12" style="margin-top: 15px">
                            <div style="float: right;">

                                <textarea class="form-control hidden" id="Remark" style="float:left;width:300px" rows="2" placeholder="กรุณาระบุเหตุผลในการแก้ไข"></textarea>

                            </div>
                        </div>
                        <div class="col-lg-12" style="margin-top: 15px">
                            <div style="float: right;">
                                <button class="btn btn-primary" onclick="editConfigReceiveItemModal(this)" style="margin-right: 15px; width: 80px; display: none;">บันทึก</button>
                                <button class="btn btn-default hidden" id="editData" onclick="setVisibleForEditReceiveItemModal(this)">แก้ไขข้อมูล</button>
                                <label id="lbStatusEditData" hidden>รออนุมัติแก้ไขข้อมูล</label>
                                <label id="lbEmpEditData" hidden></label>
                            </div>
                        </div>
                        @*}*@
                    </div>

                    <div class="box-header with-border cursor-pointer" style="background-color: forestgreen; margin-top:10px; border-radius: 7px 7px 0px 0px;" data-toggle="collapse" data-target="#boxReceiveToWorksheet" aria-expanded="true" aria-controls="boxReceiveToWorksheet" onclick="collapseToggleIcon('boxReceiveToWorksheet')">
                        <h3 class="box-title" style="color: white">เพิ่มรายการแจ้งซ่อมย่อย เพื่อนำไปสร้างใบงาน</h3>
                        <span class="pull-right" id="boxReceiveToWorksheetMinus" style="margin-right:10px; color: whitesmoke; display:none;">
                            <i class="fa fa-plus"></i>
                        </span>
                        <span class="pull-right" id="boxReceiveToWorksheetPlus" style="margin-right:10px; color: whitesmoke;">
                            <i class="fa fa-minus"></i>
                        </span>
                    </div>
                    <div class="box-body collapse in" id="boxReceiveToWorksheet">
                        <div style="overflow: auto; padding: 0; border: 1px solid lightgrey;" class="col-lg-12">
                            <table class="table table-striped table-hover" id="AddReceiveTable" style="margin: 0; min-width: 1600px;">
                                <thead>
                                    <tr class="">
                                        <th class="text-center">
                                            No.
                                        </th>
                                        <th class="text-center">
                                            สถานะ
                                        </th>
                                        <th class="text-center">
                                            ผู้รับเหมา
                                        </th>
                                        <th class="text-center">
                                            ประเภทงานซ่อม
                                        </th>
                                        <th class="text-center">
                                            วันที่นัดหมายซ่อม
                                        </th>
                                        <th class="text-center">
                                            ถึง
                                        </th>
                                        <th class="text-center">
                                            สาเหตุวันนัดเกินกำหนด
                                        </th>
                                        <th class="text-center">
                                            สร้างใบงาน
                                        </th>
                                        <th class="text-center">
                                            หมายเหตุ
                                        </th>
                                        <th class="text-center">
                                            <span class="glyphicon glyphicon-plus addBtn cursor-pointer" id="addBtn" onclick="addTableReceiveItemDetailRow()"></span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="tbodySubReceiveItem"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background-color: whitesmoke;">
                    <button type="button" class="btn pull-left" data-dismiss="modal">&emsp;ปิด&emsp;</button>
                    @if (@EnumConfiguration.Role.PMR.ToString() != @UserDetail.Role)
                    {
                        <button type="button" class="btn btn-success" id="btnSaveModal" onclick="saveModalReceivedItemsDetail()">&nbsp;บันทึก&nbsp;</button>
                    }
                </div>
            </div>
        </div>
    </div>
    @*Modal แสดงใบงานก่อนที่จะสร้าง*@
    <div tabindex="-1" class="modal fade" id="modalPreviewWorkOrder" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog" style="width:60%">
            <div class="modal-content" style="border-radius:6px;">
                <div class="modal-header bg-gray">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">รอเปิดใบงาน</h4>
                </div>
                <div class="modal-body text-center">
                    <div class="row">
                        <div class="col-lg-12 text-left">
                            <label class="text-primary">จำนวนใบงานที่รอเปิด:&nbsp;</label><span><label class="text-danger" id="lblOpenWO"></label></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <table class="table table-striped table-bordered table-hover " id="tbPreviewWorkOrder" style="margin: 8px 8px 0px 8px; width:100%">
                                <thead>
                                    <tr class="">
                                        <th class="text-center " width="30%">
                                            ชื่อผู้รับเหมา
                                        </th>
                                        <th class="text-center " width="30%">
                                            หมวดรับประกัน
                                        </th>
                                        @*<th class="text-center " width="30%">
                                            หมวดงานที่ ผรม. ต้องซ่อม
                                            </th>*@
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="text-center Bold text-danger" colspan="3">ไม่มีข้อมูล</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <div class="col-lg-12 text-center">
                            <button type="button" class="btn btn-default" id="btnOpenWorkOrder" onclick="createWorkSheet()">เปิดใบงาน</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @*Modal ดูไฟล์ภาพจาก Home App*@
    <div tabindex="-1" class="modal fade" id="modalViewFile" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;" data-backdrop="static">
        <div class="modal-dialog" style="width:90%">
            <div class="modal-content" style="border-radius:6px;">
                <div class="modal-header badge-info">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title white"> <i class="fa fa-file-o bigger-130"></i> View Attach File</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-xs-12">
                            <label class="header smaller lighter blue" id="lblattrachgroupName"></label>
                            <div><br /></div>
                            <div class="text-center">
                                <select class="image-picker show-labels" id="logo"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer text-center ">
                    <a class="btn btn-primary" id="btndownload"><i class="fa fa-cloud-download bigger-110"></i>Download</a>
                    <button class="btn btn-danger" data-dismiss="modal" type="button" id="btnmodalviewClose"><i class="fa fa-times bigger-110"></i>Close</button>
                </div>
            </div>
        </div>
    </div>
    @*Modal Extended Appointment*@
    <div tabindex="-1" class="modal fade" id="modalExtendedAppointment" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
        <div class="modal-dialog" style="width:40%">
            <div class="modal-content" style="border-radius:6px;">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">เลื่อนวันที่นัดหมายตรวจสอบ</h4>
                </div>
                <div class="modal-body text-center">
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="row">
                                <div class="col-xs-5  text-right">
                                    <h5><label class="control-label">วันที่นัดหมายตรวจสอบ(ใหม่): </label></h5>
                                </div>
                                <div class="col-xs-6">
                                    <div class="bootstrap-datepicker">
                                        <div class="input-group">
                                            <div class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </div>
                                            <input type="text" class="form-control datepicker" data-val="true" data-val-date="The field Extended Appointment must be a date." id="ExtendedReceiveAppointmentDate"
                                                   name="ExtendedReceiveAppointmentDate" style="width:100%;" onkeypress="return false">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12">
                            <div class="row">
                                <div class="col-xs-5  text-right">
                                    <h5><label class="control-label text-left">เวลา: </label></h5>
                                </div>
                                <div class="col-xs-6">
                                    <div class="bootstrap-timepicker">
                                        <div class="input-group">
                                            <input class="form-control timepicker" id="ExtendedReceiveAppointmentTimeForm" name="ExtendedReceiveAppointmentTimeForm" style="width:100%;" type="text">
                                            <div class="input-group-addon">
                                                <i class="fa fa-clock-o"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12">
                            <div class="row">
                                <div class="col-xs-5 text-right">
                                    <h5><label class="control-label">ถึง: </label></h5>
                                </div>
                                <div class="col-xs-6">
                                    <div class="bootstrap-timepicker">
                                        <div class="input-group">
                                            <input class="form-control timepicker" id="ExtendedReceiveAppointmentTimeTo" name="ExtendedReceiveAppointmentTimeTo" style="width:100%;" type="text">
                                            <div class="input-group-addon">
                                                <i class="fa fa-clock-o"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12">
                            <div class="row">
                                <div class="col-xs-5 text-right">
                                    <h5><label class="control-label"> สาเหตุเลื่อนนัดหมายฯ: </label></h5>
                                </div>
                                <div class="col-xs-6">
                                    <select id="ddlExtendedResonID" class="form-control">
                                        <option value="0" selected disabled>-- กรุณาเลือก --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 mb-2">
                            <div class="row">
                                <div class="col-xs-5 text-right">
                                    <label class="control-label"> หมายเหตุ HC: </label>
                                </div>
                                <div class="col-xs-6">
                                    <div class="input-group">
                                        <textarea class="form-control" cols="30" rows="2" data-val="true" id="txtExtendRemark" name="txtExtendRemark" style="width:100%;" type="text" maxlength="512"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @if (@UserDetail.Role == @EnumConfiguration.Role.CallCentre.ToString())
                        {
                            <div class="col-xs-12 mb-2">
                                <div class="row">
                                    <div class="col-xs-5 text-right">
                                        <label class="control-label"> หมายเหตุ CC: </label>
                                    </div>
                                    <div class="col-xs-6">
                                        <div class="bootstrap-timepicker">
                                            <div class="input-group">
                                                <textarea class="form-control" cols="30" rows="2" data-val="true" id="txtExtendRemarkCC" name="txtExtendRemarkCC" style="width:100%;" type="text" maxlength="512"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12">
                                <div class="row">
                                    <div class="col-xs-5 text-right">
                                        <label class="control-label"> สถานะ: </label>
                                    </div>
                                    <div class="col-xs-6 text-left">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" id="confirmFlagTrue" name="rdoConfirm" value="true">
                                            <label class="form-check-label" for="confirmFlagTrue">อนุมัติ</label>&nbsp;
                                            <input class="form-check-input" type="radio" id="confirmFlagFalse" name="rdoConfirm" value="false">
                                            <label class="form-check-label" for="confirmFlagFalse">ไม่อนุมัติ</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <div class="col-lg-12 text-center">
                            <button type="button" class="btn btn-default" id="btnUpdateExtended" onclick="saveModalExtendedAppointment()"><i class="fa fa-floppy-o"> </i> บันทึก</button>
                            <button type="button" class="btn btn-default" id="btnCancelxtended" data-dismiss="modal"><i class="fa fa-remove"> </i> ยกเลิก</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @*Modal Extended Appointment History*@
    <div tabindex="-1" class="modal fade" id="modalExtendedAppointmentHistory" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
        <div class="modal-dialog" style="width:60%">
            <div class="modal-content" style="border-radius:6px;">
                <div class="modal-header bg-light-blue">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">ประวัติการขอเลื่อนนัด</h4>
                </div>
                <div class="modal-body text-center">
                    <form class="widget-content">
                        <div class="row">
                            <div class="col-lg-12" style="overflow:auto">
                                <table class="table table-striped table-bordered table-hover " id="tbExtendedHistory" style="margin: 8px 8px 0px 8px; width:100%">
                                    <thead>
                                        <tr class="">
                                            <th class="text-center">
                                                ลำดับ
                                            </th>
                                            <th class="text-center">
                                                สถานะ
                                            </th>
                                            <th class="text-center">
                                                ผู้ขอเลื่อน
                                            </th>
                                            <th class="text-center">
                                                วันเดิม
                                            </th>
                                            <th class="text-center">
                                                วันใหม่
                                            </th>
                                            <th class="text-center">
                                                สาเหตุ
                                            </th>
                                            <th class="text-center">
                                                หมายเหตุ HC
                                            </th>
                                            <th class="text-center">
                                                หมายเหตุ CC
                                            </th>
                                            <th class="text-center">
                                                ผู้อนุมัติ CC
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyExtendedAppointmentHistory">
                                        <tr>
                                            <td class="text-center Bold text-danger" colspan="9">ไม่มีข้อมูล</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <br>
                    </form>
                </div>
            </div>
        </div>
    </div>
    @* Modal Quotation History *@
    <div tabindex="-1" class="modal fade" id="modalQuotationHistory" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
        <div class="modal-dialog" style="width:80%">
            <div class="modal-content" style="border-radius:6px;">
                <div class="modal-header bg-light-blue">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">ประวัติใบเสนอราคา</h4>
                </div>
                <div class="modal-body text-center">
                    <form class="widget-content">
                        <div class="row">
                            <div class="col-lg-12" style="overflow:auto">
                                <table class="table table-striped table-bordered table-hover " id="quotationHistoryTable" style="margin: 8px 8px 0px 8px; width:100%">
                                    <thead>
                                        <tr>
                                            <th>
                                                NO.
                                            </th>
                                            <th>
                                                รหัสใบเสนอราคา
                                            </th>
                                            <th>
                                                ผู้อนุมัติ
                                            </th>
                                            <th>
                                                ความคิดเห็นผู้อนุมัติ
                                            </th>
                                            <th>
                                                วันที่อนุมัติ
                                            </th>
                                            <th>
                                                ประเภทการสั่งซื้อ
                                            </th>
                                            <th>
                                                เงื่อนไขการสั่งซื้อ
                                            </th>
                                            <th>
                                                สถานะการสั่งซื้อ
                                            </th>
                                            <th>
                                                หมายเหตุ การสั่งซื้อ
                                            </th>
                                            <th>
                                                สถานะการชำระ
                                            </th>
                                            <th>
                                                เหตุผลขอเปลี่ยนแปลง/ยกเลิก
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="quotationHistoryTBody">
                                        <tr>
                                            <td class="text-center Bold text-danger" colspan="11">ไม่มีข้อมูล</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <br>
                    </form>
                </div>
            </div>
        </div>
    </div>
    @* Modal Upload ImageBefore  *@
    <div tabindex="-1" class="modal fade" id="modalUploadImageBefore" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 6px;">
                <div class="modal-header bg-light-blue">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">แนบรูปภาพก่อนซ่อม</h4>
                </div>
                <div class="modal-body text-center" style="max-height: 85vh; overflow-y: auto;">
                    <form class="widget-content">
                        <div class="row">
                            <label class="text text-primary">รูปภาพก่อนซ่อม</label>
                        </div>
                        <div id="rowOfImageInput">
                        </div>
                        <br>
                    </form>
                </div>
            </div>
        </div>
    </div>
    @*Modal รายละเอียดราคางานซ่อม*@
    <div tabindex="-1" class="modal fade" id="modalDetailPriceRepair" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog" style="width:95%">
            <div class="modal-content" style="border-radius:6px;">
                <div class="modal-header bg-light-blue">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">รายละเอียดราคางานซ่อม</h4>
                </div>

                <div class="modal-body" style="max-height: 83vh; overflow-y: auto;">
                    <form class="widget-content">
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-6">
                                <h5><label class="control-label">รายการรับแจ้งซ่อม</label><span class="text text-red Bold"> * </span></h5>
                                <select id="DdlReceiveItemList" name="DdlReceiveItemList" class="form-control">
                                    <option value="0" disabled selected>-- กรุณาเลือก --</option>
                                </select>
                            </div>
                        </div>
                        <div class="row margin">
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <label class="control-label ">โครงการ: </label>
                                <div class="text-primary" id="txtPriceRepairProject"></div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <label class="control-label ">แปลง: </label>
                                <div class="text-primary" id="txtPriceRepairUnit"></div>
                            </div>
                        </div>
                    </form>
                    <form class="widget-content" id="addItemDetail">
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <h5><label class="control-label">หมวดงานที่ ผรม. ต้องซ่อม</label><span class="text text-red Bold"> * </span></h5>
                                <select id="DdlFixingCategories" name="DdlFixingCategories" class="form-control" onchange="onchangeFixingCategories()">
                                    <option value="0" disabled selected>-- กรุณาเลือก --</option>
                                </select>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <h5><label class="control-label">รายละเอียดที่ซ่อม</label><span class="text text-red Bold"> * </span></h5>
                                <select id="DdlFixingDetail" name="DdlFixingDetail" class="form-control" onchange="onchangeFixingDetail()">
                                    <option value="0" disabled selected>-- กรุณาเลือก --</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-8 col-md-8" style="position: relative; margin-top: 20px">
                                <label style="font-weight: bold; font-size: 15px; font-style: italic; position: absolute; top: -10px; left: 28px; background-color: #FFF;">สำหรับเรียกเก็บลูกค้า</label>
                                <fieldset onkeyup="calTotalPrice()">
                                    <div class="panel panel-default">
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="col-xs-7 col-sm-7">
                                                    <h5><label class="control-label">ประเภท การเรียกเก็บ</label></h5>
                                                    <div style="width: 90%">
                                                        <select class="form-control input-group-select-left" id="ddlBillingType" style="width: 70%" onchange="onChangePriceType(this.value)" disabled></select>
                                                        <input type="number" class="form-control input-group-text-right" id="customerBillingPrice" value="" min="0" style="width: 30%" readonly>
                                                    </div>
                                                </div>
                                                <div class="col-xs-5 col-sm-5">
                                                    <div>
                                                        <h5><label class="control-label">ค่าวัสดุ (ราคาพิเศษ) </label></h5>
                                                        <div class="input-group" style="width:80%">
                                                            <span class="input-group-addon" style="padding-top: 8px">
                                                                <input type="checkbox" id="flagCustomerMaterialPrice" onchange="onChangeFlagCustomerMaterialPrice(this.value)">
                                                            </span>
                                                            <input type="number" id="customerMaterialPrice" class="form-control text-right" value="0.00" min="0" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                            <div class="col-sm-8 col-md-8" style="position: relative; margin-top: 20px">
                                <label style="font-weight: bold; font-size: 15px; font-style: italic; position: absolute; top: -10px; left: 28px; background-color: #FFF;">สำหรับผู้รับเหมา</label>
                                <fieldset onkeyup="calTotalPrice()">
                                    <div class="panel panel-default">
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="col-xs-4 col-sm-4">
                                                    <h5><label class="control-label">อัตรางานเหมา</label></h5>
                                                    <div class="input-group" style="width:60%">
                                                        <input type="number" id="vendorPackagePrice" class="form-control text-right" value="0.00" min="0" onkeyup="calVendorTotalPrice()" readonly>
                                                    </div>
                                                </div>
                                                <div class="col-xs-4 col-sm-4">
                                                    <div>
                                                        <h5><label class="control-label">ค่าแรง</label></h5>
                                                        <div class="input-group" style="width:60%">
                                                            <input type="number" id="vendorWagePrice" class="form-control text-right" value="0.00" min="0" onkeyup="calVendorTotalPrice()" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-xs-4 col-sm-4">
                                                    <div>
                                                        <h5><label class="control-label">ค่าวัสดุ (ราคาพิเศษ) </label></h5>
                                                        <div class="input-group" style="width:60%">
                                                            <input type="number" id="vendorMaterialPrice" class="form-control text-right" value="0.00" min="0" onkeyup="calVendorTotalPrice()" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <h5><label class="control-label">หน่วย </label></h5>
                                <label class="text-primary" id="txtVendorFixPriceUnit">-</label>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3" onkeyup="calTotalPrice()">
                                <h5><label class="control-label">ปริมาณ </label><span class="text text-red Bold"> * </span></h5>
                                <div class="">
                                    <input type="number" id="materialQuantity" class="form-control text-center" onclick="calTotalPrice()" style="width:100px" min="0">
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <h5><label class="control-label">ราคารวม </label></h5>
                                <div class="text-primary"><label class="text-primary" id="TotalPrice">0.00</label></div>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <h5><label class="control-label">หมายเหตุ </label><span class="text text-red Bold"> * </span></h5>
                                <div class="text-primary"><input type="text" id="QuotationItemRemark" class="form-control"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-3 text-left">
                                <br>
                                @if (@UserDetail.Role != @EnumConfiguration.Role.PMR.ToString())
                                {
                                    <button type="button" class="btn btn-success" id="btnAddWOItem" onclick="createQuotationItem()">เพิ่มรายการ</button>
                                }
                            </div>
                        </div>
                    </form>
                    <form class="widget-content">
                        <div class="row">
                            <div class="table-responsive" style="padding:0; margin:0 15px ; overflow: auto; max-height: 300px; margin-top: 10px">
                                <table class="table table-striped table-bordered table-hover quotation-item-detail" id="tbWorksheetitemDetail" style=" width:auto ; max-width 100%">
                                    <thead>
                                        <tr>
                                            <th>
                                                No.
                                            </th>
                                            <th>
                                                หมวดงานที่ ผรม. ต้องซ่อม
                                            </th>
                                            <th>
                                                รายละเอียดที่ซ่อม
                                            </th>
                                            <th>
                                                อัตรางานเหมา (ราคากลาง)
                                            </th>
                                            <th>
                                                ค่าแรง (ราคากลาง)
                                            </th>
                                            <th>
                                                อัตรางานเหมา (ราคาพิเศษ)
                                            </th>
                                            <th>
                                                ค่าแรง (ราคาพิเศษ)
                                            </th>
                                            <th>
                                                ค่าวัสดุ (ราคาพิเศษ)
                                            </th>
                                            <th>
                                                หน่วย
                                            </th>
                                            <th>
                                                ปริมาณ
                                            </th>
                                            <th>
                                                ราคารวม
                                            </th>
                                            <th>
                                                เหตุผลของราคาพิเศษ
                                            </th>
                                            <th>
                                                ลบ
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="quotationItemDetailTBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-lg-3">
                                <label class="control-label ">รวมราคาตามรายการ: </label>
                                <label class="control-label" id="lblTotalPrice">0.00</label>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    @* Modal Confirm With Reason *@
    <div tabindex="-1" class="modal fade" id="modalConfirmWithReason" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
        <div class="modal-dialog modal-dialog-centered" style="margin-top: 25vh">
            <div class="modal-content" style="border-radius: 6px;">
                <div class="modal-header bg-light-blue" style="border-top-left-radius: 3px;border-top-right-radius: 3px;">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="confirmTitle"></h4>
                </div>
                <div class="modal-body " style="padding-bottom: 0">
                    <div class="row form-group">
                        <div style="margin: 0 5%">
                            <label id="confirmTxtReason"></label><label style="color: crimson" id="confirmStarReason">*</label>
                            <input class="form-control" type="text" value="" id="confirmReason" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background-color:whitesmoke; text-align:center; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; padding: 10px">
                    <button type="button" class="btn btn-success" id="confirmBtn" onclick="" style="margin-right: 5px">ยืนยัน</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>
    @* Modal Confirm*@
    <div tabindex="-1" class="modal fade" id="modalConfirm" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
        <div class="modal-dialog modal-dialog-centered" style="margin-top: 25vh">
            <div class="modal-content" style="border-radius: 6px;">
                <div class="modal-header bg-light-blue" style="border-top-left-radius: 3px;border-top-right-radius: 3px;">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="confirmTitleWOR"></h4>
                </div>
                <div class="modal-body " style="padding-bottom: 0">
                    <div class="row form-group">
                        <div style="margin: 0 5%; text-align: center">
                            <label id="confirmTxt"></label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background-color:whitesmoke; text-align:center; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; padding: 10px">
                    <button type="button" class="btn btn-success" id="confirmBtnWOR" onclick="" style="margin-right: 5px">ยืนยัน</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>


    @* modalAlertLineApprove*@
    <div tabindex="-1" class="modal fade" id="modalAlertLineApprove" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
        <div class="modal-dialog modal-dialog-centered" style="margin-top: 25vh">
            <div class="modal-content" style="border-radius: 6px;">
                <div class="modal-header bg-light-blue" style="border-top-left-radius: 3px;border-top-right-radius: 3px;">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="confirmTitleProjectApprove"></h4>
                </div>
                <div class="modal-body " style="padding-bottom: 0">
                    <label>ไม่สามารถทำการแก้ไขข้อมูลได้ เนื่องจากยังไม่ได้ทำการ Set Workflow กรุณาติดต่อ Admin HC</label>
                </div>
                <div class="modal-footer" style="background-color:whitesmoke; text-align:center; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; padding: 10px">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalInsertRoleSuccess" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true" style="z-index:2000;">
        <!-- Change class .modal-sm to change the size of the modal -->
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title w-100" id="myModalLabel">ยืนยันการ บันทึก</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <i class="fa fa fa-check fa-2x" aria-hidden="true" style="color: #32CD32;"></i>
                    <span id="lbTxtSuccess"></span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success btn-sm" data-dismiss="modal">ตกลง</button>
                </div>
            </div>
        </div>
    </div>


    @* Modal Alert Siri Piority *@
    @{Html.RenderPartial("_DisplaySiriPiority");}
</div>
@section Script
{
    <link href="~/Content/theme_green.css" rel="stylesheet" type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.5.1/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/piexif.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.5.1/js/fileinput.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.5.1/themes/explorer/theme.js"></script>
    <script>
        // Declare global variable
        var baseUrl = '@System.Configuration.ConfigurationManager.AppSettings["Construction_API"]';
        var receiveId = window.location.href.split('/')[window.location.href.split('/').length - 1];
        var root = '@System.Configuration.ConfigurationManager.AppSettings["BasePath"]';
        var ddlReceiveItemStatus = [];
        var ddlReceiveItemCancelReason = [];
        var ddlFlagRepairTransfer = [];
        var ddlCostType = [];
        var ddlCostUnit = [];
        var ddlRepairGroup = [];
        var ddlRepairType = [];
        var ddlFixingDetail = [];
        var ddlMainWorkType = [];
        var ddlWorkIssue = [];
        var ddlWorkDetail = [];
        var ddlWorkLocation = [];
        var ddlWorkType = [];
        var ddlWorkStatus = [];
        var ddlSubWorkType = [];
        var ddlReceiveItemDetailOverAppointmentDateReason = [];
        var ddlBillingType = [];
        var chargeList = [];
        var costValueNetList = [];
        var chargeValueNetList = [];
        var receiveItemList = [];
        var changeReceiveItemList = [];
        var ddlReceiveItemList = [];
        var quotationCostList = [];
        var customerData = {};
        var receiveData = {};
        var lastQuotationGoods = {};
        var objPrice = {};
        var beforeCostTypeChange = 0;
        var tempVendoorRow;
        var receiveItemModalGuaranteeId = 0;
        var receiveItemModalId = 0;
        var approverList = [];
        var worksheetCreateFlag = false;
        var postponeHistory;
        var unitID = null;
        var projectID = null;
        var projectName = null;
        var projectCode = null;
        var obj = {}
        var objNew = {}
        var myRows_old = [];
        var flagEdit = false;
        var ReceiveJobNoText = null;
        var empApproveEditData = null;
        var request_token = null;

        // ========================================================================== Initial ==========================================================================
        window.onload = async function initialize() {
            await page.loading();


            request_token = $.ajax({
            url: '@System.Configuration.ConfigurationManager.AppSettings["Home_Care_API"]/login/getTokenCode',
            type: 'GET',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    $.ajaxSetup({
                        headers: {
                            'Authorization': "Bearer " + data.response
                        }
                    });

                }
            });

           

            if (!(+receiveId)) {
                window.location.href = `${root}/`
                return false;
            }
            $('.datepicker').datepicker({
                autoclose: true,
                format: 'dd/mm/yyyy',
                startDate: new Date(),
                todayHighlight: true
            });
            $(".timepicker").timepicker({
                showInputs: false,
                showMeridian: false,
            });
      

            // Get postponeInvestigation
            ajaxGet(`${baseUrl}/homecare/api/v1/Appointment/PostponeInvestigationAppointmentHistory/` + receiveId, response => {
                while (response.data.length > 0) {
                    postponeHistory = response.data.pop();
                    //console.log("res", postponeHistory);

                    if (postponeHistory.extendApproveFlag == 'ลูกค้ายืนยันเรียบร้อยแล้ว') {
                        break;
                    } else {
                        postponeHistory = null;
                    }
                }
                //console.log("finale", postponeHistory);
            });
            // Get receive
            receiveData = await ajaxGet(`${baseUrl}/homecare/api/v1/Receive/` + receiveId, response => {
                $('#ReceiveJobNoText').text(response.data.receiveJobNoText);
                $('#ReceiveMainProcessName').text(response.data.mainProcessDescription);
                $('#ReceiveRepairType').text(response.data.repairTypeDescription);
                $('#ReceiveinformDate').text( thaiFormatDate(response.data.informDate));
                $('#ReceiveInformUser').text(response.data.informUser);
                $('#ReceiveInformRemark').text(response.data.informRemark);
                $('#ReceiveInformCustomerTypeName').text(response.data.informCustomerTypeDescription);
                $('#ReceiveHCDate').text(thaiFormatDate(response.data.receiveHcDate));
                $('#ReceiveHCRemark').val(response.data.receiveHcRemark);
                $('#ReceiveHCUser').text(response.data.receiveHcUser);
                $('#ReceiveCCDate').text(thaiFormatDate(response.data.receiveCcDate));
                $('#ReceiveCCRemark').val(response.data.receiveCcRemark);
                $('#ReceiveCCUser').text(response.data.receiveCcUser);
                $('#ReceiveAppointmentDate').val(thaiFormatDate(response.data.receiveAppointmentDate, false));
                $('#ReceiveAppointmentTimeForm').val(response.data.receiveAppointmentTimeFrom);
                $('#ReceiveAppointmentTimeTo').val(response.data.receiveAppointmentTimeTo);
                ReceiveJobNoText = response.data.receiveJobNoText;
                projectCode = response.data.projectCode;
                // Show icon for extended appointment history
                $('#ReceiveAppointmentGroup').append(`
				    &nbsp; <a id="viewExtendedHistory" onclick="openModalExtendedHistory()"><i class="fa fa-book fa-lg cursor-pointer" style="font-size: 2.5em;"></i></a>
		        `);
                // Bind realAppointmentdate when urgent/maintenance
                if ((response.data.repairTypeId == 2 || response.data.repairTypeId == 3) && response.data.receiveAppointmentDate) {
                    $('#ReceiveAppointmentDateReal').val($('#ReceiveAppointmentDate').val());
                    $('#chkAPDateReal').attr({ checked: true, disabled: true });
                    $('#btnExtendedAppointment').hide();
                }
                // Disable appointmentDateReal
                if (!response.data.receiveAppointmentDate) {
                    $('#chkAPDateReal').attr('disabled', 1)	;
                }

                // Disable select receiveStatus when mainProcessId > 2
                if (response.data.receiveStatusId == 2) {
                    $('#ddlReceivedStatusID').attr('disabled', 1);
                }
                // Show icon for extend appointment
                if (response.data.receiveAppointmentDate && (!response.data.receiveAppointmentDateReal || '@UserDetail.Role' == '@EnumConfiguration.Role.CallCentre.ToString()')) {
                    $('#ReceiveAppointmentGroup').append(`
				        &nbsp;<a id="btnExtendedAppointment"onclick="openModalExtendedAppointment()"><i class="fa fa-calendar-plus-o fa-lg cursor-pointer" style="color:chocolate; font-size: 2.5em;"></i></a>
			        `);
                }
                // Show informer info if informer is not owner
                if (response.data.informCustomerTypeId != 1) {
                    $('#DivOptionalNameTel').show();
                    $('#ReceiveInformCustomerName').text(response.data.informCustomerName);
                    $('#ReceiveInformCustomerTel').text(response.data.informCustomerTelephone);
                }
                // If a receive has informer email then show it
                if (response.data.informCustomerEmail) {
                    $('#DivOptionalEmail').show();
                    $('#CustomerEmail').text(response.data.informCustomerEmail);
                }
                // Check flagUrgent
                if (response.data.flagUrgent) {
                    $('#flagUrgent').show();
                }
                // Check flagImageBefore
                if (response.data.flagImageBefore) {
                    $('#DivOfferPrice').show();
                    $('#FlagImageBeforeText').css('color', 'limegreen');
                    $('#FlagImageBeforeText').text('อัพโหลดเรียบร้อย');
                }
                // Check flagChina
                if (response.data.flagChina) {
                    $('#HeaderReceive').append(`
                        <img class="flag-china" src="https://s3-ap-southeast-1.amazonaws.com/sansiri-conss-ro77/www/public/images/flag-china.svg" alt="China flag" />
                    `);
                }
                // ซ่อนปุ่มและใส่ค่า DateReal เมื่อ DateReal มีค่า
                if (response.data.receiveAppointmentDateReal) {
                    $('#ReceiveAppointmentDateReal').val(thaiFormatDate(response.data.receiveAppointmentDateReal));
                    $('#chkAPDateReal').attr({ checked: true, disabled: true });
                    $('#btnUploadFile').removeAttr('disabled');
                    $('#btnExtendedAppointment').hide();
                }

                return response;
            });
            //logging('receiveData', receiveData);
            // Get receiveItem
            await ajaxGet(`${baseUrl}/homecare/api/v1/Receive/GetReceiveItem/${receiveId}`, async response => {
                receiveItemList = response.data;
            //logging('receiveItemList', receiveItemList);
            var promises = [
                ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/ReceiveItemStatus`),
                ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/FlagRepairTransfer`),
                ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/ReceiveItemCancelReason`),
                ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/RepairType/${receiveData.data.repairTypeId || 0}`),
                ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/Work/MainWorkType`), // Get ddlMainWorkType
                ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/Work/Issue`), // Get ddlWorkIssue
            ];
            [ddlReceiveItemStatus, ddlFlagRepairTransfer, ddlReceiveItemCancelReason, ddlRepairGroup, ddlMainWorkType, ddlWorkIssue] = await Promise.all(promises);
            // Create ddl (select option) in form string
            for (var i = 0; i < response.data.length; i++) {
                await addTableReceiveItemRow(response.data[i]);
            }

            CheckPagePermission();
        });
        // Get customer
        ajaxGet(`${baseUrl}/homecare/api/v1/Customer/${receiveData.data.unitId}`, response => {
            // Toggle customer info pane
            $($('#Received-customer').children()[1]).collapse();
            receiveData.data.mainProcessId < 3 ? $($('#Received-Receive').children()[1]).collapse() : '';
            customerData = response;
            $('#CustomerName').text(response.data.fullNameTh);
            $('#CustomerMobile').text(response.data.mobile + ', ' + response.data.contactInformation);
            $('#CustomerProject').text(response.data.projectNameTh);
            $('#CustomerUnitCode').text(response.data.unitCodeAddress);
            $('#CustomerUnitModel').text(response.data.unitModel);
            $('#CustomerStartGuaranteeDate').text(response.data.startGuaranteeDate);
            $('#CustomerEndGuaranteeDate').text(response.data.endGuaranteeDate);
            $('#CustomerExtraGuaranteeDate').text(response.data.extraGuaranteeDate);
            unitID = response.data.unitId;
            projectID = response.data.projectId;
            projectName = response.data.projectNameTh;
            projectCode = response.data.projectCode;
            // Get over appointment reasons
            bindingDdlReceiveOverAppointmentDateReason();
            // Set disable all input, select, button when mainProcressId = 6
            if (receiveData.data.mainProcessId == 6) {
                $('.main').find('input, button, textarea, select').attr('disabled', 1);
                $('.close').removeAttr('disabled');
                $('#ddlQuotationGoodsName').removeAttr('disabled');
            }
            page.loaded();
        });
        // Get receive status
        ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/ReceiveStatus`, response => {
            bindingDdlist('ddlReceivedStatusID', response.data, receiveData.data.receiveStatusId);
        });
        // Get cost unit
        await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/CostUnit`, response => {
            ddlCostUnit = response;
            bindingDdlist('ddlCostUnit1', response.data, 1);
            // Get ประเภทส่วนลด และ ค่าธรรมเนียม
            ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/CostType`, response => {
                //ddlCostType = response;
                $.each(response.data, (i, d) => {
                    if (d.id == 0) {
                        chargeList.push(d);
                        ddlCostType.push(d);
                    }
                    if (d.keyValue === 'D') {
                        ddlCostType.push(d);
                        costValueNetList.push(0);
                    } else if (d.keyValue === 'C') {
                        chargeList.push(d);
                        chargeValueNetList.push(0);
                    }
                });
                $.each(chargeList, (i, d) => {
                    if (d.id != 0) {
                        $('#DivChargeDetail').append(`
									<div class="row mb-1">
										<div class="col-lg-2 col-sm-2 col-xs-2 col-xs-offset-1">
											<label class="pt-5">${d.description} (%)</label>
										</div>
										<div class="col-lg-3 col-sm-3 col-xs-3">
											<div style="width: 80%">
												<input type="number" class="form-control input-group-text" id="chargeValue${i}" value="${d.costValue}" min="0" style="width: 60%" onkeyup="calChargeValueNet()" onclick="calChargeValueNet()" ${d.id == 5 ? 'readonly' : ''} >
											</div>
										</div>
										<div class="col-lg-3 col-sm-3 col-xs-3">
											<input class="form-control width60" type="number" value="" readonly id="chargeValueNet${i}" />
										</div>
										<div class="col-lg-3 col-sm-3 col-xs-3">
											<input class="form-control width60" type="number" value="" readonly id="totalPriceAfterCharge${i}" />
										</div>
									</div>
								`);
                        bindingDdlist(`ddlChargeUnit${i}`, ddlCostUnit.data, 1);
                    }
                });

                ////Vendor
                //$.each(chargeList, (i, d) => {
                //    if (d.id != 0) {
                //        $('#DivVendorCharge').append(`
                //					<div class="row mb-1">
                //						<div class="col-lg-2 col-sm-2 col-xs-2 col-xs-offset-1">
                //							<label class="pt-5">${d.description} (%)</label>
                //						</div>
                //						<div class="col-lg-3 col-sm-3 col-xs-3">
                //							<div style="width: 80%">
                //								<input type="number" class="form-control input-group-text" id="chargeValue${i}" value="${d.costValue}" min="0" style="width: 60%" onkeyup="calChargeValueNet()" onclick="calChargeValueNet()"} >
                //							</div>
                //						</div>
                //						<div class="col-lg-3 col-sm-3 col-xs-3">
                //							<input class="form-control width60" type="number" value="" readonly id="chargeValueNet${i}" />
                //						</div>
                //						<div class="col-lg-3 col-sm-3 col-xs-3">
                //							<input class="form-control width60" type="number" value="" readonly id="totalPriceAfterCharge${i}" />
                //						</div>
                //					</div>
                //				`);
                //        bindingDdlist(`ddlChargeUnit${i}`, ddlCostUnit.data, 1);
                //    }
                //});

                //bindingDdlist('ddlCostType1', ddlCostType, 0);
            });
        });
        // Check vip status
        ajaxGet(`${baseUrl}/homecare/api/v1/Customer/CheckVipStatus/${receiveData.data.prospectId}`, response => {
            if (response.data.vipStatus)
            {
                if (response.data.vipStatus.includes('Priority'))
                {
                    $('#customerInfo').append(` <span class="label label-danger tag-label">${response.data.vipStatus}</span>`);
                }
                else {
                    $('#customerInfo').append(' <a class="label label-warning DisplaySiriPiority">VIP</a> <input type="hidden" value=${response.data.vipStatus} id="hdVipStatus" />');
                }
                $(".DisplaySiriPiority").on('click', function () {

                    $('#modalDisplaySiriPiority').modal('show');

                });
                if (sessionStorage.reloadAfterPageLoad) {

                } else {
                    if ($("#hdVipStatus").val() != null) {
                        if ($("#hdVipStatus").val() != "priority") {
                            $('#modalDisplaySiriPiority').modal('show');
                        }
                    }
                    sessionStorage.reloadAfterPageLoad = false;
                }

            }
        });
        // Get quotation dll
        var ddlQuotations = [
            // Get customer cancel quotation reason
            ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/CustomerCancelQuotationReason`, response => {
                bindingDdlist('DdlCustomerCancelQuotationReason', response.data.filter(d => (d.system && d.system.toUpperCase() === 'OTS') || d.id === 0), 0);
            }),
            // Check Approver Name
            ajaxGet(`${baseUrl}/homecare/api/v1/Quotation/GetQuotationApprovers`, response => {
                approverList = response.data;
                //console.log('approverList', approverList);
            })
        ];
        await Promise.all(ddlQuotations);
        //// Get quotation
        await getQuotation();
        //// Enable/Disable ddlReceivedItemStatusID
        if(quotationList.length > 0)
        {
            if (quotationList.filter(q => q.paymentStatusId != 2 && !q.canceledByCustomer).length > 0)
            {
                $("#btnPreviewWO").attr('disabled', true);
                $("#InformTable #ddlReceivedItemStatusID").prop('disabled', true);
            }
        }
        else { $("#btnPreviewWO").attr('disabled', true); }

        if($('#ReceiveAppointmentDateReal').val() == "")
        {
            $("#InformTable #ddlReceivedItemStatusID").prop('disabled', true);
        }

        // Get ddlReceiveItemDetailOverAppointmentDateReason
        ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/PostponeRepairAppointmentReason`, response => {
            ddlReceiveItemDetailOverAppointmentDateReason = response;
        });
        // Get ddlWorkType ***dont use
        ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/Work/jobType`, response => {
            ddlWorkType = response;
        });
        // Get ddlRepairType
        ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/RepairType`, response => {
            ddlRepairType = response;
        });
        // Get ddlBillingType
        ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/BillingType`, response => {
            ddlBillingType = response;
        });
        // Get ddlWorkStatus
        await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/Work/Status`, response => {
            ddlWorkStatus = response;
        });
        // Create ddlReceiveItemList
        ddlReceiveItemList.push(ddlWorkStatus.data[0]);
        for (var i = 0; i < receiveItemList.length; i++) {
            ddlReceiveItemList.push({ id: receiveItemList[i].receiveItemId, description: `${receiveItemList[i].no} ${receiveItemList[i].guaranteeDescription} ${receiveItemList[i].detail}` })
        }

        loadingUrgentMaintenanceForm();
        // Set disable all input, select, button when mainProcressId = 6
        if (receiveData.data.mainProcessId == 6)
        {
            $('.main').find('input, button, textarea, select').attr('disabled', 1);
            $('.close').removeAttr('disabled');
            $('#btndetailPriceRepair').hide();
        }

        }

        function bindingDdlReceiveOverAppointmentDateReason() {
            var ddlOverAppointmentReasonUrl = `${baseUrl}/homecare/api/v1/DropDown/PostponeInvestigationAppointmentReason`;
            ajaxGet(ddlOverAppointmentReasonUrl, response => {
                bindingDdlist('ddlReceiveOverAppointmentDateReason', response.data, postponeHistory ? postponeHistory.description.includes('ลูกค้า') ? 1 : 0 : receiveData.data.receivePostponeAppointmentId);
            });
        }

        // =========================================================================== Events ===========================================================================
        // สถานะรับเรื่อง
        function onChangeddlReceivedStatus() {//TODO canchange when StatusIDOld == 1
            var StatusID = $("#ddlReceivedStatusID").val();
            var StatusIDOld = receiveData.data.receiveStatusId;
            var HCDateOld = thaiFormatDate(receiveData.data.receiveHcDate);
            var CCDateOld = thaiFormatDate(receiveData.data.receiveCcDate);
            var InformDate = new Date(receiveData.data.informDate);
            var d = new Date(Date.now()),
                today = [d.getDate().padLeft(),
                (d.getMonth() + 1).padLeft(),
                d.getFullYear()].join('/') + ' ' + [d.getHours().padLeft(),
                d.getMinutes().padLeft(),
                        d.getSeconds().padLeft()].join(':');

            var currentDatetime = moment(new Date()).format('DD/MM/YYYY HH:mm:ss');
            var lastUpdateDatetimeStatus = moment(InformDate).format('DD/MM/YYYY HH:mm:ss');

            var currentDateTimeConverted = moment(currentDatetime, 'DD/MM/YYYY HH:mm:ss');
            var lastUpdateDatetimeStatusConverted = moment(lastUpdateDatetimeStatus, 'DD/MM/YYYY HH:mm:ss');
            var duration = moment(currentDateTimeConverted).diff(lastUpdateDatetimeStatusConverted, 'hours', true);

            if (StatusID == "1") {
                $("#ddlReceivedStatusID").val(StatusIDOld ? StatusIDOld : 1);
                $("#ReceiveHCDate").text(HCDateOld);
                $("#ReceiveCCDate").text(CCDateOld);
                modalWaring("กรุณาเลือกสถานะรับเรื่อง");
            } else if ("@EnumConfiguration.Role.CallCentre.ToString()" != "@UserDetail.Role" && (StatusID == "6"||StatusID == "7")){
                $("#ddlReceivedStatusID").val(StatusIDOld);
                $("#ReceiveHCDate").text(HCDateOld);
                $("#ReceiveCCDate").text(CCDateOld);
                modalWaring("คุณไม่มีสิทธิ์เลือกสถานะของ Call Centre");
            } else if ("@EnumConfiguration.Role.CallCentre.ToString()" == "@UserDetail.Role" && (StatusID == "2"||StatusID == "3"||StatusID == "4"||StatusID == "5")){
                $("#ddlReceivedStatusID").val(StatusIDOld);
                $("#ReceiveHCDate").text(HCDateOld);
                $("#ReceiveCCDate").text(CCDateOld);
                modalWaring("คุณไม่มีสิทธิ์เลือกสถานะของ Home Care");
            } else if (((StatusIDOld != "4" && StatusID == "5")) || ((StatusID == "5") && (duration != NaN && duration < 24))) {
                $("#ddlReceivedStatusID").val(StatusIDOld);
                $("#ReceiveHCDate").text(HCDateOld);
                $("#ReceiveCCDate").text(CCDateOld);
                modalWaring("กรุณาติดต่อลูกค้าให้ครบภายใน 24 ชั่วโมง");
            } else if (((StatusIDOld != "5" && StatusID == "7")) || ((StatusID == "7") && (duration != NaN && duration < 72))) {
                $("#ddlReceivedStatusID").val(StatusIDOld);
                $("#ReceiveHCDate").text(HCDateOld);
                $("#ReceiveCCDate").text(CCDateOld);
                modalWaring("กรุณาติดต่อลูกค้าให้ครบภายใน 3 วัน");
            } else if (StatusID == "2") {
                $("#ReceiveHCDate").text(today);
                $("#ReceiveCCRemark").attr('disabled','disabled');
                $("#ReceiveHCRemark").removeAttr('disabled');
                if ($("#ReceiveAppointmentDate").val() == "") {
                    $("#ReceiveAppointmentDate").removeAttr('disabled');
                    $("#ReceiveAppointmentTimeForm").removeAttr('disabled');
                    $("#ReceiveAppointmentTimeTo").removeAttr('disabled');
                    //$("#ddlReceiveOverAppointmentDateReason").removeAttr('disabled');
                }
            } else if (StatusID == "3" || StatusID == "4" || StatusID == "5") {
                $("#ReceiveHCDate").text(today);
                $("#ReceiveCCRemark").attr('disabled','disabled');
                $("#ReceiveHCRemark").removeAttr('disabled');
                $("#ReceiveAppointmentDate").attr('disabled','disabled');
                $("#ReceiveAppointmentTimeForm").attr('disabled','disabled');
                $("#ReceiveAppointmentTimeTo").attr('disabled','disabled');
                $("#ddlReceiveOverAppointmentDateReason").attr('disabled','disabled');
            } else if (StatusID == "6"||StatusID == "7") {
                $("#ReceiveCCDate").text(today);
                $("#ReceiveHCRemark").attr('disabled','disabled');
                $("#ReceiveCCRemark").removeAttr('disabled');
                $("#ReceiveAppointmentDate").attr('disabled','disabled');
                $("#ReceiveAppointmentTimeForm").attr('disabled','disabled');
                $("#ReceiveAppointmentTimeTo").attr('disabled','disabled');
            } else {
                $("#ReceiveHCDate").text("");
                $("#ReceiveCCDate").text("");

                $("#ReceiveCCRemark").attr('disabled','disabled');
                $("#ReceiveHCRemark").attr('disabled','disabled');
            }
        };
        // วันเข้าตรวจสอบจริง
        function bindRealAppointmentDate() {
            if ($('#chkAPDateReal').prop('checked')) {
                var date = new Date().toJSON().slice(0, 10).replace(/-/g, '/').split('/');
                $('#ReceiveAppointmentDateReal').val(`${date[2]}/${date[1]}/${date[0]}`)
                $('#btnExtendedAppointment').hide();
            } else {
                $('#ReceiveAppointmentDateReal').val('');
                $('#btnExtendedAppointment').show();
            }
        }
        // Enabled overAppointmentDateReason
        function onchangeAppointmentDate() {
            var selectedDate = new Date(reorganizeDateFormat($("#ReceiveAppointmentDate").val()));
            var receiveHcDate = new Date();
            //console.log((selectedDate - receiveHcDate) / 8.64e+7);
            //If more than 1 day (2 or more): enabled ddlReason
            if (((selectedDate - receiveHcDate) / 8.64e+7) >= 2) {
                $('#ddlReceiveOverAppointmentDateReason').removeAttr('disabled');
            } else {
                $('#ddlReceiveOverAppointmentDateReason').attr('disabled', 1);
                $('#ddlReceiveOverAppointmentDateReason').val(0);
            }
        }
        // Bind realAppDate when reapirType = 2, 3
        function bindRealAppointmentDateWithType() {
            if (receiveData.data.repairTypeId == 2 || receiveData.data.repairTypeId == 3) {
                $('#chkAPDateReal').prop('checked', 1);
                $('#ReceiveAppointmentDateReal').val($('#ReceiveAppointmentDate').val())
            }
        }
        // สร้างใบเสนอราคา
        function createQuotation() {
            if (!validateCreateQuotation()) {
                return false;
            }
            var body = {
                receiveId: receiveId,

                //orderTypeId: $('#DdlGoodsType').val(),
                //orderConditionId: $('#DdlGoodsOrderCondition').val(),
                //orderStatusId: $('#DdlGoodsOrderStatus').val(),
                //remark: $('#txtGoodsRemark').val() || lastQuotationGoods.remark,

                //edit by Adisorn
                orderTypeId: 0,
                orderConditionId: 0,
                orderStatusId: 0,
                remark: null,
                //edit by Adisorn

                username: '@UserDetail.CodeName'
            }
            //Api Create new Quotation
            ajaxPost(`${baseUrl}/homecare/api/v1/Quotation/InsertQuotationGoods`, body, (response) => {
                if (response) {
                    $('#preQuotationItemDetailTBody').empty();
                    for (var i = 1; i <= chargeList.length - 1; i++) {
                        if (i != chargeList.length - 1) {
                            $('#chargeValue' + i).removeAttr('disabled');
                        }
                        $('#ddlChargeUnit' + i).removeAttr('disabled');
                    }
                    $('#preTotalPrice').text(0);
                    $('#preVendorTotalPrice').text(0);
                    clearDivCost();
                    calCostValueNet();
                    $('#flagChangeRequest').prop('checked', false);
                    $('#flagChangeRequest').removeAttr('disabled');
                    $('#DdlCustomerCancelQuotationReason').attr('disabled', 1);
                    $('#DdlCustomerCancelQuotationReason').val(0);
                    $('#DivGenQuotationPDF').hide();

                    openModaldetailPriceRepair();
                }
            });
        }
        // Get fixing detail on fixing categories changed
        function onchangeFixingCategories() {
            ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/FixingDetail/${$('#DdlFixingCategories').val()}`, response => {
                bindingDdlist('DdlFixingDetail', response.data, 0);
                ddlFixingDetail = response;
                //logging('DdlFixingDetail', response);
            });
        }
        // Get fixing issue on fixing detail changed
        function onchangeFixingDetail() {
            $.each(ddlFixingDetail.data, (i, d) => {
                if (d.id == $('#DdlFixingDetail').val()) {
                    $('#txtVendorFixPriceUnit').text(d.units);
                    objPrice = {
                        customerPackagePrice: d.customerPackagePrice,
                        customerWagePrice: d.customerWagePrice,
                        vendorPackagePrice: d.vendorPackagePrice,
                        vendorWagePrice: d.vendorWagePrice
                    }
                }
            })
            onChangePriceType($('#ddlBillingType').val());
            $('#ddlBillingType').removeAttr('disabled');
        }


        //ปุ่มแก้ไขข้อมูล
        function setVisibleForEditReceiveItemModal(element) {
            $.get(`${baseUrl}/homecare/api/v1/LineApprove/GetLineApproveEditData?projectId=${projectID}`,
            function (data) {
                if (data.data.length == 0) {
                    $('#modalAlertLineApprove').modal('show');
                    var title = "โครงการ " + projectCode + " - " + projectName;
                    $('#confirmTitleProjectApprove').text(title);

                } else {

                    $(element).parent().parent().parent().find('#ReceiveTable tbody select').removeAttr('disabled');
                    $(element).parent().find('button').show();
                    $('#Remark').removeClass('hidden');

                    var obj = {}
                    var row = $(element).parent().parent().parent().find('#ReceiveTable tbody');
                    obj["mainJobDetails"] = row.find("#ddlReceiveItemMainWorkType").val() == null ? 0 : row.find("#ddlReceiveItemMainWorkType").val();
                    obj["SecondaryWork"] = row.find("#ddlReceiveItemSubWorkType").val() == null ? 0 : row.find("#ddlReceiveItemSubWorkType").val();
                    obj["appraisalCharacteristics"] = row.find("#ddlReceiveItemWorkDetail").val() == null ? 0 : row.find("#ddlReceiveItemWorkDetail").val();
                    obj["location"] = row.find("#ddlReceiveItemLocation").val() == null ? 0 : row.find("#ddlReceiveItemLocation").val();
                    obj["causeOfProblem"] = row.find("#ddlReceiveItemWorkIssue").val() == null ? 0 : row.find("#ddlReceiveItemWorkIssue").val();
                    obj["duplicateFixid"] = row.find("#flagReceiveItemDuplicateFix").val();
                    obj["ReceiveItemPriority"] = row.find("#txtReceiveItemPriority").val();
                    obj["id"] = receiveItemModalId;

                    myRows_old.push(obj)

                }
            });

        }


        function editConfigReceiveItemModal(element) {
            if ($('#Remark').val() == "") {
                modalWaring("กรุณาระบุเหตุผลในการแก้ไข");
                return
            }

            var row = $(element).parent().parent().parent().find('#ReceiveTable tbody');

            var myRows_new = [];
            objNew["mainJobDetails"] = row.find("#ddlReceiveItemMainWorkType").val() == null ? 0 : row.find("#ddlReceiveItemMainWorkType").val();
            objNew["SecondaryWork"] = row.find("#ddlReceiveItemSubWorkType").val() == null ? 0 : row.find("#ddlReceiveItemSubWorkType").val();
            objNew["appraisalCharacteristics"] = row.find("#ddlReceiveItemWorkDetail").val() == null ? 0 : row.find("#ddlReceiveItemWorkDetail").val();
            objNew["location"] = row.find("#ddlReceiveItemLocation").val() == null ? 0 : row.find("#ddlReceiveItemLocation").val();
            objNew["causeOfProblem"] = row.find("#ddlReceiveItemWorkIssue").val() == null ? 0 : row.find("#ddlReceiveItemWorkIssue").val();
            objNew["duplicateFixid"] = row.find("#flagReceiveItemDuplicateFix").val();
            objNew["ReceiveItemPriority"] = row.find("#txtReceiveItemPriority").val();
            objNew["id"] = receiveItemModalId;

            myRows_new.push(objNew)

        //validation
            if (row.find("#ddlReceiveItemMainWorkType").val() == "0" || row.find("#ddlReceiveItemSubWorkType").val() == "0" || row.find("#ddlReceiveItemWorkDetail").val() == "0" ||
                row.find("#ddlReceiveItemLocation").val() == "0" || row.find("#ddlReceiveItemWorkIssue").val() == "0")
        {
            pleaseWaitDialogClose();
            modalWaring("กรุณาระบุ ข้อมูลแจ้งซ่อม ให้ครบ");
            return false;
        }
            var data = {
                ID: receiveItemModalId,
                ReceiveJobNo: ReceiveJobNoText,
                projectCode: projectCode,
                projectName: projectCode + '-' + projectName,
                EditType: "แก้ไขรายละเอียดงานซ่อม",
                Remark: $('#Remark').val(),
                UserLogin : "@UserDetail.CodeName",
                Detail_old: myRows_old,
                Detail_new: myRows_new
            };

            ajaxPost(`${baseUrl}/homecare/api/v1/Receive/SaveEditDataSendApprove`, data, response => {

                if (response) {
                    $(element).parent().parent().parent().find('#ReceiveTable tbody select').prop('disabled', true);
                    $(element).parent().find('button').hide();
                    $('#lbStatusEditData').show();
                    showModalLineApprveSuccess('ส่งคำขอแก้ไขข้อมูลเรียบร้อยแล้ว');

                } else {
                    showModalLineApprveWarning('เกิดข้อผิดพลาด บันทึกไม่สำเร็จ');
                }
            });

        }

        function showModalLineApprveSuccess(msg) {
            $('#modalInsertRoleSuccess').modal('show');
            $('#lbTxtSuccess').text(msg);
        }


        //Add row discountTable
        function addTableRow(disabled = false) {
            var tempTrLength = $('#discountTBody tr').length + 1;
            if (tempTrLength == ddlCostType.length) { return false; }
            $('#discountTBody').append(`
				<tr>
					<td><p class="pt-5" >${tempTrLength}</p></td>
					<td>
						<select class="form-control" id="ddlCostType${tempTrLength}" onchange="onChangeCostType(this)" onfocus="beforeCostTypeChange = this.value" ${disabled ? 'disabled' : ''}></select>
					</td>
					<td>
						<div>
							<input type="number" class="form-control input-group-text" id="costValue${tempTrLength}" placeholder="0.00" min="0" onkeyup="calCostValueNet()" onclick="calCostValueNet()" readonly ${disabled ? 'disabled' : ''}>
							<select class="form-control input-group-select" id="ddlCostUnit${tempTrLength}" onchange="calCostValueNet()" ${disabled ? 'disabled' : ''}></select>
						</div>
					</td>
					<td><label class="pt-5" id="costValueNet${tempTrLength}"></label></td>
					<td><i class="fa fa-close pt-5" onclick="removeTableRow(this)"></i></td>
				</tr>
			`)
            bindingDdlist('ddlCostType' + tempTrLength, ddlCostType, 0);
            bindingDdlist('ddlCostUnit' + tempTrLength, ddlCostUnit.data, 1);
            if ($('#discountTBody tr').length == ddlCostType.length - 1) {
                $('#btnAddRowCost').hide();
            }
            calCostValueNet();
        }

            // Delete row discountTable
            function removeTableRow(element) {
                $(element).parent().parent().remove();
                $('#discountTBody tr').each((i, element) => {
                    $(element).find('p').text(i + 1);
                    $(element).find('input').attr('id', 'costValue' + (i + 1));
                    $(element).find('label').attr('id', 'costValueNet' + (i + 1));
                    $(element).find('select').each((j, select) => {
                        if (j === 0) {
                            $(select).attr('id', 'ddlCostType' + (i + 1));
                        } else {
                            $(select).attr('id', 'ddlCostUnit' + (i + 1));
                        }
                    });
                });
                $('#btnAddRowCost').show();
                $.each($('#discountTBody tr'), (i, d) => {
                    if (!$('#ddlCostType' + (i + 1)).val()) {
                        $('#btnAddRowCost').hide();
                    }
                })
                calCostValueNet();
            }
            // addReceiveItemDetailRow
            function addTableReceiveItemDetailRow(indexDateReason = 0, indexWorkStatus = 0, createdWorksheet = false, canDelete = true) {
                var tempTrLength = $('#tbodySubReceiveItem tr').length + 1;
                $('#tbodySubReceiveItem').append(`
				<tr>
					<td class="text-center">
						<p class="pt-5">${tempTrLength}</p>
						<input type="hidden" id="ReceiveItemDetailId${tempTrLength}" />
					</td>
					<td class="text-center">
						<select class="form-control" id="ddlReceiveItemDetailStatus${tempTrLength}" ${createdWorksheet ? 'disabled' : ''} style="min-width: 125px"></select>
					</td>
					<td class="text-center">
						<div class="input-group" onclick="itemAddvendor(this,${createdWorksheet})">
							<input type="hidden" id="receiveItemDetailVendorCode${tempTrLength}" />
							<div class="input-group-addon">
								<a id="itemAddVendor"><i class="fa fa-user fa-lg"></i></a>
							</div>
							<div class="input-group">
								<input type="text" id="receiveItemDetailVendorName${tempTrLength}" disabled readonly class="form-control" value="" />
							</div>
						</div>
					</td>
					<td class="text-center">
						<select class="form-control" id="ddlReceiveItemDetailWorkType${tempTrLength}" style="min-width: 155px" disabled></select>
					</td>
					<td class="text-center">
						<div class="input-group">
							<div class="input-group-addon">
								<i class="fa fa-calendar"></i>
							</div>
							<input type="text" class="form-control datepicker" data-val="true"  id="receivItemDetailAppointmentDateForm${tempTrLength}" ${createdWorksheet ? 'disabled' : ''} onchange="onChangeReceivItemDetailAppointmentDateForm(${tempTrLength})"/>
						</div>
					</td>
					<td class="text-center">
						<div class="input-group">
							<div class="input-group-addon">
								<i class="fa fa-calendar"></i>
							</div>
							<input type="text" class="form-control datepicker" data-val="true" id="receivItemDetailAppointmentDateTo${tempTrLength}" ${createdWorksheet ? 'disabled' : ''} />
						</div>
					</td>
					<td class="text-center">
						<select class="form-control" id="ddlReceiveItemDetailOverAppointmentDateReason${tempTrLength}" ${createdWorksheet ? 'disabled' : ''} disabled ></select>
					</td>
					<td class="text-center">
						<span class="fa fa-check" style="display: none" id="FlagworksheetCreated${tempTrLength}" /></span>
					</td>
					<td class="text-center">
						<input type="text" class="form-control" id="txtReceiveItemDetailRemark${tempTrLength}" ${createdWorksheet ? 'disabled' : ''} />
					</td>
					<td class="text-center">
						<span class="fa fa-close cursor-pointer ${canDelete ? '' : 'hidden'}" id="btnRemoveSubItem${tempTrLength}" onclick="removeTableReceiveItemDetailRow(this)" />
					</td>
				</tr>
			`)
                bindingDdlist(`ddlReceiveItemDetailOverAppointmentDateReason${tempTrLength}`, ddlReceiveItemDetailOverAppointmentDateReason.data, indexDateReason);
                bindingDdlist(`ddlReceiveItemDetailWorkType${tempTrLength}`, ddlRepairType.data, receiveData.data.repairTypeId);
                bindingDdlist(`ddlReceiveItemDetailStatus${tempTrLength}`, ddlWorkStatus.data, indexWorkStatus);
                $('.datepicker').datepicker({
                    autoclose: true,
                    format: 'dd/mm/yyyy',
                    startDate: new Date(),
                    todayHighlight: true
                });
            }

                // Delete row discountTable
                function removeTableReceiveItemDetailRow(element) {
                    $(element).parent().parent().remove();
                    $('#tbodySubReceiveItem tr').each((i, element) => {
                        $(element).find('p').text(i + 1);
                        $.each($(element).find('select'), (j, selected) => {
                            switch (j) {
                                case 0:
                                    $(selected).attr('id', `ddlReceiveItemDetailStatus${i + 1}`);
                                    break;
                                case 1:
                                    $(selected).attr('id', `ddlReceiveItemDetailWorkType${i + 1}`)
                                    break;
                                case 2:
                                    $(selected).attr('id', `ddlReceiveItemDetailOverAppointmentDateReason${i + 1}`)
                                    break;
                            }
                        });
                        $.each($(element).find('input'), (j, selected) => {
                            switch (j) {
                                case 0:
                                    $(selected).attr('id', `ReceiveItemDetailId${i + 1}`);
                                    break;
                                case 1:
                                    $(selected).attr('id', `receiveItemDetailVendorCode${i + 1}`)
                                    break;
                                case 2:
                                    $(selected).attr('id', `receiveItemDetailVendorName${i + 1}`)
                                    break;
                                case 3:
                                    $(selected).attr('id', `receivItemDetailAppointmentDateForm${i + 1}`)
                                    break;
                                case 4:
                                    $(selected).attr('id', `receivItemDetailAppointmentDateTo${i + 1}`)
                                    break;
                                case 5:
                                    $(selected).attr('id', `txtReceiveItemDetailRemark${i + 1}`)
                                    break;
                            }
                        });
                        $.each($(element).find('span'), (j, selected) => {
                            switch (j) {
                                case 0:
                                    $(selected).attr('id', `FlagworksheetCreated${i + 1}`);
                                    break;
                                case 1:
                                    $(selected).attr('id', `btnRemoveSubItem${i + 1}`)
                                    break;
                            }
                        });
                    });

                }
                //Check costType cant duplicate
                function onChangeCostType(element) {
                    var countDup = 0;
                    var countValue = 0;
                    var index = 0;
                    // Count duplicate and value
                    for (var i = 0; i < $('#discountTBody tr').length; i++) {
                        if ($('#' + element.id).val() == $('#ddlCostType' + (i + 1)).val()) {
                            index = (i + 1);
                            countDup++;
                        }
                        if ($('#ddlCostType' + (i + 1)).val()) {
                            countValue++;
                        }
                    }
                    // Show btnAddRowCost เมื่อทุกบรรทัดมีค่า
                    if (countValue == $('#discountTBody tr').length) {
                        if ($('#discountTBody tr').length != ddlCostType.length - 1) {
                            $('#btnAddRowCost').show();
                        }
                    } else {
                        $('#btnAddRowCost').hide();
                    }
                    // Veridate ห้ามซ้ำ
                    if (countDup > 1) {
                        $('#' + element.id).val(beforeCostTypeChange);
                        if (beforeCostTypeChange == 0) {
                            $('#costValue' + index).attr('readonly', 'true');
                        }
                        $('#costValue' + index).val(ddlCostType.filter(element => element.id == beforeCostTypeChange)[0].costValue);
                        modalWaring('กรุณาเลือกประเภทส่วนลดให้ไม่ซ้ำกัน');
                        calCostValueNet();
                        return false;
                    }
                    // Bind costvalue
                    $.each(ddlCostType, (i, d) => {
                        if (d.id == $('#' + element.id).val()) {
                            $('#costValue' + index).val(d.costValue);
                            $('#costValue' + index).removeAttr('readonly');
                        }
                    })
                    calCostValueNet();
                }
                // Toggle disabled
                function toggleById(id) {
                    $(id).prop('disabled', (_, bool) => { return !bool; });
                }

                // View picture on itemReceive
                function viewPicUploaded(element) {
                    //logging($(element).parent().parent().find('label').text());
                }
                // Get SubWorkType and Location by MainWorkType
                async function onChangeMainWorkType(val, indexSub = 0, indexLocation = 0) {
                    var promises = [
                        ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/Work/Location/${val}`),// Get ddlWorkLocation
                        ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/Work/SubWorkType/${val}`),// Get ddlSubWorkType
                    ];
                    [ddlWorkLocation, ddlSubWorkType] = await Promise.all(promises);
                    // Binding ddlWorkLocation ddlSubWorkType
                    bindingDdlist('ddlReceiveItemSubWorkType', ddlSubWorkType.data, indexSub);
                    bindingDdlist('ddlReceiveItemLocation', ddlWorkLocation.data, indexLocation);
                }
                    //Get ddlWorkDetail
                    async function onChangeSubWorkType(val, index = 0) {
                        await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/Work/Detail/${val}`, response => {
                            ddlWorkDetail = response;
                            //Binding ddlWorkDetail
                            bindingDdlist('ddlReceiveItemWorkDetail', ddlWorkDetail.data, index);
                        })
                    }
                        // binding txtPriority
                        function onChangeWorkDetail(workDetailid) {
                            var tempPriority = ddlWorkDetail.data.filter(element => element.id == workDetailid)[0].priority;
                            $('#txtReceiveItemPriority').val(tempPriority);
                        }
                        //chaeck ซ่อมซ้ำ
                        function checkDupFix() {
                            var body = {
                                "unitId": receiveData.data.unitId,
                                "guaranteeId": receiveItemModalGuaranteeId,
                                "spec1Id": $('#ddlReceiveItemMainWorkType').val() || 0,
                                "spec2Id": $('#ddlReceiveItemSubWorkType').val() || 0,
                                "spec3Id": $('#ddlReceiveItemWorkDetail').val() || 0,
                                "locationId": $('#ddlReceiveItemLocation').val() || 0
                            }
                            ajaxPost(`${baseUrl}/homecare/api/v1/Receive/CheckDuplicateFix`, body, response => {
                                if (response.data.trim()) {
                                    $('#flagReceiveItemDuplicateFix').show();
                                    $('#flagReceiveItemDuplicateFix').val(true);
                                    modalWaring(response.data);
                                } else {
                                    $('#flagReceiveItemDuplicateFix').hide();
                                    $('#flagReceiveItemDuplicateFix').val(false);
                                }
                            })

                        }
                        // Add addTableReceiveItemRow
                        async function addTableReceiveItemRow(d = { no: $('#ReceiveItemTBody tr').length + 1, statusId: 1, repairId: 3}) {
                        var ddlReceiveItemStatusStr = createDdlStringForm('ddlReceivedItemStatusID', ddlReceiveItemStatus.data, d.statusId || 0, !!!d.receiveItemId, true);
                        var ddlFlagRepairTransferStr = createDdlStringForm('ddlRepairID', ddlFlagRepairTransfer.data, d.repairId || 3);
                        var ddlReceiveItemCancelReasonStr = createDdlStringForm('ddlCancelResonID', ddlReceiveItemCancelReason.data, d.cancelReasonId || 0, (d.statusId != 3 && d.statusId != 4));
                        var ddlGuaranteeIDStr = createDdlStringForm('ddlGuaranteeID', ddlRepairGroup.data, d.guaranteeId || 0, !!d.receiveItemId );
                        $('#ReceiveItemTBody').append(`
				<tr id="${d.receiveItemId || 0}" onchange="changeReceiveItemList.includes(${d.receiveItemId}) ? '' : changeReceiveItemList.push(${d.receiveItemId || 0});">
					<td align="center">
						<label>${d.no}</label>
					</td>
					<td>
						${ddlReceiveItemStatusStr}
					</td>
					<td>
						${ddlGuaranteeIDStr}
					</td>
					<td>
						<textarea class="form-control" cols="30" rows="2" data-val="true" id="txtItemDetail" name="txtItemDetail" style="width:100%;" type="text" maxlength="512" ${!!d.receiveItemId ? 'disabled' : ''}>${d.detail || ''}</textarea>
					</td>
					<td>
						<textarea class="form-control" cols="30" rows="2" data-val="true" id="txtItemRemark" name="txtItemRemark" style="width:100%;" type="text" maxlength="512">${d.receiveRemark || ''}</textarea>
					</td>
					<td>
						${ddlFlagRepairTransferStr}
					</td>
					<td class="text-center">
						<span class="fa fa-folder-open fa-lg viewFile cursor-pointer" aria-hidden="true" ${d.statusId != 2 ? 'style ="display: none"' : ''} onclick=openModalReceivedItemsDetail(${d.receiveItemId})></span>
                        <span class="glyphicon glyphicon-time" id="iconwait"></span>
					</td>
					<td class="text-center">
						<span class="fa fa-picture-o fa-lg viewFile cursor-pointer" aria-hidden="true" onclick="openModalViewEachImageBefore(${d.receiveItemId}, ${d.no - 1})"></span>
					</td>
					<td class="text-center">
						${ddlReceiveItemCancelReasonStr}
					</td>
				</tr>
			`);
                        if (d.receiveItemId) {
                            await ajaxGet(`${baseUrl}/homecare/api/v1/Receive/GetReceiveItemDetail/${d.receiveItemId}`, async response => {
                                if (response.data.length > 0) {
                                    $.each(response.data, (i, d) => {
                                        if (d.worksheetCreateFlag) {
                                            $('#ReceiveItemTBody tr:last').find('input, select, textarea').attr('disabled', 1);

                                        } else {
                                            $('#editData').hide();
                                        }
                                    })
                                }
                            });
 

                            await ajaxGet(`${baseUrl}/homecare/api/v1/LineApprove/CheckHistoryEditDataFlow?id=${d.receiveItemId}&projectCode=${projectCode}`, async response => {
                                if (response.data.length > 0 && response.data[0].Detail_old != null) {
                                    $('#iconwait').show();
                                    empApproveEditData = 'โดยคุณ' +response.data[0].EmpApproveName;
                                    flagEdit = true;

                                } else {

                                    $('#iconwait').hide();
                                    flagEdit = false;
                                }
                            });

                            }

                }



                function toggleReceiveItemBtn() {
                    $('#btnAddReceivedItem').attr('disabled') ? $('#btnAddReceivedItem').removeAttr('disabled') : $('#btnAddReceivedItem').attr('disabled', 1) ;
                    $('#btnSaveReceivedItem').attr('disabled') ? $('#btnSaveReceivedItem').removeAttr('disabled') : $('#btnSaveReceivedItem').attr('disabled', 1) ;
                    $('#btnRemoveReceivedItem').attr('disabled') ? $('#btnRemoveReceivedItem').removeAttr('disabled') : $('#btnRemoveReceivedItem').attr('disabled', 1) ;
                }

                function onChangeReceivedItemStatusID(val, element) {
                    var data = $(element).parent().parent();

                    switch (val) {
                        case '0':
                            break;
                        case '1':
                            data.find('#ddlCancelResonID').attr('disabled', true);
                            data.find('#ddlCancelResonID').val(0);
                            data.find('.fa-folder-open').hide();
                            break;
                        case '2':
                            data.find('#ddlCancelResonID').attr('disabled', true);
                            data.find('#ddlCancelResonID').val(0);
                            data.find('.fa-folder-open').show();
                            break;
                        case '3':
                            data.find('#ddlCancelResonID').removeAttr('disabled');
                            data.find('.fa-folder-open').hide();
                            break;
                        case '4':
                            data.find('#ddlCancelResonID').removeAttr('disabled');
                            data.find('.fa-folder-open').hide();
                            break;
                    }

                    $('#ddlCancelResonID').change(function (e) {
                        var ddlReceivedItemStatusID = $(this).closest('tr').find("#ddlReceivedItemStatusID").val();
                        //console.log(ddlReceivedItemStatusID);
                        if ($(this).val() == 7)
                        {
                            modalWaring("สาเหตุนี้กรณี Call Centre ติดต่อไม่ได้ และจะเลือกโดยระบบเท่านั้น");
                            $(this).val(0);
                            return false;
                        }
                        else if (($(this).val() == 9 || $(this).val() == 10) && ddlReceivedItemStatusID != 4)
                        {
                            modalWaring("สาเหตุนี้ เฉพาะกรณีเลือกสถานะเป็น Pending เท่านั้น");
                            $(this).val(0);
                            return false;
                        }
                        else if (($(this).val() != 9 && $(this).val() != 10) && ddlReceivedItemStatusID == 4)
                        {
                            modalWaring("สาเหตุนี้ เฉพาะกรณีเลือกสถานะเป็น ไม่ดำเนินการ เท่านั้น");
                            $(this).val(0);
                            return false;
                        }

                    });//alert สาเหตุกรณีไม่ดำเนินการ หรือ Pending

                }
                function onChangePriceType(val)
                {
                    switch (val) {
                        case '0':
                            break;
                        case '1':
                            $('#customerBillingPrice').attr('readonly', true);
                            $('#customerBillingPrice').val(objPrice.customerPackagePrice || '0.00');
                            $('#vendorPackagePrice').attr('readonly', true);
                            $('#vendorWagePrice').attr('readonly', true);
                            $('#vendorPackagePrice').val(objPrice.vendorPackagePrice || '0.00')
                            $('#vendorWagePrice').val('0.00')
                            break;
                        case '2':
                            $('#customerBillingPrice').attr('readonly', true);
                            $('#customerBillingPrice').val(objPrice.customerWagePrice || '0.00');
                            $('#vendorPackagePrice').attr('readonly', true);
                            $('#vendorWagePrice').attr('readonly', true);
                            $('#vendorPackagePrice').val('0.00')
                            $('#vendorWagePrice').val(objPrice.vendorWagePrice || '0.00')
                            break;
                        case '3':
                            $('#customerBillingPrice').removeAttr('readonly');
                            $('#customerBillingPrice').val('0.00');
                            $('#vendorPackagePrice').removeAttr('readonly');
                            $('#vendorWagePrice').attr('readonly', true);
                            $('#vendorPackagePrice').val('0.00')
                            $('#vendorWagePrice').val('0.00')
                            break;
                        case '4':
                            $('#customerBillingPrice').removeAttr('readonly');
                            $('#customerBillingPrice').val('0.00');
                            $('#vendorPackagePrice').attr('readonly', true);
                            $('#vendorWagePrice').removeAttr('readonly');
                            $('#vendorPackagePrice').val('0.00')
                            $('#vendorWagePrice').val('0.00')
                            break;
                    }
                    calTotalPrice();
                }
                // onChange Flag CustomerMaterialPrice
                function onChangeFlagCustomerMaterialPrice() {
                    if ($('#flagCustomerMaterialPrice').prop('checked')) {
                        $('#customerMaterialPrice').removeAttr('readonly');
                        $('#vendorMaterialPrice').removeAttr('readonly');
                    } else {
                        $('#customerMaterialPrice').attr('readonly', true);
                        $('#vendorMaterialPrice').attr('readonly', true);
                        $('#customerMaterialPrice').val('0.00');
                        $('#vendorMaterialPrice').val('0.00');
                    }
                }

                // delete QuotationItemById
                function deleteQuotationItem(ele, id) {
                    var body = {
                        quotationGoodsItemId: id,
                        updatedBy: '@UserDetail.CodeName'
                    }
                    ajaxDelete(`${baseUrl}/homecare/api/v1/quotation/deletequotationgoodsitem`, body, response => {
                        if (response) {
                            $(ele).parent().parent().remove();
                            $.each($('#quotationItemDetailTBody tr'), (i, d) => {
                                $(d).find('td:first').text(i + 1);
                            })
                            $.each($('#preQuotationItemDetailTBody tr'), (i, d) => {
                                if (i == (+$(ele).parent().parent().find('td:first').text().trim() - 1)) {
                                    d.remove();
                                }
                            });
                            $.each($('#preQuotationItemDetailTBody tr'), (i, d) => {
                                $(d).find('td:first').text(i + 1);
                                $($($(d).find('td')[7]).attr('id', 'itemPrice' + (i + 1)));
                            });
                            calAllTotalPrice();
                            calCostValueNet();
                        }
                    })
                }
                // On Select other quotation
                async function onChangeQuotationGoodsName() {
                    var temp = quotationList.filter(quotation => quotation.quotationGoodsId == $('#ddlQuotationGoodsName').val());
                    //console.log('temp', temp);
                    await getQuotation(temp[0].quotationGoodsId);
                    if (receiveData.data.mainProcessId == 6) {
                        //Edit by Adisorn
                        //$('#DdlGoodsType').attr('disabled', 1);
                        //$('#DdlGoodsOrderCondition').attr('disabled', 1);
                        //$('#DdlGoodsOrderStatus').attr('disabled', 1);
                        //$('#txtGoodsRemark').attr('disabled', 1);
                        //Edit by Adisorn
                    } else if (temp[0].quotationGoodsId == quotationList[quotationList.length - 1].quotationGoodsId && (temp[0].approvedStatusId != 1 && temp[0].approvedStatusId != 2)) {
                        for (var i = 1; i <= $('#discountTBody tr').length; i++) {
                            $('#ddlCostType' + i).removeAttr('disabled');
                            $('#ddlCostUnit' + i).removeAttr('disabled');
                        }
                        for (var i = 0; i < chargeList.length; i++) {
                            $('#chargeValue' + i).removeAttr('disabled');
                            $('#ddlChargeUnit' + i).removeAttr('disabled');
                        }
                    }
                }
                // Onchange flagChangeRequest
                function onchangeflagChangeRequest() {
                    if (!validateflagChangeRequest()) {
                        $('#flagChangeRequest').prop('checked', 0);
                        return false;
                    }
                    toggleById(DdlCustomerCancelQuotationReason)
                }
                // Remove receiveItem before save
                function removeReceiveItem() {
                    $('#ReceiveItemTBody tr:last').remove();
                }
                // Enabled ddlReceiveItemDetailOverAppointmentDateReason
                function onChangeReceivItemDetailAppointmentDateForm(index, date = null) {
                    var selectedDate = date ? new Date(reorganizeDateFormat(date)) : new Date(reorganizeDateFormat($('#receivItemDetailAppointmentDateForm' + index).val()));
                    var receiveRealDate = new Date(receiveData.data.receiveAppointmentDateReal);
                    //If more than 1 day (2 or more): enabled ddlReason
                    if (((selectedDate - receiveRealDate) / 8.64e+7) > 3) {
                        $('#ddlReceiveItemDetailOverAppointmentDateReason' + index).removeAttr('disabled');
                    } else {
                        $('#ddlReceiveItemDetailOverAppointmentDateReason' + index).attr('disabled', 1);
                        $('#ddlReceiveItemDetailOverAppointmentDateReason' + index).val(0);
                    }
                }
                    // ========================================================================= OpenModal =========================================================================
                    // Open extended history modal
                    async function openModalExtendedHistory() {
                        await page.loading();
                        ajaxGet(`${baseUrl}/homecare/api/v1/Appointment/PostponeInvestigationAppointmentHistory/` + receiveId, response => {
                            if (response.data.length > 0) {
                                $('#tbodyExtendedAppointmentHistory').empty();
                                $.each(response.data, (i, d) => {
                                    $('#tbodyExtendedAppointmentHistory').append(`
						<tr>
							<td>${d.row}</td>
							<td>${d.extendApproveFlag}</td>
							<td>${d.createdBy} </td>
							<td>${d.receiveAppointmentOld}</td>
							<td>${d.receiveAppointmentNew}</td>
							<td>${d.description}</td>
							<td>${d.extendRemark}</td>
							<td>${d.extendRemarkCc}</td>
							<td>${d.updatedBy}</td>
						</tr>
					`)
                                })
                            }
                            $("#modalExtendedAppointmentHistory").modal('show');
                            page.loaded();;
                        });
                    }
                    // Open extend appointment modal
                    async function openModalExtendedAppointment() {
                        // Get extended reasons
                        await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/PostponeAppointmentReason/1`, (response) => {
                            bindingDdlist('ddlExtendedResonID', response.data, 0);
                        });
                        // Check if can extend appointment
                        if ("@UserDetail.Role" != "@EnumConfiguration.Role.CallCentre.ToString()") {
                            var cannotExtend = await ajaxGet(`${baseUrl}/homecare/api/v1/Appointment/CheckChangeAppointment/R/${receiveId}`, response => {
                                if (response && response.data) {
                                    modalWaring(response.data);
                                    return true;
                                }
                                return false;
                            });
                            if (cannotExtend) {
                                return false;
                            }
                        }
                        // Get extended appointment
                        ajaxGet(`${baseUrl}/homecare/api/v1/Appointment/ReceiveAppointment/${receiveId}`, response => {
                            // If user role is call centre
                            if (response.data.length > 0 && "@UserDetail.Role" == "@EnumConfiguration.Role.CallCentre.ToString()") {
                                $("#ExtendedReceiveAppointmentDate").val(response.data[0].extReceiveAppointmentDate);
                                if(response.data[0].extReceiveAppointmentTimeFrom == null && response.data[0].extReceiveAppointmentTimeTo == null) {
                                    $("#ExtendedReceiveAppointmentTimeForm").val('');
                                    $("#ExtendedReceiveAppointmentTimeTo").val('');
                                } else {
                                    $("#ExtendedReceiveAppointmentTimeForm").val(response.data[0].extReceiveAppointmentTimeFrom);
                                    $("#ExtendedReceiveAppointmentTimeTo").val(response.data[0].extReceiveAppointmentTimeTo);
                                }
                                $("#ddlExtendedResonID").val(response.data[0].extendedReasonId);
                                $("#txtExtendRemark").val(response.data[0].extendedRemark);
                                $("#txtExtendRemarkCC").val(response.data[0].extendedRemarkCC);

                                if ("@EnumConfiguration.Role.CallCentre.ToString()" == "@UserDetail.Role" && (response.data[0].extReceiveAppointmentDate != '' && response.data[0].extendedApproveFlag==null)) {
                                    $("[name='rdoConfirm']").prop('disabled', false);
                                    $("#txtExtendRemarkCC").prop('disabled', false);
                                    $('#btnUpdateExtended').prop('disabled', false);
                                } else if ("@EnumConfiguration.Role.CallCentre.ToString()" == "@UserDetail.Role" && (response.data[0].extendedApproveFlag==true || response.data[0].extendedApproveFlag==false)) {
                                    //$('#chkExtendedConfirm').prop('disabled', true);
                                    $("[name='rdoConfirm']").prop('disabled', true);
                                    $("#txtExtendRemarkCC").prop('disabled', true);
                                    $('#btnUpdateExtended').prop('disabled', true);
                                } else if ("@EnumConfiguration.Role.CallCentre.ToString()" != "@UserDetail.Role") {
                                    //$('#chkExtendedConfirm').prop('disabled', true);
                                    $("[name='rdoConfirm']").prop('disabled', true);
                                    $("#txtExtendRemarkCC").prop('disabled', true);
                                    $('#btnUpdateExtended').prop('disabled', false);
                                } else {
                                    //$('#chkExtendedConfirm').prop('disabled', true);
                                    $("[name='rdoConfirm']").prop('disabled', true);
                                    $("#txtExtendRemarkCC").prop('disabled', true);
                                    $('#btnUpdateExtended').prop('disabled', true);
                                }

                                if ("@EnumConfiguration.Role.CallCentre.ToString()" == "@UserDetail.Role") {
                                    $("#ExtendedReceiveAppointmentDate").prop('disabled', true);
                                    $("#ExtendedReceiveAppointmentTimeForm").prop('disabled', true);
                                    $("#ExtendedReceiveAppointmentTimeTo").prop('disabled', true);
                                    $("#ddlExtendedResonID").prop('disabled', true);
                                    $("#txtExtendRemark").prop('disabled', true);
                                    //$("#chkExtendedConfirm").prop('checked',response[0].ExtendedApproveFlag);
                                }
                                $("input[name=rdoConfirm][value=" + response.data[0].extendedApproveFlag + "]").attr('checked', 1);
                            } else {
                                $("#ExtendedReceiveAppointmentDate").val("");
                                $("#ExtendedReceiveAppointmentTimeForm").val("");
                                $("#ExtendedReceiveAppointmentTimeTo").val("");
                            }
                            $("#modalExtendedAppointment").modal('show');
                        });
                    }
                    // Open upload image before modal
                    async function openModalUploadImageBefore() {
                        if (!validateUploadImageBefore()) {
                            return false;
                        }
                        await page.loading();
                        $('#rowOfImageInput').empty();
                        for (var i = 0; i < receiveItemList.length; i++) {
                            await InitailModalFileUpload(receiveItemList[i].receiveItemId, i);
                            $('#rowOfImageInput').append(`
					<div class="box box-default" id="ItemImage${i}" >
						<div class="box-header with-border cursor-pointer" data-toggle="collapse" data-target="#ItemImage-detail${i}" aria-expanded="true" aria-controls="ItemImage-detail${i}" st>
							<a>
								<h3 class="box-title "><i class="fa fa-picture-o"></i> รูปรายการแจ้งซ่อมที่ ${i + 1}</h3>
							</a>
						</div>
						<div class="box-body collapse" id="ItemImage-detail${i}">
							<div class="row">
								<div class="col-xs-12">
									<input id="fileInput${i}" name="file" type="file" multiple />
								</div>
							</div>
						</div>
					</div>
				`);
                            $('#modalUploadImageBefore').on('shown.bs.modal', function () {
                                $('.kv-file-remove.btn.btn-sm.btn-kv.btn-default.btn-outline-secondary').hide();
                            });
                        }
                        page.loaded();;
                        $('#modalUploadImageBefore').modal('show');
                    }
                    // Open quotation history modal
                    function openModalQuotationHistory() {
                        if (quotationList.length > 0) {
                            $('#quotationHistoryTBody').empty();
                            $.each(quotationList, (i, d) => {
                                $('#quotationHistoryTBody').append(`
				<tr>
					<td>
						${i + 1}
					</td>
					<td>
						${d.quotationGoodsName}
					</td>
					<td>
						${d.approverName || ''}
					</td>
					<td>
						${d.approverRemark || ''}
					</td>
					<td>
						${thaiFormatDate(d.approvedDate) || ''}
					</td>
					<td>
						${d.orderTypeDescription}
					</td>
					<td>
						${d.orderConditionDescription}
					</td>
					<td>
						${d.orderStatusDescription}
					</td>
					<td>
						${d.remark}
					</td>
					<td>
						${d.paymentStatusDescription}
					</td>
					<td ${d.customerReasonDescription ? 'style="background-color: #ff6666;"' : ''}>
						${d.customerReasonDescription || ''}
					</td>
				</tr>
			`) // TODO ผู้อนุมัติ ความคิดเห็น วันที่อนมัติ
                            })
                        }
                        $("#modalQuotationHistory").modal('show');
                    }
                    // Open edit quotation modal
                    async function openModaldetailPriceRepair() {
                        await page.loading();
                        getQuotation();
                        bindingDdlist('DdlReceiveItemList', ddlReceiveItemList, 0);
                        ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/FixingCategoriesByUnitID?repairTypeId=${receiveData.data.repairTypeId}&unit_id=${unitID}`, response => {
                            bindingDdlist('DdlFixingCategories', response.data, 0);
                            page.loaded();;
                        });
                        bindingDdlist('ddlBillingType', ddlBillingType.data, 0);
                        $('#txtPriceRepairProject').text(customerData.data.projectNameTh);
                        $('#txtPriceRepairUnit').text(customerData.data.unitCodeAddress);
                        $("#modalDetailPriceRepair").modal('show');
                    }

                    async function openModalViewEachImageBefore(receiveId, index) {
                        await page.loading();
                        //logging(index);
                        $('#rowOfImageInput').empty();
                        await InitailModalFileUpload(receiveId, index);
                        $('#rowOfImageInput').append(`
				<div class="box box-default" id="ItemImage${index}">
					<div class="box-header with-border cursor-pointer" data-toggle="collapse" data-target="#ItemImage-detail${index}" aria-expanded="true" aria-controls="ItemImage-detail${index}">
						<a >
							<h3 class="box-title"><i class="fa fa-picture-o"></i> รูปรายการแจ้งซ่อมที่ ${index + 1}</h3>
						</a>
					</div>
					<div class="box-body collapse in" id="ItemImage-detail${index}">
						<div class="row">
							<div class="col-xs-12">
								<input id="fileInput${index}" name="file" type="file" multiple />
							</div>
						</div>
					</div>
				</div>
			`);
                        page.loaded();;
                        $('#modalUploadImageBefore').modal('show');

                    }

        async function openModalReceivedItemsDetail(receiveItemId) {
            $('#txtReceiveItemProject').text(customerData.data.projectNameTh);
            $('#txtReceiveItemUnit').text(customerData.data.unitCodeAddress);
            var thisItem = receiveItemList.filter(element => element.receiveItemId == receiveItemId)[0];
            //หัวข้อหลักใน Modal
            $("#MainDataInModal").empty();
            $("#MainDataInModal ").append(`
				<div class="col-xs-12 col-sm-6 col-lg-4">
					<h5> หมวดงาน: <span class="text text-primary">${thisItem.guaranteeDescription}</span></h5>
				</div>
			`);
            $("#MainDataInModal").append(`
				<div class="col-xs-12 col-sm-6 col-lg-2">
					<h5> รายละเอียดการแจ้ง: <span class="text text-primary">${thisItem.detail}</span></h5>
				</div>
			`);
            receiveItemModalGuaranteeId = thisItem.guaranteeId;
            receiveItemModalId = receiveItemId;
            ajaxGet(`${baseUrl}/homecare/api/v1/Receive/GetReceiveItemModal/${receiveItemId}`, async response => {
                //logging('ReceiveItemModal', response);
                if (response.data.specL1Id) {
                    bindingDdlist('ddlReceiveItemMainWorkType', ddlMainWorkType.data, response.data.specL1Id);
                    bindingDdlist('ddlReceiveItemWorkIssue', ddlWorkIssue.data, response.data.causeId);
                    var promises = [
                        onChangeMainWorkType(response.data.specL1Id, response.data.specL2Id, response.data.locationId),
                        onChangeSubWorkType(response.data.specL2Id, response.data.specL3Id)
                    ]
                    await Promise.all(promises);

                    if (worksheetCreateFlag == true) {
                        $("#editData").removeClass('hidden');
                    } else {
                        $("#editData").addClass('hidden');
                    }
                    onChangeWorkDetail(response.data.specL3Id);
                    checkDupFix();


                    if (flagEdit == true) {
                        $('#lbStatusEditData').show();
                        $('#lbEmpEditData').text(empApproveEditData).show();
                        $('#editData').hide();
                    } else {
                        $('#lbStatusEditData').hide();
                        $('#lbEmpEditData').hide();
                        $('#editData').show();
                    }


                } else {
                    bindingDdlist('ddlReceiveItemMainWorkType', ddlMainWorkType.data, 0);
                    bindingDdlist('ddlReceiveItemWorkIssue', ddlWorkIssue.data, 0);
                    bindingDdlist('ddlReceiveItemSubWorkType', [ddlWorkIssue.data[0]], 0);
                    bindingDdlist('ddlReceiveItemWorkDetail', [ddlWorkIssue.data[0]], 0);
                    bindingDdlist('ddlReceiveItemLocation', [ddlWorkIssue.data[0]], 0);
                    $('#txtReceiveItemPriority').val('');
                }
            });
            await ajaxGet(`${baseUrl}/homecare/api/v1/Receive/GetReceiveItemDetail/${receiveItemId}`, async response => {
                //logging('ReceiveItemDetail', response);
                $('#tbodySubReceiveItem').empty();
                worksheetCreateFlag = false;
                if (response.data.length > 0) {
                    $.each(response.data, (i, d) => {
                        addTableReceiveItemDetailRow(d.repairAppointmentDateReasonId, d.statusId, d.worksheetCreateFlag, false);
                        $('#ReceiveItemDetailId' + (i + 1)).val(d.receiveItemDetailId);
                        $('#receiveItemDetailVendorName' + (i + 1)).val(d.propertyName);
                        $('#receiveItemDetailVendorCode' + (i + 1)).val(d.vendorId);
                        $('#receivItemDetailAppointmentDateForm' + (i + 1)).val(d.repairAppointmentDateFrom);
                        $('#receivItemDetailAppointmentDateTo' + (i + 1)).val(d.repairAppointmentDateTo);
                        $('#txtReceiveItemDetailRemark' + (i + 1)).val(d.remark);
                        onChangeReceivItemDetailAppointmentDateForm(i + 1, d.repairAppointmentDateFrom);
                        d.worksheetCreateFlag ? ($('#FlagworksheetCreated' + (i + 1)).show(), $('#btnRemoveSubItem' + (i + 1)).hide(), $('#ddlReceiveItemDetailOverAppointmentDateReason' + (i + 1)).attr('disabled', 1)) : ($('#FlagworksheetCreated' + (i + 1)).hide(), $('#btnRemoveSubItem' + (i + 1)).show());
                        if (d.worksheetCreateFlag) {
                            worksheetCreateFlag = true;
                        }


                    })

                } else {
                    addTableReceiveItemDetailRow();
                }





        });
        if (worksheetCreateFlag) {
            $('#boxReceivedRepair').find('input, select').attr('disabled', 1);
        } else {
            $('#boxReceivedRepair').find('input, select').removeAttr('disabled');
        }
        $('#modalReceivedItemsDetail').modal('show');
        }
        function openModalCloseReceiveRepair() {
            $('#modalCloseReceiveRepair').modal('show');
        }

        function openModalConfirmWithReason(title, txt, func, require) {
            $('#confirmTitle').text(title);
            $('#confirmTxtReason').text(txt);
            require ? $('#confirmStarReason').show() : $('#confirmStarReason').hide();
            $('#confirmBtn').removeAttr('onclick');
            $('#confirmBtn').attr('onclick', func + `(); $('#modalConfirmWithReason').modal('hide')`);
            $('#modalConfirmWithReason').modal('show');
        }

        function openModalConfirmWOR(title, txt, func) {
            $('#confirmTitleWOR').text(title);
            $('#confirmTxt').text(txt);
            $('#confirmBtnWOR').removeAttr('onclick');
            $('#confirmBtnWOR').attr('onclick', func + `(); $('#modalConfirm').modal('hide')`);
            $('#modalConfirm').modal('show');
        }
        // =============================================================================== AllSave ===================================================================================
        // Save extended appointment
        async function saveModalExtendedAppointment() {
            if (!validateExtendPanel()) {
                return false;
            }
            await page.loading();

            var body = {
                receiveId: receiveId,
                receiveAppointmentDate: reorganizeDateFormat($('#ExtendedReceiveAppointmentDate').val()),
                extReceiveAppointmentFromTime: $('#ExtendedReceiveAppointmentTimeForm').val(),
                extReceiveAppointmentToTime: $('#ExtendedReceiveAppointmentTimeTo').val(),
                extendReasonId: $('#ddlExtendedResonID option:selected').val(),
                extendReasonRemark: $('#txtExtendRemark').val() ? $('#txtExtendRemark').val() : null,
                extendedReasonRemarkCC: $('#txtExtendRemarkCC').val() ? $('#txtExtendRemarkCC').val() : null,
                extendedApproveFlag: '@EnumConfiguration.Role.CallCentre.ToString()' == '@UserDetail.Role' ? $("input[name='rdoConfirm']:checked").val() : null,
                createdBy: '@UserDetail.CodeName'
            };

            ajaxPost(`${baseUrl}/homecare/api/v1/Appointment/PostponeInvestigationAppointment`, body, response => {
                if (response) {
                    page.loaded();;
                    modalSuccess();
                    $('#notificationModal').on('hidden.bs.modal', () => {
                        page.loading();
                        window.location.reload();
                    })
                }
            });


        }
        // Save receive page
        async function saveReceiveRepair()
        {
            if (!validateReceivePanel() || !validateSaveCustomerChange()) {
                return false;
            }

            await page.loading();
            var success = true;
            var refresh = false;
            // แถบข้อมูลรับเรื่อง
            if (!receiveData.data.receiveAppointmentDateReal) {
                var body = {
                    userCode: '@UserDetail.CodeName',
                    userId: '@UserDetail.UserID',
                    receiveId: receiveId,
                    receiveStatusId: $('#ddlReceivedStatusID').val(),
                    receiveHCRemark: $('#ReceiveHCRemark').val() ? $('#ReceiveHCRemark').val() : null,
                    receiveCCRemark: $('#ReceiveCCRemark').val() ? $('#ReceiveCCRemark').val() : null,
                    receiveConfirmStatusId: 0,
                    receiveConfirmRemark: '',
                    receiveAppointmentDateFormatDate: reorganizeDateFormat($('#ReceiveAppointmentDate').val()),
                    receiveAppointmentTimeFrom: $('#ReceiveAppointmentTimeForm').val(),
                    receiveAppointmentTimeTo: $('#ReceiveAppointmentTimeTo').val(),
                    ddlOverAPDateReasonId: $('#ddlReceiveOverAppointmentDateReason').val() || 0,
                    receiveAppointmentDateReal: reorganizeDateFormat($('#ReceiveAppointmentDateReal').val())
                };

                var updated = await ajaxPut(`${baseUrl}/homecare/api/v1/Receive/UpdateReceive`, body);
                if (!updated) {
                    success = false;
                } else {
                    refresh = true;
                }
            }
            // แถบข้อมูลใบเสนอราคา งานสั่งซื้อสินค้า
            if (Object.keys(lastQuotationGoods).length) {
                // อัพเดทใบเสนอราคา งานสั่งซื้อสินค้า
                var updateBody = {
                    quotationGoodsId: lastQuotationGoods.quotationGoodsId,
                    //edit by adisorn
                    orderTypeId: null,
                    orderConditionId: null,
                    orderStatusId: null,
                    orderRemark: null,
                    //edit by adisorn

                    updatedBy: '@UserDetail.CodeName'
                }
                var updated = await ajaxPut(`${baseUrl}/homecare/api/v1/Quotation/UpdateQuotationGoods`, updateBody);
                if (!updated) {
                    success = false;
                }
                if (validateInsertQuotationCostItem()) {
                    // ลบรายการสินค้า ออกจากใบเสนอราคา
                    var deleteBody = {
                        quotationGoodsId: lastQuotationGoods.quotationGoodsId,
                        updatedBy: '@UserDetail.CodeName'
                    }
                    var deleted = await ajaxDelete(`${baseUrl}/homecare/api/v1/Quotation/DeleteQuotationGoodsCost`, deleteBody);
                    if (!deleted) {
                        success = false;
                    } else {
                        // เพิ่มรายการสินค้า ให้กับใบเสนอราคา
                        var insertBody = [];
                        var count = 1;
                        for (var i = 1; i <= $('#discountTBody tr').length; i++) {
                            var body = {
                                no: count++,
                                quotationGoodsId: lastQuotationGoods.quotationGoodsId,
                                costTypeId: $('#ddlCostType' + i).val(),
                                costValue: $('#costValue' + i).val(),
                                unitsId: $('#ddlCostUnit' + i).val(),
                                costValueNet: $('#totalPriceAfterDiscount').text(),
                                totalCostNet: $('#totalPriceNet').text(),
                                createdBy: '@UserDetail.CodeName',
                                insertType: 'customer',
                                vendorVat: 0
                            }
                            if ($('#ddlCostType' + i).val() && $('#costValue' + i).val()) {
                                insertBody.push(body);
                            }
                        }
                        for (var i = 1; i <= $('#DivChargeDetail .row').length; i++) {
                            body = {
                                no: count++,
                                quotationGoodsId: lastQuotationGoods.quotationGoodsId,
                                costTypeId: chargeList[i].id,
                                costValueNet: $('#totalPriceAfterDiscount').text(),
                                operateCostValue: $('#chargeValue' + i).val(),
                                unitsId: unitID,
                                totalCostNet: $('#totalPriceNet').text(),
                                createdBy: '@UserDetail.CodeName',
                                insertType: 'customer',
                                vendorVat: 0
                            }
                            insertBody.push(body);
                        }
                        var inserted = await ajaxPost(`${baseUrl}/homecare/api/v1/Quotation/InsertQuotationGoodsCost`, insertBody);
                        if (!inserted) {
                            success = false;
                        } else {
                            refresh = true;
                        }

                        ////Insert vendor quotation cost
                        var insertBody = [];
                        for (var i = 1; i <= 1; i++)
                        {
                            body = {
                                quotationGoodsId: lastQuotationGoods.quotationGoodsId,
                                costTypeId: 0,
                                costValueNet: (+$('#preVendorTotalPrice').text()),
                                operateCostValue: $('#vendorOperateValue').val(),
                                unitsId: unitID,
                                totalCostNet: $('#vendorTotalPriceNet').text(),
                                createdBy: '@UserDetail.CodeName',
                                insertType: 'vendor',
                                vendorVat:  $('#vendorVatValue').val()
                            }
                            insertBody.push(body);
                        }

                        inserted = await ajaxPost(`${baseUrl}/homecare/api/v1/Quotation/InsertQuotationGoodsCost`, insertBody);

                        if (!inserted) { success = false; } else { refresh = true; }
                    }
                }
            }
            if ($('#flagChangeRequest').prop('checked')) {
                var updateBody = {
                    quotationGoodsId: lastQuotationGoods.quotationGoodsId,
                    customerCancelReasonId: $('#DdlCustomerCancelQuotationReason').val(),
                    updatedBy: '@UserDetail.CodeName'
                }
                //console.log(updateBody);
                var updated = await ajaxPut(`${baseUrl}/homecare/api/v1/Quotation/UpdateQuotationGoods`, updateBody);
                if (!updated) {
                    success = false;
                } else {
                    refresh = true;
                }
            }
            // แถบข้อมูลแจ้งซ่อม
            if (changeReceiveItemList.length > 0)
            {
                for (var i = 0; i < changeReceiveItemList.length; i++)
                {
                    data = $('#ReceiveItemTBody #' + changeReceiveItemList[i]);

                    receivedItemStatus = data.find('#ddlReceivedItemStatusID').val();

                    if (receivedItemStatus == 3 || receivedItemStatus == 4) {

                        receivedItemCancelReasonId = data.find('#ddlCancelResonID').val() == null ? 0 : data.find('#ddlCancelResonID').val();

                        if (receivedItemCancelReasonId == 0) {
                            modalWaring("กรุณาระบุ สาเหตุกรณีไม่ดำเนินการ หรือ Pending");
                            page.loaded();
                            return false;
                        }
                    }

                    var body = {
                        receiveItemId: changeReceiveItemList[i],
                        receivedItemRemark: data.find('#txtItemRemark').val(),
                        receivedItemStatus: data.find('#ddlReceivedItemStatusID').val() || 0,
                        receivedItemFlagRepairTransfer: data.find('#ddlRepairID').val() || 0,
                        receivedItemCancelReasonId: data.find('#ddlCancelResonID').val() || 0,
                        userCode: "@UserDetail.CodeName"
                    }

                    var updated = await ajaxPut(`${baseUrl}/homecare/api/v1/Receive/UpdateReceiveItem`, body);

                    if (!updated)
                    {
                        success = false;
                    }
                    else { refresh = true; }
                }
            }
            if (success) {
                modalSuccess();
                if (refresh) {
                    $('#notificationModal').on('hidden.bs.modal', () => {
                        page.loading();
                        window.location.reload(true);
                    });
                }
                sessionStorage.reloadAfterPageLoad = true;
                page.loaded();
            }
        }
        // Insert quotation item
        async function createQuotationItem() {
            if (!validateQuotationItem()) {
                return false;
            }
            await page.loading();
            var body = {
                quotationGoodsId: lastQuotationGoods.quotationGoodsId,
                receiveItemId: $('#DdlReceiveItemList').val() || 0,
                workCategoryId: $('#DdlFixingCategories').val(),
                workDetailId: $('#DdlFixingDetail').val(),
                customerPackagePrice: $('#ddlBillingType').val() == 1 || $('#ddlBillingType').val() == 3 ? (Math.round($('#customerBillingPrice').val() * 100) / 100).toFixed(2) : 0.00,
                customerWagePrice: $('#ddlBillingType').val() == 2 || $('#ddlBillingType').val() == 4 ? (Math.round($('#customerBillingPrice').val() * 100) / 100).toFixed(2) : 0.00,
                customerMaterialPrice: $('#customerMaterialPrice').val(),
                vendorPackagePrice: $('#ddlBillingType').val() == 1 ? roundFixed(objPrice.vendorPackagePrice) : $('#ddlBillingType').val() == 3 ? (Math.round($('#vendorPackagePrice').val() * 100) / 100).toFixed(2) : 0.00,
                vendorWagePrice: $('#ddlBillingType').val() == 2 ? roundFixed(objPrice.vendorWagePrice) : $('#ddlBillingType').val() == 4 ? (Math.round($('#vendorWagePrice').val() * 100) / 100).toFixed(2) : 0.00,
                vendorMaterialPrice: $('#vendorMaterialPrice').val(),
                quantity: $('#materialQuantity').val(),
                packagePriceType: $('#ddlBillingType').val() == 1 ? 1 : $('#ddlBillingType').val() == 3 ? 2 : 0,
                wagePriceType: $('#ddlBillingType').val() == 2 ? 1 : $('#ddlBillingType').val() == 4 ? 2 : 0,
                remark: $('#QuotationItemRemark').val(),
                username: '@UserDetail.CodeName'
            };
            ajaxPost(`${baseUrl}/homecare/api/v1/Quotation/InsertQuotationGoodsItem`, body, (response) => {
                page.loaded();
                var materialQuantity = roundFixed($('#materialQuantity').val());
                if (response) {
                    modalSuccess();
                    $('#quotationItemDetailTBody').append(`
						<tr>
							<td>
								${$('#quotationItemDetailTBody tr').length + 1}
							</td>
							<td>
								${$('#DdlFixingCategories option:selected').text()}
							</td>
							<td>
								${$('#DdlFixingDetail option:selected').text()}
							</td>
							<td>
								${$('#ddlBillingType').val() == 1 ? roundFixed($('#customerBillingPrice').val(), 2) : '0.00'}
							</td>
							<td>
								${$('#ddlBillingType').val() == 2 ? roundFixed($('#customerBillingPrice').val(), 2) : '0.00'}
							</td>
							<td>
								${$('#ddlBillingType').val() == 3 ? roundFixed($('#customerBillingPrice').val(), 2) : '0.00'}
							</td>
							<td>
								${$('#ddlBillingType').val() == 4 ? roundFixed($('#customerBillingPrice').val(), 2) : '0.00'}
							</td>
							<td>
								${$('#customerMaterialPrice').val()}
							</td>
							<td>
								${$('#txtVendorFixPriceUnit').text()}
							</td>
							<td>
								${materialQuantity}
							</td>
							<td>
								${$('#TotalPrice').text()}
							</td>
							<td>
								${$('#QuotationItemRemark').val()}
							</td>
							<td>
								<i class="fa fa-close cursor-pointer" onclick="deleteQuotationItem(this, ${response.data.quotationGoodsItemId})"></i>
							</td>
						</tr>
					`)// TODO Delete Function
                    $('#preQuotationItemDetailTBody').append(`
						<tr>
							<td class="text-center">
								${$('#preQuotationItemDetailTBody tr').length + 1}
							</td>
							<td>
								${$('#DdlFixingCategories option:selected').text()}
							</td>
							<td>
								${$('#DdlFixingDetail option:selected').text()}
							</td>
							<td>
								${$('#ddlBillingType').val() == 1 || $('#ddlBillingType').val() == 2 ? roundFixed($('#customerBillingPrice').val()) : '0.00'}
							</td>
							<td>
								${$('#ddlBillingType').val() == 3 || $('#ddlBillingType').val() == 4 ? roundFixed(+$('#customerBillingPrice').val() + +$('#customerMaterialPrice').val()) : roundFixed($('#customerMaterialPrice').val())}
							</td>
							<td>
								${materialQuantity}
							</td>
							<td>
								${$('#txtVendorFixPriceUnit').text()}
							</td>
							<td id="itemPrice${$('#preQuotationItemDetailTBody tr').length + 1}">
								${$('#TotalPrice').text()}
							</td>
							<td>
								${$('#QuotationItemRemark').val()}
							</td>
						</tr>
					`)
                    calAllTotalPrice();
                    calCostValueNet();
                }
            });

        }
        // UpdateSert ReceivedItemsModal and create ReceivedItemsDetail
        async function saveModalReceivedItemsDetail() {
            if (!validateRepairDetailPanel() || !validateRepairVendorPanel()) {
                return false;
            }
            await page.loading();
            if (!worksheetCreateFlag) {
                var bodyModal = {
                    receiveItemId: receiveItemModalId,
                    specL1Id: $('#ddlReceiveItemMainWorkType').val(),
                    specL2Id: $('#ddlReceiveItemSubWorkType').val(),
                    specL3Id: $('#ddlReceiveItemWorkDetail').val(),
                    locationId: $('#ddlReceiveItemLocation').val(),
                    causeId: $('#ddlReceiveItemWorkIssue').val(),
                    duplicatedFixid: $('#flagReceiveItemDuplicateFix').val(),
                    userCode: '@UserDetail.CodeName'
                };
                //logging('bodyModal', bodyModal);
                var success = await ajaxPut(`${baseUrl}/homecare/api/v1/Receive/UpdateReceiveItemModal`, bodyModal);
                if (!success) {
                    modalWaring("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
                    page.loaded();;
                    return false;
                } else {
                    if ($('#tbodySubReceiveItem tr').length > 0) {
                        modalSuccess();
                        page.loaded();;
                    }
                }
            }
            for (var i = 0; i < $('#tbodySubReceiveItem tr').length; i++) {

                //For skipping row
                if (isEmptyInput("ddlReceiveItemDetailStatus" + (i + 1)) &&
                    isEmptyInput("receiveItemDetailVendorName" + (i + 1)) &&
                    isEmptyInput("ddlReceiveItemDetailWorkType" + (i + 1)) &&
                    isEmptyInput("receivItemDetailAppointmentDateForm" + (i + 1)) &&
                    isEmptyInput("receivItemDetailAppointmentDateTo" + (i + 1)) &&
                    isEmptyInput("ddlReceiveItemDetailOverAppointmentDateReason" + (i + 1))) {

                    if (i + 1 == $('#tbodySubReceiveItem tr').length) {
                        page.loaded();;
                        $("#modalReceivedItemsDetail").modal("hide");
                    }
                    //console.log("skip" + (i + 1));
                    continue;
                }
                //console.log("pass" + (i + 1));
                if ($('#receiveItemDetailVendorName' + (i + 1)).val().trim()) {
                    var bodyDetail = {
                        receiveItemId: receiveItemModalId,
                        id: $('#ReceiveItemDetailId' + (i + 1)).val(),
                        no: (i + 1),
                        statusId: $('#ddlReceiveItemDetailStatus' + (i + 1)).val(),
                        vendorId: $('#receiveItemDetailVendorCode' + (i + 1)).val(),
                        vendorName: $('#receiveItemDetailVendorName' + (i + 1)).val().trim(),
                        jobTypeId: $('#ddlReceiveItemDetailWorkType' + (i + 1)).val(),
                        repairAppointmentDateFrom: reorganizeDateFormat($('#receivItemDetailAppointmentDateForm' + (i + 1)).val()),
                        repairAppointmentDateTo: reorganizeDateFormat($('#receivItemDetailAppointmentDateTo' + (i + 1)).val()),
                        reasonId: $('#ddlReceiveItemDetailOverAppointmentDateReason' + (i + 1)).val() || 0,
                        remark: $('#txtReceiveItemDetailRemark' + (i + 1)).val(),
                        userCode: '@UserDetail.CodeName',
                        userId: '@UserDetail.UserID'
                    };
                    //logging('bodyDetail', bodyDetail);
                    await ajaxPut(`${baseUrl}/homecare/api/v1/Receive/UpdateReceiveItemDetail`, bodyDetail, response => {
                        if (i + 1 == $('#tbodySubReceiveItem tr').length) {
                            if (response) {
                                modalSuccess();
                                page.loaded();;
                                $("#modalReceivedItemsDetail").modal("hide");
                            } else {
                                modalWaring("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
                                page.loaded();;
                            }
                        }
                    });
                }
            }
        }

        function applyApproveQuotation() {
            if (!validateApproveQuotation()) {
                return false;
            }
            var updateBody = {
                quotationGoodsId: lastQuotationGoods.quotationGoodsId,
                approvedStatusId: 1,
                approvedDate: new Date(),
                approverRemark: $('#confirmReason').val(),
                updatedBy: '@UserDetail.CodeName'
            }
            //console.log(updateBody);
            ajaxPut(`${baseUrl}/homecare/api/v1/Quotation/UpdateQuotationGoods`, updateBody, response => {
                if (response) {
                    modalSuccess();
                    $('#notificationModal').on('hidden.bs.modal', () => {
                        page.loading();
                        window.location.reload();
                    })
                }
            });
        }
        function saveApproveQuotation() {
            if (!validateApproveQuotation()) {
                return false;
            }
            var updateBody = {
                quotationGoodsId: lastQuotationGoods.quotationGoodsId,
                approvedStatusId: 2,
                approvedDate: new Date(),
                approverRemark: $('#confirmReason').val(),
                updatedBy: '@UserDetail.CodeName'
            }
            ajaxPut(`${baseUrl}/homecare/api/v1/Quotation/UpdateQuotationGoods`, updateBody, response => {
                if (response) {
                    modalSuccess();
                    $('#notificationModal').on('hidden.bs.modal', () => {
                        page.loading();
                        window.location.reload();
                    })
                }
            });
        }
        function saveRejectQuotation() {
            if (!validateRejectQuotation()) {
                return false;
            }
            var updateBody = {
                quotationGoodsId: lastQuotationGoods.quotationGoodsId,
                approvedStatusId: 3,
                approvedDate: new Date(),
                approverRemark: $('#confirmReason').val(),
                updatedBy: '@UserDetail.CodeName'
            }
            ajaxPut(`${baseUrl}/homecare/api/v1/Quotation/UpdateQuotationGoods`, updateBody, response => {
                if (response) {
                    modalSuccess();
                    $('#notificationModal').on('hidden.bs.modal', () => {
                        page.loading();
                        window.location.reload();
                    })
                }
            });
        }
        function insertReceiveItem() {
            var data = $('#ReceiveItemTBody tr:last');
            if (!validateInsertReceiveItem(data)) {
                return false;
            }
            toggleReceiveItemBtn();
            var body = {
                receiveId: receiveId,
                lineItemNo: $('#ReceiveItemTBody tr').length,
                guaranteeId: data.find('#ddlGuaranteeID').val(),
                lineItemDetail: data.find('#txtItemDetail').val(),
                lineItemRemark: data.find('#txtItemRemark').val(),
                receiveItemFlagRepairTransfer: data.find('#ddlRepairID').val(),
                statusId: data.find('#ddlReceivedItemStatusID').val(),
                active: true,
                createdBy: '@UserDetail.CodeName',
            }
            ajaxPost(`${baseUrl}/homecare/api/v1/Receive/InsertReceiveItem`, body, response => {
                //console.log(response);
                if (response) {
                    modalSuccess();
                    $('#notificationModal').on('hidden.bs.modal', () => {
                        page.loading();
                        window.location.reload();
                    })
                }
            })
        }

        function createWorkSheet() {
            var body = {
                receiveId: receiveId,
                username: '@UserDetail.CodeName',
                userId: '@UserDetail.UserID'
            }
            ajaxPost(`${baseUrl}/homecare/api/v1/Worksheet/InsertWorksheet`, body, response => {
                //console.log(response);
                if (response) {
                    modalSuccess();
                    $('#notificationModal').on('hidden.bs.modal', () => {
                        page.loading();
                        window.location.reload();
                    })
                }
            });
        }

        function previewWorkSheet() {
            ajaxGet(`${baseUrl}/homecare/api/v1/Receive/GetReceiveItemDetailGroup/${receiveId}`, response => {
                //logging(response);
                data = response.data;
                $("#tbPreviewWorkOrder tbody tr").remove();
                var vendorName = "";
                var colsp = 1;
                var countWO = 0;
                var rowspan = [];

                //console.log(data);
                if (data.length > 0) {

                    $.each(data, function (key, value) {

                        if (vendorName == value.vendorName) {
                            colsp = colsp + 1;
                        } else {
                            rowspan.push(colsp);
                            //console.log(colsp);
                            countWO = countWO + 1;
                            colsp = 1;
                        }
                        vendorName = value.vendorName;
                    });

                    rowspan.push(colsp);
                    rowspan.shift();
                    vendorName = "";
                    $.each(data, function (key, value) {

                        $("#tbPreviewWorkOrder tbody").append("<tr></tr>");
                        if (vendorName != value.vendorName) {
                            $("#tbPreviewWorkOrder tbody tr:last").append("<td class=\"text-left\">" + value.vendorName + "</td>");
                            $('#tbPreviewWorkOrder tr:last').find('td:first').prop("rowspan", rowspan.shift());
                        }

                        $("#tbPreviewWorkOrder tbody tr:last").append("<td class=\"text-left\">" + value.guaranteeName + "</td>");
                        vendorName = value.vendorName;
                    });

                    $("#btnOpenWorkOrder").removeAttr("disabled");
                }
                else
                {
                    $("#tbPreviewWorkOrder tbody").append("<tr></tr>");
                    $("#tbPreviewWorkOrder tbody tr:last").append("<td class='text-center Bold text-danger' colspan='3'>ไม่มีข้อมูล</td>");
                    $("#btnOpenWorkOrder").attr("disabled", "disabled");
                }
                $("#lblOpenWO").text(countWO + " ใบงาน");
            })
            $("#modalPreviewWorkOrder").modal("show");
        }
        //Close receiveRepair
        function closeReceiveRepair() {
            if (!validateCloseReceiveReason()) {
                return false;
            }
            $('#modalConfirmWithReason').modal('hide');
            var body = {
                receiveId: receiveData.data.receiveId,
                remark: $('#confirmReason').val(),
                role: '@UserDetail.Role' == 'CallCenter' ? 'CC' : '@UserDetail.Role',
                updatedBy: '@UserDetail.CodeName'
            }
            var reciveId = receiveData.data.receiveId;
            var updateBy2 = '@UserDetail.CodeName';
            ajaxDelete(`${baseUrl}/homecare/api/v1/Receive/DeleteReceive`, body, response => {
                if (response) {
                    deleteQuatationWhenDeleteRecive(reciveId, updateBy2)

                }
            })
        }
        async function deleteQuatationWhenDeleteRecive(reciveId, updateBy) {

            await  ajaxGet(`${baseUrl}/homecare/api/v1/Quotation/DeleteQuotationGoodsByReciveID?reciveId=${reciveId}&userUpdate=${updateBy}`, response => {
                if (response.data) {
                    modalSuccess(response.data);
                    $('#notificationModal').on('hidden.bs.modal', () => {
                        page.loading();
                        window.location.reload(true);
                        redirectURL();
                    });
                }
            })
        }
        // ======================================================================= OtherFunctions =======================================================================
        // Date format for post
        function reorganizeDateFormat(date) {
            if (!date) { return '' }
            var temp = date.split('/');
            var newDate = new Date(`${temp[2]}-${temp[1]}-${temp[0]}`);
            return thaiTimeInUTC(newDate);
        }
        // Date format for display
        function thaiFormatDate(date, withTime = true) {
            if (!date) { return '' }
            date = UTCToLocal(date);
            var [y, m, d] = date.split('T')[0].split('-');
            var [t, z] = date.split('T')[1].split('.');
            return `${d}/${m}/${y} ${withTime ? t : ''}`.trim();;
        }
            function UTCToLocal(date) {
                var localeDate = new Date(date);
                return date = new Date(localeDate.setHours(localeDate.getHours() + 7)).toJSON();
            }
            function thaiTimeInUTC(date) {
                return new Date(date.setHours(date.getHours() + date.getTimezoneOffset() / 60 + 7));
            }
            // Bind dropdown list
            function bindingDdlist(ddlId, ddlData, selectedVal) {
                $(`#${ddlId}`).empty();
                $.each(ddlData, (i, d) => {
                    if (d.id == 0) {
                        $(`#${ddlId}`).append(`<option value="${d.id}" selected disabled>${d.description}</option>`);
                    } else if (selectedVal == d.id) {
                        $(`#${ddlId}`).append(`<option value="${d.id}" selected>${d.description}</option>`);
                    } else {
                        $(`#${ddlId}`).append(`<option value="${d.id}" >${d.description}</option>`);
                    }
                })
            }
            // Create ddlist in form string
            function createDdlStringForm(id, ddlData, selectedVal, disabled = false, func = false) {
                var tempstr = `<select id="${id}" class="form-control" ${disabled ? 'disabled' : ''} ${func ? 'onchange="onChangeReceivedItemStatusID(this.value, this)"' : ''}>`;
                $.each(ddlData, (i, d) => {
                    tempstr += `<option value="${d.id}" ${selectedVal == d.id ? 'selected' : ''} ${d.id == 0 ? 'disabled' : ''}>${d.description}</option>`
                });
                return tempstr + '</select>';
            }
                // สถานะรับเรื่อง function
                Number.prototype.padLeft = function (base, chr) {
                    var len = (String(base || 10).length - String(this).length) + 1;
                    return len > 0 ? new Array(len).join(chr || '0') + this : this;
                }
                // Initial file input
                function InitailModalFileUpload(referenceItemId, index) {
                    var body = {
                        referenceId: receiveId,
                        referenceType: "R",
                        attachmentTypeId: 1,
                        referenceItemId: referenceItemId
                    }
                    ajaxPost(`${baseUrl}/homecare/api/v1/Attachment/List`, body, async response => {
                        var imageList = [];
                    var imageListConfig = [];
                    // getToken Image
                    var responseToken = await ajaxGet(`${baseUrl}/homecare/api/v1/Images/Token`);
                    var imageToken = responseToken.data;
                    $.each(response.data, (i, d) => {
                        imageList.push(`${baseUrl}/${d.attachmentURL}?imageToken=${imageToken}`);
                        imageListConfig.push({
                            caption: 'before-picture-' + (i + 1),
                            url: `${baseUrl}/homecare/api/v1/Attachment/${d.attachmentId}`,
                            width: '120px',
                            key: `${d.attachmentURL}?imageToken=${imageToken}`
                        });
                    });
                    $("#fileInput" + index).fileinput({
                        showUpload: receiveData.data.mainProcessId == 6 ? false : true,
                        showBrowse: receiveData.data.mainProcessId == 6 ? false : true,
                        dropZoneEnabled: receiveData.data.mainProcessId == 6 ? false : true,
                        maxFileSize: 25000,
                        maxFileCount: 0,
                        showRemove: false,
                        msgSelected: '{n} ไฟล์',
                        initialCaption: imageList.length + ' ไฟล์',
                        msgPlaceholder: 'กรุณาเลือกไฟล์',
                        allowedFileTypes: ['image'],
                        autoOrientImage: false,
                        theme: 'explorer',
                        uploadAsync: true,
                        uploadUrl: `${baseUrl}/homecare/api/v1/Attachment/UploadAttatchmentImages`,
                        uploadExtraData: {
                            referenceId: receiveId,
                            referenceType: 'R',
                            referenceItemId: referenceItemId,
                            attachmentTypeId: 1,
                            userCode: '@UserDetail.CodeName'
                        },
                        initialPreview: imageList,
                        initialPreviewConfig: imageListConfig,
                        initialPreviewAsData: true,
                        initialPreviewDownloadUrl: '' + baseUrl + '/{key}',
                        validateInitialCount: true,
                        overwriteInitial: false,
                        ajaxSettings: {
                            headers: {
                                "Authorization": "Bearer " + constructionApiToken
                            }
                        },
                        ajaxDeleteSettings: {
                            method: 'DELETE',
                            headers: {
                                "cache-control": "no-cache",
                                "Content-Type": "application/json",
                                "Authorization": "Bearer " + constructionApiToken
                            },
                            data: JSON.stringify({ username: '@UserDetail.CodeName' })
                        }
                    }).on('fileuploaded', () => {
                        // ซ่อนปุ่มลบหลังจาก upload
                        $('.kv-file-remove:not([data-key])').css('display', 'none')
                        // check flagImageBefore if true show DivOfferPrice
                        ajaxGet(`${baseUrl}/homecare/api/v1/Receive/${receiveId}`, response => {
                            if (response && response.data && response.data.flagImageBefore) {
                                $('#DivOfferPrice').show();
                                $('#FlagImageBeforeText').css('color', 'limegreen');
                                $('#FlagImageBeforeText').text('อัพโหลดเรียบร้อย');
                            }
                        });
                    }).on('filedeleted', () => {
                        // check flagImageBefore if true show DivOfferPrice
                        ajaxGet(`${baseUrl}/homecare/api/v1/Receive/${receiveId}`, response => {
                            if (response && response.data && !response.data.flagImageBefore) {
                                $('#DivOfferPrice').hide();
                                $('#FlagImageBeforeText').css('color', 'red');
                                $('#FlagImageBeforeText').text('ยังไม่ได้อัพโหลด');
                            }
                        });
                    });
                });
        };

      
            // Get quotation goods
            async function getQuotation(quotationId = null) {
                await ajaxGet(`${baseUrl}/homecare/api/v1/Quotation/GetQuotationGoods/${receiveId}`, async response => {
                    quotationList = response.data;
                //console.log('quotationList', quotationList);
                if (quotationList.length > 0) {
                    if (quotationId) {
                        lastQuotationGoods = quotationList.filter(q => q.quotationGoodsId == quotationId)[0];
                    } else {
                        quotationList = quotationList.filter(q => q.insertType != 'V')
                        lastQuotationGoods = quotationList[quotationList.length - 1];
                        var tempQuotationList = [];
                        for (var i = 0; i < quotationList.length; i++) {
                            tempQuotationList.push({ id: quotationList[i].quotationGoodsId, description: quotationList[i].quotationGoodsName });
                        }
                        bindingDdlist('ddlQuotationGoodsName', tempQuotationList, tempQuotationList[tempQuotationList.length - 1].id);
                        $('#ddlQuotationGoodsName option:last').text(tempQuotationList[tempQuotationList.length - 1].description + ' (ล่าสุด)');
                        $('#ddlQuotationGoodsName option:last').css('color', 'green');
                    }
                    $('#txtQuotationGoodsName').text(lastQuotationGoods.quotationGoodsName);
                    $('#txtQuotationCreatedBy').text(lastQuotationGoods.createdBy);
                    $('#txtQuotationCreatedDate').text(thaiFormatDate(lastQuotationGoods.createdDate));
                    $('#txtQuotationOrderStatus').text(lastQuotationGoods.orderStatusDescription);
                    $('#txtQuotationPaymentStatus').text(lastQuotationGoods.paymentStatusDescription);
                    // Change text color when quotation is paid
                    if (lastQuotationGoods.paymentStatusId === 2) {
                        $('#txtQuotationPaymentStatus').css('color', 'forestgreen');
                        $('#btnCloseReceived').attr('disabled', 1); //disable ปุ่มปิดใบรับเรื่อง

                    } else {
                        $('#txtQuotationPaymentStatus').css('color', 'red');
                    }
                    // Case of text approvedStatusDescription
                    if (lastQuotationGoods.approvedStatusId == 1) {
                        var lastIndex = approverList.findIndex(a => a.username == lastQuotationGoods.approverName.toLowerCase());
                        if (lastIndex < 0) {
                            $('#txtQuotationApproveStatus').text(lastQuotationGoods.approvedStatusDescription + ' (จากคุณ ' + approverList[0].username + ')');
                        } else {
                            $('#txtQuotationApproveStatus').text(lastQuotationGoods.approvedStatusDescription + ' (จากคุณ ' + approverList[lastIndex + 1].username + ')');
                        }
                    } else if (lastQuotationGoods.approvedStatusId == 2) {
                        $('#txtQuotationApproveStatus').text(lastQuotationGoods.approvedStatusDescription + ' (โดยคุณ ' + lastQuotationGoods.approverName + ')');
                    } else if (lastQuotationGoods.approvedStatusId == 3) {
                        $('#txtQuotationApproveStatus').text(lastQuotationGoods.approvedStatusDescription + ' (โดยคุณ ' + lastQuotationGoods.approverName + ')');
                        $('#txtQuotationApproveStatus').css('color', 'red');
                    } else {
                        $('#txtQuotationApproveStatus').text('');
                    }
                    $('#txtQuotationRemark').text(lastQuotationGoods.remark);

                    // แสดงปุ่มอนุมัติตามสิทธิ
                    if (approverList.filter(item => item.username.toLowerCase() == '@UserDetail.CodeName'.toLowerCase()).length > 0) {
                        $('#DivApplyApprove').hide();
                        $('#DivApprove').show();
                    }
                    else {
                        $('#DivApplyApprove').show();
                        $('#DivApprove').hide();
                    }
                    if (receiveData.data.mainProcessId == 6) {
                        $('#btnPriceRepair').hide();
                    }
                    // Flow depend on approvedStatusId and canceledByCustomer
                    if (lastQuotationGoods.quotationGoodsId == quotationList[quotationList.length - 1].quotationGoodsId) {
                        if (lastQuotationGoods.canceledByCustomer) {
                            $('#btndetailPriceRepairEdit').hide();
                            $('#btndetailPriceRepair').show();
                            $.each(chargeList, (i, d) => {
                                $('#ddlChargeUnit' + i).attr('disabled', 1);
                                $('#chargeValue' + i).attr('disabled', 1);
                            });
                            $('#DivQuotationApprove').find('button').attr('disabled', 1);
                        } else if (lastQuotationGoods.approvedStatusId == 0 || lastQuotationGoods.approvedStatusId == 3) {
                            $('#btndetailPriceRepairEdit').show();
                            $('#btndetailPriceRepair').hide();
                            $('#btnAddRowCost').hide();
                            $('#DivQuotationApprove').find('button').removeAttr('disabled');
                        } else {
                            var lastIndex = approverList.findIndex(a => a.username == lastQuotationGoods.approverName.toLowerCase());
                            var currentIndex = approverList.findIndex(a => a.username == '@UserDetail.CodeName'.toLowerCase());
                            if (currentIndex <= lastIndex) {
                                $('#DivQuotationApprove').find('button').attr('disabled', 1);
                            } else {
                                $('#DivQuotationApprove').find('button').removeAttr('disabled');
                            }
                            if (lastQuotationGoods.approvedStatusId == 2) {
                                $('#DivQuotationApprove').find('button').attr('disabled', 1);
                                $('#btndetailPriceRepairEdit').hide();
                                $('#btndetailPriceRepair').show();
                            } else {
                                $('#btndetailPriceRepairEdit').hide();
                                $('#btndetailPriceRepair').hide();
                            }
                            $.each(chargeList, (i, d) => {
                                $('#ddlChargeUnit' + i).attr('disabled', 1);
                                $('#chargeValue' + i).attr('disabled', 1);
                            });
                        }
                    } else {
                        $('#btndetailPriceRepairEdit').hide();
                        $('#btndetailPriceRepair').hide();
                        $.each(chargeList, (i, d) => {
                            $('#ddlChargeUnit' + i).attr('disabled', 1);
                            $('#chargeValue' + i).attr('disabled', 1);
                        });
                        $('#DivQuotationApprove').find('button').attr('disabled', 1);
                    }

                    ajaxGet(`${baseUrl}/homecare/api/v1/Quotation/GetQuotationGoodsItem/${lastQuotationGoods.quotationGoodsId}`, response => {
                        //console.log('quotationItem', response);
                        bindTBodyPreQuotationItemDetail(response.data);
                        bindTBodyQuotationItemDetail(response.data);
                        // show gen PDF button
                        if (response.data.length > 0) {
                            $('#DivGenQuotationPDF').show();
                        }
                    })
                    await ajaxGet(`${baseUrl}/homecare/api/v1/Quotation/GetQuotationGoodsCostItem/${lastQuotationGoods.quotationGoodsId}`, (response) => {
                        //logging('quotationCost', response);
                        quotationCostList = response;
                        if (response.data.length > 0)
                        {
                            $('#discountTBody').empty();
                            for (var d of response.data)
                            {
                                if (d.keyValue == 'D')
                                {
                                    addTableRow(lastQuotationGoods.approvedStatusId == 2 || lastQuotationGoods.approvedStatusId == 1 || lastQuotationGoods.canceledByCustomer);
                                    onChangeCostType(document.getElementById('ddlCostType' + $('#discountTBody tr').length));
                                    $('#ddlCostType' + $('#discountTBody tr').length).val(d.costTypeId);
                                    $('#costValue' + $('#discountTBody tr').length).val(d.costValue);
                                    $('#costValue' + $('#discountTBody tr').length).removeAttr('readonly');
                                    $('#ddlCostUnit' + $('#discountTBody tr').length).val(d.unitsId);
                                }
                                else if (d.keyValue == 'C' && (d.insertType == 'C' || d.insertType == null))
                                {
                                    for (var i = 0; i < chargeList.length; i++) {
                                        if (chargeList[i].description == d.costTypeDescription) {
                                            $('#chargeValue' + i).val(d.operateCostValue);
                                            $('#ddlChargeUnit' + i).val(d.unitsId);
                                        }
                                    }
                                }

                                ////Vendor cost
                                if (d.insertType == 'V')
                                {
                                    if(d.costTypeId == 4 && d.operateCostValue == 0)
                                    {
                                        $('#flagVendorOpt').prop('checked', false);
                                        $('#vendorOperateValue').val(d.operateCostValue);
                                    }
                                    else if(d.costTypeId == 5 && d.operateCostValue == 0)
                                    {
                                        $('#flagVendorVat').prop('checked', false);
                                        $('#vendorVatValue').val(d.operateCostValue);
                                    }
                                }
                            }
                            calVendorTotalPrice();
                        }
                        else
                        {
                            if (lastQuotationGoods == quotationList[quotationList.length - 1] && receiveData.data.mainProcessId != 6) {
                                clearDivCost();
                            }
                            $.each(chargeList, (i, d) => {
                                if (d.id != 0) {
                                    $(`#chargeValue${i}`).val(d.costValue);
                                    $(`#ddlChargeUnit${i}`).val(1);
                                }
                            });

                            $('#vendorOperateValue').val(15);
                            $('#vendorVatValue').val(7);
                        }
                        setTimeout(calCostValueNet, 50);
                        if ($('#discountTBody tr').length < ddlCostType.length && ((lastQuotationGoods.approvedStatusId != 2 && lastQuotationGoods.approvedStatusId != 1) && !lastQuotationGoods.canceledByCustomer)) {
                            $('#btnAddRowCost').show();
                        } else {
                            $('#btnAddRowCost').hide();
                            $('#discountTBody tr').find('.fa-close').attr('hidden', 1);
                        }
                    });
                    // flagChangeRequest
                    if (lastQuotationGoods.canceledByCustomer) {
                        $('#flagChangeRequest').prop('checked', 1);
                        $('#flagChangeRequest').attr('disabled', 1);
                        $('#DdlCustomerCancelQuotationReason').val(lastQuotationGoods.customerReasonId);
                        $('#DivQuotationApprove').find('button').attr('disabled', 1);
                        $('#discountTBody .fa-close').hide();
                        $('#btnAddRowCost').hide();
                    } else {
                        $('#flagChangeRequest').prop('checked', 0)
                        $('#DdlCustomerCancelQuotationReason').attr('disabled', 1);
                        $('#DdlCustomerCancelQuotationReason').val(0);
                    }
                } else {
                    $('#DivApplyApprove').hide();
                    $('#DivApprove').hide();
                }
            });
            }
            function bindTBodyPreQuotationItemDetail(data) {
                $('#preQuotationItemDetailTBody').empty();
                var vendorTotalPrePrice = 0;
                $.each(data, (i, d) => {
                    var normalPrice = d.packagePriceType == 1 ? d.customerPackagePrice : d.wagePriceType == 1 ? d.customerWagePrice : 0;
                    var spacialPrice = d.packagePriceType == 2 ? d.customerPackagePrice : d.wagePriceType == 2 ? d.customerWagePrice : 0;

                    var normalVendorPrice = d.packagePriceType == 1 ? d.vendorPackagePrice : d.wagePriceType == 1 ? d.vendorWagePrice : 0;
                    var spacialVendorPrice = d.packagePriceType == 2 ? d.vendorPackagePrice : d.wagePriceType == 2 ? d.vendorWagePrice : 0;

                    var vendorPrePrice;

                    $('#preQuotationItemDetailTBody').append(`
					<tr>
						<td class="text-center">
							${$('#preQuotationItemDetailTBody tr').length + 1}
						</td>
						<td>
							${d.workCategoryDescription}
						</td>
						<td>
							${d.workDetailDescription}
						</td>
						<td>
							${roundFixed(normalPrice)}
						</td>
						<td>
							${roundFixed(+spacialPrice + +d.customerMaterialPrice)}
						</td>
						<td>
							${roundFixed(d.quantity)}
						</td>
						<td>
							${d.workDetailUnits}
						</td>
						<td id="itemPrice${$('#preQuotationItemDetailTBody tr').length + 1}">
							${roundFixed((+normalPrice + +spacialPrice + +d.customerMaterialPrice) * d.quantity)}
						</td>
						<td>
							${d.remark}
						</td>
					</tr>
				`)
                    vendorPrePrice = roundFixed((+normalVendorPrice + +spacialVendorPrice + +d.vendorMaterialPrice) * d.quantity);
                    vendorTotalPrePrice = +vendorTotalPrePrice + +vendorPrePrice;
                })
                $('#preVendorTotalPrice').text(vendorTotalPrePrice.toFixed(2));
                calAllTotalPrice();
                calVendorTotalPrice();
            }

            function bindTBodyQuotationItemDetail(data) {
                $('#quotationItemDetailTBody').empty();
                $.each(data, (i, d) => {
                    $('#quotationItemDetailTBody').append(`
					<tr>
						<td>
							${$('#quotationItemDetailTBody tr').length + 1}
						</td>
						<td>
							${d.workCategoryDescription}
						</td>
						<td>
							${d.workDetailDescription}
						</td>
						<td>
							${roundFixed(d.packagePriceType == 1 ? d.customerPackagePrice : 0.00)}
						</td>
						<td>
							${roundFixed(d.wagePriceType == 1 ? d.customerWagePrice : 0.00)}
						</td>
						<td>
							${roundFixed(d.packagePriceType == 2 ? d.customerPackagePrice : 0.00)}
						</td>
						<td>
							${roundFixed(d.wagePriceType == 2 ? d.customerWagePrice : 0.00)}
						</td>
						<td>
							${roundFixed(d.customerMaterialPrice)}
						</td>
						<td>
							${d.workDetailUnits}
						</td>
						<td>
							${(Math.round(d.quantity * 100) / 100).toFixed(2)}
						</td>
						<td>
							${(Math.round((d.customerPackagePrice + d.customerWagePrice + d.customerMaterialPrice) * d.quantity * 100) / 100).toFixed(2)}
						</td>
						<td>
							${d.remark}
						</td>
						<td>
							<i class="fa fa-close cursor-pointer" onclick="deleteQuotationItem(this, ${d.quotationGoodsItemId})"></i>
						</td>
					</tr>
				`) // TODO ปริมาณ
                })
                calAllTotalPrice();
            }

            // Calculate price on radio button in quotation modal changed
            function calTotalPrice() {
                var customerPrice = +$('#customerBillingPrice').val() + +$('#customerMaterialPrice').val();
                var weight = $('#materialQuantity').val() || 0;

                var TotalPrice = Math.round((parseFloat(customerPrice) * parseFloat(weight)) * 100) / 100;
                $('#TotalPrice').text(TotalPrice.toFixed(2));
            }
            // คำนวนราคารวมค่าวัสดุ
            function calAllTotalPrice() {
                var totalPrice = 0;
                for (var i = 1; i <= $('#preQuotationItemDetailTBody tr').length; i++) {
                    totalPrice += +$('#itemPrice' + i).text();
                }
                $('#preTotalPrice').text(roundFixed(+totalPrice));
                $('#lblTotalPrice').text(roundFixed(+totalPrice));
                if (totalPrice > 0) {
                    $('#DivCost').show();
                }
            }
            // Calculate CostValueNet
            function calCostValueNet() {
                for (var i = 1; i <= $('#discountTBody tr').length; i++) {
                    if (i == 1) {
                        $('#costValueNet' + i).text((Math.round(+$('#preTotalPrice').text() * +$('#costValue' + i).val()) / 100).toFixed(2));
                        costValueNetList[i - 1] = (+$('#preTotalPrice').text() * (100 - +$('#costValue' + i).val()) / 100);
                    } else {
                        $('#costValueNet' + i).text((Math.round(costValueNetList[i - 2] * +$('#costValue' + i).val()) / 100).toFixed(2));
                        costValueNetList[i - 1] = (costValueNetList[i - 2] * ((100 - +$('#costValue' + i).val()) / 100));
                    }
                }
                if ($('#discountTBody tr').length > 0) {
                    $('#DivPriceAfterDiscount').show();
                    $('#totalPriceAfterDiscount').text((Math.round(costValueNetList[($('#discountTBody tr').length || 1) - 1] * 100) / 100));
                } else {
                    $('#DivPriceAfterDiscount').hide();
                    $('#totalPriceAfterDiscount').text(roundFixed(+$('#preTotalPrice').text()));
                }
                calChargeValueNet();
            }
            // Calculate ChargeValueNet
            function calChargeValueNet()
            {
                for (var i = 1; i <= $('#DivChargeDetail .row').length; i++)
                {
                    if (i == 1)
                    {
                        $('#chargeValueNet' + i).val(Math.round(+($('#totalPriceAfterDiscount').text() != 0 ? $('#totalPriceAfterDiscount').text() : $('#totalPriceAfterDiscount').text()) * +$('#chargeValue' + i).val()) / 100);
                        $('#totalPriceAfterCharge' + i).val(Math.round(+($('#totalPriceAfterDiscount').text() != 0 ? $('#totalPriceAfterDiscount').text() : $('#totalPriceAfterDiscount').text()) * (100 + +$('#chargeValue' + i).val())) / 100);
                    }
                    else
                    {
                        $('#chargeValueNet' + i).val(Math.round(+$('#totalPriceAfterCharge' + (i - 1)).val() * +$('#chargeValue' + i).val()) / 100);
                        $('#totalPriceAfterCharge' + i).val(Math.round(+$('#totalPriceAfterCharge' + (i - 1)).val() * (100 + +$('#chargeValue' + i).val())) / 100);
                    }
                };

                $('#totalPriceNet').text(roundFixed(($('#totalPriceAfterCharge' + $('#DivChargeDetail .row').length).val())));

            }

            function genQuotation(quotationType) {
                ajaxGet(`${baseUrl}/homecare/api/v1/DocumentToken`, response => {
                    var win = window.open(`${baseUrl}/homecare/Document/QuotationGoods/R/${lastQuotationGoods.quotationGoodsId}?QuotationType=${quotationType}&Token=${response.data}`, '_blank');
                    if (win) {
                        win.focus();
                    }
                })
            }

            function logging(...data) {
                //console.log(...data);
            }
            // Math.round().toFixed(2)
            function roundFixed(data, decimal = 2) {
                return (Math.round(data * 100) / 100).toFixed(decimal)
            }
                // Vendor by พี่สืบ
                function itemAddvendor(e, createdWorksheet) {
                    if (!createdWorksheet) {
                        clearVendorSearch();
                        tempVendoorRow = $(e);
                        $("#modalAddVendor").appendTo("body").modal('show');
                        $("#tbAddvendor tbody tr").remove();
                        $("#tbAddvendor tbody").append("<tr></tr>");
                        $("#tbAddvendor tbody tr").append("<td class='text-center Bold text-danger' colspan='6'>ไม่มีข้อมูล</td>");
                    }
                }
                $("#btnSearchVendor").on("click", function () {
                    if ( $("#textCrivendorCode").val() == "" && $("#textCrivendorName").val() == "" && $("#textCriIDCard").val() == "" ) {
                        modalWaring("กรุณาระบุเงื่อนไขในการค้นหา");
                    } else {
                        searchVendor();
                    }
                });
                async function searchVendor() {
                    await page.loading();
                    var body = {
                        Name: $("#textCrivendorName").val(),
                        TaxID: $("#textCriIDCard").val(),
                        Vendor: $("#textCrivendorCode").val() == "" ? "" : $("#textCrivendorCode").val()
                    };
                    $.ajax({
                        url: '@Url.Action("getListVendormaster", "Master")',
                        type: 'POST',
                        data: body,
                        traditional: true,
                        success: function (data) {
                            $("#tbAddvendor tbody tr").remove();
                            if (data.length == 0) {
                                $("#tbAddvendor tbody").append("<tr></tr>");
                                $("#tbAddvendor tbody tr").append("<td class='text-center Bold text-danger' colspan='6'>ไม่มีข้อมูล</td>");
                            } else {
                                $.each(data, function (key, value) {
                                    $("#tbAddvendor tbody").append("<tr></tr>");
                                    $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\"><label id='VendorCode'>" + value.Vendor.substr(value.Vendor.length - 6) + "</label></td>");
                                    $("#tbAddvendor tbody tr:last").append("<td class=\"text-left\"><label id='VendorName'>" + value.Name + "</lable></td>");
                                    $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\">" + value.CardID + "</td>");
                                    $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\">" + value.TaxID + "</td>");
                                    $("#tbAddvendor tbody tr:last").append("<td class=\"text-left\"><label id='VendorAddrNew'>" + value.Address + "</lable></td>");
                                    $("#tbAddvendor tbody tr:last").append("<td class=\"text-center\"><a style='cursor: pointer;' id='selectVendor' name='selectVendor[]'>เลือก</a></td>");
                                });
                                $("[name*='selectVendor[]']").each(function (idx, elem) {
                                    $(this).click(function () {
                                        var VendorCode = $(this).closest('tr').find("#VendorCode").text()
                                        var VendorName = $(this).closest('tr').find("#VendorName").text()
                                        var no = tempVendoorRow.parent().parent().find('p').text();
                                        var VendorAddrNew = $(this).closest('tr').find("#VendorAddrNew").text();
                                        tempVendoorRow.closest('tr').find("#receiveItemDetailVendorName" + no).val(VendorName);
                                        tempVendoorRow.closest('tr').find("#receiveItemDetailVendorCode" + no).val(VendorCode);
                                        $("#modalAddVendor").modal('hide');
                                    });
                                });
                            }
                            page.loaded();
                        },
                    });
                }
                function loadingUrgentMaintenanceForm() {
                    // Request โดยพี่แสนดี ให้ข้าม Flow upload image before
                    var skipUploadImageBefore = true;
                    if (receiveData.data.flagUrgent || receiveData.data.repairTypeId == 3 || skipUploadImageBefore) {
                        if (receiveData.data.flagUrgent || receiveData.data.repairTypeId == 3) {
                            $('#chkAPDateReal').attr('disabled', 1);
                        }

                        $('#DivImageAttachment').hide();
                        if (receiveData.data.receiveAppointmentDateReal) {
                            $('#DivOfferPrice').show();
                        } else {
                            $('#Received-Quotation-detail').collapse();
                        }
                    }
                }
                function clearDivCost() {
                    $('#DivCost').empty();
                    $('#DivCost').append(`
				<div class="row" style="margin-top: 10px; margin-bottom: 10px;">
								<div style="padding:0; margin:0 3% ;">
									<table class="table table-bordered table-hover" id="discountTable">
										<thead>
											<tr>
												<th>No.</th>
												<th>ประเภทส่วนลด</th>
												<th>ส่วนลด</th>
												<th>เป็นจำนวนเงิน</th>
												<th>ลบ</th>
											</tr>
										</thead>

										<tbody id="discountTBody">
											<tr>
												<td><p class="pt-5">1</p></td>
												<td>
													<select class="form-control" id="ddlCostType1" onchange="onChangeCostType(this)" onfocus="beforeCostTypeChange = this.value"></select>
												</td>
												<td>
													<div>
														<input type="number" class="form-control input-group-text" id="costValue1" placeholder="0.00" min="0" onkeyup="calCostValueNet()" onclick="calCostValueNet()" readonly>
														<select class="form-control input-group-select" id="ddlCostUnit1" onclick="calCostValueNet()"></select>
													</div>
												</td>
												<td><label class="pt-5" id="costValueNet1"></label></td>
												<td><i class="fa fa-close pt-5" onclick="removeTableRow(this)"></i></td>
											</tr>
										</tbody>
										<tfoot>
											<tr>
												<th class="text-right" colspan="5">
													<span class="glyphicon glyphicon-plus addBtn" onclick="addTableRow()" id="btnAddRowCost" style="display: none"></span>
												</th>
											</tr>
										</tfoot>
									</table>
								</div>
								<div class="row mb-1" id="DivPriceAfterDiscount">
									<div class="col-lg-5 col-sm-6 col-xs-6" style="text-align: left; font-size: 15px">
										<label style="color: red; margin-left: 20px">ราคาสุทธิหลังหักส่วนลด : &nbsp;</label>
										<label id="totalPriceAfterDiscount"></label>
										<label>&emsp;บาท</label>
									</div>
								</div>
							</div>
			`)
                    bindingDdlist('ddlCostUnit1', ddlCostUnit.data, 1);
                    bindingDdlist('ddlCostType1', ddlCostType, 0);
                }
                //===================================================================== Validate ===============================================================================
                //Validate Repair Detail
                function validateRepairDetailPanel() {
                    if (isEmptyInput("ddlReceiveItemMainWorkType") ||
                        isEmptyInput("ddlReceiveItemSubWorkType") ||
                        isEmptyInput("ddlReceiveItemWorkDetail") ||
                        isEmptyInput("ddlReceiveItemLocation") ||
                        isEmptyInput("ddlReceiveItemWorkIssue")) {
                        modalWaring("กรุณากรอก\"ข้อมูลผู้แจ้งซ่อม\"ให้ครบถ้วน");
                        return false;
                    }

                    //console.log("success")
                    return true;
                }

                //Validate quotation
                function validateCreateQuotation() {
                    //Edit by Adisorn
                    //if (isEmptyInput("DdlGoodsType")) {
                    //    modalWaring("กรุณาเลือก \"ประเภทการสั่งซื้อ\"");
                    //    return false;
                    //}
                    //if (isEmptyInput("DdlGoodsOrderCondition")) {
                    //    modalWaring("กรุณาเลือก \"เงื่อนไขการสั่งซื้อ\"");
                    //    return false;
                    //}
                    //if (isEmptyInput("DdlGoodsOrderStatus")) {
                    //    modalWaring("กรุณาเลือก \"สถานะการสั่งซื้อ\"");
                    //    return false;
                    //}
                    //Edit by Adisorn
                    return true;
                }

                function validateRepairVendorPanel() {
                    var len = $('#tbodySubReceiveItem tr').length;

                    for (var i = 1; i <= len; i++) {
                        if (isEmptyInput("ddlReceiveItemDetailStatus" + i) &&
                            isEmptyInput("receiveItemDetailVendorName" + i) &&
                            isEmptyInput("ddlReceiveItemDetailWorkType" + i) &&
                            isEmptyInput("receivItemDetailAppointmentDateForm" + i) &&
                            isEmptyInput("receivItemDetailAppointmentDateTo" + i) &&
                            isEmptyInput("ddlReceiveItemDetailOverAppointmentDateReason" + i)) {
                            continue;
                        }

                        if (isEmptyInput("ddlReceiveItemDetailStatus" + i)) {
                            modalWaring("กรุณาเลือก \"สถานะ\" ของรายการที่ " + i);
                            return false;
                        }

                        if (isEmptyInput("receiveItemDetailVendorName" + i)) {
                            modalWaring("กรุณาเลือก \"ผู้รับเหมา\" ของรายการที่ " + i);
                            return false;
                        }

                        if (isEmptyInput("ddlReceiveItemDetailWorkType" + i)) {
                            modalWaring("กรุณาเลือก \"ประเภทงานซ่อม\" ของรายการที่ " + i);
                            return false;
                        }

                        if (!isValidDateRepairVendor("receivItemDetailAppointmentDateForm" + i, "receivItemDetailAppointmentDateTo" + i)) {
                            modalWaring("กรุณาเลือกกรอก \"วันที่นัดหมายซ่อม\"  ของรายการที่ " + i + " ให้ถูกต้อง");
                            return false;
                        }

                        //สาเหตุวันนัดเกินกำหนด
                        if (isExceedDateRepairVendor("receivItemDetailAppointmentDateForm" + i)) {
                            if (isEmptyInput("ddlReceiveItemDetailOverAppointmentDateReason" + i)) {
                                modalWaring("กรุณาเลือกเลือก \"สาเหตุวันนัดเกินกำหนด\" ของรายการที่ " + i);
                                return false;
                            }
                        }
                    }

                    return true;
                }

                //Validate Extend data
                function validateExtendPanel() {
                    if ('@UserDetail.Role'.toLocaleLowerCase() == 'callcentre') {
                        return true;
                    }

                    if (isEmptyInput("ExtendedReceiveAppointmentDate")) {
                        modalWaring("กรุณาเลือก: \"วันที่นัดหมายตรวจสอบ(ใหม่)\"");
                        return false;
                    }

                    if (!isValidExtendDateReceive()) {
                        modalWaring("กรุณาเลือก \"วันที่นัดหมายตรวจสอบ(ใหม่)\" ให้ถูกต้อง");
                        return false;
                    }

                    //Time validate
                    if (isExceedTime("ExtendedReceiveAppointmentTimeForm", "ExtendedReceiveAppointmentTimeTo")) {
                        modalWaring("กรุณากรอก: \"เวลา\" เลื่อนนัดตรวจสอบให้ถูกต้อง");
                        return false;
                    }

                    if (isEmptyInput("ddlExtendedResonID")) {
                        modalWaring("กรุณาเลือก: \"สาเหตุเลื่อนนัดหมายฯ\"");
                        return false;
                    }

                    //console.log("success")
                    return true;
                }

                //Validate Receive data
                function validateReceivePanel() {
                    var selectedStatus = $('#ddlReceivedStatusID').val();

                    //check Empty date
                    if (isEmptyInput("ReceiveAppointmentDate") && selectedStatus == 2) {
                        modalWaring("กรุณากรอก: \"วันที่นัดหมายตรวจสอบ\"");
                        return false;
                    }
                    //chekcHCRemark-CCRemark
                    if ('@UserDetail.Role'.toLocaleLowerCase().indexOf('hc') >= 0 && ['2', '3', '4', '5'].includes($('#ddlReceivedStatusID').val())) {
                        if (isEmptyInput("ReceiveHCRemark")) {
                            modalWaring("กรุณากรอก: \"หมายเหตุ HC\"");
                            return false;
                        }
                    }
                    if ('@UserDetail.Role'.toLocaleLowerCase() == 'callcentre' && ['6', '7'].includes($('#ddlReceivedStatusID' ).val())) {
                        if (isEmptyInput("ReceiveCCRemark")) {
                            modalWaring("กรุณากรอก: \"หมายเหตุ CC\"");
                            return false;
                        }
                    }

                    //DateCheck
                    if (isExceedDateReceive() && selectedStatus == 2) {
                        if (isEmptyInput("ddlReceiveOverAppointmentDateReason") && !postponeHistory) {
                            modalWaring("กรุณาเลือก: \"สาเหตุวันนัดเกินกำหนด\"");
                            return false;
                        }
                    }

                    //Time validate
                    if (isExceedTime("ReceiveAppointmentTimeForm", "ReceiveAppointmentTimeTo") && selectedStatus == 2) {
                        modalWaring("กรุณาเลือก: \"กรุณากรอกเวลาตรวจสอบให้ถูกต้อง\"");
                        return false;
                    }

                    //console.log("SUCCESS");
                    return true;
                }

                function validateSaveCustomerChange() {
                    if ($("#flagChangeRequest").prop('checked')) {
                        if (!$("#DdlCustomerCancelQuotationReason").val()) {
                            modalWaring("กรุณาเลือก \"เหตุผล ลูกค้าขอเปลี่ยนแปลง / ยกเลิก\"");
                            return false;
                        }
                    }
                    return true;
                }

                function validateQuotationItem() {
                    if (isEmptyInput("DdlReceiveItemList")) {
                        modalWaring("กรุณาเลือก \"รายการรับแจ้งซ่อม\"");
                        return false;
                    }

                    if (isEmptyInput("DdlFixingCategories")) {
                        modalWaring("กรุณาเลือก \"หมวดงานที่ ผรม.ต้องซ่อม\"");
                        return false;
                    }

                    if (isEmptyInput("DdlFixingDetail")) {
                        modalWaring("กรุณาเลือก \"รายละเอียดที่ซ่อม\"");
                        return false;
                    }

                    if (isEmptyInput("ddlBillingType")) {
                        modalWaring("กรุณาเลือก \"ประเภท การเรียกเก็บ\"");
                        return false;
                    }

                    if (isEmptyInput("materialQuantity")) {
                        modalWaring("กรุณากรอก \"ปริมาณ\"");
                        return false;
                    }

                    if ($("#materialQuantity").val() <= 0) {
                        modalWaring("กรุณากรอก \"ปริมาณ ให้มีค่ามากกว่า 0\"");
                        return false;
                    }

                    if (isEmptyInput("QuotationItemRemark")) {
                        modalWaring("กรุณากรอก \"หมายเหตุ\"");
                        return false;
                    }

                    if ($("#TotalPrice").text() <= 0) {
                        modalWaring("ราคารวมต้องมีค่ามากกว่า 0");
                        return false;
                    }
                    return true;
                }

                function validateUploadImageBefore() {
                    if (!receiveData.data.receiveAppointmentDateReal) {
                        modalWaring('กรุณาบันทึกวันเข้าตรวจสอบจริง ก่อนแนบรูปถ่าย');
                        return false;
                    }
                    return true;
                }

                function validateApproveQuotation() {
                    if (!quotationCostList.data || quotationCostList.data.length <= 0) {
                        modalWaring('กรุณาบันทึกราคาของใบเสนอราคาก่อนยื่นขออนุมัติ');
                        return false;
                    }
                    return true;
                }

                function validateInsertQuotationCostItem() {
                    if ($("#totalPriceNet").text() <= 0 ) {
                        //modalWaring('กรุณาตรวจสอบเปอร์เซ็นต์ส่วนลด');
                        return false;
                    }
                    return true;
                }

                function validateCloseReceiveReason() {
                    if ($('#confirmReason').val() == '') {
                        modalWaring('กรุณากรอกเหตุผลการปิดใบรับเรื่อง');
                        $('#warningModal').on('hidden.bs.modal', () => {
                            $('#confirmReason').focus();
                            $('#warningModal').off();
                        })
                        return false
                    }
                    return true;
                }
                function validateRejectQuotation() {
                    if ($('#confirmReason').val() == '') {
                        modalWaring('กรุณากรอกเหตุผลการไม่อนุมัติ');
                        return false
                    }
                    return true;
                }
                function validateflagChangeRequest() {
                    if (lastQuotationGoods.paymentStatusId == 2) {
                        modalWaring('ไม่สามารถเปลี่ยนแปลง/ยกเลิกได้ เนื่องจากลูกค้าชำระค่าบริการเรียบร้อยแล้ว');
                        return false;
                    }
                    return true;
                }
                function validateInsertReceiveItem(data) {
                    if (!data.find('#ddlGuaranteeID').val()) {
                        modalWaring('กรุณาเลือกหมวงงานก่อนทำการบันทึกข้อมูล');
                        $('#warningModal').on('hidden.bs.modal', () => {
                            data.find('#ddlGuaranteeID').focus();
                            $('#warningModal').off();
                        })
                        return false;
                    }
                    if (data.find('#txtItemDetail').val() == '') {
                        modalWaring('กรุณากรอกรายละเอียดการแจ้งก่อนทำการบันทึกข้อมูล');
                        $('#warningModal').on('hidden.bs.modal', () => {
                            data.find('#txtItemDetail').focus();
                            $('#warningModal').off();
                        })
                        return false;
                    }
                    return true;
                }
                //-------------------------------------- Sub validate methods -------------------------------------------//

                function isExceedDateReceive() {

                    var selectedDate = new Date(reorganizeDateFormat($("#ReceiveAppointmentDate").val()));
                    var receiveHcDate = new Date();

                    if (selectedDate == NaN) {
                        return false;
                    }

                    //If more than 1 day (2 or more): return true
                    if (((selectedDate - receiveHcDate) / 8.64e+7) < 2) {
                        return false;
                    }
                    return true;
                }

                function isValidExtendDateReceive() {
                    //var selectedDate = new Date(reorganizeDateFormat($("#ReceiveAppointmentDate").val()));
                    var selectedDate = new Date();
                    var extendedDate = new Date(reorganizeDateFormat($("#ExtendedReceiveAppointmentDate").val()));

                    //check date
                    if (selectedDate < extendedDate) {
                        return true;
                    }
                    if (selectedDate < extendedDate)
                        return false;
                }

                function isValidDateRepairVendor(from, to) {
                    if (isEmptyInput(from) || isEmptyInput(to)) {
                        return false;
                    }

                    var fromDate = new Date(reorganizeDateFormat($("#" + from).val()));
                    var toDate = new Date(reorganizeDateFormat($("#" + to).val()));

                    //check date
                    if (fromDate > toDate) {
                        return false;
                    }
                    return true;
                }

                function isExceedDateRepairVendor(from) {
                    if (isEmptyInput(from)) {
                        return false;
                    }

                    var fromDate = new Date(reorganizeDateFormat($("#" + from).val()));
                    var receiveDateReal = new Date(receiveData.data.receiveAppointmentDateReal)

                    //check date
                    if (((fromDate - receiveDateReal) / 8.64e+7) < 3) {
                        return false;
                    }
                    return true;
                }

                //-------------------------------------- Mostly use validate function -------------------------------------------//
                function isEmptyInput(inputId) {
                    if (!$("#" + inputId).val()) {
                        return true;
                    }
                    return false
                }

                function isExceedTime(timeFrom, timeTo) {
                    //check empty
                    if (isEmptyInput(timeFrom) || isEmptyInput(timeTo)) {
                        return true;
                    }
                    //check exceed time
                    if ($("#" + timeFrom).val() >= $("#" + timeTo).val()) {
                        return true;
                    }
                    return false;
                }

                //Update Email
                function changeEmailPanel() {
                    if ($("#editEmailInput").is(":visible")) {
                        $("#editEmailInput").hide();
                        $("#editEmailSave").hide();
                        $("#editEmailButton").show();
                        $("#editEmailCancelButton").hide();
                        $("#editEmailInput").val("");
                        $("#CustomerEmail").show();
                    }
                    else {
                        $("#editEmailInput").show();
                        $("#editEmailSave").show();
                        $("#editEmailButton").hide();
                        $("#editEmailCancelButton").show();
                        $("#editEmailInput").val($("#CustomerEmail").text());
                        $("#CustomerEmail").hide();
                    }
                }

                async function saveReceiveEmail() {

                    var regexEmail = /^(([^<>()[\]\\.,;:\s@@\"]+(\.[^<>()[\]\\.,;:\s@@\"]+)*)|(\".+\"))@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

                    if ($(`#editEmailInput`).val() == $("#CustomerEmail").text())
                    {
                        modalWaring('ท่านได้กรอกอีเมลเก่า');
                        $(`#editEmailInput`).focus();
                        return false;
                    }
                    else if (!regexEmail.test($('#editEmailInput').val())) {
                        modalWaring('กรุณากรอกอีเมลให้ถูกต้อง ตัวอย่าง"example@mail.com"');
                        $(`#editEmailInput`).focus();
                        return false;
                    }
                    else
                    {
                        var body = {
                            receiveId: receiveId,
                            email: $("#editEmailInput").val(),
                            updatedBy: "@UserDetail.CodeName"
                        }
                        await page.loading();
                        ajaxPut(baseUrl + "/homecare/api/v1/Receive/UpdateReceiveEmail", body, response => {
                            if (response) {
                                modalSuccess();
                                $('#notificationModal').on('hidden.bs.modal', () => {
                                    page.loading();
                                    window.location.reload(true);
                                });
                            }
                            page.loaded();
                        });
                    }
                }

                function collapseToggleIcon(id) {
                    if ($('#' + id).is(':hidden')) {
                        $('#' + id + 'Minus').fadeOut(100, () => {
                            $('#' + id + 'Plus').fadeIn(300);
                        });

                    } else {
                        $('#' + id + 'Plus').fadeOut(100, () => {
                            $('#' + id + 'Minus').fadeIn(300);
                        });
                    }
                }
                function redirectURL() {

                    window.location.href = window.location.pathname;
                }

                $('#modalDetailPriceRepair').on('hidden.bs.modal', function () {
                    saveReceiveRepair()
                });

                function CheckPagePermission() {

                    ajaxGet(`${baseUrl}/homecare/api/v1/User/@UserDetail.UserID/Permission`, response => {
                        if (response) {
                            if (!response.data.find(a => a.permissionDescription === 'CloseReceiveButton')) {
                                $("#btnCloseReceived").hide();
                            }

                            if (!response.data.find(a => a.permissionDescription === 'OpenWorksheetButton')) {
                                $("#btnPreviewWO").hide();
                            }

                            if (!response.data.find(a => a.permissionDescription === 'receivedAction')) {
                                console.log('disable');
                                $("#receivedRepaireInform :input").attr('disabled', 'disabled');
                                $(".modal-header .close ").removeAttr('disabled');
                            }

                            if (response.data.find(a => a.accessDescription === 'SUPPORT_QCRole')) {
                                $("#receivedRepaireInform :input").attr('disabled', 'disabled');
                                $("#receivedRepaireInform :button").attr('disabled', 'disabled');
                            }
                        }
                    });
                }

                // Calculate vendor quotation
                function calVendorTotalPrice()
                {
                    var vendorVatParam  = 0;
                    var vendorOptParam  = 0;

                    if ($('#flagVendorVat').prop('checked')) {
                        vendorVatParam  = 7;
                    }
                    $('#vendorVatValue').val(vendorVatParam);

                    if ($('#flagVendorOpt').prop('checked')) {
                        vendorOptParam  =  $('#vendorOperateValue').val() == 0 ? 15 : $('#vendorOperateValue').val();
                    }
                    $('#vendorOperateValue').val(vendorOptParam);

                    var vendorSumPrice  = +$('#preVendorTotalPrice').text();
                    var vendorOperate   = Math.round(vendorSumPrice * +vendorOptParam) / 100;
                    vendorSumPrice      = +vendorSumPrice + +vendorOperate;
                    var vendorVat       = Math.round(vendorSumPrice * +vendorVatParam) / 100;
                    $('#vendorTotalPriceNet').text((+vendorSumPrice + +vendorVat).toFixed(2));
                }
    </script>
}
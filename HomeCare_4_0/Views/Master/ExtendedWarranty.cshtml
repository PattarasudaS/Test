@using HomeCare_4_0.Common
@using HomeCare_4_0.ClassLib
@{
    ViewBag.Title = "ExtendedWarranty";
    Layout = "~/Views/Shared/_MasterLayout.cshtml";
}
@section AddToHead {
    <style>
        h3.box-title {
            font-weight: 600;
        }

        .btn-group .btn {
            min-width: 85.5px;
        }

        .project-status-filter {
            border: 0;
            box-shadow: none;
            position: relative;
            bottom: 6.5px;
            right: 11px;
        }

        .list-group {
            margin: 0;
        }

        .list-group-item {
            position: relative;
        }

            .list-group-item:hover {
                background-color: rgba(128, 128, 128, .064);
            }

            .list-group-item.empty-item:hover {
                background-color: transparent;
            }

        .badge {
            background: none;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #project-nav {
            text-align: center;
        }

        .pagination {
            margin: 20px auto 0px auto;
        }

            .pagination li a:hover {
                cursor: pointer;
            }

            .pagination li a {
                min-width: 38px;
            }

        #clear-search {
            position: absolute;
            right: 26px;
            top: 22px;
            bottom: 0;
            display: flex;
            align-items: center;
            font-size: 18px;
            color: #333;
            cursor: pointer;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__rendered {
            box-sizing: border-box;
            list-style: none;
            margin: 0;
            padding: 0 5px;
            width: 100%;
            display: flex;
            flex-direction: row;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            padding: 0 5px;
        }

        ul.select2-selection__rendered > span.select2-selection__clear {
            position: absolute;
            right: 0;
            margin: 3px 5px;
        }

        li.select2-selection__choice {
            background-color: #6bbbc7 !important;
        }

        form .error {
            color: #ff0000;
            font-weight: 300;
            font-style: italic;
            font-size: 1.2rem;
        }

        .multiselect .dropdown-toggle .btn .btn-default {
            height: 62px;
            font-family: cursive;
        }

        .nav-tabs li.disabled a {
            pointer-events: none;
        }


        /*******************************
        * MODAL AS LEFT/RIGHT SIDEBAR
        * Add "left" or "right" in modal parent div, after class="modal".
        * Get free snippets on bootpen.com
        *******************************/
        .modal.left .modal-dialog,
        .modal.right .modal-dialog {
            position: fixed;
            margin: auto;
            width: 500px;
            height: 100%;
            -webkit-transform: translate3d(0%, 0, 0);
            -ms-transform: translate3d(0%, 0, 0);
            -o-transform: translate3d(0%, 0, 0);
            transform: translate3d(0%, 0, 0);
        }

        .modal.left .modal-content,
        .modal.right .modal-content {
            height: 100%;
            overflow-y: auto;
        }

        .modal.left .modal-body,
        .modal.right .modal-body {
            padding: 15px 15px 80px;
        }

        /*Left*/
        .modal.left.fade .modal-dialog {
            left: -320px;
            -webkit-transition: opacity 0.3s linear, left 0.3s ease-out;
            -moz-transition: opacity 0.3s linear, left 0.3s ease-out;
            -o-transition: opacity 0.3s linear, left 0.3s ease-out;
            transition: opacity 0.3s linear, left 0.3s ease-out;
        }

        .modal.left.fade.in .modal-dialog {
            left: 0;
        }

        /*Right*/
        .modal.right.fade .modal-dialog {
            right: -320px;
            -webkit-transition: opacity 0.3s linear, right 0.3s ease-out;
            -moz-transition: opacity 0.3s linear, right 0.3s ease-out;
            -o-transition: opacity 0.3s linear, right 0.3s ease-out;
            transition: opacity 0.3s linear, right 0.3s ease-out;
        }

        .modal.right.fade.in .modal-dialog {
            right: 0;
        }

        /* ----- MODAL STYLE ----- */
        .modal-content {
            border-radius: 0;
            border: none;
        }

        .modal-header {
            border-bottom-color: #EEEEEE;
            background-color: #FAFAFA;
        }

        /* ----- v CAN BE DELETED v ----- */
        body {
            background-color: #78909C;
        }

        .demo {
            padding-top: 60px;
            padding-bottom: 110px;
        }

        .btn-demo {
            margin: 15px;
            padding: 10px 15px;
            border-radius: 0;
            font-size: 16px;
            background-color: #FFFFFF;
        }

            .btn-demo:focus {
                outline: 0;
            }

        .demo-footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            padding: 15px;
            background-color: #212121;
            text-align: center;
        }

            .demo-footer > a {
                text-decoration: none;
                font-weight: bold;
                font-size: 16px;
                color: #fff;
            }



        .thumbnails li img {
            width: 350px;
            height: 350px;
        }

        .theme-explorer .file-upload-indicator, .theme-explorer .file-drag-handle,
        .theme-explorer .explorer-frame .kv-file-content, .theme-explorer .file-actions,
        .explorer-frame .file-preview-other {
            text-align: center;
        }

        .theme-explorer .file-thumb-progress .progress, .theme-explorer .file-thumb-progress .progress-bar {
            height: 13px;
            font-size: 11px;
            line-height: 13px;
        }

        .theme-explorer .file-upload-indicator, .theme-explorer .file-drag-handle {
            position: absolute;
            display: inline-block;
            top: 0;
            right: 3px;
            width: 16px;
            height: 16px;
            font-size: 16px;
        }

        .theme-explorer .file-thumb-progress .progress, .theme-explorer .explorer-caption {
            display: block;
        }

        .theme-explorer .explorer-frame td {
            vertical-align: middle;
            text-align: left;
        }

        .theme-explorer .explorer-frame .kv-file-content {
            width: 80px;
            height: 80px;
            padding: 5px;
        }

        .theme-explorer .file-actions-cell {
            position: relative;
            width: 120px;
            padding: 0;
        }

        .theme-explorer .file-thumb-progress .progress {
            margin-top: 5px;
        }

        .theme-explorer .explorer-caption {
            color: #777;
        }

        .theme-explorer .kvsortable-ghost {
            opacity: 0.6;
            background: #e1edf7;
            border: 2px solid #a1abff;
        }

        .theme-explorer .file-preview .table {
            margin: 0;
        }

        .theme-explorer .file-error-message ul {
            padding: 5px 0 0 20px;
        }

        .explorer-frame .file-preview-text {
            display: inline-block;
            color: #428bca;
            border: 1px solid #ddd;
            font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
            outline: none;
            padding: 8px;
            resize: none;
        }

        .explorer-frame .file-preview-html {
            display: inline-block;
            border: 1px solid #ddd;
            padding: 8px;
            overflow: auto;
        }

        .explorer-frame .file-other-icon {
            font-size: 2.6em;
        }

        @@media only screen and (max-width: 767px) {
            .theme-explorer .table, .theme-explorer .table tbody, .theme-explorer .table tr, .theme-explorer .table td {
                display: block;
                width: 100% !important;
            }

            .theme-explorer .table {
                border: none;
            }

                .theme-explorer .table tr {
                    margin-top: 5px;
                }

                    .theme-explorer .table tr:first-child {
                        margin-top: 0;
                    }

                .theme-explorer .table td {
                    text-align: center;
                }

                .theme-explorer .table .kv-file-content {
                    border-bottom: none;
                    padding: 4px;
                    margin: 0;
                }

                    .theme-explorer .table .kv-file-content .file-preview-image {
                        max-width: 100%;
                        font-size: 20px;
                    }

            .theme-explorer .file-details-cell {
                border-top: none;
                border-bottom: none;
                padding-top: 0;
                margin: 0;
            }

            .theme-explorer .file-actions-cell {
                border-top: none;
                padding-bottom: 4px;
            }

            .theme-explorer .explorer-frame .explorer-caption {
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
                left: 0;
                right: 0;
                margin: auto;
            }
        }

        .file-preview {
            min-height: 24vh;
            max-height: 62vh;
        }

        .file-preview-image {
            object-fit: cover;
        }

        .file-drop-zone {
            overflow-y: auto;
            min-height: 30vh;
            max-height: 56vh;
        }

        .file-zoom-dialog .explorer-frame .file-other-icon {
            font-size: 22em;
            font-size: 50vmin;
        }

        .fileinput-remove {
            display: none;
        }
    </style>

}

<head>
</head>
<body>
    <ul id="mytabs" class="nav nav-tabs">
        <li class="active"><a data-toggle="pill" href="#extendwarranty"><i class="fa fa-expand"></i> &nbsp;ทำรายการขยายวันรับประกัน</a></li>
        <li>              <a data-toggle="pill" href="#serch"><i class="fa fa-search"></i> &nbsp;ประวัติการทำรายการขยายวันรับประกัน</a></li>
    </ul>
    <div class="tab-content">
        <div id="extendwarranty" class="tab-pane fade in active">
            <div class="row" id="create-data-panel">
                <div class="col-xs-12">
                    <div class="box" id="form-box" hidden>
                        <div class="box-header">
                            <h3>บันทึกรายการขยายวันรับประกัน</h3>
                        </div>
                        <div class="box-body">
                            <!-- Material form register -->
                            <form id="frmSaveExtended" name="frmSaveExtended">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-4 col-lg-4 ">
                                        <div class="md-form">
                                            <i class="fa fa-home prefix grey-text"></i><label for="unitid" class="font-weight-light">&nbsp;โครงการ</label>
                                            <select id="project" name="project" class="form-control select2" data-placeholder="เลือก โครงการ">
                                                <option selected>เลือกโครงการ</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-sm-4 col-sm-4">
                                        <div class="md-form">
                                            <i class="fa fa-home prefix grey-text"></i><label for="unitid" class="font-weight-light">&nbsp; แปลง</label>
                                            <select id="unitid" name="unitid" class="form-control select2" data-placeholder="เลือก Unit">
                                                <option selected>เลือก Unit</option>
                                            </select>
                                        </div>

                                    </div>
                                    <div class="col-xs-12 col-sm-4 col-sm-4">
                                        <div class="row">
                                            <div class="col-xs-12 col-sm-12 col-sm-12">
                                                <i class="fa fa-calendar-o"></i><label for="detail" class="font-weight-light"> &nbsp;รายละเอียดวันรับประกัน</label>
                                            </div>
                                            <div class="col-xs-12 col-sm-12 col-sm-12">
                                                <div class="md-form">

                                                    <label id="detail" class="font-weight-light"></label>
                                                </div>
                                            </div>

                                        </div>

                                    </div>
                                </div>
                                <br />
                                <div class="row">
                                    <div class="col-xs-12 col-sm-4 col-lg-4 ">
                                        <div class="md-form">
                                            <i class="fa fa-calendar-o"></i><label for="extenddate" class="font-weight-light"> &nbsp;วันที่ขยายประกัน</label>
                                            @*<input type="date" id="extenddate" name="extenddate" data-date-format="DD/MM/YYYY" class="form-control" placeholder="เลือกวันที่ขยายประกัน">*@
                                            <input type="text" id="extenddate" name="extenddate" class="form-control datepicker">
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-sm-4 col-sm-4">
                                        <div class="md-form">
                                            <i class="fa fa-file-text"></i><label for="remark" class="font-weight-light">&nbsp;หมายเหตุ</label>
                                            <input type="text" id="remark" name="remark" class="form-control" placeholder="หมายเหตุ">

                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-sm-4 col-sm-4">
                                        <div class="md-form">
                                            <i class="fa fa fa-file-text"></i><label for="memo" class="font-weight-light">&nbsp;เลขที่อ้างอิง-Memo</label>
                                            <input type="text" id="memo" name="memo" class="form-control" placeholder="เลขที่อ้างอิง (ความยาวไม่เกิน 50 ตัวอักษร) ">
                                        </div>
                                    </div>

                                </div>
                                <br />
                                <div class="row  spece-line"></div>
                                <div class="row">

                                    <div class="col-xs-3">
                                        <button type="submit" class="btn btn-primary" id="btnSaveData">
                                            <i class="fa fa-save" aria-hidden="true" style="font-size: 14px;"></i> บันทึกข้อมูล
                                        </button>
                                        <button type="submit" class="btn btn-danger" id="btnBacktoMain2" data-toggle="pill">
                                            <i class="fa fa-close" aria-hidden="true" style="font-size: 14px;"></i> ยกเลิก
                                        </button>
                                    </div>
                                    <div class="col-xs-3">

                                    </div>

                                    <div class="col-xs-3">

                                    </div>
                                    <div class="col-xs-3"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div id="serch" class="tab-pane fade">
            <div class="row" id="search-user-panel">
                <div class="col-xs-12">
                    <div class="box" id="form-box">
                        <div class="box-header">
                            <h3>ประวัติการทำรายการขยายวันรับประกัน</h3>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="form-group col-xs-12 col-md-6 col-lg-6">
                                    <label>เลือกโครงการที่ต้องการแสดงผล : </label>
                                    <select id="searchProjectDoc" name="project2" class="form-control select2" multiple="multiple" data-placeholder="เลือก โครงการ">
                                        <option selected>เลือกโครงการ</option>
                                    </select>
                                </div>
                                <div class="form-group col-xs-3 col-md-3 col-lg-2">
                                    <label>&nbsp;</label>
                                    <div class="controls">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="box" id="search-result" style="margin-bottom: 0;" hidden>
                        <div class="box-body">
                            <div class="row">
                                <div class="col-xs-12">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-striped" id="extended-data-table" style="margin-bottom: 0;">
                                            <thead>
                                                <tr>
                                                    <th>ลำดับ</th>
                                                    <th></th>
                                                    <th>แปลง</th>
                                                    <th>เริ่มประกัน</th>
                                                    <th>หมดประกัน</th>
                                                    <th>ขยายประกัน</th>
                                                    <th>อ้างอิงเลขที่-Memo</th>
                                                    <th>เหตุผล ขยายประกัน</th>
                                                    <th>ขยายประกันโดย</th>
                                                    <th>เอกสาร Memo</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td class="text-center">&nbsp;</td>
                                                    <td class="text-center">&nbsp;</td>
                                                    <td class="text-center">&nbsp;</td>
                                                    <td class="text-center">&nbsp;</td>
                                                    <td class="text-center">&nbsp;</td>
                                                    <td class="text-center">&nbsp;</td>
                                                    <td class="text-center">&nbsp;</td>
                                                    <td class="text-center">&nbsp;</td>
                                                    <td class="text-center">&nbsp;</td>
                                                    <td class="text-center">&nbsp;</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>



    <!--  Modal Insert Success -->
    <div class="modal fade" id="modalInsertRoleSuccess" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <!-- Change class .modal-sm to change the size of the modal -->
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title w-100" id="myModalLabel">ยืนยันการ บันทึก</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <i class="fa fa fa-check fa-2x" aria-hidden="true" style="color: #32CD32;"></i>
                    <span id="lbTxtSuccess"></span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success btn-sm" data-dismiss="modal" onclick="redirectURL()">ตกลง</button>
                </div>
            </div>
        </div>
    </div>
    <!--  Modal Role warning -->
    <div class="modal fade" id="modalRoleWarning" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <!-- Change class .modal-sm to change the size of the modal -->
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title w-100" id="myModalLabel">แจ้งเตือน</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <i class="fa fa-exclamation-triangle fa-2x" aria-hidden="true" style="color:#FFCC00;"></i>
                    <span id="lbTxtWarning"></span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    @* Modal Upload Image  *@
    <div tabindex="-1" class="modal fade" id="modalUploadImageBefore" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;  ">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 6px;">
                <div class="modal-header bg-light-blue">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">แนบเอกสาร Memo</h4>
                </div>
                <div class="modal-body text-center" style="max-height: 85vh; overflow-y: auto;">
                    <div class="box box-default">
                        <div class="box-header with-border cursor-pointer" data-toggle="collapse" data-target="memofileattachmentImageInput" aria-expanded="true" aria-controls="beforeImageInput">
                            <a>
                                <h3 class="box-title"><i class="fa fa-picture-o"></i> แนบเอกสาร Memo </h3>
                            </a>
                        </div>
                        <div class="box-body collapse in" id="memofileattachmentImageInput">
                            <div class="row">
                                <div class="col-xs-12">
                                    <input id="MemofileAttachment" name="file" type="file" multiple />
                                </div>
                            </div>
                        </div>
                    </div>
                    <br>

                    <br>
                </div>
            </div>
        </div>
    </div>

</body>

@section Script {


    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

    @*dataTable*@
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <link href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css" rel="stylesheet">
    @*dataTable*@

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.9.3/js/bootstrap-select.min.js" type="text/javascript"></script>

    <link rel="stylesheet" href="~/assets/plugins/datatables/dataTables.bootstrap-1.10.12.min.css" />
    <link rel="stylesheet" href="~/assets/plugins/datatables/responsive.bootstrap.min.css" />

    @*<link href="path/to/bootstrap-editable/css/bootstrap-editable.css" rel="stylesheet">
        <script src="path/to/bootstrap-editable/js/bootstrap-editable.min.js"></script>*@
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.5.1/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/piexif.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.5.1/js/fileinput.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.5.1/themes/explorer/theme.js"></script>

    <script>
        const baseUrl = '@System.Configuration.ConfigurationManager.AppSettings["Construction_API"]';
        var unitfromprojectSelected = null
        var projectListUserExtended = [];
        var checkValidation = false;
        var dateEnddatecompare = null;
        var newDateCompare = null;

    var validateDateWarranty = false;
    var imageList = [];
    var imageListConfig = [];

    var projectExtendedAllList = []
    var selectedUnit = [];
        $(document).ready(function () {
            var showLoading = true
            if (showLoading) {
                page.loading();
            }
            ajaxGet(`${baseUrl}/homecare/api/v1/User/@UserDetail.UserID/Permission`, response => {
                if (response) {
                    if (!response.data.length) {
                        noPermissionAlert();
                    } else if (!response.data.find(a => a.permissionDescription === 'ExtendedWarranty')) {
                        noPermissionAlert();
                    } else {
                        $('#form-box').show();
                    }
                }
            });
            var link = "#extendwarranty";
            $('#mytabs a[href="' + link + '"]').tab('show');

            $('#extended-data-table').DataTable({
                "processing": true,
                "language": {
                    "search": "ค้นหา : ",
                    "lengthMenu": "แสดง _MENU_ รายการ",
                    "emptyTable": "ไม่พบข้อมูล",
                    "info": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                    "paginate": {
                        "first": "หน้าแรก",
                        "last": "หน้าสุดท้าย",
                        "next": "ถัดไป",
                        "previous": "ก่อนหน้า"
                    }
                }
            });

            frmSaveExtended = $('#frmSaveExtended').validate({ // initialize the plugin
                rules: {
                },

                messages: {
                },
                submitHandler: function (event) { // for demo

                    validateForm();
                    if (checkValidation == false) { return false; }

                    if (!confirm("ยืนยันบันทึกข้อมูล ?")) {
                        return false;
                    }
                    SaveData();
                }

            });

            //Initial DatePicker
            const today = new Date().getDate();
            const thisMonth = new Date().getMonth() + 1;
            const thisYear = new Date().getFullYear();
            $('.datepicker').datepicker({
                autoclose: true,
                format: 'dd/mm/yyyy',
                //endDate: '0d'
            });

            setProject();
            if (showLoading) {
                page.loaded();
            }
        });


        function noPermissionAlert() {
                modalWaring('คุณไม่มีสิทธิในการเข้าถึงหน้านี้ ขออภัยครับ');
                $('#warningModal').on('hidden.bs.modal', function () {
                    window.location.href = '@Url.Content("~/")';
                });

        }

        $('#btnBacktoMain2').click(function () {
            resetform();
        });
        $('#btnRightSlide').click(function () {
            $('#modalSaveData').modal({ backdrop: 'static', keyboard: false, show: true });
            $('#modalSaveData').modal('show');
            $('.error').hide();
            $("#frmSaveExtended")[0].reset();
            $("#project").val([0]).trigger('change');
            $("#unitid").val([]).trigger('change');

        });
        async function setProject() {
                //setProject All;
                await ajaxGet(`${baseUrl}/homecare/api/v1/DropDown/GetProjectListForExtendedWarranty`, response => {
                    if (response.data) {
                        allProjectList = response.data;
                        $("#searchProjectDoc option").remove();
                        $(`#searchProjectDoc` ).append(`<option value="0"  style="color:gray;">---แสดงทุกโครงการ---</option>`);
                        $.each(response.data, function (Index, Value) {
                            $("#searchProjectDoc").append($("<option></option>").val(Value.id).html(Value.description));
                        });

                        $("#project option").remove();
                        $(`#project`).append(`<option value="0" selected style="color:gray;">---กรุณาเลือกโครงการ---</option>`);
                        $.each(response.data, function (Index, Value) {
                            $("#project").append($("<option></option>").val(Value.id).html(Value.description));
                        });


                    }
                });
        }

   function showModalLineApprveWarning(msg) {
            $('#modalRoleWarning').modal('show');
            $('#lbTxtWarning').text(msg);
   }
   function showModalLineApprveSuccess(msg) {
            $('#modalInsertRoleSuccess').modal('show');
            $('#lbTxtSuccess').text(msg);
   }

    $(`#searchProjectDoc`).on("select2:select", function (evt) {
        page.loading();
        var element = null;
        var chk = $(`#searchProjectDoc`).val()
        var a = chk.indexOf("0");
        if (a == 0) {
            $(`#searchProjectDoc`).val([0]).trigger('change')
            projectListUserExtended = [];
            element = 0;
        } else {
            element = evt.params.data.id;

        }

            ajaxGet(`${baseUrl}/homecare/api/v1/ExtendedWarranty/GetExtendedWarranty?projectid=` + element, response => {
                if (response.data) {
                    $.each(response.data, function (Index, Value) {
                        projectListUserExtended.push(

                            {
                                "row": projectListUserExtended.length + 1,
                                "projectId": Value.projectId,
                                "unitCode": Value.unitCode,
                                "startWarrantyDate": Value.startWarrantyDate,
                                "endWarrantyDate": Value.endWarrantyDate,
                                "extendedWarrantyDate": Value.extendedWarrantyDate,
                                "extendedRemark": Value.extendedRemark,
                                "extendedMemo": Value.extendedMemo,
                                "createdBy": Value.createdBy,
                                "extendedID": Value.extendedID
                            }
                        )
                    });
                    page.loaded();
                    LoadTableProject();
                }
            });
        if (element == 0) {
            $(`#searchProjectDoc`).val([0]).trigger('change')
        }

    });


        $(`#project`).on("select2:select", function (evt) {
            $('.error').hide();
        var element = evt.params.data.id;
        var data =
        {
            "projectIDList": element
            }
            newDateCompare = null;
            dateEnddatecompare = null;
        //$(`#unitid`).append($("<option></option>").val(0).html('-กรุณาเลือก'));
        ajaxPost(`${baseUrl}/homecare/api/v1/Tracker/GetUnitIDbyProjectsID`, data, response => {
            if (response.data) {
                selectedUnit = response.data;
                $(`#unitid option`).remove();

                $.each(response.data, function (Index, Value) {
                    $(`#unitid`).append($("<option></option>").val(Value.Unit_ID).html(Value.Unit_Code));
                });

                if (response.data.length > 0) {
                    validateDateWarranty = true;
                    if (response.data[0].StartGaranteeDate == "" || response.data[0].StartGaranteeDate == null) {
                        star = "-"
                        validateDateWarranty = false;
                    }
                    else {
                        var from = response.data[0].StartGaranteeDate.split("/")
                        if (from[0].length == 1) {
                            from[0] = '0' + from[0];
                        }
                        if (from[1].length == 1) {
                            from[1] = '0' + from[1];
                        }
                        star = from[1] + '/' + from[0] + '/' + from[2].substr(0, 4);
                    }

                    if (response.data[0].EndGaranteeDate == "" || response.data[0].EndGaranteeDate == null) {
                        end = "-"
                        validateDateWarranty = false;
                    } else {

                        //end = response.data[0].EndGaranteeDate;
                        var from = response.data[0].EndGaranteeDate.split("/")
                        if (from[0].length == 1) {
                            from[0] = '0' + from[0];
                        }
                        if (from[1].length == 1) {
                            from[1] = '0' + from[1];
                        }
                        end = from[1] + '/' + from[0] + '/' + from[2].substr(0, 4);
                        dateEnddatecompare = new Date(from[2].substr(0, 4), parseInt(from[0]) -1 , from[1]);
                    }

                    if (response.data[0].NewGuaranteeEndDate == "" || response.data[0].NewGuaranteeEndDate == null) {
                        newdate = "-"
                    } else {
                        //newdate = response.data[0].NewGuaranteeEndDate;
                        var from = null;
                         from =    response.data[0].NewGuaranteeEndDate.split("/")
                        if (from[0].length == 1) {
                            from[0] = '0' + from[0];
                        }
                        if (from[1].length == 1) {
                            from[1] = '0' + from[1];
                        }
                        newdate = from[1] + '/' + from[0] + '/' + from[2].substr(0, 4);
                        newDateCompare = new Date(from[2].substr(0, 4), parseInt(from[0]) - 1, from[1]);

                    }
                    detail = "วันที่เริ่มต้น: " + star + " , วันที่สิ้นสุด: " + end + " ,วันที่ขยายประกัน: " + newdate;
                    //$("label[for='" + this.id + "']").text("TESTTTT");
                    $(`#detail`).text(detail);
                } else {

                    detail = "วันที่เริ่มต้น:-  , วันที่สิ้นสุด:- ,วันที่ขยายประกัน:- "
                    //$("label[for='" + this.id + "']").text("TESTTTT");
                    $(`#detail`).text(detail);
                    validateDateWarranty = false;
                }


            }
            else {
                selectedUnit = [];
                //page.loaded();
                $(`#unitid option`).remove();
            }
        });

        });

        $(`#unitid`).on("select2:select", function (evt) {
            var r = evt.params.data;
            var star = null;
            var end = null;
            var newdate = null;
            var detail = null;
            validateDateWarranty = true;
            newDateCompare = null;
            dateEnddatecompare = null;
            var filtered = selectedUnit.filter(element => element.Unit_ID == r.id);
            $('.error').hide();

            if (filtered.length > 0) {
                if (filtered[0].StartGaranteeDate == "" || filtered[0].StartGaranteeDate == null ) {
                    star = "-"
                    validateDateWarranty = false;
                }
                else {
                    //star = filtered[0].StartGaranteeDate;
                    var from = filtered[0].StartGaranteeDate.split("/")
                    if (from[0].length == 1) {
                        from[0] = '0' + from[0];
                    }
                    if (from[1].length == 1) {
                        from[1] = '0' + from[1];
                    }
                    star = from[1] + '/' + from[0] + '/' + from[2].substr(0, 4);

                }

                if (filtered[0].EndGaranteeDate == "" || filtered[0].EndGaranteeDate == null) {
                    end = "-"
                    validateDateWarranty = false;
                } else {

                    var from = filtered[0].EndGaranteeDate.split("/")
                    if (from[0].length == 1) {
                        from[0] = '0' + from[0];
                    }
                    if (from[1].length == 1) {
                        from[1] = '0' + from[1];
                    }
                    end = from[1] + '/' + from[0] + '/' + from[2].substr(0, 4);


                    dateEnddatecompare = new Date(from[2].substr(0, 4), parseInt(from[0]) - 1, from[1]);
                    //newDateCompare = null;
                }

                if (filtered[0].NewGuaranteeEndDate == "" || filtered[0].NewGuaranteeEndDate == null) {
                    newdate = "-"
                } else {
                    var from = filtered[0].NewGuaranteeEndDate.split("/")
                    if (from[0].length == 1) {
                        from[0] = '0' + from[0];
                    }
                    if (from[1].length == 1) {
                        from[1] = '0' + from[1];
                    }
                    newdate = from[1] + '/' + from[0] + '/' + from[2].substr(0, 4);
                    newDateCompare = new Date(from[2].substr(0, 4), parseInt(from[0]) - 1, from[1]);

                }
                detail = "วันที่เริ่มต้น: " + star + " , วันที่สิ้นสุด: " + end + " ,วันที่ขยายประกัน: " + newdate;
                //$("label[for='" + this.id + "']").text("TESTTTT");
                $(`#detail`).text(detail);
            }

        });

    $(`#searchProjectDoc`).on("select2:unselecting", function (evt) {
        //page.loading();
        var r = evt.params["args"].data.id;
        if (r == 0) {
            projectListUserExtended = [];
            LoadTableProject();
            return;
        }
        var filtered = projectListUserExtended.filter(element => element.projectId != r);
        projectListUserExtended = filtered;
        LoadTableProject();

    });

    $("#extenddate").on("change", function () {

            $('.error').hide();
        }).trigger("change")


    function LoadTableProject() {
        var projectListShow = null;
        $('#search-result').hide();

        projectListShow = projectListUserExtended;
        if (projectListShow.length == 0) {
            return;
        }
            //page.loading();
        var table = $('#extended-data-table').DataTable();
        table.destroy();


        $('#extended-data-table tbody').empty();

            var tr = '';
            var row = 0;
            //page.loading();
        sortByKeyAsc(projectListShow, 'projectId');
        var lastprj = null;
        $.each(projectListShow, function (Index, Value) {

            //if (lastprj != Value.projectId) {
                var prjDesc = allProjectList.filter(element => element.id == Value.projectId);
                var descriptionPrj = prjDesc[0].description.split(':');

                tr += `
                     <tr id=datarow_${row + 1}>;
                           <td class="text-right" style="vertical-align: middle;">
                                ${row + 1}
                           </td>

                           <td class="text-left" style="vertical-align: middle;">
                                ${ descriptionPrj[1]}
                           </td>

                           <td class="text-left" style="vertical-align: middle;">
                               ${Value.unitCode.trim()}
                           </td>

                           <td class="text-left" style="vertical-align: middle;">
                               ${Value.startWarrantyDate}
                           </td>

                           <td class="text-left" style="vertical-align: middle;">
                                ${Value.endWarrantyDate}
                           </td>

                           <td class="text-left" style="vertical-align: middle;">
                                ${Value.extendedWarrantyDate}
                           </td>

                           <td class="text-left" style="vertical-align: middle;">
                                ${Value.extendedMemo}
                           </td>

                           <td class="text-left" style="vertical-align: middle;">
                                ${Value.extendedRemark}
                           </td>

                           <td class="text-left" style="vertical-align: middle;">
                                ${Value.createdBy}
                           </td>
                           <td>
                                    <button id="btnWorksheetPic_${row + 1}" onclick=openModalUploadWorkImage(${Value.extendedID})><i class="fa fa-photo fa-lg"></i></button>
                            </td>
                       </tr>
                     `;

                 lastprj = Value.projectId;

                 row++;

             }

          );

        $('#extended-data-table tbody').append(tr);
   /*     $('#extended-data-table').DataTable().columns.adjust().draw()*/;

      var t =   $('#extended-data-table').DataTable({
            "processing": true,
            "language": {
                "search": "ค้นหา : ",
                "lengthMenu": "แสดง _MENU_ รายการ",
                "emptyTable": "ไม่พบข้อมูล",
                "info": "รายการ _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                "paginate": {
                    "first": "หน้าแรก",
                    "last": "หน้าสุดท้าย",
                    "next": "ถัดไป",
                    "previous": "ก่อนหน้า"
                }
            },
            "columnDefs": [
                {
                    "orderable": false, "targets": [0, 1, 2, 3, 4, 5, 6, 7,8]
                },

                {
                    "targets": [1],
                    "visible": false
                }
                //{ "orderable": true, "targets": [1, 2, 3] }
            ],
            "drawCallback": async function (settings) {
                var api = this.api();
                var rows = api.rows({ page: 'current' }).nodes();
                var last = null;

                api.column(1, { page: 'current' }).data().each(function (group, i) {
                    if (last !== group) {
                        $(rows).eq(i).before(
                            '<tr class="group"><td colspan="9"><b>' + group + '</b></td></tr>'
                        );

                        last = group;
                    }
                });

            },

        });
        t.on('order.dt search.dt', function () {
            t.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                cell.innerHTML = i + 1;
            });
        }).draw();
        $('#search-result').show();
    }


    // Open upload image before modal
    async function openModalUploadWorkImage(extendedID, receiveItemId = 0) {
        await page.loading();
        drawFileInputRow('MemofileAttachment');

        var promises = [
            InitailModalFileUpload(extendedID, 'MemofileAttachment', 16, true, receiveItemId),
        ];
        await Promise.all(promises);
        if ('@UserDetail.Role' !== '@EnumConfiguration.Role.ADMIN') {
            $('#modalUploadImageBefore').on('shown.bs.modal', function () {
                $('.kv-file-remove.btn.btn-sm.btn-kv.btn-default.btn-outline-secondary').hide();              
            });
        }
        page.loaded();
        $('#modalUploadImageBefore').modal('show');

    }
    // reDraw html fileInput
    function drawFileInputRow(name) {
        $(`#memofileattachmentImageInput`).empty();
        $(`#memofileattachmentImageInput`).append(`
				<div class="row">
					<div class="col-xs-12">
						<input id="${name}" name="file" type="file" multiple />
					</div>
				</div>
	    `);
    }
    		// Initial file input
   function InitailModalFileUpload(referenceItemId, name, attType, canUpload, receiveItemId = 0) {
            var body = {
                referenceId: referenceItemId,
                referenceType: "EXTENDED",
				attachmentTypeId: attType,
                referenceItemId: 0
            }
			ajaxPost(`${baseUrl}/homecare/api/v1/Attachment/List`, body, async response => {
                var imageList = [];
				var imageListConfig = [];
				var receiveImageList = [];
				// Get token Image
                var responseToken = await ajaxGet(`${baseUrl}/homecare/api/v1/DocumentToken`);
				var imageToken = responseToken.data;

				var tempImageList = receiveImageList.data ? receiveImageList.data.concat(response.data) : response.data;
                $.each(tempImageList, (i, d) => {
                    var extension = d.attachmentURL.split('.')[d.attachmentURL.split('.').length - 1].toLowerCase();
                    var fileType = 'object';
                    var types = ['jpg', 'png', 'gif', 'tiff', 'jpeg', 'bmp'];
                    if (types.indexOf(extension) >= 0) {
                        fileType = 'image';
                    }

					imageList.push(`${baseUrl}/${d.attachmentURL}?Token=${imageToken}`);
					imageListConfig.push({
                        caption: name + '-File-' + (i + 1),
                        type: fileType,
						url: `${baseUrl}/homecare/api/v1/Attachment/${d.attachmentId}`,
						width: '120px',
                        key: `${d.attachmentURL}?Token=${imageToken}`


					});
				});

                $("#MemofileAttachment").fileinput({
					showUpload: true,
					showBrowse: true,
					dropZoneEnabled: true,
					maxFileSize: 25000,
					maxFileCount: 0,
					showRemove: true,
					msgSelected: '{n} ไฟล์',
					initialCaption: imageList.length + ' ไฟล์',
                    msgPlaceholder: 'กรุณาเลือกไฟล์',                   
                    allowedFileExtensions: ['doc', 'docx', 'pdf', 'jpg', 'jpeg', 'tif','png','pdf','xls','xlsx'],
					autoOrientImage: false,
					theme: 'explorer',
					uploadAsync: true,
                    uploadUrl: `${baseUrl}/homecare/api/v1/Attachment/UploadExtendedWarrantyMemoAttatchment`,
					uploadExtraData: () => {
						return {
	                            referenceId: referenceItemId,
                                referenceType: 'EXTENDED',
						        referenceItemId: 0,
						        attachmentTypeId: attType,
						        userCode: '@UserDetail.CodeName'
						}
					},
					initialPreview: imageList,
					initialPreviewFileType: 'image',
					initialPreviewConfig: imageListConfig,
					initialPreviewAsData: true,
					initialPreviewDownloadUrl: '' + baseUrl + '/{key}',
					validateInitialCount: true,
					overwriteInitial: false,
					previewFileIcon: '<i class="fa fa-file-pdf-o text-danger"></i>',
					preferIconicPreview: true,
					ajaxSettings: {
						headers: {
							"Authorization": "Bearer " + constructionApiToken
						}
					},
					ajaxDeleteSettings: {
						method: 'DELETE',
						headers: {
							"cache-control": "no-cache",
							"Content-Type": "application/json",
							"Authorization": "Bearer " + constructionApiToken
						},
						data: JSON.stringify({ username: '@UserDetail.CodeName' })
					}
				}).on('fileuploaded', () => {
					// ซ่อนปุ่มลบหลังจาก upload
					//$('.kv-file-remove:not([data-key])').css('display', 'none');
					@*$('#flagImage' + attType).removeClass('fa-times').addClass('fa-check-square-o').css('color', 'green');
					$('#fileCreateBy' + attType).text('@UserDetail.CodeName');
					$('#fileCreateDate' + attType).text(thaiFormatDate(new Date().toISOString(), false));*@
                    $('#MemofileAttachment').removeClass('fa-times').addClass('fa-check-square-o').css('color', 'green');
                });
			});
   };


    // open ModalViewImageByType

    //open ModalViewQuotation
    function openModalViewQuotation(receiveItemId) {
        var tempReceiveItem = receiveItemList.data.filter(item => item.receiveItemId == receiveItemId);
        $('#DdlReceiveItemList').empty();
        $('#DdlReceiveItemList').append(`<option value="0" selected>${tempReceiveItem[0].guaranteeDescription}</option>`);
        $('#txtPriceRepairProject').text(customerData.projectNameTh);
        $('#txtPriceRepairUnit').text(customerData.unitCodeAddress);
        bindTBodyQuotationItemDetail(quotationItemList.filter(item => item.receiveItemId == receiveItemId));
        calTotalPrice(quotationItemList.filter(item => item.receiveItemId == receiveItemId));
        $('#lblTotalPrice').text();
        $('#modalDetailPriceRepair').modal('show');
    }



       function validateForm() {
            checkValidation = true;
            $('.error').hide();

            var project = $('#project').val();
            var unitid = $('#unitid').val();
            var remark = $('#remark').val();
            var memo = $('#memo').val();

            var extenddate = $('#extenddate').val();

            if (project == 0) {
                $('#project').after('<span class="error"> กรุณาเลือกโครงการ </span>');
                checkValidation = false;
            }
            if (unitid == "" || unitid == undefined) {
                $('#unitid').after('<span class="error"> กรุณาเลือกแปลง </span>');
                checkValidation = false;
            }

            if (extenddate == "") {
                $('#extenddate').after('<span class="error"> กรุณาระบุวันที่ ที่ต้องการทำการขยาย   </span>');
                checkValidation = false;
            }


            if (remark == "") {
                $('#remark').after('<span class="error"> กรุณาระบุหมายเหตุ</span>');
                checkValidation = false;
            }
            if (memo == "") {
                $('#memo').after('<span class="error"> กรุณาระบุ Memo</span>');
                checkValidation = false;
            }

            if (memo.length > 50) {
                $('#memo').after('<span class="error"> กรุณาระบุ Memo ไม่เกิน 50 ตัวอักษร </span>');
                checkValidation = false;
            }

            if (validateDateWarranty == false) {
                $('#detail').after('<span class="error"> กรุณาติดต่อ Admin เนื่องจาก Unit ที่เลือกไม่มีข้อมูลเกี่ยววันที่รับประกันกัน </span>');
                checkValidation = false;

            }
            else {
                var from = $('#extenddate').val().split("/")
                var dateCompare = new Date(from[2], parseInt(from[1]) - 1, from[0]);
                if (dateCompare < newDateCompare) {

                    $('#extenddate').after('<span class="error"> กรุณาเลือกวันที่มากกว่าวันที่ขยายประกันกัน   </span>');
                    checkValidation = false;
                }
                else {
                    if (dateCompare < dateEnddatecompare) {

                        $('#extenddate').after('<span class="error"> กรุณาเลือกวันที่มากกว่าวันที่หมดประกัน   </span>');
                        checkValidation = false;
                    }
                }

            }
        }


    function SaveData() {
        page.loading();
        var data = []; //empty var;

        var from = $('#extenddate').val().split("/")
        //if (from[0].length == 1) {
        //    from[0] = '0' + from[0];
        //}
        var savedate = from[1] + '/' + from[0] + '/' + from[2];




            data.push({

                "unitId": $('#unitid').val(),
                //"extendDate": $('#extenddate').val(),
                "extendDate": savedate,
                "extendRemark": $('#remark').val(),
                "extendMemo": $('#memo').val(),
                "userLogon": '@UserDetail.CodeName'
            });

            ajaxPost(`${baseUrl}/homecare/api/v1/ExtendedWarranty/PostExtendedWarranty`, data, response => {
                if (response.data.msg == "Success.") {
                    console.log('OK')
                    $('#modalSaveData').modal('hide');
                    showModalLineApprveSuccess('บันทึกข้อมูลสำเร็จ');
                    page.loaded();
                }
                else {
                    page.loaded();
                }
            });
    }

    $('#flagAllProj').change(function () {
        if (this.checked) {
            //if (projectExtendedAllList == []) {
            projectExtendedAllList = [];
            var showLoading = true
            if (showLoading) {
                page.loading();
            }
            ajaxGet(`${baseUrl}/homecare/api/v1/ExtendedWarranty/GetExtendedWarranty?projectid=` + 0, response => {
                if (response.data) {
                    $.each(response.data, function (Index, Value) {

                        projectExtendedAllList.push(

                            {
                                "row": projectExtendedAllList.length + 1,
                                "projectId": Value.projectId,
                                "unitCode": Value.unitCode,
                                "startWarrantyDate": Value.startWarrantyDate,
                                "endWarrantyDate": Value.endWarrantyDate,
                                "extendedWarrantyDate": Value.extendedWarrantyDate,
                                "extendedRemark": Value.extendedRemark,
                                "extendedMemo": Value.extendedMemo,
                                "createdBy": Value.createdBy
                            }
                        )
                    });
                    LoadTableProject();
                    page.loaded();
                }
            });

        } else {
            LoadTableProject();
            page.loaded();
        }


    }

    );

    function sortByKeyDesc(array, key) {
        return array.sort(function (a, b) {
            var x = a[key]; var y = b[key];
            return ((x > y) ? -1 : ((x < y) ? 1 : 0));
        });
    }
    function sortByKeyAsc(array, key) {
        return array.sort(function (a, b) {
            var x = a[key]; var y = b[key];
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        });
    }

    function redirectURL() {

        window.location.href = window.location.pathname;
    }
    function resetform() {
            $('.error').hide();
            $("#frmSaveExtended")[0].reset();
            $("#project").val([0]).trigger('change');
            $("#unitid").val([]).trigger('change');
     }
    //$(`#unitid`).on("select2:select", function (evt) {

    //    var r = $(`#unitid`).val();

    //    if (unitselected.length > 0) {
    //        var filtered = unitselected.filter(element => element.projectId != r);
    //    }



    //});


    </script>
}